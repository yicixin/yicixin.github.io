<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css integrity=sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.2.1.slim.min.js integrity=sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js integrity=sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js integrity=sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl crossorigin=anonymous></script><title>Golangå†…å­˜å›æ”¶ | yicixin's blog</title>
<meta name=keywords content="golang,GC,å†…å­˜å›æ”¶,æºç è§£æ"><meta name=description content="GCæºç åˆ†å¸ƒ: æµç¨‹ æ–‡ä»¶ æ ‡è®°å‡†å¤‡ runtime/mgc.go è°ƒæ­¥ç­–ç•¥ runtime/mgcpacer.go å¹¶å‘æ ‡è®° runtime/mgcmark.go æ¸…æ‰«æµç¨‹ runtime/msweep.go ä½å›¾æ ‡è¯† runtime/mbitmap.go è§¦å‘å±éšœ runtime/mbwbuf.go å†…å­˜å›æ”¶ runtime/mgcscavenge.go GCè§¦å‘é“¾è·¯: è§¦å‘ GC çš„äº‹ä»¶ç±»å‹å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§ï¼š
ç±»å‹ è§¦å‘äº‹ä»¶ æ ¡éªŒæ¡ä»¶ gcTriggerHeap åˆ†é…å¯¹è±¡æ—¶è§¦å‘ å †å·²åˆ†é…å†…å­˜è¾¾åˆ°é˜ˆå€¼ gcTriggerTime ç”± forcegchelper å®ˆæŠ¤åç¨‹å®šæ—¶è§¦å‘ æ¯2åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ gcTriggerCycle ç”¨æˆ·è°ƒç”¨ runtime.GC æ–¹æ³• ä¸Šä¸€è½® GC å·²ç»“æŸ è§¦å‘ç±»å‹çš„æºç :
type gcTriggerKind int const ( // å †è§¦å‘ gcTriggerHeap gcTriggerKind = iota // å®šæ—¶è§¦å‘ gcTriggerTime // æ‰‹åŠ¨è§¦å‘ gcTriggerCycle ) // è¿›è¡Œè§¦å‘æ¡ä»¶çš„æ ¡éªŒ func (t gcTrigger) test() bool { if !memstats.enablegc || panicking.Load() !"><meta name=author content="å£¹æ¬¡å¿ƒ"><link rel=canonical href=https://www.yici.xin/post/tech/golang%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.00d594ac5404702263b7df2f247aae4053818963176b093f9b95a1fc7e4e0b42.css integrity="sha256-ANWUrFQEcCJjt98vJHquQFOBiWMXawk/m5Wh/H5OC0I=" rel="preload stylesheet" as=style><link rel=icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=icon type=image/png sizes=16x16 href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=icon type=image/png sizes=32x32 href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=apple-touch-icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=mask-icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Golangå†…å­˜å›æ”¶"><meta property="og:description" content="GCæºç åˆ†å¸ƒ: æµç¨‹ æ–‡ä»¶ æ ‡è®°å‡†å¤‡ runtime/mgc.go è°ƒæ­¥ç­–ç•¥ runtime/mgcpacer.go å¹¶å‘æ ‡è®° runtime/mgcmark.go æ¸…æ‰«æµç¨‹ runtime/msweep.go ä½å›¾æ ‡è¯† runtime/mbitmap.go è§¦å‘å±éšœ runtime/mbwbuf.go å†…å­˜å›æ”¶ runtime/mgcscavenge.go GCè§¦å‘é“¾è·¯: è§¦å‘ GC çš„äº‹ä»¶ç±»å‹å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§ï¼š
ç±»å‹ è§¦å‘äº‹ä»¶ æ ¡éªŒæ¡ä»¶ gcTriggerHeap åˆ†é…å¯¹è±¡æ—¶è§¦å‘ å †å·²åˆ†é…å†…å­˜è¾¾åˆ°é˜ˆå€¼ gcTriggerTime ç”± forcegchelper å®ˆæŠ¤åç¨‹å®šæ—¶è§¦å‘ æ¯2åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ gcTriggerCycle ç”¨æˆ·è°ƒç”¨ runtime.GC æ–¹æ³• ä¸Šä¸€è½® GC å·²ç»“æŸ è§¦å‘ç±»å‹çš„æºç :
type gcTriggerKind int const ( // å †è§¦å‘ gcTriggerHeap gcTriggerKind = iota // å®šæ—¶è§¦å‘ gcTriggerTime // æ‰‹åŠ¨è§¦å‘ gcTriggerCycle ) // è¿›è¡Œè§¦å‘æ¡ä»¶çš„æ ¡éªŒ func (t gcTrigger) test() bool { if !memstats.enablegc || panicking.Load() !"><meta property="og:type" content="article"><meta property="og:url" content="https://www.yici.xin/post/tech/golang%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6/"><meta property="og:image" content="https://www.yici.xin/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-27T18:26:23+08:00"><meta property="article:modified_time" content="2022-12-27T18:26:23+08:00"><meta property="og:site_name" content="yicixin's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.yici.xin/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Golangå†…å­˜å›æ”¶"><meta name=twitter:description content="GCæºç åˆ†å¸ƒ: æµç¨‹ æ–‡ä»¶ æ ‡è®°å‡†å¤‡ runtime/mgc.go è°ƒæ­¥ç­–ç•¥ runtime/mgcpacer.go å¹¶å‘æ ‡è®° runtime/mgcmark.go æ¸…æ‰«æµç¨‹ runtime/msweep.go ä½å›¾æ ‡è¯† runtime/mbitmap.go è§¦å‘å±éšœ runtime/mbwbuf.go å†…å­˜å›æ”¶ runtime/mgcscavenge.go GCè§¦å‘é“¾è·¯: è§¦å‘ GC çš„äº‹ä»¶ç±»å‹å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§ï¼š
ç±»å‹ è§¦å‘äº‹ä»¶ æ ¡éªŒæ¡ä»¶ gcTriggerHeap åˆ†é…å¯¹è±¡æ—¶è§¦å‘ å †å·²åˆ†é…å†…å­˜è¾¾åˆ°é˜ˆå€¼ gcTriggerTime ç”± forcegchelper å®ˆæŠ¤åç¨‹å®šæ—¶è§¦å‘ æ¯2åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ gcTriggerCycle ç”¨æˆ·è°ƒç”¨ runtime.GC æ–¹æ³• ä¸Šä¸€è½® GC å·²ç»“æŸ è§¦å‘ç±»å‹çš„æºç :
type gcTriggerKind int const ( // å †è§¦å‘ gcTriggerHeap gcTriggerKind = iota // å®šæ—¶è§¦å‘ gcTriggerTime // æ‰‹åŠ¨è§¦å‘ gcTriggerCycle ) // è¿›è¡Œè§¦å‘æ¡ä»¶çš„æ ¡éªŒ func (t gcTrigger) test() bool { if !memstats.enablegc || panicking.Load() !"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.yici.xin/post/"},{"@type":"ListItem","position":2,"name":"ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯","item":"https://www.yici.xin/post/tech/"},{"@type":"ListItem","position":3,"name":"Golangå†…å­˜å›æ”¶","item":"https://www.yici.xin/post/tech/golang%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Golangå†…å­˜å›æ”¶","name":"Golangå†…å­˜å›æ”¶","description":"GCæºç åˆ†å¸ƒ: æµç¨‹ æ–‡ä»¶ æ ‡è®°å‡†å¤‡ runtime/mgc.go è°ƒæ­¥ç­–ç•¥ runtime/mgcpacer.go å¹¶å‘æ ‡è®° runtime/mgcmark.go æ¸…æ‰«æµç¨‹ runtime/msweep.go ä½å›¾æ ‡è¯† runtime/mbitmap.go è§¦å‘å±éšœ runtime/mbwbuf.go å†…å­˜å›æ”¶ runtime/mgcscavenge.go GCè§¦å‘é“¾è·¯: è§¦å‘ GC çš„äº‹ä»¶ç±»å‹å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§ï¼š\nç±»å‹ è§¦å‘äº‹ä»¶ æ ¡éªŒæ¡ä»¶ gcTriggerHeap åˆ†é…å¯¹è±¡æ—¶è§¦å‘ å †å·²åˆ†é…å†…å­˜è¾¾åˆ°é˜ˆå€¼ gcTriggerTime ç”± forcegchelper å®ˆæŠ¤åç¨‹å®šæ—¶è§¦å‘ æ¯2åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ gcTriggerCycle ç”¨æˆ·è°ƒç”¨ runtime.GC æ–¹æ³• ä¸Šä¸€è½® GC å·²ç»“æŸ è§¦å‘ç±»å‹çš„æºç :\ntype gcTriggerKind int const ( // å †è§¦å‘ gcTriggerHeap gcTriggerKind = iota // å®šæ—¶è§¦å‘ gcTriggerTime // æ‰‹åŠ¨è§¦å‘ gcTriggerCycle ) // è¿›è¡Œè§¦å‘æ¡ä»¶çš„æ ¡éªŒ func (t gcTrigger) test() bool { if !memstats.enablegc || panicking.Load() !","keywords":["golang","GC","å†…å­˜å›æ”¶","æºç è§£æ"],"articleBody":"GCæºç åˆ†å¸ƒ: æµç¨‹ æ–‡ä»¶ æ ‡è®°å‡†å¤‡ runtime/mgc.go è°ƒæ­¥ç­–ç•¥ runtime/mgcpacer.go å¹¶å‘æ ‡è®° runtime/mgcmark.go æ¸…æ‰«æµç¨‹ runtime/msweep.go ä½å›¾æ ‡è¯† runtime/mbitmap.go è§¦å‘å±éšœ runtime/mbwbuf.go å†…å­˜å›æ”¶ runtime/mgcscavenge.go GCè§¦å‘é“¾è·¯: è§¦å‘ GC çš„äº‹ä»¶ç±»å‹å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§ï¼š\nç±»å‹ è§¦å‘äº‹ä»¶ æ ¡éªŒæ¡ä»¶ gcTriggerHeap åˆ†é…å¯¹è±¡æ—¶è§¦å‘ å †å·²åˆ†é…å†…å­˜è¾¾åˆ°é˜ˆå€¼ gcTriggerTime ç”± forcegchelper å®ˆæŠ¤åç¨‹å®šæ—¶è§¦å‘ æ¯2åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ gcTriggerCycle ç”¨æˆ·è°ƒç”¨ runtime.GC æ–¹æ³• ä¸Šä¸€è½® GC å·²ç»“æŸ è§¦å‘ç±»å‹çš„æºç :\ntype gcTriggerKind int const ( // å †è§¦å‘ gcTriggerHeap gcTriggerKind = iota // å®šæ—¶è§¦å‘ gcTriggerTime // æ‰‹åŠ¨è§¦å‘ gcTriggerCycle ) // è¿›è¡Œè§¦å‘æ¡ä»¶çš„æ ¡éªŒ func (t gcTrigger) test() bool { if !memstats.enablegc || panicking.Load() != 0 || gcphase != _GCoff { return false } switch t.kind { case gcTriggerHeap: // è§¦å‘å †å¤§å° trigger, _ := gcController.trigger() // æ¯”è¾ƒå¤§å°æ˜¯å¦æ»¡è¶³ return gcController.heapLive.Load() \u003e= trigger case gcTriggerTime: // gcController.gcPercent \u003c 0 è¡¨ç¤ºä¸è¿›è¡ŒGC if gcController.gcPercent.Load() \u003c 0 { return false } // ä¸Šæ¬¡gcæ—¶é—´ lastgc := int64(atomic.Load64(\u0026memstats.last_gc_nanotime)) return lastgc != 0 \u0026\u0026 t.now-lastgc \u003e forcegcperiod case gcTriggerCycle: // t.n \u003e work.cycles, but accounting for wraparound. return int32(t.n-work.cycles.Load()) \u003e 0 } return true } å®šæ—¶è§¦å‘GC \u003c!DOCTYPE HTML\u003e æ–¹æ³• æ–‡ä»¶ ä½œç”¨ init runtime/proc.go å¼€å¯ä¸€ä¸ª forcegchelper åç¨‹ forcegchelper runtime/proc.go å¾ªç¯é˜»å¡æŒ‚èµ·+å®šæ—¶è§¦å‘ gc main runtime/proc.go è°ƒç”¨ sysmon æ–¹æ³• sysmon runtime/proc.go å®šæ—¶å”¤é†’ forcegchelperï¼Œä»è€Œè§¦å‘ gc gcTrigger.test runtime/mgc.go æ ¡éªŒæ˜¯å¦æ»¡è¶³ gc è§¦å‘æ¡ä»¶ gcStart runtime/mgc.go æ ‡è®°å‡†å¤‡é˜¶æ®µä¸»æµç¨‹æ–¹æ³• init + forcegchelper\n// start forcegc helper goroutine func init() { go forcegchelper() } // runtime åŒ…ä¸‹çš„å…¨å±€å˜é‡ var forcegc forcegcstate type forcegcstate struct { lock mutex g *g idle atomic.Bool } func forcegchelper() { // è·å–å½“å‰g forcegc.g = getg() // åˆå§‹åŒ–é” lockInit(\u0026forcegc.lock, lockRankForcegc) for { lock(\u0026forcegc.lock) if forcegc.idle.Load() { throw(\"forcegc: phase error\") } forcegc.idle.Store(true) // å°†å½“å‰ goroutine ç½®äºç­‰å¾…çŠ¶æ€å¹¶è§£é” goparkunlock(\u0026forcegc.lock, waitReasonForceGCIdle, traceEvGoBlock, 1) // this goroutine is explicitly resumed by sysmon if debug.gctrace \u003e 0 { println(\"GC forced\") } // Time-triggered, fully concurrent. // è¢«å”¤é†’åæ‰§è¡ŒgcStartï¼Œè¿›å…¥æ ‡è®°å‡†å¤‡é˜¶æ®µï¼Œè§¦å‘ç±»å‹å³å®šæ—¶è§¦å‘ gcStart(gcTrigger{kind: gcTriggerTime, now: nanotime()}) } } å”¤é†’forcegchelperçš„åœ°æ–¹åœ¨proc.goçš„mainå‡½æ•°ä¸­:\n// The main goroutine. func main() { ... // é€šè¿‡ systemstack æ“ä½œåˆ‡æ¢è‡³ g0ï¼Œå¹¶è°ƒç”¨ sysmon æ–¹æ³•ï¼Œè½®è¯¢å°è¯•å°† forcegchelper åç¨‹æ·»åŠ åˆ° gList ä¸­ï¼Œå¹¶åœ¨ injectglist æ–¹æ³•å†…å°†å…¶å”¤é†’ systemstack(func() { newm(sysmon, nil, -1) }) ... } func sysmon() { // ... for { // é€šè¿‡ gcTrigger.test æ–¹æ³•æ£€æŸ¥æ˜¯å¦éœ€è¦å‘èµ· gcï¼Œè§¦å‘ç±»å‹ä¸º gcTriggerTimeï¼šå®šæ—¶è§¦å‘ if t := (gcTrigger{kind: gcTriggerTime, now: now}); t.test() \u0026\u0026 atomic.Load(\u0026forcegc.idle) != 0 { lock(\u0026forcegc.lock) forcegc.idle = 0 var list gList // éœ€è¦å‘èµ· gcï¼Œåˆ™å°† forcegc.g æ³¨å…¥ list ä¸­, injectglist æ–¹æ³•å†…éƒ¨ä¼šæ‰§è¡Œå”¤é†’æ“ä½œ list.push(forcegc.g) injectglist(\u0026list) unlock(\u0026forcegc.lock) } // ... } } å¯¹è±¡åˆ†é…è§¦å‘ \u003c!DOCTYPE HTML\u003e æ–¹æ³• æ–‡ä»¶ ä½œç”¨ mallocgc runtime/malloc.go åˆ†é…å¯¹è±¡ä¸»æµç¨‹æ–¹æ³• gcTrigger.test runtime/mgc.go æ ¡éªŒæ˜¯å¦æ»¡è¶³ gc è§¦å‘æ¡ä»¶ gcStart runtime/mgc.go æ ‡è®°å‡†å¤‡é˜¶æ®µä¸»æµç¨‹æ–¹æ³• åœ¨åˆ†é…å¯¹è±¡çš„mallocæ–¹æ³•ä¸­ï¼Œå€˜è‹¥æ»¡è¶³å¦‚ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€ï¼Œéƒ½ä¼šå‘èµ·ä¸€æ¬¡è§¦å‘GCçš„å°è¯•ï¼š\néœ€è¦åˆå§‹åŒ–ä¸€ä¸ªå¤§å°è¶…è¿‡32KBçš„å¤§å¯¹è±¡ å¾…åˆå§‹åŒ–å¯¹è±¡åœ¨mcacheä¸­å¯¹åº”spanClassçš„mspanç©ºé—´å·²ç”¨å°½ å¯¹è±¡åˆ†é…:\nfunc mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer { // ... // æ ‡å¿—æ˜¯å¦éœ€è¦è§¦å‘gc shouldhelpgc := false // ... if size \u003c= maxSmallSize { if noscan \u0026\u0026 size \u003c maxTinySize { // ... if v == 0 { // å€˜è‹¥ mcache ä¸­å¯¹åº” spanClass çš„ mspan å·²æ»¡ï¼Œç½® true v, span, shouldhelpgc = c.nextFree(tinySpanClass) } // ... } else { // ... if v == 0 { // å€˜è‹¥ mcache ä¸­å¯¹åº” spanClass çš„ mspan å·²æ»¡ï¼Œç½® true v, span, shouldhelpgc = c.nextFree(spc) } // ... } } else { // ç”³è¯·å¤§å°å¤§äº 32KB çš„å¤§å¯¹è±¡ï¼Œç›´æ¥ç½®ä¸º true shouldhelpgc = true // ... } // ... // å°è¯•è§¦å‘ gcï¼Œç±»å‹ä¸º gcTriggerHeap if shouldhelpgc { if t := (gcTrigger{kind: gcTriggerHeap}); t.test() { gcStart(t) } } // ... } æ‰‹åŠ¨è§¦å‘ æ–¹æ³• æ–‡ä»¶ ä½œç”¨ GC runtime/mgc.go æ‰‹åŠ¨è§¦å‘GCä¸»æµç¨‹æ–¹æ³• gcStart runtime/mgc.go æ ‡è®°å‡†å¤‡é˜¶æ®µä¸»æµç¨‹æ–¹æ³• æœ€åä¸€ç§è§¦å‘çš„GCå½¢å¼æ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œå…¥å£ä½äº runtime åŒ…çš„å…¬å…±æ–¹æ³•ï¼šruntime.GCï¼š\nfunc GC() { // ... // è§¦å‘gcï¼Œç±»å‹ä¸ºæ‰‹åŠ¨è§¦å‘ï¼Œé’ˆå¯¹è¿™ç§ç±»å‹çš„æ ¡éªŒæ¡ä»¶æ˜¯ï¼Œä¸Šä¸€è½®GCå·²ç»å®Œæˆï¼Œæ­¤æ—¶èƒ½å¤Ÿå¼€å¯æ–°ä¸€è½®GCä»»åŠ¡. gcStart(gcTrigger{kind: gcTriggerCycle, n: n + 1}) // ... } GCæ‰§è¡Œæµç¨‹ æ ‡è®°å‡†å¤‡ æ–¹æ³• æ–‡ä»¶ ä½œç”¨ gcStart runtime/mgc.go æ ‡è®°å‡†å¤‡é˜¶æ®µä¸»æµç¨‹æ–¹æ³• gcBgMarkStartWorkers runtime/mgc.go æ‰¹é‡å¯åŠ¨æ ‡è®°åç¨‹ ï¼Œæ•°é‡å¯¹åº”äº P çš„ä¸ªæ•° gcBgMarkWorker runtime/mgc.go æ ‡è®°åç¨‹ä¸»æµç¨‹æ–¹æ³•ï¼Œå¯åŠ¨ä¹‹åˆä¼šå…ˆé˜»å¡æŒ‚èµ·ï¼Œå¾…è¢«å”¤é†’åçœŸæ­£æ‰§è¡Œä»»åŠ¡ stopTheWorldWithSema runtime/mgc.go å³STWï¼Œåœæ­¢P. gcControllerState.startCycle runtime/mgcspacer.go é™åˆ¶æ ‡è®°åç¨‹æ‰§è¡Œé¢‘ç‡ï¼Œç›®æ ‡æ˜¯ä»¤æ ‡è®°åç¨‹å¯¹CPUçš„å ç”¨ç‡è¶‹è¿‘äº 25% setGCPhase runtime/mgc.go æ›´æ–°GCé˜¶æ®µ. å½“ä¸ºæ ‡è®°é˜¶æ®µï¼ˆGCMarkï¼‰æ—¶ä¼šå¯ç”¨æ··åˆå†™å±éšœ gcMarkTinyAllocs runtime/mgc.go æ ‡è®° mcache ä¸­çš„ tiny å¯¹è±¡ startTheWorldWithSema runtime/mgc.go ä¸STWç›¸åï¼Œä¼šé‡æ–°å”¤é†’å„ä¸ªP ä¸»æµç¨‹-gcStartï¼š\nå†æ¬¡æ£€æŸ¥GCè§¦å‘æ¡ä»¶æ˜¯å¦è¾¾æˆ å¼‚æ­¥å¯åŠ¨å¯¹åº”äºPæ•°é‡çš„æ ‡è®°åç¨‹ Stop the world æ§åˆ¶æ ‡è®°åç¨‹æ•°é‡å’Œæ‰§è¡Œæ—¶é•¿ï¼Œä½¿å¾—CPUå ç”¨ç‡è¶‹è¿‘25% è®¾ç½®GCé˜¶æ®µä¸ºGCMarkï¼Œå¼€å¯æ··åˆæ··åˆå†™å±éšœ æ ‡è®°mcacheä¸­çš„tinyå¯¹è±¡ Start the world func gcStart(trigger gcTrigger) { // ç”±äºè¿™æ˜¯ä» malloc è°ƒç”¨çš„ï¼Œå¹¶ä¸” malloc æ˜¯åœ¨è®¸å¤šå¯èƒ½æŒæœ‰é”çš„åº“çš„å†…éƒ¨è°ƒç”¨çš„ï¼Œæ‰€ä»¥ä¸è¦å°è¯•åœ¨ä¸å¯æŠ¢å æˆ–å¯èƒ½ä¸ç¨³å®šçš„æƒ…å†µä¸‹å¯åŠ¨ GCã€‚ mp := acquirem() // ä¸æ»¡è¶³çš„æƒ…å†µç›´æ¥return if gp := getg(); gp == mp.g0 || mp.locks \u003e 1 || mp.preemptoff != \"\" { releasem(mp) return } releasem(mp) mp = nil // æ£€æŸ¥gcæ¡ä»¶ for trigger.test() \u0026\u0026 sweepone() != ^uintptr(0) { sweep.nbgsweep++ } // ä¸Šé” semacquire(\u0026work.startSema) // åŠ é” double check if !trigger.test() { semrelease(\u0026work.startSema) return } // ... // è¿›å…¥äº† GC æ¨¡å¼ï¼Œä¼šæ ¹æ® P çš„æ•°é‡å¯åŠ¨å¤šä¸ª GC å¹¶å‘æ ‡è®°åç¨‹ï¼Œä½†æ˜¯ä¼šå…ˆé˜»å¡æŒ‚èµ·ï¼Œç­‰å¾…è¢«å”¤é†’ï¼Œåœ¨æ ‡è®°é˜¶æ®µæ‰å¼€å§‹æ‰§è¡Œ gcBgMarkStartWorkers() // ... // åˆ‡æ¢åˆ° g0ï¼Œæ‰§è¡Œ Stop the world æ“ä½œ systemstack(stopTheWorldWithSema) // ... // é™åˆ¶æ ‡è®°åç¨‹å ç”¨ CPU æ—¶é—´ç‰‡çš„æ¯”ä¾‹ä¸ºè¶‹è¿‘ 25% gcController.startCycle(now, int(gomaxprocs), trigger) // è®¾ç½®GCé˜¶æ®µä¸º_GCmarkï¼Œå¯ç”¨æ··åˆå†™å±éšœ setGCPhase(_GCmark) // ... // å¯¹ mcache ä¸­çš„ tiny å¯¹è±¡è¿›è¡Œæ ‡è®° gcMarkTinyAllocs() // åˆ‡æ¢è‡³ g0ï¼Œé‡æ–° start the world systemstack(func() { now = startTheWorldWithSema(trace.enabled) // ... }) // ... } gcBgMarkStartWorkers-å¼‚æ­¥å¯åŠ¨æ ‡è®°åç¨‹ï¼š\nvar gcBgMarkWorkerCount int32 func gcBgMarkStartWorkers() { // Background marking is performed by per-P G's. Ensure that each P has // a background GC G. // // Worker Gs don't exit if gomaxprocs is reduced. If it is raised // again, we can reuse the old workers; no need to create new workers. // è¿™äº›WorkerGä¸ä¼šéšç€Pçš„æ•°é‡å‡å°‘è€Œé€€å‡ºï¼Œè¿™æ ·çš„è¯ï¼Œå¦‚æœè¦æ±‚çš„æ•°é‡é‡æ–°ä¸Šè°ƒï¼Œå¯ä»¥é‡ç”¨æ—§çš„è€Œä¸ç”¨åˆ›å»ºæ–°çš„worker for gcBgMarkWorkerCount \u003c gomaxprocs { go gcBgMarkWorker() notetsleepg(\u0026work.bgMarkReady, -1) noteclear(\u0026work.bgMarkReady) // The worker is now guaranteed to be added to the pool before // its P's next findRunnableGCWorker. gcBgMarkWorkerCount++ } } // gcBgMarkWorker æ–¹æ³•ä¸­å°†gåŒ…è£…æˆä¸€ä¸ªnodeæ·»åŠ åˆ°å…¨å±€çš„gcBgMarkWorkerPoolä¸­ï¼Œä¿è¯æ ‡è®°åç¨‹ä¸Pçš„ä¸€å¯¹ä¸€å…³è”ï¼Œå¹¶è°ƒç”¨ gopark æ–¹æ³•å°†å½“å‰ g æŒ‚èµ·ï¼Œç­‰å¾…è¢«å”¤é†’. func gcBgMarkWorker() { gp := getg() node := new(gcBgMarkWorkerNode) gp.m.preemptoff = \"\" node.gp.set(gp) node.m.set(acquirem()) // å”¤é†’å¤–éƒ¨çš„ for å¾ªç¯ notewakeup(\u0026work.bgMarkReady) for { // å½“å‰ g é˜»å¡è‡³æ­¤ï¼Œç›´åˆ° gcController.findRunnableGCWorker æ–¹æ³•è¢«è°ƒç”¨ï¼Œä¼šå°†å½“å‰ g å”¤é†’ gopark(func(g *g, nodep unsafe.Pointer) bool { node := (*gcBgMarkWorkerNode)(nodep) // ... // å°†å½“å‰ g åŒ…è£…æˆä¸€ä¸ª node æ·»åŠ åˆ° gcBgMarkWorkerPool ä¸­ gcBgMarkWorkerPool.push(\u0026node.node) return true }, unsafe.Pointer(node), waitReasonGCWorkerIdle, traceEvGoBlock, 0) // ... } } Stop-the-world:\ngcStart æ–¹æ³•åœ¨è°ƒç”¨gcBgMarkStartWorkersæ–¹æ³•å¼‚æ­¥å¯åŠ¨æ ‡è®°åç¨‹åï¼Œä¼šæ‰§è¡ŒSTWæ“ä½œåœæ­¢æ‰€æœ‰ç”¨æˆ·åç¨‹ï¼Œå…¶å®ç°ä½äº stopTheWorldWithSema æ–¹æ³•ï¼Œæ ¸å¿ƒç‚¹å¦‚ä¸‹ï¼š\nå–é”ï¼šsched.lock å°† sched.gcwaiting æ ‡è¯†ç½®ä¸º 1ï¼Œåç»­çš„è°ƒåº¦æµç¨‹è§å…¶æ ‡è¯†ï¼Œéƒ½ä¼šé˜»å¡æŒ‚èµ· æŠ¢å æ‰€æœ‰gï¼Œå¹¶å°† P çš„çŠ¶æ€ç½®ä¸º syscall å°†æ‰€æœ‰Pçš„çŠ¶æ€æ”¹ä¸º stop å€˜è‹¥éƒ¨åˆ†ä»»åŠ¡æ— æ³•æŠ¢å ï¼Œåˆ™ç­‰å¾…å…¶å®Œæˆåå†è¿›è¡ŒæŠ¢å  è°ƒç”¨æ–¹æ³•worldStoppedæ”¶å°¾ï¼Œä¸–ç•Œåœæ­¢äº† func stopTheWorldWithSema() { _g_ := getg() // å…¨å±€è°ƒåº¦é” lock(\u0026sched.lock) sched.stopwait = gomaxprocs // æ­¤æ ‡è¯†ç½® 1ï¼Œä¹‹åæ‰€æœ‰çš„è°ƒåº¦éƒ½ä¼šé˜»å¡ç­‰å¾… atomic.Store(\u0026sched.gcwaiting, 1) // å‘é€æŠ¢å ä¿¡æ¯æŠ¢å æ‰€æœ‰ Gï¼Œåå°† p çŠ¶æ€ç½®ä¸º syscall preemptall() // å°†å½“å‰ p çš„çŠ¶æ€ç½®ä¸º stop _g_.m.p.ptr().status = _Pgcstop // Pgcstop is only diagnostic. sched.stopwait-- // æŠŠæ‰€æœ‰ p çš„çŠ¶æ€ç½®ä¸º stop for _, p := range allp { s := p.status if s == _Psyscall \u0026\u0026 atomic.Cas(\u0026p.status, s, _Pgcstop) { // ... p.syscalltick++ sched.stopwait-- } } // æŠŠç©ºé—² p çš„çŠ¶æ€ç½®ä¸º stop now := nanotime() for { p, _ := pidleget(now) if p == nil { break } p.status = _Pgcstop sched.stopwait-- } wait := sched.stopwait \u003e 0 unlock(\u0026sched.lock) // å€˜è‹¥æœ‰ p æ— æ³•è¢«æŠ¢å ï¼Œåˆ™é˜»å¡ç›´åˆ°å°†å…¶ç»Ÿç»ŸæŠ¢å å®Œæˆ if wait { for { // wait for 100us, then try to re-preempt in case of any races if notetsleep(\u0026sched.stopnote, 100*1000) { noteclear(\u0026sched.stopnote) break } preemptall() } } // native æ–¹æ³•ï¼Œstop the world worldStopped() } æ§åˆ¶æ ‡è®°åç¨‹é¢‘ç‡:\ngcStartæ–¹æ³•ä¸­ï¼Œè¿˜ä¼šé€šè¿‡gcController.startCycleæ–¹æ³•ï¼Œå°†æ ‡è®°åç¨‹å¯¹CPUçš„å ç”¨ç‡æ§åˆ¶åœ¨ 25% å·¦å³. æ­¤æ—¶ï¼Œæ ¹æ®Pçš„æ•°é‡æ˜¯å¦èƒ½è¢«4æ•´é™¤ï¼Œåˆ†ä¸ºä¸¤ç§å¤„ç†æ–¹å¼ï¼š\nå€˜è‹¥Pçš„ä¸ªæ•°èƒ½è¢«4æ•´é™¤ï¼Œåˆ™ç®€å•å°†æ ‡è®°åç¨‹çš„æ•°é‡è®¾ç½®ä¸ºP/4 å€˜è‹¥Pçš„ä¸ªæ•°ä¸èƒ½è¢«4æ•´é™¤ï¼Œåˆ™é€šè¿‡æ§åˆ¶æ ‡è®°åç¨‹æ‰§è¡Œæ—¶é•¿çš„æ–¹å¼ï¼Œæ¥ä½¿å…¨å±€æ ‡è®°åç¨‹å¯¹CPUçš„ä½¿ç”¨ç‡è¶‹è¿‘äº25% // ç›®æ ‡ï¼šæ ‡è®°åç¨‹å¯¹CPUçš„ä½¿ç”¨ç‡ç»´æŒåœ¨25%çš„æ°´å¹³ const gcBackgroundUtilization = 0.25 func (c *gcControllerState) startCycle(markStartTime int64, procs int, trigger gcTrigger) { // ... // P çš„ä¸ªæ•° * 0.25 totalUtilizationGoal := float64(procs) * gcBackgroundUtilization // P çš„ä¸ªæ•° * 0.25 åå››èˆäº”å…¥å–æ•´ c.dedicatedMarkWorkersNeeded = int64(totalUtilizationGoal + 0.5) utilError := float64(c.dedicatedMarkWorkersNeeded)/totalUtilizationGoal - 1 const maxUtilError = 0.3 // å€˜è‹¥ P çš„ä¸ªæ•°ä¸èƒ½è¢« 4 æ•´é™¤ if utilError \u003c -maxUtilError || utilError \u003e maxUtilError { if float64(c.dedicatedMarkWorkersNeeded) \u003e totalUtilizationGoal { c.dedicatedMarkWorkersNeeded-- } // è®¡ç®—å‡ºæ¯ä¸ª P éœ€è¦é¢å¤–æ‰§è¡Œæ ‡è®°ä»»åŠ¡çš„æ—¶é—´ç‰‡æ¯”ä¾‹ c.fractionalUtilizationGoal = (totalUtilizationGoal - float64(c.dedicatedMarkWorkersNeeded)) / float64(procs) // å€˜è‹¥ P çš„ä¸ªæ•°å¯ä»¥è¢« 4 æ•´é™¤ï¼Œåˆ™æ— éœ€æ§åˆ¶æ‰§è¡Œæ—¶é•¿ } else { c.fractionalUtilizationGoal = 0 } // ... } è®¾ç½®å†™å±éšœ:\ngcStartæ–¹æ³•ä¼šè°ƒç”¨setGCPhaseæ–¹æ³•ï¼Œæ ‡å¿—GCæ­£å¼è¿›å…¥å¹¶å‘æ ‡è®°ï¼ˆGCmarkï¼‰é˜¶æ®µ. æˆ‘ä»¬è§‚å¯Ÿè¯¥æ–¹æ³•ä»£ç å®ç°ï¼Œå¯ä»¥æ³¨æ„åˆ°ï¼Œåœ¨_GCMarkå’Œ_GCMarkTerminationé˜¶æ®µä¸­ï¼Œä¼šå¯ç”¨æ··åˆå†™å±éšœ.\nfunc setGCPhase(x uint32) { atomic.Store(\u0026gcphase, x) writeBarrier.needed = gcphase == _GCmark || gcphase == _GCmarktermination writeBarrier.enabled = writeBarrier.needed || writeBarrier.cgo } åœ¨æ··åˆå†™å±éšœæœºåˆ¶ä¸­ï¼Œæ ¸å¿ƒæ˜¯ä¼šå°†éœ€è¦ç½®ç°çš„å¯¹è±¡æ·»åŠ åˆ°å½“å‰Pçš„wbBufç¼“å­˜ä¸­. éšååœ¨å¹¶å‘æ ‡è®°ç¼ºç°ã€æ ‡è®°ç»ˆæ­¢å‰ç½®æ£€æŸ¥ç­‰æ—¶æœºä¼šæ‰§è¡ŒwbBufFlush1æ–¹æ³•ï¼Œæ‰¹é‡åœ°å°†wbBufä¸­çš„å¯¹è±¡é‡Šæ”¾å‡ºæ¥è¿›è¡Œç½®ç°ï¼Œä¿è¯è¾¾åˆ°é¢„æœŸçš„æ•ˆæœ.\n// src/runtime/mwbbuf.go:168 func wbBufFlush(dst *uintptr, src uintptr) { // ... systemstack(func() { wbBufFlush1(getg().m.p.ptr()) }) } wbBufFlush1æ–¹æ³•ä¸­æ¶‰åŠäº†å¯¹è±¡ç½®ç°æ“ä½œï¼Œå…¶åŒ…å«äº†åœ¨å¯¹åº”mspançš„bitmapä¸­æ‰“ç‚¹æ ‡è®°ä»¥åŠå°†å¯¹è±¡æ·»åŠ åˆ°gcwé˜Ÿåˆ—ä¸¤æ­¥.\nfunc wbBufFlush1(_p_ *p) { // è·å–å½“å‰ P é€šè¿‡å±éšœæœºåˆ¶ç¼“å­˜çš„æŒ‡é’ˆ start := uintptr(unsafe.Pointer(\u0026_p_.wbBuf.buf[0])) n := (_p_.wbBuf.next - start) / unsafe.Sizeof(_p_.wbBuf.buf[0]) ptrs := _p_.wbBuf.buf[:n] // å°†ç¼“å­˜çš„æŒ‡é’ˆä½œæ ‡è®°ï¼Œæ·»åŠ åˆ° gcw é˜Ÿåˆ— gcw := \u0026_p_.gcw pos := 0 for _, ptr := range ptrs { // ... obj, span, objIndex := findObject(ptr, 0, 0) if obj == 0 { continue } // æ‰“æ ‡ mbits := span.markBitsForIndex(objIndex) if mbits.isMarked() { continue } mbits.setMarked() // ... } // æ‰€æœ‰ç¼“å­˜å¯¹è±¡å…¥é˜Ÿ gcw.putBatch(ptrs[:pos]) _p_.wbBuf.reset() } tinyå¯¹è±¡æ ‡è®°:\ngcMarkTinyAllocsæ–¹æ³•ä¸­ï¼Œéå†æ‰€æœ‰çš„Pï¼Œå¯¹mcacheä¸­çš„Tinyå¯¹è±¡åˆ†åˆ«è°ƒç”¨greyobjectæ–¹æ³•è¿›è¡Œç½®ç°.\nfunc gcMarkTinyAllocs() { assertWorldStopped() for _, p := range allp { c := p.mcache if c == nil || c.tiny == 0 { continue } _, span, objIndex := findObject(c.tiny, 0, 0) gcw := \u0026p.gcw greyobject(c.tiny, 0, 0, span, gcw, objIndex) } } Start the world:\nå°†æ‰€æœ‰På”¤é†’. å€˜è‹¥ç¼ºå°‘Mï¼Œåˆ™æ„é€ æ–°çš„Mä¸ºPè¡¥é½.\nfunc startTheWorldWithSema(emitTraceEvent bool) int64 { assertWorldStopped() // ... p1 := procresize(procs) // é‡å¯ä¸–ç•Œ worldStarted() // éå†æ‰€æœ‰ pï¼Œå°†å…¶å”¤é†’ for p1 != nil { p := p1 p1 = p1.link.ptr() if p.m != 0 { mp := p.m.ptr() p.m = 0 if mp.nextp != 0 { throw(\"startTheWorld: inconsistent mp-\u003enextp\") } mp.nextp.set(p) notewakeup(\u0026mp.park) } else { newm(nil, p, -1) } } // ... return startTime } å¹¶å‘æ ‡è®° æ ‡è®°æ¸…æ‰« ","wordCount":"1331","inLanguage":"zh","datePublished":"2022-12-27T18:26:23+08:00","dateModified":"2022-12-27T18:26:23+08:00","author":[{"@type":"Person","name":"å£¹æ¬¡å¿ƒ"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.yici.xin/post/tech/golang%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6/"},"publisher":{"@type":"Organization","name":"yicixin's blog","logo":{"@type":"ImageObject","url":"https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.yici.xin/ accesskey=h title="ğŸ‘€ (Alt + H)">ğŸ‘€</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.yici.xin/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://www.yici.xin/post/>Posts</a>&nbsp;Â»&nbsp;<a href=https://www.yici.xin/post/tech/>ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div><h1 class=post-title>Golangå†…å­˜å›æ”¶</h1><div class=post-meta>&lt;span title='2022-12-27 18:26:23 +0800 +0800'>2022-12-27&lt;/span>&amp;nbsp;Â·&amp;nbsp;å£¹æ¬¡å¿ƒ&nbsp;|&nbsp;<a href=https://github.com/yicixin/blog/blob/main/content/post/tech/golang%e5%86%85%e5%ad%98%e5%9b%9e%e6%94%b6.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#gc%e6%ba%90%e7%a0%81%e5%88%86%e5%b8%83 aria-label=GCæºç åˆ†å¸ƒ:>GCæºç åˆ†å¸ƒ:</a></li><li><a href=#gc%e8%a7%a6%e5%8f%91%e9%93%be%e8%b7%af aria-label=GCè§¦å‘é“¾è·¯:>GCè§¦å‘é“¾è·¯:</a><ul><li><a href=#%e5%ae%9a%e6%97%b6%e8%a7%a6%e5%8f%91gc aria-label=å®šæ—¶è§¦å‘GC>å®šæ—¶è§¦å‘GC</a></li><li><a href=#%e5%af%b9%e8%b1%a1%e5%88%86%e9%85%8d%e8%a7%a6%e5%8f%91 aria-label=å¯¹è±¡åˆ†é…è§¦å‘>å¯¹è±¡åˆ†é…è§¦å‘</a></li><li><a href=#%e6%89%8b%e5%8a%a8%e8%a7%a6%e5%8f%91 aria-label=æ‰‹åŠ¨è§¦å‘>æ‰‹åŠ¨è§¦å‘</a></li></ul></li><li><a href=#gc%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b aria-label=GCæ‰§è¡Œæµç¨‹>GCæ‰§è¡Œæµç¨‹</a><ul><li><a href=#%e6%a0%87%e8%ae%b0%e5%87%86%e5%a4%87 aria-label=æ ‡è®°å‡†å¤‡>æ ‡è®°å‡†å¤‡</a></li><li><a href=#%e5%b9%b6%e5%8f%91%e6%a0%87%e8%ae%b0 aria-label=å¹¶å‘æ ‡è®°>å¹¶å‘æ ‡è®°</a></li><li><a href=#%e6%a0%87%e8%ae%b0%e6%b8%85%e6%89%ab aria-label=æ ‡è®°æ¸…æ‰«>æ ‡è®°æ¸…æ‰«</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=gcæºç åˆ†å¸ƒ>GCæºç åˆ†å¸ƒ:<a hidden class=anchor aria-hidden=true href=#gcæºç åˆ†å¸ƒ>#</a></h2><table><thead><tr><th style=text-align:center><strong>æµç¨‹</strong></th><th style=text-align:center><strong>æ–‡ä»¶</strong></th></tr></thead><tbody><tr><td style=text-align:center>æ ‡è®°å‡†å¤‡</td><td style=text-align:center>runtime/mgc.go</td></tr><tr><td style=text-align:center>è°ƒæ­¥ç­–ç•¥</td><td style=text-align:center>runtime/mgcpacer.go</td></tr><tr><td style=text-align:center>å¹¶å‘æ ‡è®°</td><td style=text-align:center>runtime/mgcmark.go</td></tr><tr><td style=text-align:center>æ¸…æ‰«æµç¨‹</td><td style=text-align:center>runtime/msweep.go</td></tr><tr><td style=text-align:center>ä½å›¾æ ‡è¯†</td><td style=text-align:center>runtime/mbitmap.go</td></tr><tr><td style=text-align:center>è§¦å‘å±éšœ</td><td style=text-align:center>runtime/mbwbuf.go</td></tr><tr><td style=text-align:center>å†…å­˜å›æ”¶</td><td style=text-align:center>runtime/mgcscavenge.go</td></tr></tbody></table><h2 id=gcè§¦å‘é“¾è·¯>GCè§¦å‘é“¾è·¯:<a hidden class=anchor aria-hidden=true href=#gcè§¦å‘é“¾è·¯>#</a></h2><p>è§¦å‘ GC çš„äº‹ä»¶ç±»å‹å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§ï¼š</p><table><thead><tr><th style=text-align:center><strong>ç±»å‹</strong></th><th style=text-align:center><strong>è§¦å‘äº‹ä»¶</strong></th><th style=text-align:center><strong>æ ¡éªŒæ¡ä»¶</strong></th></tr></thead><tbody><tr><td style=text-align:center>gcTriggerHeap</td><td style=text-align:center>åˆ†é…å¯¹è±¡æ—¶è§¦å‘</td><td style=text-align:center>å †å·²åˆ†é…å†…å­˜è¾¾åˆ°é˜ˆå€¼</td></tr><tr><td style=text-align:center>gcTriggerTime</td><td style=text-align:center>ç”± forcegchelper å®ˆæŠ¤åç¨‹å®šæ—¶è§¦å‘</td><td style=text-align:center>æ¯2åˆ†é’Ÿè§¦å‘ä¸€æ¬¡</td></tr><tr><td style=text-align:center>gcTriggerCycle</td><td style=text-align:center>ç”¨æˆ·è°ƒç”¨ runtime.GC æ–¹æ³•</td><td style=text-align:center>ä¸Šä¸€è½® GC å·²ç»“æŸ</td></tr></tbody></table><p>è§¦å‘ç±»å‹çš„æºç :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>gcTriggerKind</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å †è§¦å‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gcTriggerHeap</span> <span style=color:#a6e22e>gcTriggerKind</span> = <span style=color:#66d9ef>iota</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å®šæ—¶è§¦å‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gcTriggerTime</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ‰‹åŠ¨è§¦å‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gcTriggerCycle</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è¿›è¡Œè§¦å‘æ¡ä»¶çš„æ ¡éªŒ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#a6e22e>gcTrigger</span>) <span style=color:#a6e22e>test</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>memstats</span>.<span style=color:#a6e22e>enablegc</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>panicking</span>.<span style=color:#a6e22e>Load</span>() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>gcphase</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>_GCoff</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>kind</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>gcTriggerHeap</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è§¦å‘å †å¤§å°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>trigger</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>trigger</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¯”è¾ƒå¤§å°æ˜¯å¦æ»¡è¶³
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>heapLive</span>.<span style=color:#a6e22e>Load</span>() <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>trigger</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>gcTriggerTime</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e>// gcController.gcPercent &lt; 0 è¡¨ç¤ºä¸è¿›è¡ŒGC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>gcPercent</span>.<span style=color:#a6e22e>Load</span>() &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¸Šæ¬¡gcæ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>lastgc</span> <span style=color:#f92672>:=</span> int64(<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>memstats</span>.<span style=color:#a6e22e>last_gc_nanotime</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>lastgc</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>now</span><span style=color:#f92672>-</span><span style=color:#a6e22e>lastgc</span> &gt; <span style=color:#a6e22e>forcegcperiod</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>gcTriggerCycle</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// t.n &gt; work.cycles, but accounting for wraparound.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> int32(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>n</span><span style=color:#f92672>-</span><span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>cycles</span>.<span style=color:#a6e22e>Load</span>()) &gt; <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=å®šæ—¶è§¦å‘gc>å®šæ—¶è§¦å‘GC<a hidden class=anchor aria-hidden=true href=#å®šæ—¶è§¦å‘gc>#</a></h3><!doctype html><html lang=en><head><style type=text/css>#chart{padding-bottom:66%;position:relative;display:block;width:100%;border-bottom:5px solid}#chart iframe{position:absolute;top:0;left:0}</style><title></title></head><body><div id=chart><iframe id=embed_dom width=100% height=100% name=embed_dom frameborder=0 src="https://viewer.diagrams.net/?tags=%7B%7D&amp;highlight=0000ff&amp;edit=_blank&amp;layers=1&amp;nav=1&amp;title=golang-%E5%AE%9A%E6%97%B6gc%E8%A7%A6%E5%8F%91%E8%B7%AF%E5%BE%84.drawio#R7Zhbl5owEMc%2FjY%2FbI0G5vNa19qHtOXvsZX2MMEB2A2NDUOmnb5CwQHHV9qirnj7J%2FDO5zeQ3AXvmKF5PBF1En9EH3iN9f90z73uEGGRgqJ9CyUvFce1SCAXztVMtTNkv0GJfqxnzIW05SkQu2aItepgk4MmWRoXAVdstQN6edUFD6AhTj%2FKu%2BoP5MtK7IHatfwQWRtXMhuWWLTGtnPVO0oj6uGpI5rhnjgSiLJ%2Fi9Qh4EbwqLmW%2FD6%2B0vixMQCIP6XD38O0L%2ByoI2N9n9KfxkE2EdWfqtcm82jD4av%2FaRCEjDDGhfFyr7wVmiQ%2FFqH1l1T6fEBdKNJT4BFLmOpk0k6ikSMZct8KaycfG86wY6t1QW%2FdrPfLGyCsjkSJ%2FbBqNXoVZd9tYVb8AE6kXUoS8tPX2toRQSylmwoMdcauOIhUhyB1%2BpPQrgtqYQCdoAhiDWqxyEMCpZMv2oaP67IYvfnV61YPO8F9kW4%2B7pDzTM7GEyc4RqBNcZGgVMQnTBd3EY6UobyezE2DG%2BQg5is1Ypk%2FBCTylp1LgMzRaLM%2BBeaBaXs3CEoSE9c646VZTQ5dXxUMzt6qRdbUUNWi1%2BqcKtNEJ6o1z9e8okQNRqm6EC2GJdFgKUG009CLgCxA3ABUx9lNl2OfEatCJeehN1cE5cQkbguMPtkXbIXPTso4Tbcu9sBpm%2Fy9hh5aw4YElzLqoCjbs0BRTlpwUpSAAy9tauHzbnff7J3kbIPYbk%2BReC0nHI8I6kAjnooiwOkSkeRrjLTDx52X%2B5lAYV%2FjpWV8ps2qMs9wvznW%2BIjsdnFjyBJ4MOUtP%2B8p2pnvG2c%2BUQc4KFbkWqI4HR3Xo99IxuCg4qmU3P2ZQ7f%2F5pGCc58tx4JztW0aZ9V%2Bom7bGH9Hm%2BDc%3D"></iframe></div></body></html><br><table><thead><tr><th style=text-align:center><strong>æ–¹æ³•</strong></th><th style=text-align:center><strong>æ–‡ä»¶</strong></th><th style=text-align:center><strong>ä½œç”¨</strong></th></tr></thead><tbody><tr><td style=text-align:center>init</td><td style=text-align:center>runtime/proc.go</td><td style=text-align:center>å¼€å¯ä¸€ä¸ª forcegchelper åç¨‹</td></tr><tr><td style=text-align:center>forcegchelper</td><td style=text-align:center>runtime/proc.go</td><td style=text-align:center>å¾ªç¯é˜»å¡æŒ‚èµ·+å®šæ—¶è§¦å‘ gc</td></tr><tr><td style=text-align:center>main</td><td style=text-align:center>runtime/proc.go</td><td style=text-align:center>è°ƒç”¨ sysmon æ–¹æ³•</td></tr><tr><td style=text-align:center>sysmon</td><td style=text-align:center>runtime/proc.go</td><td style=text-align:center>å®šæ—¶å”¤é†’ forcegchelperï¼Œä»è€Œè§¦å‘ gc</td></tr><tr><td style=text-align:center>gcTrigger.test</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>æ ¡éªŒæ˜¯å¦æ»¡è¶³ gc è§¦å‘æ¡ä»¶</td></tr><tr><td style=text-align:center>gcStart</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>æ ‡è®°å‡†å¤‡é˜¶æ®µä¸»æµç¨‹æ–¹æ³•</td></tr></tbody></table><p>init + forcegchelper</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// start forcegc helper goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>forcegchelper</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// runtime åŒ…ä¸‹çš„å…¨å±€å˜é‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span>  <span style=color:#a6e22e>forcegc</span>   <span style=color:#a6e22e>forcegcstate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>forcegcstate</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lock</span> <span style=color:#a6e22e>mutex</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>idle</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Bool</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>forcegchelper</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è·å–å½“å‰g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆå§‹åŒ–é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lockInit</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>lockRankForcegc</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>idle</span>.<span style=color:#a6e22e>Load</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;forcegc: phase error&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>idle</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å°†å½“å‰ goroutine ç½®äºç­‰å¾…çŠ¶æ€å¹¶è§£é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>goparkunlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>waitReasonForceGCIdle</span>, <span style=color:#a6e22e>traceEvGoBlock</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// this goroutine is explicitly resumed by sysmon
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debug</span>.<span style=color:#a6e22e>gctrace</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			println(<span style=color:#e6db74>&#34;GC forced&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Time-triggered, fully concurrent.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// è¢«å”¤é†’åæ‰§è¡ŒgcStartï¼Œè¿›å…¥æ ‡è®°å‡†å¤‡é˜¶æ®µï¼Œè§¦å‘ç±»å‹å³å®šæ—¶è§¦å‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>gcStart</span>(<span style=color:#a6e22e>gcTrigger</span>{<span style=color:#a6e22e>kind</span>: <span style=color:#a6e22e>gcTriggerTime</span>, <span style=color:#a6e22e>now</span>: <span style=color:#a6e22e>nanotime</span>()})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å”¤é†’forcegchelperçš„åœ°æ–¹åœ¨proc.goçš„mainå‡½æ•°ä¸­:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// The main goroutine.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  	<span style=color:#75715e>// é€šè¿‡ systemstack æ“ä½œåˆ‡æ¢è‡³ g0ï¼Œå¹¶è°ƒç”¨ sysmon æ–¹æ³•ï¼Œè½®è¯¢å°è¯•å°† forcegchelper åç¨‹æ·»åŠ åˆ° gList ä¸­ï¼Œå¹¶åœ¨ injectglist æ–¹æ³•å†…å°†å…¶å”¤é†’
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>newm</span>(<span style=color:#a6e22e>sysmon</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sysmon</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> { 
</span></span><span style=display:flex><span>        <span style=color:#75715e>// é€šè¿‡ gcTrigger.test æ–¹æ³•æ£€æŸ¥æ˜¯å¦éœ€è¦å‘èµ· gcï¼Œè§¦å‘ç±»å‹ä¸º gcTriggerTimeï¼šå®šæ—¶è§¦å‘
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> (<span style=color:#a6e22e>gcTrigger</span>{<span style=color:#a6e22e>kind</span>: <span style=color:#a6e22e>gcTriggerTime</span>, <span style=color:#a6e22e>now</span>: <span style=color:#a6e22e>now</span>}); <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>test</span>() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>idle</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {     
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>idle</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>list</span> <span style=color:#a6e22e>gList</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// éœ€è¦å‘èµ· gcï¼Œåˆ™å°† forcegc.g æ³¨å…¥ list ä¸­, injectglist æ–¹æ³•å†…éƒ¨ä¼šæ‰§è¡Œå”¤é†’æ“ä½œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>list</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>g</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>injectglist</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>list</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=å¯¹è±¡åˆ†é…è§¦å‘>å¯¹è±¡åˆ†é…è§¦å‘<a hidden class=anchor aria-hidden=true href=#å¯¹è±¡åˆ†é…è§¦å‘>#</a></h3><!doctype html><html lang=en><head><style type=text/css>#chart{padding-bottom:66%;position:relative;display:block;width:100%;border-bottom:5px solid}#chart iframe{position:absolute;top:0;left:0}</style><title></title></head><body><div id=chart><iframe id=embed_dom width=100% height=100% name=embed_dom frameborder=0 src="https://viewer.diagrams.net/?tags=%7B%7D&amp;highlight=0000ff&amp;edit=_blank&amp;layers=1&amp;nav=1&amp;title=golang-gc%E5%AF%B9%E8%B1%A1%E5%88%86%E9%85%8D%E8%A7%A6%E5%8F%91%E8%B7%AF%E5%BE%84.drawio#R5VfbjpswEP0aHrsCHAw85tbdh1ZqlW277ZsDEyA1mcg4t%2F36GjC3kqRZbdKqrRQRz%2FGMmZnjY8Ag43R%2FL9g6fo8hcMM2w71BJoZtW%2FbAUn85cigRz3dLIBJJqJ0aYJY8gwZNjW6SELKOo0TkMll3wQBXKwhkB2NC4K7rtkDeveuaRdADZgHjffRLEspYV2G7Df4ASRRXd7aoX86krHLWlWQxC3HXgsjUIGOBKMtRuh8Dz5tX9aWMe3titk5MwEpeEiCe78nHz5%2B%2BLbNwO18%2BiEfPJm9snZs8VAVDqOrXJgoZY4QrxqcNOhK4WYWQr2oqq%2FF5h7hWoKXAJUh50GSyjUQFxTLlehb2iXxqjb%2FmS9052prs9cqFcdBGmWee3MnyNZThRgRwpuZqGzERgTzjR2qS1O4GTEGKg4oTwJlMtt08mN5mUe1Xh37ARGVom1oS9X7QgiDE6S5R5qWjGj7VoJVGAxUsv4BxnfCW8Y0uIWWcYxAFva3QEJ0ztYsTCbM1K3q7U2rvkrrAldSM57WPFgnnY%2BQoirVIyMBbBArPpMDv0JqhgQfzRU3xFoSE%2FXmS%2B6TogMFPvTV1b3eNdK2q%2F3FLttQ8TWOHgJd22%2FkP9UUu1Nfglfp6FTGkJ4MoeBRJFIG4k5DJf0AM9TP0nBro71SD%2B7eoQXVYHJ7aRisqN5uwwrqBigYXqoj%2BSRUNeioypo4xNA2P5gN19ZwCmRi%2BVyBeMeXnuDfRyMg0puo6zX9qSr0hDpUzNYau4Y%2F6QowxnW%2ByC0TYFR1YoQPuMdH51CWMdmVrOVd6IpGuCG3f7IvQPSJC%2F1YipEdOvpnaZjc%2B8hzwwsGx7nv2nFB6nW5T99dHnn%2BdE0%2BZzbt7%2BXLWfAGR6Q8%3D"></iframe></div></body></html><br><table><thead><tr><th style=text-align:center><strong>æ–¹æ³•</strong></th><th style=text-align:center><strong>æ–‡ä»¶</strong></th><th style=text-align:center><strong>ä½œç”¨</strong></th></tr></thead><tbody><tr><td style=text-align:center>mallocgc</td><td style=text-align:center>runtime/malloc.go</td><td style=text-align:center>åˆ†é…å¯¹è±¡ä¸»æµç¨‹æ–¹æ³•</td></tr><tr><td style=text-align:center>gcTrigger.test</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>æ ¡éªŒæ˜¯å¦æ»¡è¶³ gc è§¦å‘æ¡ä»¶</td></tr><tr><td style=text-align:center>gcStart</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>æ ‡è®°å‡†å¤‡é˜¶æ®µä¸»æµç¨‹æ–¹æ³•</td></tr></tbody></table><p>åœ¨åˆ†é…å¯¹è±¡çš„mallocæ–¹æ³•ä¸­ï¼Œå€˜è‹¥æ»¡è¶³å¦‚ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€ï¼Œéƒ½ä¼šå‘èµ·ä¸€æ¬¡è§¦å‘GCçš„å°è¯•ï¼š</p><ul><li>éœ€è¦åˆå§‹åŒ–ä¸€ä¸ªå¤§å°è¶…è¿‡32KBçš„å¤§å¯¹è±¡</li><li>å¾…åˆå§‹åŒ–å¯¹è±¡åœ¨mcacheä¸­å¯¹åº”spanClassçš„mspanç©ºé—´å·²ç”¨å°½</li></ul><p>å¯¹è±¡åˆ†é…:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mallocgc</span>(<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>typ</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>_type</span>, <span style=color:#a6e22e>needzero</span> <span style=color:#66d9ef>bool</span>) <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  	<span style=color:#75715e>// æ ‡å¿—æ˜¯å¦éœ€è¦è§¦å‘gc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>shouldhelpgc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>maxSmallSize</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>noscan</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>size</span> &lt; <span style=color:#a6e22e>maxTinySize</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// å€˜è‹¥ mcache ä¸­å¯¹åº” spanClass çš„ mspan å·²æ»¡ï¼Œç½® true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>shouldhelpgc</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nextFree</span>(<span style=color:#a6e22e>tinySpanClass</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// å€˜è‹¥ mcache ä¸­å¯¹åº” spanClass çš„ mspan å·²æ»¡ï¼Œç½® true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>shouldhelpgc</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nextFree</span>(<span style=color:#a6e22e>spc</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç”³è¯·å¤§å°å¤§äº 32KB çš„å¤§å¯¹è±¡ï¼Œç›´æ¥ç½®ä¸º true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>shouldhelpgc</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// å°è¯•è§¦å‘ gcï¼Œç±»å‹ä¸º gcTriggerHeap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>shouldhelpgc</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> (<span style=color:#a6e22e>gcTrigger</span>{<span style=color:#a6e22e>kind</span>: <span style=color:#a6e22e>gcTriggerHeap</span>}); <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>test</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>gcStart</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h3 id=æ‰‹åŠ¨è§¦å‘>æ‰‹åŠ¨è§¦å‘<a hidden class=anchor aria-hidden=true href=#æ‰‹åŠ¨è§¦å‘>#</a></h3><table><thead><tr><th style=text-align:center><strong>æ–¹æ³•</strong></th><th style=text-align:center><strong>æ–‡ä»¶</strong></th><th style=text-align:center><strong>ä½œç”¨</strong></th></tr></thead><tbody><tr><td style=text-align:center>GC</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>æ‰‹åŠ¨è§¦å‘GCä¸»æµç¨‹æ–¹æ³•</td></tr><tr><td style=text-align:center>gcStart</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>æ ‡è®°å‡†å¤‡é˜¶æ®µä¸»æµç¨‹æ–¹æ³•</td></tr></tbody></table><p>æœ€åä¸€ç§è§¦å‘çš„GCå½¢å¼æ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œå…¥å£ä½äº runtime åŒ…çš„å…¬å…±æ–¹æ³•ï¼šruntime.GCï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GC</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  	<span style=color:#75715e>// è§¦å‘gcï¼Œç±»å‹ä¸ºæ‰‹åŠ¨è§¦å‘ï¼Œé’ˆå¯¹è¿™ç§ç±»å‹çš„æ ¡éªŒæ¡ä»¶æ˜¯ï¼Œä¸Šä¸€è½®GCå·²ç»å®Œæˆï¼Œæ­¤æ—¶èƒ½å¤Ÿå¼€å¯æ–°ä¸€è½®GCä»»åŠ¡.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>gcStart</span>(<span style=color:#a6e22e>gcTrigger</span>{<span style=color:#a6e22e>kind</span>: <span style=color:#a6e22e>gcTriggerCycle</span>, <span style=color:#a6e22e>n</span>: <span style=color:#a6e22e>n</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>})
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=gcæ‰§è¡Œæµç¨‹>GCæ‰§è¡Œæµç¨‹<a hidden class=anchor aria-hidden=true href=#gcæ‰§è¡Œæµç¨‹>#</a></h2><h3 id=æ ‡è®°å‡†å¤‡>æ ‡è®°å‡†å¤‡<a hidden class=anchor aria-hidden=true href=#æ ‡è®°å‡†å¤‡>#</a></h3><table><thead><tr><th style=text-align:center><strong>æ–¹æ³•</strong></th><th style=text-align:center><strong>æ–‡ä»¶</strong></th><th style=text-align:center><strong>ä½œç”¨</strong></th></tr></thead><tbody><tr><td style=text-align:center>gcStart</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>æ ‡è®°å‡†å¤‡é˜¶æ®µä¸»æµç¨‹æ–¹æ³•</td></tr><tr><td style=text-align:center>gcBgMarkStartWorkers</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>æ‰¹é‡å¯åŠ¨æ ‡è®°åç¨‹ ï¼Œæ•°é‡å¯¹åº”äº P çš„ä¸ªæ•°</td></tr><tr><td style=text-align:center>gcBgMarkWorker</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>æ ‡è®°åç¨‹ä¸»æµç¨‹æ–¹æ³•ï¼Œå¯åŠ¨ä¹‹åˆä¼šå…ˆé˜»å¡æŒ‚èµ·ï¼Œå¾…è¢«å”¤é†’åçœŸæ­£æ‰§è¡Œä»»åŠ¡</td></tr><tr><td style=text-align:center>stopTheWorldWithSema</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>å³STWï¼Œåœæ­¢P.</td></tr><tr><td style=text-align:center>gcControllerState.startCycle</td><td style=text-align:center>runtime/mgcspacer.go</td><td style=text-align:center>é™åˆ¶æ ‡è®°åç¨‹æ‰§è¡Œé¢‘ç‡ï¼Œç›®æ ‡æ˜¯ä»¤æ ‡è®°åç¨‹å¯¹CPUçš„å ç”¨ç‡è¶‹è¿‘äº 25%</td></tr><tr><td style=text-align:center>setGCPhase</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>æ›´æ–°GCé˜¶æ®µ. å½“ä¸ºæ ‡è®°é˜¶æ®µï¼ˆGCMarkï¼‰æ—¶ä¼šå¯ç”¨æ··åˆå†™å±éšœ</td></tr><tr><td style=text-align:center>gcMarkTinyAllocs</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>æ ‡è®° mcache ä¸­çš„ tiny å¯¹è±¡</td></tr><tr><td style=text-align:center>startTheWorldWithSema</td><td style=text-align:center>runtime/mgc.go</td><td style=text-align:center>ä¸STWç›¸åï¼Œä¼šé‡æ–°å”¤é†’å„ä¸ªP</td></tr></tbody></table><p>ä¸»æµç¨‹-gcStartï¼š</p><ul><li>å†æ¬¡æ£€æŸ¥GCè§¦å‘æ¡ä»¶æ˜¯å¦è¾¾æˆ</li><li>å¼‚æ­¥å¯åŠ¨å¯¹åº”äºPæ•°é‡çš„æ ‡è®°åç¨‹</li><li>Stop the world</li><li>æ§åˆ¶æ ‡è®°åç¨‹æ•°é‡å’Œæ‰§è¡Œæ—¶é•¿ï¼Œä½¿å¾—CPUå ç”¨ç‡è¶‹è¿‘25%</li><li>è®¾ç½®GCé˜¶æ®µä¸ºGCMarkï¼Œå¼€å¯æ··åˆæ··åˆå†™å±éšœ</li><li>æ ‡è®°mcacheä¸­çš„tinyå¯¹è±¡</li><li>Start the world</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcStart</span>(<span style=color:#a6e22e>trigger</span> <span style=color:#a6e22e>gcTrigger</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ç”±äºè¿™æ˜¯ä» malloc è°ƒç”¨çš„ï¼Œå¹¶ä¸” malloc æ˜¯åœ¨è®¸å¤šå¯èƒ½æŒæœ‰é”çš„åº“çš„å†…éƒ¨è°ƒç”¨çš„ï¼Œæ‰€ä»¥ä¸è¦å°è¯•åœ¨ä¸å¯æŠ¢å æˆ–å¯èƒ½ä¸ç¨³å®šçš„æƒ…å†µä¸‹å¯åŠ¨ GCã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>mp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acquirem</span>()
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ä¸æ»¡è¶³çš„æƒ…å†µç›´æ¥return
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>(); <span style=color:#a6e22e>gp</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>g0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>locks</span> &gt; <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>preemptoff</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>mp</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>mp</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mp</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// æ£€æŸ¥gcæ¡ä»¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>trigger</span>.<span style=color:#a6e22e>test</span>() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>sweepone</span>() <span style=color:#f92672>!=</span> ^uintptr(<span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>nbgsweep</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ä¸Šé”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>semacquire</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>startSema</span>)
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åŠ é” double check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>trigger</span>.<span style=color:#a6e22e>test</span>() {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>semrelease</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>startSema</span>)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// è¿›å…¥äº† GC æ¨¡å¼ï¼Œä¼šæ ¹æ® P çš„æ•°é‡å¯åŠ¨å¤šä¸ª GC å¹¶å‘æ ‡è®°åç¨‹ï¼Œä½†æ˜¯ä¼šå…ˆé˜»å¡æŒ‚èµ·ï¼Œç­‰å¾…è¢«å”¤é†’ï¼Œåœ¨æ ‡è®°é˜¶æ®µæ‰å¼€å§‹æ‰§è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>gcBgMarkStartWorkers</span>()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// åˆ‡æ¢åˆ° g0ï¼Œæ‰§è¡Œ Stop the world æ“ä½œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>systemstack</span>(<span style=color:#a6e22e>stopTheWorldWithSema</span>)
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// é™åˆ¶æ ‡è®°åç¨‹å ç”¨ CPU æ—¶é—´ç‰‡çš„æ¯”ä¾‹ä¸ºè¶‹è¿‘ 25%
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>startCycle</span>(<span style=color:#a6e22e>now</span>, int(<span style=color:#a6e22e>gomaxprocs</span>), <span style=color:#a6e22e>trigger</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è®¾ç½®GCé˜¶æ®µä¸º_GCmarkï¼Œå¯ç”¨æ··åˆå†™å±éšœ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>setGCPhase</span>(<span style=color:#a6e22e>_GCmark</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// å¯¹ mcache ä¸­çš„ tiny å¯¹è±¡è¿›è¡Œæ ‡è®°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>gcMarkTinyAllocs</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// åˆ‡æ¢è‡³ g0ï¼Œé‡æ–° start the world
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>now</span> = <span style=color:#a6e22e>startTheWorldWithSema</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span>)
</span></span><span style=display:flex><span>     <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  })
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>gcBgMarkStartWorkers-å¼‚æ­¥å¯åŠ¨æ ‡è®°åç¨‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>gcBgMarkWorkerCount</span> <span style=color:#66d9ef>int32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcBgMarkStartWorkers</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Background marking is performed by per-P G&#39;s. Ensure that each P has
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// a background GC G.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Worker Gs don&#39;t exit if gomaxprocs is reduced. If it is raised
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// again, we can reuse the old workers; no need to create new workers.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// è¿™äº›WorkerGä¸ä¼šéšç€Pçš„æ•°é‡å‡å°‘è€Œé€€å‡ºï¼Œè¿™æ ·çš„è¯ï¼Œå¦‚æœè¦æ±‚çš„æ•°é‡é‡æ–°ä¸Šè°ƒï¼Œå¯ä»¥é‡ç”¨æ—§çš„è€Œä¸ç”¨åˆ›å»ºæ–°çš„worker
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>gcBgMarkWorkerCount</span> &lt; <span style=color:#a6e22e>gomaxprocs</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>gcBgMarkWorker</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>notetsleepg</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>bgMarkReady</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>noteclear</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>bgMarkReady</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// The worker is now guaranteed to be added to the pool before
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// its P&#39;s next findRunnableGCWorker.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gcBgMarkWorkerCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// gcBgMarkWorker æ–¹æ³•ä¸­å°†gåŒ…è£…æˆä¸€ä¸ªnodeæ·»åŠ åˆ°å…¨å±€çš„gcBgMarkWorkerPoolä¸­ï¼Œä¿è¯æ ‡è®°åç¨‹ä¸Pçš„ä¸€å¯¹ä¸€å…³è”ï¼Œå¹¶è°ƒç”¨ gopark æ–¹æ³•å°†å½“å‰ g æŒ‚èµ·ï¼Œç­‰å¾…è¢«å”¤é†’.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcBgMarkWorker</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>gcBgMarkWorkerNode</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>preemptoff</span> = <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>gp</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>acquirem</span>())
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å”¤é†’å¤–éƒ¨çš„ for å¾ªç¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>notewakeup</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>bgMarkReady</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å½“å‰ g é˜»å¡è‡³æ­¤ï¼Œç›´åˆ° gcController.findRunnableGCWorker æ–¹æ³•è¢«è°ƒç”¨ï¼Œä¼šå°†å½“å‰ g å”¤é†’
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>gopark</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>nodep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>gcBgMarkWorkerNode</span>)(<span style=color:#a6e22e>nodep</span>)
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// å°†å½“å‰ g åŒ…è£…æˆä¸€ä¸ª node æ·»åŠ åˆ° gcBgMarkWorkerPool ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>gcBgMarkWorkerPool</span>.<span style=color:#a6e22e>push</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>node</span>)          
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        }, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>node</span>), <span style=color:#a6e22e>waitReasonGCWorkerIdle</span>, <span style=color:#a6e22e>traceEvGoBlock</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Stop-the-world:</p><p>gcStart æ–¹æ³•åœ¨è°ƒç”¨gcBgMarkStartWorkersæ–¹æ³•å¼‚æ­¥å¯åŠ¨æ ‡è®°åç¨‹åï¼Œä¼šæ‰§è¡ŒSTWæ“ä½œåœæ­¢æ‰€æœ‰ç”¨æˆ·åç¨‹ï¼Œå…¶å®ç°ä½äº stopTheWorldWithSema æ–¹æ³•ï¼Œæ ¸å¿ƒç‚¹å¦‚ä¸‹ï¼š</p><ul><li>å–é”ï¼šsched.lock</li><li>å°† sched.gcwaiting æ ‡è¯†ç½®ä¸º 1ï¼Œåç»­çš„è°ƒåº¦æµç¨‹è§å…¶æ ‡è¯†ï¼Œéƒ½ä¼šé˜»å¡æŒ‚èµ·</li><li>æŠ¢å æ‰€æœ‰gï¼Œå¹¶å°† P çš„çŠ¶æ€ç½®ä¸º syscall</li><li>å°†æ‰€æœ‰Pçš„çŠ¶æ€æ”¹ä¸º stop</li><li>å€˜è‹¥éƒ¨åˆ†ä»»åŠ¡æ— æ³•æŠ¢å ï¼Œåˆ™ç­‰å¾…å…¶å®Œæˆåå†è¿›è¡ŒæŠ¢å </li><li>è°ƒç”¨æ–¹æ³•worldStoppedæ”¶å°¾ï¼Œä¸–ç•Œåœæ­¢äº†</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>stopTheWorldWithSema</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å…¨å±€è°ƒåº¦é”
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopwait</span> = <span style=color:#a6e22e>gomaxprocs</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ­¤æ ‡è¯†ç½® 1ï¼Œä¹‹åæ‰€æœ‰çš„è°ƒåº¦éƒ½ä¼šé˜»å¡ç­‰å¾…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>gcwaiting</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‘é€æŠ¢å ä¿¡æ¯æŠ¢å æ‰€æœ‰ Gï¼Œåå°† p çŠ¶æ€ç½®ä¸º syscall
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>preemptall</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å°†å½“å‰ p çš„çŠ¶æ€ç½®ä¸º stop
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>status</span> = <span style=color:#a6e22e>_Pgcstop</span> <span style=color:#75715e>// Pgcstop is only diagnostic.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopwait</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æŠŠæ‰€æœ‰ p çš„çŠ¶æ€ç½®ä¸º stop
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allp</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>status</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>_Psyscall</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Cas</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>status</span>, <span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>_Pgcstop</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>syscalltick</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopwait</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æŠŠç©ºé—² p çš„çŠ¶æ€ç½®ä¸º stop
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nanotime</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pidleget</span>(<span style=color:#a6e22e>now</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>status</span> = <span style=color:#a6e22e>_Pgcstop</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopwait</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wait</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopwait</span> &gt; <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å€˜è‹¥æœ‰ p æ— æ³•è¢«æŠ¢å ï¼Œåˆ™é˜»å¡ç›´åˆ°å°†å…¶ç»Ÿç»ŸæŠ¢å å®Œæˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>wait</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// wait for 100us, then try to re-preempt in case of any races
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>notetsleep</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopnote</span>, <span style=color:#ae81ff>100</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1000</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>noteclear</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopnote</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>preemptall</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// native æ–¹æ³•ï¼Œstop the world
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>worldStopped</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ§åˆ¶æ ‡è®°åç¨‹é¢‘ç‡:</p><p>gcStartæ–¹æ³•ä¸­ï¼Œè¿˜ä¼šé€šè¿‡gcController.startCycleæ–¹æ³•ï¼Œå°†æ ‡è®°åç¨‹å¯¹CPUçš„å ç”¨ç‡æ§åˆ¶åœ¨ 25% å·¦å³. æ­¤æ—¶ï¼Œæ ¹æ®Pçš„æ•°é‡æ˜¯å¦èƒ½è¢«4æ•´é™¤ï¼Œåˆ†ä¸ºä¸¤ç§å¤„ç†æ–¹å¼ï¼š</p><ul><li>å€˜è‹¥Pçš„ä¸ªæ•°èƒ½è¢«4æ•´é™¤ï¼Œåˆ™ç®€å•å°†æ ‡è®°åç¨‹çš„æ•°é‡è®¾ç½®ä¸ºP/4</li><li>å€˜è‹¥Pçš„ä¸ªæ•°ä¸èƒ½è¢«4æ•´é™¤ï¼Œåˆ™é€šè¿‡æ§åˆ¶æ ‡è®°åç¨‹æ‰§è¡Œæ—¶é•¿çš„æ–¹å¼ï¼Œæ¥ä½¿å…¨å±€æ ‡è®°åç¨‹å¯¹CPUçš„ä½¿ç”¨ç‡è¶‹è¿‘äº25%</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// ç›®æ ‡ï¼šæ ‡è®°åç¨‹å¯¹CPUçš„ä½¿ç”¨ç‡ç»´æŒåœ¨25%çš„æ°´å¹³
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>gcBackgroundUtilization</span> = <span style=color:#ae81ff>0.25</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gcControllerState</span>) <span style=color:#a6e22e>startCycle</span>(<span style=color:#a6e22e>markStartTime</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>procs</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>trigger</span> <span style=color:#a6e22e>gcTrigger</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// P çš„ä¸ªæ•° * 0.25
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>totalUtilizationGoal</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>procs</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>gcBackgroundUtilization</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// P çš„ä¸ªæ•° * 0.25 åå››èˆäº”å…¥å–æ•´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dedicatedMarkWorkersNeeded</span> = int64(<span style=color:#a6e22e>totalUtilizationGoal</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.5</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>utilError</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dedicatedMarkWorkersNeeded</span>)<span style=color:#f92672>/</span><span style=color:#a6e22e>totalUtilizationGoal</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>maxUtilError</span> = <span style=color:#ae81ff>0.3</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å€˜è‹¥ P çš„ä¸ªæ•°ä¸èƒ½è¢« 4 æ•´é™¤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>utilError</span> &lt; <span style=color:#f92672>-</span><span style=color:#a6e22e>maxUtilError</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>utilError</span> &gt; <span style=color:#a6e22e>maxUtilError</span> {        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> float64(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dedicatedMarkWorkersNeeded</span>) &gt; <span style=color:#a6e22e>totalUtilizationGoal</span> {    
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dedicatedMarkWorkersNeeded</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è®¡ç®—å‡ºæ¯ä¸ª P éœ€è¦é¢å¤–æ‰§è¡Œæ ‡è®°ä»»åŠ¡çš„æ—¶é—´ç‰‡æ¯”ä¾‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>fractionalUtilizationGoal</span> = (<span style=color:#a6e22e>totalUtilizationGoal</span> <span style=color:#f92672>-</span> float64(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dedicatedMarkWorkersNeeded</span>)) <span style=color:#f92672>/</span> float64(<span style=color:#a6e22e>procs</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å€˜è‹¥ P çš„ä¸ªæ•°å¯ä»¥è¢« 4 æ•´é™¤ï¼Œåˆ™æ— éœ€æ§åˆ¶æ‰§è¡Œæ—¶é•¿
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>fractionalUtilizationGoal</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>è®¾ç½®å†™å±éšœ:</p><p>gcStartæ–¹æ³•ä¼šè°ƒç”¨setGCPhaseæ–¹æ³•ï¼Œæ ‡å¿—GCæ­£å¼è¿›å…¥å¹¶å‘æ ‡è®°ï¼ˆGCmarkï¼‰é˜¶æ®µ. æˆ‘ä»¬è§‚å¯Ÿè¯¥æ–¹æ³•ä»£ç å®ç°ï¼Œå¯ä»¥æ³¨æ„åˆ°ï¼Œåœ¨_GCMarkå’Œ_GCMarkTerminationé˜¶æ®µä¸­ï¼Œä¼šå¯ç”¨æ··åˆå†™å±éšœ.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>setGCPhase</span>(<span style=color:#a6e22e>x</span> <span style=color:#66d9ef>uint32</span>) {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>gcphase</span>, <span style=color:#a6e22e>x</span>)
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>writeBarrier</span>.<span style=color:#a6e22e>needed</span> = <span style=color:#a6e22e>gcphase</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>_GCmark</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>gcphase</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>_GCmarktermination</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>writeBarrier</span>.<span style=color:#a6e22e>enabled</span> = <span style=color:#a6e22e>writeBarrier</span>.<span style=color:#a6e22e>needed</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>writeBarrier</span>.<span style=color:#a6e22e>cgo</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨æ··åˆå†™å±éšœæœºåˆ¶ä¸­ï¼Œæ ¸å¿ƒæ˜¯ä¼šå°†éœ€è¦ç½®ç°çš„å¯¹è±¡æ·»åŠ åˆ°å½“å‰Pçš„wbBufç¼“å­˜ä¸­. éšååœ¨å¹¶å‘æ ‡è®°ç¼ºç°ã€æ ‡è®°ç»ˆæ­¢å‰ç½®æ£€æŸ¥ç­‰æ—¶æœºä¼šæ‰§è¡ŒwbBufFlush1æ–¹æ³•ï¼Œæ‰¹é‡åœ°å°†wbBufä¸­çš„å¯¹è±¡é‡Šæ”¾å‡ºæ¥è¿›è¡Œç½®ç°ï¼Œä¿è¯è¾¾åˆ°é¢„æœŸçš„æ•ˆæœ.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// src/runtime/mwbbuf.go:168
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>wbBufFlush</span>(<span style=color:#a6e22e>dst</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>src</span> <span style=color:#66d9ef>uintptr</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wbBufFlush1</span>(<span style=color:#a6e22e>getg</span>().<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>())
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>wbBufFlush1æ–¹æ³•ä¸­æ¶‰åŠäº†å¯¹è±¡ç½®ç°æ“ä½œï¼Œå…¶åŒ…å«äº†åœ¨å¯¹åº”mspançš„bitmapä¸­æ‰“ç‚¹æ ‡è®°ä»¥åŠå°†å¯¹è±¡æ·»åŠ åˆ°gcwé˜Ÿåˆ—ä¸¤æ­¥.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>wbBufFlush1</span>(<span style=color:#a6e22e>_p_</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–å½“å‰ P é€šè¿‡å±éšœæœºåˆ¶ç¼“å­˜çš„æŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> (<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>next</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>start</span>) <span style=color:#f92672>/</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Sizeof</span>(<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ptrs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>buf</span>[:<span style=color:#a6e22e>n</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å°†ç¼“å­˜çš„æŒ‡é’ˆä½œæ ‡è®°ï¼Œæ·»åŠ åˆ° gcw é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>gcw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>gcw</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pos</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ptr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ptrs</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>objIndex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>findObject</span>(<span style=color:#a6e22e>ptr</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ‰“æ ‡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>mbits</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>markBitsForIndex</span>(<span style=color:#a6e22e>objIndex</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mbits</span>.<span style=color:#a6e22e>isMarked</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mbits</span>.<span style=color:#a6e22e>setMarked</span>()
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ‰€æœ‰ç¼“å­˜å¯¹è±¡å…¥é˜Ÿ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>putBatch</span>(<span style=color:#a6e22e>ptrs</span>[:<span style=color:#a6e22e>pos</span>])
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>reset</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>tinyå¯¹è±¡æ ‡è®°:</p><p>gcMarkTinyAllocsæ–¹æ³•ä¸­ï¼Œéå†æ‰€æœ‰çš„Pï¼Œå¯¹mcacheä¸­çš„Tinyå¯¹è±¡åˆ†åˆ«è°ƒç”¨greyobjectæ–¹æ³•è¿›è¡Œç½®ç°.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcMarkTinyAllocs</span>() {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>assertWorldStopped</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allp</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mcache</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>tiny</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>objIndex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>findObject</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>tiny</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>gcw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>gcw</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>greyobject</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>tiny</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>gcw</span>, <span style=color:#a6e22e>objIndex</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Start the world:</p><p>å°†æ‰€æœ‰På”¤é†’. å€˜è‹¥ç¼ºå°‘Mï¼Œåˆ™æ„é€ æ–°çš„Mä¸ºPè¡¥é½.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>startTheWorldWithSema</span>(<span style=color:#a6e22e>emitTraceEvent</span> <span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>int64</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assertWorldStopped</span>()
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...   
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>p1</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>procresize</span>(<span style=color:#a6e22e>procs</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é‡å¯ä¸–ç•Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>worldStarted</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// éå†æ‰€æœ‰ pï¼Œå°†å…¶å”¤é†’
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>p1</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p1</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p1</span> = <span style=color:#a6e22e>p1</span>.<span style=color:#a6e22e>link</span>.<span style=color:#a6e22e>ptr</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>mp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>ptr</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>m</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>nextp</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;startTheWorld: inconsistent mp-&gt;nextp&#34;</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>nextp</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>notewakeup</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>park</span>)
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {           
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>newm</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>p</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>startTime</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=å¹¶å‘æ ‡è®°>å¹¶å‘æ ‡è®°<a hidden class=anchor aria-hidden=true href=#å¹¶å‘æ ‡è®°>#</a></h3><h3 id=æ ‡è®°æ¸…æ‰«>æ ‡è®°æ¸…æ‰«<a hidden class=anchor aria-hidden=true href=#æ ‡è®°æ¸…æ‰«>#</a></h3></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.yici.xin/tags/golang/>golang</a></li><li><a href=https://www.yici.xin/tags/gc/>GC</a></li><li><a href=https://www.yici.xin/tags/%E5%86%85%E5%AD%98%E5%9B%9E%E6%94%B6/>å†…å­˜å›æ”¶</a></li><li><a href=https://www.yici.xin/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>æºç è§£æ</a></li></ul><nav class=paginav><a class=prev href=https://www.yici.xin/post/tech/golang%E8%AF%BB%E5%86%99%E9%94%81/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>Golangè¯»å†™é”</span>
</a><a class=next href=https://www.yici.xin/post/tech/golang%E4%BA%92%E6%96%A5%E9%94%81/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>Golangäº’æ–¥é”-Mutex</span></a></nav></footer><script type=text/javascript>let giscusTheme=localStorage.getItem("pref-theme")==="dark"?"dark_dimmed":"light",giscusAttributes={src:"https://giscus.app/client.js","data-repo":"yicixin/blog_comment","data-repo-id":"R_kgDOIr6QyQ","data-category":"Announcements","data-category-id":"DIC_kwDOIr6Qyc4CTSs3","data-mapping":"title","data-reactions-enabled":"1","data-emit-metadata":"0","data-theme":giscusTheme===null?"light":giscusTheme,"data-lang":"zh-CN",crossorigin:"anonymous","data-loading":"lazy",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([e,t])=>giscusScript.setAttribute(e,t));var article=document.getElementsByTagName("article")[0].appendChild(giscusScript);function changeGiscusTheme(){const e=localStorage.getItem("pref-theme")==="dark"?"light":"dark_dimmed";function t(e){const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}t({setConfig:{theme:e}})}const toggle=document.querySelector("#theme-toggle");toggle&&toggle.addEventListener("click",changeGiscusTheme)</script><script src=https://giscus.app/client.js data-repo=yicixin/blog_comment data-repo-id=R_kgDOIr6QyQ data-category=Announcements data-category-id=DIC_kwDOIr6Qyc4CTSs3 data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.yici.xin/>yicixin's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script src=https://code.jquery.com/jquery-1.12.4.min.js></script><script>$("code[class^=language] ").on("mouseover",function(){this.clientWidth<this.scrollWidth&&$(this).css("width","135%")}).on("mouseout",function(){$(this).css("width","100%"),$(".copy-code").css("right","4px")})</script></body></html>