<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css integrity=sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.2.1.slim.min.js integrity=sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js integrity=sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js integrity=sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl crossorigin=anonymous></script><title>ProtobufåŸç† | yicixin's blog</title><meta name=keywords content="protobuf"><meta name=description content="protobuf ä»‹ç» ProtoBuf(Protocol Buffers)æ˜¯ä¸€ç§å…·æœ‰è·¨å¹³å°ã€è¯­è¨€æ— å…³ã€å¯æ‰©å±•ç­‰ç‰¹æ€§çš„åºåˆ—åŒ–ç»“æ„æ•°æ®çš„æ–¹æ³•ï¼Œå¯ç”¨äºç½‘ç»œæ•°æ®äº¤æ¢åŠå­˜å‚¨ã€‚å’Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ jsonã€xml æ˜¯åŒä¸€ç§ä¸œè¥¿ã€‚å®ƒåœ¨è§£ææ€§èƒ½å’Œæ•°æ®å‹ç¼©åå¤§å°æ–¹é¢æ¯” jsonã€xml æ›´ä¼˜ç§€ï¼Œç›®å‰å¸¸ç”¨äº rpcã€‚
protobuf åºåˆ—åŒ–æœºåˆ¶ ä¸åŒäºä¼ ç»Ÿçš„åºåˆ—åŒ–æ–¹å¼ï¼Œprotobuf åœ¨åºåˆ—åŒ–æ•°æ®ä¹‹å‰ï¼Œéœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒæ˜¯è®°å½•æ•°æ®åœ¨åºåˆ—åŒ–å’Œè§£ææ—¶çš„å‚ç…§ï¼Œæˆ‘ä»¬ç®€å•çœ‹çœ‹å®ƒçš„è¯­æ³•ï¼š
message Person { required int32 id = 1; required string name = 2; required string hobby = 3; } åœ¨è¯¥ç»“æ„ä½“çš„å­—æ®µå®šä¹‰ä¸­ï¼Œæœ‰å‡ ä¸ªå…³é”®ä½ç½®ï¼Œåˆ†åˆ«æ˜¯ç±»å‹(å¦‚ int32)ã€å­—æ®µå(å¦‚ name)ï¼Œä»¥åŠä¸€ä¸ªç¼–å·(å¦‚ 1ã€2ã€3)ï¼Œ
ä½¿ç”¨ protobuf çš„åŒæ–¹éƒ½éœ€è¦ä¾ç…§è¿™ä¸ªç»“æ„ä½“å®šä¹‰æ¥è¿›è¡Œåºåˆ—åŒ–å’Œè§£æã€‚
æˆ‘ä»¬é€šè¿‡å‡ ä¸ªé—®é¢˜æ¥äº†è§£å…¶åºåˆ—åŒ–æœºåˆ¶å§ï¼š
QUESTION1 ğŸ™‹â€â™‚ï¸
åœ¨è§£æåºåˆ—åŒ–æ•°æ®æ—¶ï¼Œæ€ä¹ˆç¡®å®šå½“å‰è§£æçš„æ•°æ®å¯¹åº”å“ªä¸ªå­—æ®µï¼Ÿ åœ¨ä¼ ç»Ÿçš„åºåˆ—åŒ–æœºåˆ¶ä¸­ï¼Œåºåˆ—åŒ–æ•°æ®ä¸å…¶å¯¹åº”çš„å­—æ®µï¼Œéƒ½ä¼šé€šè¿‡å­—æ®µåè¿›è¡Œè”ç³»ï¼Œä½†åœ¨ protobuf çš„åºåˆ—åŒ–ç»“æœä¸­ï¼Œæ˜¯æ²¡æœ‰idã€nameå’Œhobbyè¿™æ ·çš„å­—æ®µåçš„ï¼Œå®ƒä»¬ä¼šè¢«ç¼–å·æ›¿ä»£ã€‚
QUESTION2 ğŸ™‹â€â™‚ï¸
åºåˆ—åŒ–åçš„å­—èŠ‚æµï¼Œå¦‚ä½•åˆ†éš”å„ä¸ªå­—æ®µï¼Ÿ æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ•°æ®æœ€ç»ˆåœ¨ä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä»¥ä¸€ä¸ªä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶å½¢å¼ä¼ è¾“çš„ï¼Œé¢å¯¹ä¸€é•¿ä¸²çš„å­—èŠ‚æµï¼Œå¦‚ä½•ç¡®å®šæ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæ®µå‘¢ï¼Ÿ åœ¨æ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæœ€å‰é¢ï¼Œä¼šæœ‰å‡ ä¸ªç‰¹æ®Šå­—èŠ‚ï¼Œç§°ä¸º Tagï¼ŒTag å°±å……å½“äº†è¾¹ç•Œçš„ä½œç”¨ï¼Œåˆ†éš”å„ä¸ªå­—æ®µã€‚
å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå­—èŠ‚æµçœ‹æˆä¸€ä¸ªä¸ªç”± Tag å’Œæ•°æ®(value)ç»„æˆçš„ç»“æ„ã€‚
Tag ä¸ä»…ä»…åªæ˜¯èµ·åˆ°äº†åˆ†éš”å­—æ®µçš„ä½œç”¨ï¼Œå®ƒè¿˜æ‰¿è½½äº†ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Tag æ˜¯å¦‚ä½•ç”Ÿæˆçš„:
static int makeTag(final int fieldNumber, final int wireType) { return (filedNumber << 3) | wireType; } å…¶ä¸­çš„fieldNumberï¼Œå°±æ˜¯æˆ‘ä»¬å®šä¹‰ç»“æ„ä½“æ—¶ç»™çš„ç¼–å·ï¼ŒwireTypeæœ‰ä»¥ä¸‹å‡ ä¸ªå€¼ï¼š"><meta name=author content="å£¹æ¬¡å¿ƒ"><link rel=canonical href=https://www.yici.xin/post/tech/protobuf%E5%8E%9F%E7%90%86/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.00d594ac5404702263b7df2f247aae4053818963176b093f9b95a1fc7e4e0b42.css integrity="sha256-ANWUrFQEcCJjt98vJHquQFOBiWMXawk/m5Wh/H5OC0I=" rel="preload stylesheet" as=style><link rel=icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=icon type=image/png sizes=16x16 href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=icon type=image/png sizes=32x32 href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=apple-touch-icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=mask-icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="ProtobufåŸç†"><meta property="og:description" content="protobuf ä»‹ç» ProtoBuf(Protocol Buffers)æ˜¯ä¸€ç§å…·æœ‰è·¨å¹³å°ã€è¯­è¨€æ— å…³ã€å¯æ‰©å±•ç­‰ç‰¹æ€§çš„åºåˆ—åŒ–ç»“æ„æ•°æ®çš„æ–¹æ³•ï¼Œå¯ç”¨äºç½‘ç»œæ•°æ®äº¤æ¢åŠå­˜å‚¨ã€‚å’Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ jsonã€xml æ˜¯åŒä¸€ç§ä¸œè¥¿ã€‚å®ƒåœ¨è§£ææ€§èƒ½å’Œæ•°æ®å‹ç¼©åå¤§å°æ–¹é¢æ¯” jsonã€xml æ›´ä¼˜ç§€ï¼Œç›®å‰å¸¸ç”¨äº rpcã€‚
protobuf åºåˆ—åŒ–æœºåˆ¶ ä¸åŒäºä¼ ç»Ÿçš„åºåˆ—åŒ–æ–¹å¼ï¼Œprotobuf åœ¨åºåˆ—åŒ–æ•°æ®ä¹‹å‰ï¼Œéœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒæ˜¯è®°å½•æ•°æ®åœ¨åºåˆ—åŒ–å’Œè§£ææ—¶çš„å‚ç…§ï¼Œæˆ‘ä»¬ç®€å•çœ‹çœ‹å®ƒçš„è¯­æ³•ï¼š
message Person { required int32 id = 1; required string name = 2; required string hobby = 3; } åœ¨è¯¥ç»“æ„ä½“çš„å­—æ®µå®šä¹‰ä¸­ï¼Œæœ‰å‡ ä¸ªå…³é”®ä½ç½®ï¼Œåˆ†åˆ«æ˜¯ç±»å‹(å¦‚ int32)ã€å­—æ®µå(å¦‚ name)ï¼Œä»¥åŠä¸€ä¸ªç¼–å·(å¦‚ 1ã€2ã€3)ï¼Œ
ä½¿ç”¨ protobuf çš„åŒæ–¹éƒ½éœ€è¦ä¾ç…§è¿™ä¸ªç»“æ„ä½“å®šä¹‰æ¥è¿›è¡Œåºåˆ—åŒ–å’Œè§£æã€‚
æˆ‘ä»¬é€šè¿‡å‡ ä¸ªé—®é¢˜æ¥äº†è§£å…¶åºåˆ—åŒ–æœºåˆ¶å§ï¼š
QUESTION1 ğŸ™‹â€â™‚ï¸
åœ¨è§£æåºåˆ—åŒ–æ•°æ®æ—¶ï¼Œæ€ä¹ˆç¡®å®šå½“å‰è§£æçš„æ•°æ®å¯¹åº”å“ªä¸ªå­—æ®µï¼Ÿ åœ¨ä¼ ç»Ÿçš„åºåˆ—åŒ–æœºåˆ¶ä¸­ï¼Œåºåˆ—åŒ–æ•°æ®ä¸å…¶å¯¹åº”çš„å­—æ®µï¼Œéƒ½ä¼šé€šè¿‡å­—æ®µåè¿›è¡Œè”ç³»ï¼Œä½†åœ¨ protobuf çš„åºåˆ—åŒ–ç»“æœä¸­ï¼Œæ˜¯æ²¡æœ‰idã€nameå’Œhobbyè¿™æ ·çš„å­—æ®µåçš„ï¼Œå®ƒä»¬ä¼šè¢«ç¼–å·æ›¿ä»£ã€‚
QUESTION2 ğŸ™‹â€â™‚ï¸
åºåˆ—åŒ–åçš„å­—èŠ‚æµï¼Œå¦‚ä½•åˆ†éš”å„ä¸ªå­—æ®µï¼Ÿ æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ•°æ®æœ€ç»ˆåœ¨ä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä»¥ä¸€ä¸ªä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶å½¢å¼ä¼ è¾“çš„ï¼Œé¢å¯¹ä¸€é•¿ä¸²çš„å­—èŠ‚æµï¼Œå¦‚ä½•ç¡®å®šæ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæ®µå‘¢ï¼Ÿ åœ¨æ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæœ€å‰é¢ï¼Œä¼šæœ‰å‡ ä¸ªç‰¹æ®Šå­—èŠ‚ï¼Œç§°ä¸º Tagï¼ŒTag å°±å……å½“äº†è¾¹ç•Œçš„ä½œç”¨ï¼Œåˆ†éš”å„ä¸ªå­—æ®µã€‚
å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå­—èŠ‚æµçœ‹æˆä¸€ä¸ªä¸ªç”± Tag å’Œæ•°æ®(value)ç»„æˆçš„ç»“æ„ã€‚
Tag ä¸ä»…ä»…åªæ˜¯èµ·åˆ°äº†åˆ†éš”å­—æ®µçš„ä½œç”¨ï¼Œå®ƒè¿˜æ‰¿è½½äº†ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Tag æ˜¯å¦‚ä½•ç”Ÿæˆçš„:
static int makeTag(final int fieldNumber, final int wireType) { return (filedNumber << 3) | wireType; } å…¶ä¸­çš„fieldNumberï¼Œå°±æ˜¯æˆ‘ä»¬å®šä¹‰ç»“æ„ä½“æ—¶ç»™çš„ç¼–å·ï¼ŒwireTypeæœ‰ä»¥ä¸‹å‡ ä¸ªå€¼ï¼š"><meta property="og:type" content="article"><meta property="og:url" content="https://www.yici.xin/post/tech/protobuf%E5%8E%9F%E7%90%86/"><meta property="og:image" content="https://www.yici.xin/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-27T17:52:06+08:00"><meta property="article:modified_time" content="2022-12-27T17:52:06+08:00"><meta property="og:site_name" content="yicixin's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.yici.xin/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="ProtobufåŸç†"><meta name=twitter:description content="protobuf ä»‹ç» ProtoBuf(Protocol Buffers)æ˜¯ä¸€ç§å…·æœ‰è·¨å¹³å°ã€è¯­è¨€æ— å…³ã€å¯æ‰©å±•ç­‰ç‰¹æ€§çš„åºåˆ—åŒ–ç»“æ„æ•°æ®çš„æ–¹æ³•ï¼Œå¯ç”¨äºç½‘ç»œæ•°æ®äº¤æ¢åŠå­˜å‚¨ã€‚å’Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ jsonã€xml æ˜¯åŒä¸€ç§ä¸œè¥¿ã€‚å®ƒåœ¨è§£ææ€§èƒ½å’Œæ•°æ®å‹ç¼©åå¤§å°æ–¹é¢æ¯” jsonã€xml æ›´ä¼˜ç§€ï¼Œç›®å‰å¸¸ç”¨äº rpcã€‚
protobuf åºåˆ—åŒ–æœºåˆ¶ ä¸åŒäºä¼ ç»Ÿçš„åºåˆ—åŒ–æ–¹å¼ï¼Œprotobuf åœ¨åºåˆ—åŒ–æ•°æ®ä¹‹å‰ï¼Œéœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒæ˜¯è®°å½•æ•°æ®åœ¨åºåˆ—åŒ–å’Œè§£ææ—¶çš„å‚ç…§ï¼Œæˆ‘ä»¬ç®€å•çœ‹çœ‹å®ƒçš„è¯­æ³•ï¼š
message Person { required int32 id = 1; required string name = 2; required string hobby = 3; } åœ¨è¯¥ç»“æ„ä½“çš„å­—æ®µå®šä¹‰ä¸­ï¼Œæœ‰å‡ ä¸ªå…³é”®ä½ç½®ï¼Œåˆ†åˆ«æ˜¯ç±»å‹(å¦‚ int32)ã€å­—æ®µå(å¦‚ name)ï¼Œä»¥åŠä¸€ä¸ªç¼–å·(å¦‚ 1ã€2ã€3)ï¼Œ
ä½¿ç”¨ protobuf çš„åŒæ–¹éƒ½éœ€è¦ä¾ç…§è¿™ä¸ªç»“æ„ä½“å®šä¹‰æ¥è¿›è¡Œåºåˆ—åŒ–å’Œè§£æã€‚
æˆ‘ä»¬é€šè¿‡å‡ ä¸ªé—®é¢˜æ¥äº†è§£å…¶åºåˆ—åŒ–æœºåˆ¶å§ï¼š
QUESTION1 ğŸ™‹â€â™‚ï¸
åœ¨è§£æåºåˆ—åŒ–æ•°æ®æ—¶ï¼Œæ€ä¹ˆç¡®å®šå½“å‰è§£æçš„æ•°æ®å¯¹åº”å“ªä¸ªå­—æ®µï¼Ÿ åœ¨ä¼ ç»Ÿçš„åºåˆ—åŒ–æœºåˆ¶ä¸­ï¼Œåºåˆ—åŒ–æ•°æ®ä¸å…¶å¯¹åº”çš„å­—æ®µï¼Œéƒ½ä¼šé€šè¿‡å­—æ®µåè¿›è¡Œè”ç³»ï¼Œä½†åœ¨ protobuf çš„åºåˆ—åŒ–ç»“æœä¸­ï¼Œæ˜¯æ²¡æœ‰idã€nameå’Œhobbyè¿™æ ·çš„å­—æ®µåçš„ï¼Œå®ƒä»¬ä¼šè¢«ç¼–å·æ›¿ä»£ã€‚
QUESTION2 ğŸ™‹â€â™‚ï¸
åºåˆ—åŒ–åçš„å­—èŠ‚æµï¼Œå¦‚ä½•åˆ†éš”å„ä¸ªå­—æ®µï¼Ÿ æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ•°æ®æœ€ç»ˆåœ¨ä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä»¥ä¸€ä¸ªä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶å½¢å¼ä¼ è¾“çš„ï¼Œé¢å¯¹ä¸€é•¿ä¸²çš„å­—èŠ‚æµï¼Œå¦‚ä½•ç¡®å®šæ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæ®µå‘¢ï¼Ÿ åœ¨æ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæœ€å‰é¢ï¼Œä¼šæœ‰å‡ ä¸ªç‰¹æ®Šå­—èŠ‚ï¼Œç§°ä¸º Tagï¼ŒTag å°±å……å½“äº†è¾¹ç•Œçš„ä½œç”¨ï¼Œåˆ†éš”å„ä¸ªå­—æ®µã€‚
å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå­—èŠ‚æµçœ‹æˆä¸€ä¸ªä¸ªç”± Tag å’Œæ•°æ®(value)ç»„æˆçš„ç»“æ„ã€‚
Tag ä¸ä»…ä»…åªæ˜¯èµ·åˆ°äº†åˆ†éš”å­—æ®µçš„ä½œç”¨ï¼Œå®ƒè¿˜æ‰¿è½½äº†ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Tag æ˜¯å¦‚ä½•ç”Ÿæˆçš„:
static int makeTag(final int fieldNumber, final int wireType) { return (filedNumber << 3) | wireType; } å…¶ä¸­çš„fieldNumberï¼Œå°±æ˜¯æˆ‘ä»¬å®šä¹‰ç»“æ„ä½“æ—¶ç»™çš„ç¼–å·ï¼ŒwireTypeæœ‰ä»¥ä¸‹å‡ ä¸ªå€¼ï¼š"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.yici.xin/post/"},{"@type":"ListItem","position":2,"name":"ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯","item":"https://www.yici.xin/post/tech/"},{"@type":"ListItem","position":3,"name":"ProtobufåŸç†","item":"https://www.yici.xin/post/tech/protobuf%E5%8E%9F%E7%90%86/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ProtobufåŸç†","name":"ProtobufåŸç†","description":"protobuf ä»‹ç» ProtoBuf(Protocol Buffers)æ˜¯ä¸€ç§å…·æœ‰è·¨å¹³å°ã€è¯­è¨€æ— å…³ã€å¯æ‰©å±•ç­‰ç‰¹æ€§çš„åºåˆ—åŒ–ç»“æ„æ•°æ®çš„æ–¹æ³•ï¼Œå¯ç”¨äºç½‘ç»œæ•°æ®äº¤æ¢åŠå­˜å‚¨ã€‚å’Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ jsonã€xml æ˜¯åŒä¸€ç§ä¸œè¥¿ã€‚å®ƒåœ¨è§£ææ€§èƒ½å’Œæ•°æ®å‹ç¼©åå¤§å°æ–¹é¢æ¯” jsonã€xml æ›´ä¼˜ç§€ï¼Œç›®å‰å¸¸ç”¨äº rpcã€‚\nprotobuf åºåˆ—åŒ–æœºåˆ¶ ä¸åŒäºä¼ ç»Ÿçš„åºåˆ—åŒ–æ–¹å¼ï¼Œprotobuf åœ¨åºåˆ—åŒ–æ•°æ®ä¹‹å‰ï¼Œéœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒæ˜¯è®°å½•æ•°æ®åœ¨åºåˆ—åŒ–å’Œè§£ææ—¶çš„å‚ç…§ï¼Œæˆ‘ä»¬ç®€å•çœ‹çœ‹å®ƒçš„è¯­æ³•ï¼š\nmessage Person { required int32 id = 1; required string name = 2; required string hobby = 3; } åœ¨è¯¥ç»“æ„ä½“çš„å­—æ®µå®šä¹‰ä¸­ï¼Œæœ‰å‡ ä¸ªå…³é”®ä½ç½®ï¼Œåˆ†åˆ«æ˜¯ç±»å‹(å¦‚ int32)ã€å­—æ®µå(å¦‚ name)ï¼Œä»¥åŠä¸€ä¸ªç¼–å·(å¦‚ 1ã€2ã€3)ï¼Œ\nä½¿ç”¨ protobuf çš„åŒæ–¹éƒ½éœ€è¦ä¾ç…§è¿™ä¸ªç»“æ„ä½“å®šä¹‰æ¥è¿›è¡Œåºåˆ—åŒ–å’Œè§£æã€‚\næˆ‘ä»¬é€šè¿‡å‡ ä¸ªé—®é¢˜æ¥äº†è§£å…¶åºåˆ—åŒ–æœºåˆ¶å§ï¼š\nQUESTION1 ğŸ™‹â€â™‚ï¸\nåœ¨è§£æåºåˆ—åŒ–æ•°æ®æ—¶ï¼Œæ€ä¹ˆç¡®å®šå½“å‰è§£æçš„æ•°æ®å¯¹åº”å“ªä¸ªå­—æ®µï¼Ÿ åœ¨ä¼ ç»Ÿçš„åºåˆ—åŒ–æœºåˆ¶ä¸­ï¼Œåºåˆ—åŒ–æ•°æ®ä¸å…¶å¯¹åº”çš„å­—æ®µï¼Œéƒ½ä¼šé€šè¿‡å­—æ®µåè¿›è¡Œè”ç³»ï¼Œä½†åœ¨ protobuf çš„åºåˆ—åŒ–ç»“æœä¸­ï¼Œæ˜¯æ²¡æœ‰idã€nameå’Œhobbyè¿™æ ·çš„å­—æ®µåçš„ï¼Œå®ƒä»¬ä¼šè¢«ç¼–å·æ›¿ä»£ã€‚\nQUESTION2 ğŸ™‹â€â™‚ï¸\nåºåˆ—åŒ–åçš„å­—èŠ‚æµï¼Œå¦‚ä½•åˆ†éš”å„ä¸ªå­—æ®µï¼Ÿ æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ•°æ®æœ€ç»ˆåœ¨ä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä»¥ä¸€ä¸ªä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶å½¢å¼ä¼ è¾“çš„ï¼Œé¢å¯¹ä¸€é•¿ä¸²çš„å­—èŠ‚æµï¼Œå¦‚ä½•ç¡®å®šæ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæ®µå‘¢ï¼Ÿ åœ¨æ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæœ€å‰é¢ï¼Œä¼šæœ‰å‡ ä¸ªç‰¹æ®Šå­—èŠ‚ï¼Œç§°ä¸º Tagï¼ŒTag å°±å……å½“äº†è¾¹ç•Œçš„ä½œç”¨ï¼Œåˆ†éš”å„ä¸ªå­—æ®µã€‚\nå¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå­—èŠ‚æµçœ‹æˆä¸€ä¸ªä¸ªç”± Tag å’Œæ•°æ®(value)ç»„æˆçš„ç»“æ„ã€‚\nTag ä¸ä»…ä»…åªæ˜¯èµ·åˆ°äº†åˆ†éš”å­—æ®µçš„ä½œç”¨ï¼Œå®ƒè¿˜æ‰¿è½½äº†ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Tag æ˜¯å¦‚ä½•ç”Ÿæˆçš„:\nstatic int makeTag(final int fieldNumber, final int wireType) { return (filedNumber \u0026lt;\u0026lt; 3) | wireType; } å…¶ä¸­çš„fieldNumberï¼Œå°±æ˜¯æˆ‘ä»¬å®šä¹‰ç»“æ„ä½“æ—¶ç»™çš„ç¼–å·ï¼ŒwireTypeæœ‰ä»¥ä¸‹å‡ ä¸ªå€¼ï¼š","keywords":["protobuf"],"articleBody":"protobuf ä»‹ç» ProtoBuf(Protocol Buffers)æ˜¯ä¸€ç§å…·æœ‰è·¨å¹³å°ã€è¯­è¨€æ— å…³ã€å¯æ‰©å±•ç­‰ç‰¹æ€§çš„åºåˆ—åŒ–ç»“æ„æ•°æ®çš„æ–¹æ³•ï¼Œå¯ç”¨äºç½‘ç»œæ•°æ®äº¤æ¢åŠå­˜å‚¨ã€‚å’Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ jsonã€xml æ˜¯åŒä¸€ç§ä¸œè¥¿ã€‚å®ƒåœ¨è§£ææ€§èƒ½å’Œæ•°æ®å‹ç¼©åå¤§å°æ–¹é¢æ¯” jsonã€xml æ›´ä¼˜ç§€ï¼Œç›®å‰å¸¸ç”¨äº rpcã€‚\nprotobuf åºåˆ—åŒ–æœºåˆ¶ ä¸åŒäºä¼ ç»Ÿçš„åºåˆ—åŒ–æ–¹å¼ï¼Œprotobuf åœ¨åºåˆ—åŒ–æ•°æ®ä¹‹å‰ï¼Œéœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒæ˜¯è®°å½•æ•°æ®åœ¨åºåˆ—åŒ–å’Œè§£ææ—¶çš„å‚ç…§ï¼Œæˆ‘ä»¬ç®€å•çœ‹çœ‹å®ƒçš„è¯­æ³•ï¼š\nmessage Person { required int32 id = 1; required string name = 2; required string hobby = 3; } åœ¨è¯¥ç»“æ„ä½“çš„å­—æ®µå®šä¹‰ä¸­ï¼Œæœ‰å‡ ä¸ªå…³é”®ä½ç½®ï¼Œåˆ†åˆ«æ˜¯ç±»å‹(å¦‚ int32)ã€å­—æ®µå(å¦‚ name)ï¼Œä»¥åŠä¸€ä¸ªç¼–å·(å¦‚ 1ã€2ã€3)ï¼Œ\nä½¿ç”¨ protobuf çš„åŒæ–¹éƒ½éœ€è¦ä¾ç…§è¿™ä¸ªç»“æ„ä½“å®šä¹‰æ¥è¿›è¡Œåºåˆ—åŒ–å’Œè§£æã€‚\næˆ‘ä»¬é€šè¿‡å‡ ä¸ªé—®é¢˜æ¥äº†è§£å…¶åºåˆ—åŒ–æœºåˆ¶å§ï¼š\nQUESTION1 ğŸ™‹â€â™‚ï¸\nåœ¨è§£æåºåˆ—åŒ–æ•°æ®æ—¶ï¼Œæ€ä¹ˆç¡®å®šå½“å‰è§£æçš„æ•°æ®å¯¹åº”å“ªä¸ªå­—æ®µï¼Ÿ åœ¨ä¼ ç»Ÿçš„åºåˆ—åŒ–æœºåˆ¶ä¸­ï¼Œåºåˆ—åŒ–æ•°æ®ä¸å…¶å¯¹åº”çš„å­—æ®µï¼Œéƒ½ä¼šé€šè¿‡å­—æ®µåè¿›è¡Œè”ç³»ï¼Œä½†åœ¨ protobuf çš„åºåˆ—åŒ–ç»“æœä¸­ï¼Œæ˜¯æ²¡æœ‰idã€nameå’Œhobbyè¿™æ ·çš„å­—æ®µåçš„ï¼Œå®ƒä»¬ä¼šè¢«ç¼–å·æ›¿ä»£ã€‚\nQUESTION2 ğŸ™‹â€â™‚ï¸\nåºåˆ—åŒ–åçš„å­—èŠ‚æµï¼Œå¦‚ä½•åˆ†éš”å„ä¸ªå­—æ®µï¼Ÿ æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ•°æ®æœ€ç»ˆåœ¨ä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä»¥ä¸€ä¸ªä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶å½¢å¼ä¼ è¾“çš„ï¼Œé¢å¯¹ä¸€é•¿ä¸²çš„å­—èŠ‚æµï¼Œå¦‚ä½•ç¡®å®šæ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæ®µå‘¢ï¼Ÿ åœ¨æ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæœ€å‰é¢ï¼Œä¼šæœ‰å‡ ä¸ªç‰¹æ®Šå­—èŠ‚ï¼Œç§°ä¸º Tagï¼ŒTag å°±å……å½“äº†è¾¹ç•Œçš„ä½œç”¨ï¼Œåˆ†éš”å„ä¸ªå­—æ®µã€‚\nå¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå­—èŠ‚æµçœ‹æˆä¸€ä¸ªä¸ªç”± Tag å’Œæ•°æ®(value)ç»„æˆçš„ç»“æ„ã€‚\nTag ä¸ä»…ä»…åªæ˜¯èµ·åˆ°äº†åˆ†éš”å­—æ®µçš„ä½œç”¨ï¼Œå®ƒè¿˜æ‰¿è½½äº†ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Tag æ˜¯å¦‚ä½•ç”Ÿæˆçš„:\nstatic int makeTag(final int fieldNumber, final int wireType) { return (filedNumber \u003c\u003c 3) | wireType; } å…¶ä¸­çš„fieldNumberï¼Œå°±æ˜¯æˆ‘ä»¬å®šä¹‰ç»“æ„ä½“æ—¶ç»™çš„ç¼–å·ï¼ŒwireTypeæœ‰ä»¥ä¸‹å‡ ä¸ªå€¼ï¼š\nwireTypeæ€»å…±åªæœ‰ 5 ä¸ªå€¼ï¼Œç”¨äºŒè¿›åˆ¶æ¥è¡¨ç¤ºåªéœ€è¦ 3 ä½ï¼ŒfiledNumber \u003c\u003c 3æŠŠfiledNumberå·¦ç§» 3 ä½ï¼Œç„¶åä¸wireTypeåšæˆ–è¿ç®—ï¼ŒwireTypeå³æ˜¯Tagçš„æœ€å 3 ä½ã€‚\nQUESTION3 ğŸ™‹â€â™‚ï¸\nTagå¦‚ä½•ä¿è¯ä¸å’ŒValueæ··æ·†ï¼Ÿ Tag å’ŒValueåœ¨å­—èŠ‚æµä¸­éƒ½æ˜¯ä¸€ä¸ªä¸ªå­—èŠ‚ï¼Œå¦‚æœå­—èŠ‚ç›¸åŒï¼Œé‚£å°±ä¼šæŠŠvalueè¯¯è®¤ä¸º Tagï¼Œè§£æå°±ä¼šå‡ºé”™ã€‚\nè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ protobuf åºåˆ—åŒ–æˆå­—èŠ‚æµæ—¶çš„ç¼–ç æ–¹å¼\nå¯å˜é•¿åº¦ç¼–ç (Varint) æˆ‘ä»¬çŸ¥é“ï¼Œæ•´æ•°ç±»å‹çš„é•¿åº¦éƒ½æ˜¯ç¡®å®šçš„ï¼Œå¦‚ int ç±»å‹çš„é•¿åº¦ä¸º 4 ä¸ªå­—èŠ‚ï¼Œå¯è¡¨ç¤ºçš„æ•´æ•°èŒƒå›´ä¸º-231â€”â€”231-1ï¼Œä½†æ˜¯å®é™…ä¼ è¾“ä¸­çš„æ•°å­—å‡æ¯”è¾ƒå°ï¼Œä¼šé€ æˆå­—èŠ‚æµªè´¹ï¼Œå¯å˜é•¿åº¦ç¼–ç å°±èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯å˜é•¿åº¦ç¼–ç è§„åˆ™å¦‚ä¸‹ï¼š\nå­—èŠ‚æœ€é«˜ä½è¡¨ç¤ºæ•°æ®æ˜¯å¦ç»“æŸï¼Œå¦‚æœæœ€é«˜ä½ä¸º 1ï¼Œåˆ™è¡¨ç¤ºåé¢çš„å­—èŠ‚ä¹Ÿæ˜¯è¯¥æ•°æ®çš„ä¸€éƒ¨åˆ† å¯å˜é•¿åº¦ç¼–ç å”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯å½“æ•°å¾ˆå¤§çš„æ—¶å€™ int32 éœ€è¦å ç”¨ 5 ä¸ªå­—èŠ‚ï¼Œå› ä¸ºå»æ‰å­—èŠ‚æœ€é«˜ä½åï¼Œä¸€ä¸ªå­—èŠ‚èƒ½ç”¨æ¥è¡¨ç¤ºæ•°æ®çš„åªå‰© 7 ä½ï¼Œä½†æ˜¯ä»ç»Ÿè®¡å­¦è§’åº¦æ¥è¯´ï¼Œä¸€èˆ¬ä¸ä¼šæœ‰è¿™ä¹ˆå¤§çš„æ•°ã€‚\nä¸Šæ–‡æåˆ°çš„Tagï¼Œè¿˜éœ€è¦ 3 ä½è¡¨ç¤ºæ•°æ®ç±»å‹ï¼Œç”¨æ¥è¡¨ç¤ºç¼–å·çš„ä½æ•°ä¸º 4 ä½æ—¶(èƒ½è¡¨ç¤º 15 ä¸ªç¼–å·)ï¼ŒTagæ‰èƒ½ç”¨ 1 ä¸ªå­—èŠ‚è£…ä¸‹ã€‚\nè´Ÿæ•°é—®é¢˜\næ•´æ•°åœ¨è®¡ç®—æœºä¸­æ˜¯ä»¥è¡¥ç å½¢å¼å­˜å‚¨çš„ï¼Œ-1 çš„è¡¥ç å½¢å¼æ˜¯1111 1111 1111 1111ï¼Œè¿™æ ·çš„å€¼åœ¨ä½¿ç”¨å¯å˜é•¿åº¦ç¼–ç æ—¶çš„æ•ˆç‡éå¸¸ä½ï¼Œæ‰€ä»¥å¦‚æœè¦ä½¿ç”¨è´Ÿæ•°å¼ºçƒˆä¸å»ºè®®ä½¿ç”¨ int32 å’Œ int64ï¼Œå»ºè®®ä½¿ç”¨ sint32 å’Œ sint64ï¼Œsint32 å’Œ sint64 ä¼šä½¿ç”¨ zigZag ç¼–ç ï¼Œç”Ÿæˆçš„æ•°å†ä½¿ç”¨å¯å˜é•¿åº¦ç¼–ç  ä¸‹é¢ä»‹ç»ä¸€ä¸‹ zigzag ç¼–ç ã€‚\nzigzag ç¼–ç æœºåˆ¶å¦‚ä¸‹:\nZigzag(n) = (n \u003c\u003c 1) ^ (n \u003e\u003e 31), n ä¸º sint32 æ—¶ Zigzag(n) = (n \u003c\u003c 1) ^ (n \u003e\u003e 63), n ä¸º sint64 æ—¶ å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š\nè´Ÿæ•°: x = 2|x| -1 æ­£æ•°: x = 2|x| ä¸‹å›¾æ˜¯ä¸€äº›æ•°æŒ‰ç…§ zigzag ç¼–ç æ–¹å¼åå¾—åˆ°çš„æ•°ï¼š\næˆ‘ä»¬æŠŠæ•°å…ˆç»è¿‡ zigzag ç¼–ç åå†è¿›è¡Œä¸å®šé•¿ç¼–ç ï¼Œå°±èƒ½å¤Ÿæé«˜è´Ÿæ•°åœ¨ä¸å®šé•¿ç¼–ç ä¸­çš„æ•ˆç‡ã€‚\nå®šé•¿ç¼–ç  ä¸Šæ–‡è®²åˆ°çš„ Varint å’Œ zigzag ç¼–ç éƒ½æ˜¯é’ˆå¯¹æ•°å­—è¿›è¡Œç¼–ç ï¼Œåœ¨ç¼–ç å­—ç¬¦æ—¶ä½¿ç”¨çš„æ˜¯å®šé•¿ç¼–ç ï¼Œå®šé•¿ç¼–ç åœ¨å­—èŠ‚æµä¸­çš„ç»“æ„æ˜¯ TLVï¼Œå³Tag-Length-Valueï¼ŒLength æ˜¯ä¸€ä¸ªæ•°å­—(ä¹Ÿä¼šç”¨ Varint ç¼–ç )ï¼Œè®°å½•çš„æ˜¯åé¢ value æ‰€å çš„å­—èŠ‚æ•°ã€‚\nå®é™…çš„å­—èŠ‚æµä¸æ˜¯åªæœ‰ TV æˆ–è€… TLVï¼Œæ˜¯ TV å’Œ TLV æ··åˆåœ¨ä¸€èµ·çš„ã€‚\næˆ‘ä»¬ç°åœ¨å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆä¸ä¼šå‡ºç°æ··æ·†é—®é¢˜äº†ï¼Œæˆ‘ä»¬åœ¨è§£ææ—¶ï¼Œé¦–å…ˆä¼šå–ç¬¬ä¸€ä¸ªTagï¼Œå› ä¸ºTagä½¿ç”¨äº† Varint ç¼–ç ï¼Œæ ¹æ® Varint ç¼–ç è§„åˆ™ï¼Œå¦‚æœTagåªæœ‰ä¸€ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—èŠ‚çš„é¦–ä½ä¼šä¸º 0ï¼Œå¦‚æœTagå¤§äº 1 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆç»§ç»­å¾€åå–åˆ°é¦–ä½ä¸º 0 çš„é‚£ä¸€ä¸ªå­—èŠ‚ï¼Œå³å¯æ­£ç¡®è·å–Tagã€‚æ¥ç€æˆ‘ä»¬é€šè¿‡Tagçš„äºŒè¿›åˆ¶åä¸‰ä½å¯ä»¥å¾—åˆ°å­—æ®µçš„ç±»å‹wireTypeï¼Œåˆ†ä¸¤ç§æƒ…å†µ:\nå¦‚æœç±»å‹æ˜¯æ•°å­—ï¼Œé‚£ä¹ˆè¿™æ˜¯ä¸€ä¸ª TV ç»“æ„ï¼ŒValueé‡‡ç”¨ä¸å®šé•¿ç¼–ç ï¼Œæˆ‘ä»¬æ ¹æ®ä¸å®šé•¿ç¼–ç è§„åˆ™å–å¾—Valueåï¼Œå†å¾€åå°±æ˜¯ä¸‹ä¸€ä¸ªTagäº†ã€‚ å¦‚æœç±»å‹æ˜¯å­—ç¬¦ï¼Œé‚£ä¹ˆè¿™ä¼šæ˜¯ä¸€ä¸ª TLV ç»“æ„ï¼Œæˆ‘ä»¬å…ˆæ ¹æ®ä¸å®šé•¿ç¼–ç è§„åˆ™è·å–Lengthï¼ŒLengthè®°å½•äº†Valueçš„å­—èŠ‚æ•° nï¼Œåé¢çš„ n ä¸ªå­—èŠ‚å³æ˜¯Valueï¼Œå†å¾€åå°±æ˜¯ä¸‹ä¸€ä¸ªTagã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½æ¸…æ¥šçŸ¥é“å½“å‰çš„å­—èŠ‚æ˜¯Tagã€Lengthè¿˜æ˜¯Valueï¼Œä¸ä¼šå‡ºç°æ··æ·†çš„æƒ…å†µã€‚\nä¸ºä»€ä¹ˆ protobuf çš„æ€§èƒ½æ›´å¥½ï¼Ÿ æ²¡æœ‰åºåˆ—åŒ– keyï¼Œé€šè¿‡ç¼–å·ä»£æ›¿ å¯å˜é•¿åº¦ç¼–ç å’Œ zigzag ç¼–ç ï¼Œå‡å°å­—èŠ‚å ç”¨ ","wordCount":"233","inLanguage":"zh","datePublished":"2022-12-27T17:52:06+08:00","dateModified":"2022-12-27T17:52:06+08:00","author":[{"@type":"Person","name":"å£¹æ¬¡å¿ƒ"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.yici.xin/post/tech/protobuf%E5%8E%9F%E7%90%86/"},"publisher":{"@type":"Organization","name":"yicixin's blog","logo":{"@type":"ImageObject","url":"https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.yici.xin/ accesskey=h title="ğŸ‘€ (Alt + H)">ğŸ‘€</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.yici.xin/tags/ title=æ ‡ç­¾ğŸ·ï¸><span>æ ‡ç­¾ğŸ·ï¸</span></a></li><li><a href=https://www.yici.xin/archives/ title=å½’æ¡£ğŸ•°ï¸><span>å½’æ¡£ğŸ•°ï¸</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.yici.xin/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://www.yici.xin/post/>Posts</a>&nbsp;Â»&nbsp;<a href=https://www.yici.xin/post/tech/>ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div><h1 class=post-title>ProtobufåŸç†</h1><div class=post-meta><span title='2022-12-27 17:52:06 +0800 +0800'>2022-12-27</span>&nbsp;Â·&nbsp;2 åˆ†é’Ÿ&nbsp;Â·&nbsp;233 å­—&nbsp;Â·&nbsp;å£¹æ¬¡å¿ƒ&nbsp;|&nbsp;<a href=https://github.com/yicixin/blog/blob/main/content/post/tech/protobuf%e5%8e%9f%e7%90%86.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#protobuf-%e4%bb%8b%e7%bb%8d aria-label="protobuf ä»‹ç»">protobuf ä»‹ç»</a></li><li><a href=#protobuf-%e5%ba%8f%e5%88%97%e5%8c%96%e6%9c%ba%e5%88%b6 aria-label="protobuf åºåˆ—åŒ–æœºåˆ¶">protobuf åºåˆ—åŒ–æœºåˆ¶</a><ul><li><a href=#%e5%8f%af%e5%8f%98%e9%95%bf%e5%ba%a6%e7%bc%96%e7%a0%81varint aria-label=å¯å˜é•¿åº¦ç¼–ç (Varint)>å¯å˜é•¿åº¦ç¼–ç (Varint)</a></li><li><a href=#%e5%ae%9a%e9%95%bf%e7%bc%96%e7%a0%81 aria-label=å®šé•¿ç¼–ç >å®šé•¿ç¼–ç </a></li></ul></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88-protobuf-%e7%9a%84%e6%80%a7%e8%83%bd%e6%9b%b4%e5%a5%bd aria-label="ä¸ºä»€ä¹ˆ protobuf çš„æ€§èƒ½æ›´å¥½ï¼Ÿ">ä¸ºä»€ä¹ˆ protobuf çš„æ€§èƒ½æ›´å¥½ï¼Ÿ</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=protobuf-ä»‹ç»>protobuf ä»‹ç»<a hidden class=anchor aria-hidden=true href=#protobuf-ä»‹ç»>#</a></h2><p>ProtoBuf(Protocol Buffers)æ˜¯ä¸€ç§å…·æœ‰è·¨å¹³å°ã€è¯­è¨€æ— å…³ã€å¯æ‰©å±•ç­‰ç‰¹æ€§çš„åºåˆ—åŒ–ç»“æ„æ•°æ®çš„æ–¹æ³•ï¼Œå¯ç”¨äºç½‘ç»œæ•°æ®äº¤æ¢åŠå­˜å‚¨ã€‚å’Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ jsonã€xml æ˜¯åŒä¸€ç§ä¸œè¥¿ã€‚å®ƒåœ¨è§£ææ€§èƒ½å’Œæ•°æ®å‹ç¼©åå¤§å°æ–¹é¢æ¯” jsonã€xml æ›´ä¼˜ç§€ï¼Œç›®å‰å¸¸ç”¨äº rpcã€‚</p><h2 id=protobuf-åºåˆ—åŒ–æœºåˆ¶>protobuf åºåˆ—åŒ–æœºåˆ¶<a hidden class=anchor aria-hidden=true href=#protobuf-åºåˆ—åŒ–æœºåˆ¶>#</a></h2><p>ä¸åŒäºä¼ ç»Ÿçš„åºåˆ—åŒ–æ–¹å¼ï¼Œprotobuf åœ¨åºåˆ—åŒ–æ•°æ®ä¹‹å‰ï¼Œéœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒæ˜¯è®°å½•æ•°æ®åœ¨åºåˆ—åŒ–å’Œè§£ææ—¶çš„å‚ç…§ï¼Œæˆ‘ä»¬ç®€å•çœ‹çœ‹å®ƒçš„è¯­æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Person</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>int32</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> name <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>required</span> <span style=color:#66d9ef>string</span> hobby <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>åœ¨è¯¥ç»“æ„ä½“çš„å­—æ®µå®šä¹‰ä¸­ï¼Œæœ‰å‡ ä¸ªå…³é”®ä½ç½®ï¼Œåˆ†åˆ«æ˜¯ç±»å‹(å¦‚ int32)ã€å­—æ®µå(å¦‚ name)ï¼Œä»¥åŠä¸€ä¸ªç¼–å·(å¦‚ 1ã€2ã€3)ï¼Œ</p><p>ä½¿ç”¨ protobuf çš„åŒæ–¹éƒ½éœ€è¦ä¾ç…§è¿™ä¸ªç»“æ„ä½“å®šä¹‰æ¥è¿›è¡Œåºåˆ—åŒ–å’Œè§£æã€‚</p><p>æˆ‘ä»¬é€šè¿‡å‡ ä¸ªé—®é¢˜æ¥äº†è§£å…¶åºåˆ—åŒ–æœºåˆ¶å§ï¼š</p><style type=text/css media=screen>html{--color-alert-info-text:#24292e;--color-alert-info-bg:#dbedff;--color-alert-info-border:rgba(4, 66, 137, 0.2);--color-alert-warn-text:#24292e;--color-alert-warn-bg:#fffbdd;--color-alert-warn-border:rgba(176, 136, 0, 0.2);--color-alert-error-text:#24292e;--color-alert-error-bg:#ffe3e6;--color-alert-error-border:rgba(158, 28, 35, 0.2);--color-alert-success-text:#24292e;--color-alert-success-bg:#dcffe4;--color-alert-success-border:rgba(23, 111, 44, 0.2)}html[data-theme=dark]{--color-alert-info-text:#79c0ff;--color-alert-info-bg:rgba(56, 139, 253, 0.1);--color-alert-info-border:rgba(56, 139, 253, 0.4);--color-alert-warn-text:#e3b341;--color-alert-warn-bg:rgba(187, 128, 9, 0.1);--color-alert-warn-border:rgba(187, 128, 9, 0.4);--color-alert-error-text:#ff7b72;--color-alert-error-bg:rgba(248, 81, 73, 0.1);--color-alert-error-border:rgba(248, 81, 73, 0.4);--color-alert-success-text:#56d364;--color-alert-success-bg:rgba(46, 160, 67, 0.1);--color-alert-success-border:rgba(46, 160, 67, 0.4)}.tips{position:relative;padding:20px 16px;margin-bottom:20px;border-style:solid;border-width:1px;border-radius:6px;border-left-style:solid;border-left-width:6px}.tips.info{color:var(--color-alert-info-text);background-image:linear-gradient(var(--color-alert-info-bg),var(--color-alert-info-bg));border-color:var(--color-alert-info-border)}.tips.warn{color:var(--color-alert-warn-text);background-image:linear-gradient(var(--color-alert-warn-bg),var(--color-alert-warn-bg));border-color:var(--color-alert-warn-border)}.tips.error{color:var(--color-alert-error-text);background-image:linear-gradient(var(--color-alert-error-bg),var(--color-alert-error-bg));border-color:var(--color-alert-error-border)}.tips.success{color:var(--color-alert-success-text);background-image:linear-gradient(var(--color-alert-success-bg),var(--color-alert-success-bg));border-color:var(--color-alert-success-border)}#tips-title{font-size:19px;font-weight:800;margin-bottom:10px}</style><div class="tips warn"><p id=tips-title>QUESTION1 ğŸ™‹â€â™‚ï¸</p>åœ¨è§£æåºåˆ—åŒ–æ•°æ®æ—¶ï¼Œæ€ä¹ˆç¡®å®šå½“å‰è§£æçš„æ•°æ®å¯¹åº”å“ªä¸ªå­—æ®µï¼Ÿ</div><p>åœ¨ä¼ ç»Ÿçš„åºåˆ—åŒ–æœºåˆ¶ä¸­ï¼Œåºåˆ—åŒ–æ•°æ®ä¸å…¶å¯¹åº”çš„å­—æ®µï¼Œéƒ½ä¼šé€šè¿‡å­—æ®µåè¿›è¡Œè”ç³»ï¼Œä½†åœ¨ protobuf çš„åºåˆ—åŒ–ç»“æœä¸­ï¼Œæ˜¯æ²¡æœ‰<code>id</code>ã€<code>name</code>å’Œ<code>hobby</code>è¿™æ ·çš„å­—æ®µåçš„ï¼Œå®ƒä»¬ä¼šè¢«ç¼–å·æ›¿ä»£ã€‚</p><div class="tips warn"><p id=tips-title>QUESTION2 ğŸ™‹â€â™‚ï¸</p>åºåˆ—åŒ–åçš„å­—èŠ‚æµï¼Œå¦‚ä½•åˆ†éš”å„ä¸ªå­—æ®µï¼Ÿ
æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ•°æ®æœ€ç»ˆåœ¨ä¼ è¾“çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä»¥ä¸€ä¸ªä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶å½¢å¼ä¼ è¾“çš„ï¼Œé¢å¯¹ä¸€é•¿ä¸²çš„å­—èŠ‚æµï¼Œå¦‚ä½•ç¡®å®šæ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæ®µå‘¢ï¼Ÿ</div><p>åœ¨æ¯ä¸ªå­—æ®µçš„å­—èŠ‚æµæœ€å‰é¢ï¼Œä¼šæœ‰å‡ ä¸ªç‰¹æ®Šå­—èŠ‚ï¼Œç§°ä¸º <code>Tag</code>ï¼Œ<code>Tag</code> å°±å……å½“äº†è¾¹ç•Œçš„ä½œç”¨ï¼Œåˆ†éš”å„ä¸ªå­—æ®µã€‚</p><p>å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå­—èŠ‚æµçœ‹æˆä¸€ä¸ªä¸ªç”± <code>Tag</code> å’Œæ•°æ®(value)ç»„æˆçš„ç»“æ„ã€‚</p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202202262050060.jpeg alt=TV></p><p><code>Tag</code> ä¸ä»…ä»…åªæ˜¯èµ·åˆ°äº†åˆ†éš”å­—æ®µçš„ä½œç”¨ï¼Œå®ƒè¿˜æ‰¿è½½äº†ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>Tag</code> æ˜¯å¦‚ä½•ç”Ÿæˆçš„:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>makeTag</span>(<span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> fieldNumber, <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> wireType)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (filedNumber <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>3</span>) <span style=color:#f92672>|</span> wireType;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…¶ä¸­çš„<code>fieldNumber</code>ï¼Œå°±æ˜¯æˆ‘ä»¬å®šä¹‰ç»“æ„ä½“æ—¶ç»™çš„ç¼–å·ï¼Œ<code>wireType</code>æœ‰ä»¥ä¸‹å‡ ä¸ªå€¼ï¼š</p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202202262216861.png alt=wireType></p><p><code>wireType</code>æ€»å…±åªæœ‰ 5 ä¸ªå€¼ï¼Œç”¨äºŒè¿›åˆ¶æ¥è¡¨ç¤ºåªéœ€è¦ 3 ä½ï¼Œ<code>filedNumber &lt;&lt; 3</code>æŠŠ<code>filedNumber</code>å·¦ç§» 3 ä½ï¼Œç„¶åä¸<code>wireType</code>åšæˆ–è¿ç®—ï¼Œ<code>wireType</code>å³æ˜¯<code>Tag</code>çš„æœ€å 3 ä½ã€‚</p><div class="tips warn"><p id=tips-title>QUESTION3 ğŸ™‹â€â™‚ï¸</p>Tagå¦‚ä½•ä¿è¯ä¸å’ŒValueæ··æ·†ï¼Ÿ</div><p><code>Tag</code> å’Œ<code>Value</code>åœ¨å­—èŠ‚æµä¸­éƒ½æ˜¯ä¸€ä¸ªä¸ªå­—èŠ‚ï¼Œå¦‚æœå­—èŠ‚ç›¸åŒï¼Œé‚£å°±ä¼šæŠŠ<code>value</code>è¯¯è®¤ä¸º <code>Tag</code>ï¼Œè§£æå°±ä¼šå‡ºé”™ã€‚</p><p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ protobuf åºåˆ—åŒ–æˆå­—èŠ‚æµæ—¶çš„ç¼–ç æ–¹å¼</p><h3 id=å¯å˜é•¿åº¦ç¼–ç varint>å¯å˜é•¿åº¦ç¼–ç (Varint)<a hidden class=anchor aria-hidden=true href=#å¯å˜é•¿åº¦ç¼–ç varint>#</a></h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œæ•´æ•°ç±»å‹çš„é•¿åº¦éƒ½æ˜¯ç¡®å®šçš„ï¼Œå¦‚ int ç±»å‹çš„é•¿åº¦ä¸º 4 ä¸ªå­—èŠ‚ï¼Œå¯è¡¨ç¤ºçš„æ•´æ•°èŒƒå›´ä¸º-231â€”â€”231-1ï¼Œä½†æ˜¯å®é™…ä¼ è¾“ä¸­çš„æ•°å­—å‡æ¯”è¾ƒå°ï¼Œä¼šé€ æˆå­—èŠ‚æµªè´¹ï¼Œå¯å˜é•¿åº¦ç¼–ç å°±èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯å˜é•¿åº¦ç¼–ç è§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li>å­—èŠ‚æœ€é«˜ä½è¡¨ç¤ºæ•°æ®æ˜¯å¦ç»“æŸï¼Œå¦‚æœæœ€é«˜ä½ä¸º 1ï¼Œåˆ™è¡¨ç¤ºåé¢çš„å­—èŠ‚ä¹Ÿæ˜¯è¯¥æ•°æ®çš„ä¸€éƒ¨åˆ†</li></ul><p>å¯å˜é•¿åº¦ç¼–ç å”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯å½“æ•°å¾ˆå¤§çš„æ—¶å€™ int32 éœ€è¦å ç”¨ 5 ä¸ªå­—èŠ‚ï¼Œå› ä¸ºå»æ‰å­—èŠ‚æœ€é«˜ä½åï¼Œä¸€ä¸ªå­—èŠ‚èƒ½ç”¨æ¥è¡¨ç¤ºæ•°æ®çš„åªå‰© 7 ä½ï¼Œä½†æ˜¯ä»ç»Ÿè®¡å­¦è§’åº¦æ¥è¯´ï¼Œä¸€èˆ¬ä¸ä¼šæœ‰è¿™ä¹ˆå¤§çš„æ•°ã€‚</p><blockquote><p>ä¸Šæ–‡æåˆ°çš„Tagï¼Œè¿˜éœ€è¦ 3 ä½è¡¨ç¤ºæ•°æ®ç±»å‹ï¼Œç”¨æ¥è¡¨ç¤ºç¼–å·çš„ä½æ•°ä¸º 4 ä½æ—¶(èƒ½è¡¨ç¤º 15 ä¸ªç¼–å·)ï¼ŒTagæ‰èƒ½ç”¨ 1 ä¸ªå­—èŠ‚è£…ä¸‹ã€‚</p></blockquote><div class="tips info"><p id=tips-title>è´Ÿæ•°é—®é¢˜</p>æ•´æ•°åœ¨è®¡ç®—æœºä¸­æ˜¯ä»¥è¡¥ç å½¢å¼å­˜å‚¨çš„ï¼Œ-1 çš„è¡¥ç å½¢å¼æ˜¯<code>1111 1111 1111 1111</code>ï¼Œè¿™æ ·çš„å€¼åœ¨ä½¿ç”¨å¯å˜é•¿åº¦ç¼–ç æ—¶çš„æ•ˆç‡éå¸¸ä½ï¼Œæ‰€ä»¥å¦‚æœè¦ä½¿ç”¨è´Ÿæ•°å¼ºçƒˆä¸å»ºè®®ä½¿ç”¨ int32 å’Œ int64ï¼Œå»ºè®®ä½¿ç”¨ sint32 å’Œ sint64ï¼Œsint32 å’Œ sint64 ä¼šä½¿ç”¨ zigZag ç¼–ç ï¼Œç”Ÿæˆçš„æ•°å†ä½¿ç”¨å¯å˜é•¿åº¦ç¼–ç </div><p>ä¸‹é¢ä»‹ç»ä¸€ä¸‹ zigzag ç¼–ç ã€‚</p><p>zigzag ç¼–ç æœºåˆ¶å¦‚ä¸‹:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Zigzag(n) = (n &lt;&lt; 1) ^ (n &gt;&gt; 31), n ä¸º sint32 æ—¶
</span></span><span style=display:flex><span>Zigzag(n) = (n &lt;&lt; 1) ^ (n &gt;&gt; 63), n ä¸º sint64 æ—¶
</span></span></code></pre></div><p>å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š</p><ul><li>è´Ÿæ•°: x = 2|x| -1</li><li>æ­£æ•°: x = 2|x|</li></ul><p>ä¸‹å›¾æ˜¯ä¸€äº›æ•°æŒ‰ç…§ zigzag ç¼–ç æ–¹å¼åå¾—åˆ°çš„æ•°ï¼š</p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202202271309033.png alt=zigzagç¼–ç ></p><p>æˆ‘ä»¬æŠŠæ•°å…ˆç»è¿‡ zigzag ç¼–ç åå†è¿›è¡Œä¸å®šé•¿ç¼–ç ï¼Œå°±èƒ½å¤Ÿæé«˜è´Ÿæ•°åœ¨ä¸å®šé•¿ç¼–ç ä¸­çš„æ•ˆç‡ã€‚</p><h3 id=å®šé•¿ç¼–ç >å®šé•¿ç¼–ç <a hidden class=anchor aria-hidden=true href=#å®šé•¿ç¼–ç >#</a></h3><p>ä¸Šæ–‡è®²åˆ°çš„ Varint å’Œ zigzag ç¼–ç éƒ½æ˜¯é’ˆå¯¹æ•°å­—è¿›è¡Œç¼–ç ï¼Œåœ¨ç¼–ç å­—ç¬¦æ—¶ä½¿ç”¨çš„æ˜¯å®šé•¿ç¼–ç ï¼Œå®šé•¿ç¼–ç åœ¨å­—èŠ‚æµä¸­çš„ç»“æ„æ˜¯ TLVï¼Œå³<code>Tag-Length-Value</code>ï¼ŒLength æ˜¯ä¸€ä¸ªæ•°å­—(ä¹Ÿä¼šç”¨ Varint ç¼–ç )ï¼Œè®°å½•çš„æ˜¯åé¢ value æ‰€å çš„å­—èŠ‚æ•°ã€‚</p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202202271330628.jpeg alt=TLV></p><p>å®é™…çš„å­—èŠ‚æµä¸æ˜¯åªæœ‰ TV æˆ–è€… TLVï¼Œæ˜¯ TV å’Œ TLV æ··åˆåœ¨ä¸€èµ·çš„ã€‚</p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202202271347956.jpeg alt=TVå’ŒTVLæ··åˆ></p><p>æˆ‘ä»¬ç°åœ¨å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆä¸ä¼šå‡ºç°æ··æ·†é—®é¢˜äº†ï¼Œæˆ‘ä»¬åœ¨è§£ææ—¶ï¼Œé¦–å…ˆä¼šå–ç¬¬ä¸€ä¸ª<code>Tag</code>ï¼Œå› ä¸º<code>Tag</code>ä½¿ç”¨äº† Varint ç¼–ç ï¼Œæ ¹æ® Varint ç¼–ç è§„åˆ™ï¼Œå¦‚æœ<code>Tag</code>åªæœ‰ä¸€ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—èŠ‚çš„é¦–ä½ä¼šä¸º 0ï¼Œå¦‚æœ<code>Tag</code>å¤§äº 1 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆç»§ç»­å¾€åå–åˆ°é¦–ä½ä¸º 0 çš„é‚£ä¸€ä¸ªå­—èŠ‚ï¼Œå³å¯æ­£ç¡®è·å–<code>Tag</code>ã€‚æ¥ç€æˆ‘ä»¬é€šè¿‡<code>Tag</code>çš„äºŒè¿›åˆ¶åä¸‰ä½å¯ä»¥å¾—åˆ°å­—æ®µçš„ç±»å‹<code>wireType</code>ï¼Œåˆ†ä¸¤ç§æƒ…å†µ:</p><ul><li>å¦‚æœç±»å‹æ˜¯æ•°å­—ï¼Œé‚£ä¹ˆè¿™æ˜¯ä¸€ä¸ª TV ç»“æ„ï¼Œ<code>Value</code>é‡‡ç”¨ä¸å®šé•¿ç¼–ç ï¼Œæˆ‘ä»¬æ ¹æ®ä¸å®šé•¿ç¼–ç è§„åˆ™å–å¾—<code>Value</code>åï¼Œå†å¾€åå°±æ˜¯ä¸‹ä¸€ä¸ª<code>Tag</code>äº†ã€‚</li><li>å¦‚æœç±»å‹æ˜¯å­—ç¬¦ï¼Œé‚£ä¹ˆè¿™ä¼šæ˜¯ä¸€ä¸ª TLV ç»“æ„ï¼Œæˆ‘ä»¬å…ˆæ ¹æ®ä¸å®šé•¿ç¼–ç è§„åˆ™è·å–<code>Length</code>ï¼Œ<code>Length</code>è®°å½•äº†<code>Value</code>çš„å­—èŠ‚æ•° nï¼Œåé¢çš„ n ä¸ªå­—èŠ‚å³æ˜¯<code>Value</code>ï¼Œå†å¾€åå°±æ˜¯ä¸‹ä¸€ä¸ª<code>Tag</code>ã€‚</li></ul><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½æ¸…æ¥šçŸ¥é“å½“å‰çš„å­—èŠ‚æ˜¯<code>Tag</code>ã€<code>Length</code>è¿˜æ˜¯<code>Value</code>ï¼Œä¸ä¼šå‡ºç°æ··æ·†çš„æƒ…å†µã€‚</p><h2 id=ä¸ºä»€ä¹ˆ-protobuf-çš„æ€§èƒ½æ›´å¥½>ä¸ºä»€ä¹ˆ protobuf çš„æ€§èƒ½æ›´å¥½ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#ä¸ºä»€ä¹ˆ-protobuf-çš„æ€§èƒ½æ›´å¥½>#</a></h2><ol><li>æ²¡æœ‰åºåˆ—åŒ– keyï¼Œé€šè¿‡ç¼–å·ä»£æ›¿</li><li>å¯å˜é•¿åº¦ç¼–ç å’Œ zigzag ç¼–ç ï¼Œå‡å°å­—èŠ‚å ç”¨</li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.yici.xin/tags/protobuf/>protobuf</a></li></ul><nav class=paginav><a class=prev href=https://www.yici.xin/post/tech/protobuf%E8%AF%AD%E6%B3%95/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>Protobufè¯­æ³•</span></a>
<a class=next href=https://www.yici.xin/post/tech/rust%E7%9A%84%E6%89%80%E6%9C%89%E6%9D%83%E7%B3%BB%E7%BB%9F/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>Rustçš„æ‰€æœ‰æƒç³»ç»Ÿ</span></a></nav></footer><script type=text/javascript>let giscusTheme=localStorage.getItem("pref-theme")==="dark"?"dark_dimmed":"light",giscusAttributes={src:"https://giscus.app/client.js","data-repo":"yicixin/blog_comment","data-repo-id":"R_kgDOIr6QyQ","data-category":"Announcements","data-category-id":"DIC_kwDOIr6Qyc4CTSs3","data-mapping":"title","data-reactions-enabled":"1","data-emit-metadata":"0","data-theme":giscusTheme===null?"light":giscusTheme,"data-lang":"zh-CN",crossorigin:"anonymous","data-loading":"lazy",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([e,t])=>giscusScript.setAttribute(e,t));var article=document.getElementsByTagName("article")[0].appendChild(giscusScript);function changeGiscusTheme(){const e=localStorage.getItem("pref-theme")==="dark"?"light":"dark_dimmed";function t(e){const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}t({setConfig:{theme:e}})}const toggle=document.querySelector("#theme-toggle");toggle&&toggle.addEventListener("click",changeGiscusTheme)</script><script src=https://giscus.app/client.js data-repo=yicixin/blog_comment data-repo-id=R_kgDOIr6QyQ data-category=Announcements data-category-id=DIC_kwDOIr6Qyc4CTSs3 data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.yici.xin/>yicixin's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="ctrl\u002bc";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="ctrl\u002bc"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script src=https://code.jquery.com/jquery-1.12.4.min.js></script>
<script>$("code[class^=language] ").on("mouseover",function(){this.clientWidth<this.scrollWidth&&$(this).css("width","135%")}).on("mouseout",function(){$(this).css("width","100%"),$(".copy-code").css("right","4px")})</script></body></html>