<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css integrity=sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.2.1.slim.min.js integrity=sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js integrity=sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js integrity=sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl crossorigin=anonymous></script><title>Go channel | yicixin's blog</title><meta name=keywords content><meta name=description content="æ•°æ®ç»“æ„ channel çš„åº•å±‚æºç å’Œç›¸å…³å®ç°åœ¨/src/runtime/chan.goä¸­ã€‚
type hchan struct { qcount uint // é˜Ÿåˆ—ä¸­æ‰€æœ‰æ•°æ®æ€»æ•° dataqsiz uint // ç¯å½¢é˜Ÿåˆ—çš„ size buf unsafe.Pointer // æŒ‡å‘ dataqsiz é•¿åº¦çš„æ•°ç»„ elemsize uint16 // å…ƒç´ å¤§å° closed uint32 elemtype *_type // å…ƒç´ ç±»å‹ sendx uint // å·²å‘é€çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½® recvx uint // å·²æ¥æ”¶çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½® recvq waitq // æ¥æ”¶è€…çš„ç­‰å¾…é˜Ÿåˆ— sendq waitq // å‘é€è€…çš„ç­‰å¾…é˜Ÿåˆ— // lock é”ä¿æŠ¤ hchan ä¸­çš„æ‰€æœ‰å­—æ®µï¼Œä»¥åŠæ­¤é€šé“ä¸Šè¢«é˜»å¡çš„ sudogs ä¸­çš„å¤šä¸ªå­—æ®µã€‚ // æŒæœ‰ lock çš„æ—¶å€™ï¼Œç¦æ­¢æ›´æ”¹å¦ä¸€ä¸ª G çš„çŠ¶æ€ï¼ˆç‰¹åˆ«æ˜¯ä¸è¦ä½¿ G çŠ¶æ€å˜æˆreadyï¼‰ï¼Œ // å› ä¸ºè¿™ä¼šå› ä¸ºå †æ ˆ shrinking è€Œå‘ç”Ÿæ­»é”ã€‚ lock mutex } recvq å’Œ sendq æ˜¯ç­‰å¾…é˜Ÿåˆ—ï¼Œwaitq æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼š"><meta name=author content="å£¹æ¬¡å¿ƒ"><link rel=canonical href=https://www.yici.xin/post/tech/go-channel/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.00d594ac5404702263b7df2f247aae4053818963176b093f9b95a1fc7e4e0b42.css integrity="sha256-ANWUrFQEcCJjt98vJHquQFOBiWMXawk/m5Wh/H5OC0I=" rel="preload stylesheet" as=style><link rel=icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=icon type=image/png sizes=16x16 href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=icon type=image/png sizes=32x32 href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=apple-touch-icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=mask-icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Go channel"><meta property="og:description" content="æ•°æ®ç»“æ„ channel çš„åº•å±‚æºç å’Œç›¸å…³å®ç°åœ¨/src/runtime/chan.goä¸­ã€‚
type hchan struct { qcount uint // é˜Ÿåˆ—ä¸­æ‰€æœ‰æ•°æ®æ€»æ•° dataqsiz uint // ç¯å½¢é˜Ÿåˆ—çš„ size buf unsafe.Pointer // æŒ‡å‘ dataqsiz é•¿åº¦çš„æ•°ç»„ elemsize uint16 // å…ƒç´ å¤§å° closed uint32 elemtype *_type // å…ƒç´ ç±»å‹ sendx uint // å·²å‘é€çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½® recvx uint // å·²æ¥æ”¶çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½® recvq waitq // æ¥æ”¶è€…çš„ç­‰å¾…é˜Ÿåˆ— sendq waitq // å‘é€è€…çš„ç­‰å¾…é˜Ÿåˆ— // lock é”ä¿æŠ¤ hchan ä¸­çš„æ‰€æœ‰å­—æ®µï¼Œä»¥åŠæ­¤é€šé“ä¸Šè¢«é˜»å¡çš„ sudogs ä¸­çš„å¤šä¸ªå­—æ®µã€‚ // æŒæœ‰ lock çš„æ—¶å€™ï¼Œç¦æ­¢æ›´æ”¹å¦ä¸€ä¸ª G çš„çŠ¶æ€ï¼ˆç‰¹åˆ«æ˜¯ä¸è¦ä½¿ G çŠ¶æ€å˜æˆreadyï¼‰ï¼Œ // å› ä¸ºè¿™ä¼šå› ä¸ºå †æ ˆ shrinking è€Œå‘ç”Ÿæ­»é”ã€‚ lock mutex } recvq å’Œ sendq æ˜¯ç­‰å¾…é˜Ÿåˆ—ï¼Œwaitq æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼š"><meta property="og:type" content="article"><meta property="og:url" content="https://www.yici.xin/post/tech/go-channel/"><meta property="og:image" content="https://www.yici.xin/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-11-21T09:45:13+08:00"><meta property="article:modified_time" content="2022-11-21T09:45:13+08:00"><meta property="og:site_name" content="yicixin's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.yici.xin/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Go channel"><meta name=twitter:description content="æ•°æ®ç»“æ„ channel çš„åº•å±‚æºç å’Œç›¸å…³å®ç°åœ¨/src/runtime/chan.goä¸­ã€‚
type hchan struct { qcount uint // é˜Ÿåˆ—ä¸­æ‰€æœ‰æ•°æ®æ€»æ•° dataqsiz uint // ç¯å½¢é˜Ÿåˆ—çš„ size buf unsafe.Pointer // æŒ‡å‘ dataqsiz é•¿åº¦çš„æ•°ç»„ elemsize uint16 // å…ƒç´ å¤§å° closed uint32 elemtype *_type // å…ƒç´ ç±»å‹ sendx uint // å·²å‘é€çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½® recvx uint // å·²æ¥æ”¶çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½® recvq waitq // æ¥æ”¶è€…çš„ç­‰å¾…é˜Ÿåˆ— sendq waitq // å‘é€è€…çš„ç­‰å¾…é˜Ÿåˆ— // lock é”ä¿æŠ¤ hchan ä¸­çš„æ‰€æœ‰å­—æ®µï¼Œä»¥åŠæ­¤é€šé“ä¸Šè¢«é˜»å¡çš„ sudogs ä¸­çš„å¤šä¸ªå­—æ®µã€‚ // æŒæœ‰ lock çš„æ—¶å€™ï¼Œç¦æ­¢æ›´æ”¹å¦ä¸€ä¸ª G çš„çŠ¶æ€ï¼ˆç‰¹åˆ«æ˜¯ä¸è¦ä½¿ G çŠ¶æ€å˜æˆreadyï¼‰ï¼Œ // å› ä¸ºè¿™ä¼šå› ä¸ºå †æ ˆ shrinking è€Œå‘ç”Ÿæ­»é”ã€‚ lock mutex } recvq å’Œ sendq æ˜¯ç­‰å¾…é˜Ÿåˆ—ï¼Œwaitq æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼š"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.yici.xin/post/"},{"@type":"ListItem","position":2,"name":"ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯","item":"https://www.yici.xin/post/tech/"},{"@type":"ListItem","position":3,"name":"Go channel","item":"https://www.yici.xin/post/tech/go-channel/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go channel","name":"Go channel","description":"æ•°æ®ç»“æ„ channel çš„åº•å±‚æºç å’Œç›¸å…³å®ç°åœ¨/src/runtime/chan.goä¸­ã€‚\ntype hchan struct { qcount uint // é˜Ÿåˆ—ä¸­æ‰€æœ‰æ•°æ®æ€»æ•° dataqsiz uint // ç¯å½¢é˜Ÿåˆ—çš„ size buf unsafe.Pointer // æŒ‡å‘ dataqsiz é•¿åº¦çš„æ•°ç»„ elemsize uint16 // å…ƒç´ å¤§å° closed uint32 elemtype *_type // å…ƒç´ ç±»å‹ sendx uint // å·²å‘é€çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½® recvx uint // å·²æ¥æ”¶çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½® recvq waitq // æ¥æ”¶è€…çš„ç­‰å¾…é˜Ÿåˆ— sendq waitq // å‘é€è€…çš„ç­‰å¾…é˜Ÿåˆ— // lock é”ä¿æŠ¤ hchan ä¸­çš„æ‰€æœ‰å­—æ®µï¼Œä»¥åŠæ­¤é€šé“ä¸Šè¢«é˜»å¡çš„ sudogs ä¸­çš„å¤šä¸ªå­—æ®µã€‚ // æŒæœ‰ lock çš„æ—¶å€™ï¼Œç¦æ­¢æ›´æ”¹å¦ä¸€ä¸ª G çš„çŠ¶æ€ï¼ˆç‰¹åˆ«æ˜¯ä¸è¦ä½¿ G çŠ¶æ€å˜æˆreadyï¼‰ï¼Œ // å› ä¸ºè¿™ä¼šå› ä¸ºå †æ ˆ shrinking è€Œå‘ç”Ÿæ­»é”ã€‚ lock mutex } recvq å’Œ sendq æ˜¯ç­‰å¾…é˜Ÿåˆ—ï¼Œwaitq æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼š","keywords":[""],"articleBody":"æ•°æ®ç»“æ„ channel çš„åº•å±‚æºç å’Œç›¸å…³å®ç°åœ¨/src/runtime/chan.goä¸­ã€‚\ntype hchan struct { qcount uint // é˜Ÿåˆ—ä¸­æ‰€æœ‰æ•°æ®æ€»æ•° dataqsiz uint // ç¯å½¢é˜Ÿåˆ—çš„ size buf unsafe.Pointer // æŒ‡å‘ dataqsiz é•¿åº¦çš„æ•°ç»„ elemsize uint16 // å…ƒç´ å¤§å° closed uint32 elemtype *_type // å…ƒç´ ç±»å‹ sendx uint // å·²å‘é€çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½® recvx uint // å·²æ¥æ”¶çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½® recvq waitq // æ¥æ”¶è€…çš„ç­‰å¾…é˜Ÿåˆ— sendq waitq // å‘é€è€…çš„ç­‰å¾…é˜Ÿåˆ— // lock é”ä¿æŠ¤ hchan ä¸­çš„æ‰€æœ‰å­—æ®µï¼Œä»¥åŠæ­¤é€šé“ä¸Šè¢«é˜»å¡çš„ sudogs ä¸­çš„å¤šä¸ªå­—æ®µã€‚ // æŒæœ‰ lock çš„æ—¶å€™ï¼Œç¦æ­¢æ›´æ”¹å¦ä¸€ä¸ª G çš„çŠ¶æ€ï¼ˆç‰¹åˆ«æ˜¯ä¸è¦ä½¿ G çŠ¶æ€å˜æˆreadyï¼‰ï¼Œ // å› ä¸ºè¿™ä¼šå› ä¸ºå †æ ˆ shrinking è€Œå‘ç”Ÿæ­»é”ã€‚ lock mutex } recvq å’Œ sendq æ˜¯ç­‰å¾…é˜Ÿåˆ—ï¼Œwaitq æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼š\ntype waitq struct { first *sudog last *sudog } // sudog è¡¨ç¤ºä¸€ä¸ªåœ¨ç­‰å¾…åˆ—è¡¨ä¸­çš„g, ä¾‹å¦‚åœ¨ä¸€ä¸ªchannelä¸Šç­‰å¾…å‘é€/æ¥æ”¶. // sudog æ˜¯ Go ä¸­éå¸¸é‡è¦çš„æ•°æ®ç»“æ„. // g ä¸åŒæ­¥å¯¹è±¡å…³ç³»å¯ä»¥æ˜¯å¤šå¯¹å¤šçš„ï¼Œä¸€ä¸ª g èƒ½å‡ºç°åœ¨è®¸å¤šç­‰å¾…é˜Ÿåˆ—ä¸Š(ä¾‹å¦‚ä½¿ç”¨selectç­‰å¾…å¤šä¸ªchannel)ï¼Œå› æ­¤ä¸€ä¸ª g å¯èƒ½æœ‰å¾ˆå¤šsudogã€‚ // å¹¶ä¸”å¤šä¸ª g å¯èƒ½æ­£åœ¨ç­‰å¾…åŒä¸€ä¸ªåŒæ­¥å¯¹è±¡(å¤šä¸ªåç¨‹ç­‰å¾…åŒä¸€ä¸ªchannel)ï¼Œå› æ­¤ä¸€ä¸ªå¯¹è±¡å¯èƒ½æœ‰è®¸å¤š sudogã€‚ // sudog æ˜¯ä»ç‰¹æ®Šæ± ä¸­åˆ†é…å‡ºæ¥çš„ã€‚ä½¿ç”¨ acquireSudog å’Œ releaseSudog åˆ†é…å’Œé‡Šæ”¾å®ƒä»¬ã€‚ type sudog struct { // The following fields are protected by the hchan.lock of the // channel this sudog is blocking on. shrinkstack depends on // this for sudogs involved in channel ops. g *g next *sudog prev *sudog elem unsafe.Pointer // data element (may point to stack) // ä»¥ä¸‹çš„ä¸‰ä¸ªå­—æ®µæ°¸è¿œä¸ä¼šè¢«åŒæ—¶è®¿é—®. // å¯¹channelæ¥è¯´ï¼Œwaitlinkä»…å…è®¸gè®¿é—®. // å¯¹semaphoresæ¥è¯´ï¼Œåªæœ‰åœ¨æŒæœ‰semaRooté”çš„æ—¶å€™æ‰èƒ½è®¿é—®è¿™ä¸‰ä¸ªå­—æ®µ. acquiretime int64 releasetime int64 ticket uint32 // isSelect è¡¨ç¤º g æ˜¯å¦è¢«é€‰æ‹©. // g.selectDone å¿…é¡»è¿›è¡Œ CAS æ‰èƒ½åœ¨è¢«å”¤é†’çš„ç«äº‰ä¸­èƒœå‡º. isSelect bool // success è¡¨ç¤º channel c ä¸Šçš„é€šä¿¡æ˜¯å¦æˆåŠŸ. // å¦‚æœgoroutineå› channelä¸Šæ´¾å‘äº†ä¸€ä¸ªå€¼è€Œè¢«å”¤é†’ï¼Œsuccessä¸ºtrueï¼Œ // å¦‚æœæ˜¯å› ä¸ºchannelå…³é—­è€Œå”¤é†’ï¼Œåˆ™ä¸ºfalse success bool parent *sudog // semaRoot binary tree waitlink *sudog // g.waiting list or semaRoot waittail *sudog // semaRoot c *hchan // channel } åˆ›å»ºchannel åˆ›å»ºchannelçš„å‡½æ•°ä½äº/src/runtime/chan.go:72\n// params: // t: channelçš„ç±»å‹æºæ•°æ® // size: channelçš„å¤§å°ï¼Œ å¯¹åº”hchanä¸­dataqsizå¤§å° func makechan(t *chantype, size int) *hchan { elem := t.elem // ç¼–è¯‘å™¨æ£€æŸ¥æ•°æ®é¡¹å¤§å°ä¸èƒ½è¶…è¿‡ 64KB if elem.size \u003e= 1\u003c\u003c16 { throw(\"makechan: invalid channel element type\") } // æ£€æŸ¥å¯¹é½æ˜¯å¦æ­£ç¡® if hchanSize%maxAlign != 0 || elem.align \u003e maxAlign { throw(\"makechan: bad alignment\") } // ç¼“å†²åŒºå¤§å°æ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦æº¢å‡º mem, overflow := math.MulUintptr(elem.size, uintptr(size)) if overflow || mem \u003e maxAlloc-hchanSize || size \u003c 0 { panic(plainError(\"makechan: size out of range\")) } var c *hchan switch { case mem == 0: // memä¸º0ï¼Œåˆ™ä»£è¡¨é˜Ÿåˆ—æˆ–è€…å…ƒç´ å¤§å°ä¸ºzero. c = (*hchan)(mallocgc(hchanSize, nil, true)) // Race ç«äº‰æ£€æŸ¥åˆ©ç”¨è¿™ä¸ªåœ°å€æ¥è¿›è¡ŒåŒæ­¥æ“ä½œ. c.buf = c.raceaddr() case elem.ptrdata == 0: // å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆï¼Œä½¿ç”¨è¿ç»­çš„å†…å­˜ç©ºé—´ä¸€æ¬¡æ€§åˆ†é…hchanå’Œbufæ‰€éœ€çš„å†…å­˜ c = (*hchan)(mallocgc(hchanSize+mem, nil, true)) c.buf = add(unsafe.Pointer(c), hchanSize) default: // å…ƒç´ åŒ…å«æŒ‡é’ˆ c = new(hchan) c.buf = mallocgc(mem, elem, true) } // è®¾ç½®å±æ€§ c.elemsize = uint16(elem.size) c.elemtype = elem c.dataqsiz = uint(size) lockInit(\u0026c.lock, lockRankHchan) if debugChan { print(\"makechan: chan=\", c, \"; elemsize=\", elem.size, \"; dataqsiz=\", size, \"\\n\") } return c } ä¸Šé¢è¿™æ®µ makechan() ä»£ç ä¸»è¦ç›®çš„æ˜¯ç”Ÿæˆ *hchanå¯¹è±¡ã€‚é‡ç‚¹å…³æ³¨ switch-case ä¸­çš„ 3 ç§æƒ…å†µ\nå½“é˜Ÿåˆ—æˆ–è€…å…ƒç´ å¤§å°ä¸º 0 æ—¶ï¼Œè°ƒç”¨ mallocgc() åœ¨å †ä¸Šä¸º channel å¼€è¾Ÿä¸€æ®µå¤§å°ä¸º hchanSize çš„å†…å­˜ç©ºé—´ã€‚ å½“å…ƒç´ ç±»å‹ä¸æ˜¯æŒ‡é’ˆç±»å‹æ—¶ï¼Œè°ƒç”¨ mallocgc() åœ¨å †ä¸Šå¼€è¾Ÿä¸º channel å’Œåº•å±‚ buf ç¼“å†²åŒºæ•°ç»„å¼€è¾Ÿä¸€æ®µå¤§å°ä¸º hchanSize + mem è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚ é»˜è®¤æƒ…å†µå…ƒç´ ç±»å‹ä¸­æœ‰æŒ‡é’ˆç±»å‹ï¼Œè°ƒç”¨ mallocgc() åœ¨å †ä¸Šåˆ†åˆ«ä¸º channel å’Œ buf ç¼“å†²åŒºåˆ†é…å†…å­˜ã€‚ å®Œæˆç¬¬ä¸€æ­¥çš„å†…å­˜åˆ†é…ä¹‹åï¼Œå†å°±æ˜¯ hchan æ•°æ®ç»“æ„å…¶ä»–å­—æ®µçš„åˆå§‹åŒ–å’Œ lock çš„åˆå§‹åŒ–ã€‚å€¼å¾—è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼Œå½“å­˜å‚¨åœ¨ buf ä¸­çš„å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆæ—¶ï¼ŒHchan ä¸­ä¹Ÿä¸åŒ…å« GC å…³å¿ƒçš„æŒ‡é’ˆã€‚buf æŒ‡å‘ä¸€æ®µç›¸åŒå…ƒç´ ç±»å‹çš„å†…å­˜ï¼Œelemtype å›ºå®šä¸å˜ã€‚ SudoG æ˜¯ä»å®ƒä»¬è‡ªå·±çš„çº¿ç¨‹ä¸­å¼•ç”¨çš„ï¼Œå› æ­¤åƒåœ¾å›æ”¶çš„æ—¶å€™æ— æ³•å›æ”¶å®ƒä»¬ã€‚å—åˆ°åƒåœ¾å›æ”¶å™¨çš„é™åˆ¶ï¼ŒæŒ‡é’ˆç±»å‹çš„ç¼“å†² buf éœ€è¦å•ç‹¬åˆ†é…å†…å­˜ã€‚å®˜æ–¹åœ¨è¿™é‡ŒåŠ äº†ä¸€ä¸ª TODOï¼Œåƒåœ¾å›æ”¶çš„æ—¶å€™è¿™æ®µä»£ç é€»è¾‘éœ€è¦é‡æ–°è€ƒè™‘ã€‚\nå› ä¸º channel çš„åˆ›å»ºå…¨éƒ¨è°ƒç”¨çš„ mallocgc()ï¼Œåœ¨å †ä¸Šå¼€è¾Ÿçš„å†…å­˜ç©ºé—´ï¼Œchannel æœ¬èº«ä¼šè¢« GC è‡ªåŠ¨å›æ”¶ã€‚æœ‰äº†è¿™ä¸€æ€§è´¨ï¼Œæ‰€ä»¥æ‰æœ‰äº†ä¸‹æ–‡å…³é—­ channel ä¸­ä¼˜é›…å…³é—­çš„æ–¹æ³•ã€‚ å‘é€æ•°æ® å¾€channelå‘é€æ•°æ®çš„ä»£ç åœ¨/src/runtime/chan.go:159.\nå¼‚å¸¸æ£€æŸ¥ // params: // c: chansendæ‰€æ“ä½œçš„channel // ep: å‘é€çš„å€¼ // block: æ˜¯å¦é˜»å¡å‘é€ï¼Œå³åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ // callerpc: è°ƒç”¨è€…çš„pcå¯„å­˜å™¨åœ°å€ func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool { // åˆ¤æ–­channelæ˜¯å¦ä¸ºnil, æœä¸€ä¸ªä¸º nil çš„ channel å‘é€æ•°æ®ä¼šå‘ç”Ÿé˜»å¡ã€‚ // gopark ä¼šå¼•å‘ä»¥ waitReasonChanSendNilChan ä¸ºåŸå› çš„ä¼‘çœ ï¼Œå¹¶æŠ›å‡º unreachable çš„ fatal errorã€‚ if c == nil { if !block { return false } gopark(nil, nil, waitReasonChanSendNilChan, traceEvGoStop, 2) throw(\"unreachable\") } if debugChan { print(\"chansend: chan=\", c, \"\\n\") } if raceenabled { racereadpc(c.raceaddr(), callerpc, abi.FuncPCABIInternal(chansend)) } // å½“ channel ä¸ä¸º nilï¼Œå¹¶ä¸” channel æ²¡æœ‰ close æ—¶ï¼Œè¿˜éœ€è¦æ£€æŸ¥æ­¤æ—¶ channel æ˜¯å¦å¯ä»¥sendï¼Œå³åˆ¤æ–­ full(c) if !block \u0026\u0026 c.closed == 0 \u0026\u0026 full(c) { return false } ... fullçš„ä»£ç :\n// fullåæ˜ åœ¨cä¸Šçš„ä¸€ä¸ªsendæ˜¯å¦ä¼šé˜»å¡(å³channelæ˜¯å¦å·²æ»¡) func full(c *hchan) bool { // c.dataqsiz æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€ä»¥åœ¨channelåˆ›å»ºåï¼Œè¯¥å€¼éƒ½æ˜¯å¯ä»¥å®‰å…¨è¯»å–çš„ if c.dataqsiz == 0 { return c.recvq.first == nil } return c.qcount == c.dataqsiz } è¿™æ®µæ£€æŸ¥å¤±è´¥çš„éé˜»å¡æ“ä½œå¹¶æ²¡æœ‰ä¸Šé”ï¼Œè€Œæ˜¯åœ¨æ£€æŸ¥ä¹‹åè¿›è¡Œçš„ä¸Šé”æ“ä½œã€‚è¿™ä¸ªåŸå› åœ¨æºç ä¸­æœ‰æ³¨é‡Šè¿›è¡Œäº†é˜è¿°ï¼Œæˆ‘è¿›è¡Œä¸€ä¸‹æ¶¦è‰²è§£é‡Šï¼š !block \u0026\u0026 c.closed == 0 \u0026\u0026 full(c)ï¼Œåœ¨è¿™ä¸ªåˆ¤æ–­ä¸­ï¼Œæˆ‘ä»¬å…ˆè§‚å¯Ÿåˆ°channelæ˜¯æœªå…³é—­çŠ¶æ€ï¼Œå†è§‚å¯Ÿchannelæ˜¯å¦fullï¼Œè¿™ä¸¤æ­¥ä¸­çš„è¯»å–æ“ä½œéƒ½æ˜¯å•å­—å¤§å°çš„è¯»å–(ä½ å¯ä»¥è®¤ä¸ºè¿™ä¸¤æ­¥è¯»å–éƒ½æ˜¯åŸå­æ€§çš„).\næˆ‘ä»¬å¯ä»¥å‡è®¾ä¸€ä¸ªæƒ…å†µï¼Œåœ¨æˆ‘ä»¬è§‚å¯Ÿåˆ°channelæœªå…³é—­åï¼Œåœ¨è§‚å¯Ÿfullçš„è¿‡ç¨‹ä¸­ï¼Œchannelè¢«å…³é—­äº†ï¼Œå¦‚æœfullçš„ç»“æœä¸ºfalseï¼Œé‚£è¿™æ¬¡closeçš„ä¿®æ”¹æ²¡æœ‰äº§ç”Ÿå®è´¨å½±å“ï¼›å¦‚æœfullçš„ç»“æœä¸ºtrueï¼Œæ­¤æ—¶æ•´ä¸ªåˆ¤æ–­ä¸ºçœŸï¼Œä¼šæ‰§è¡Œreturnï¼Œè™½ç„¶æœ¬ä¸åº”è¯¥ï¼Œä½†æ˜¯ä¸å½±å“æ•´ä½“çš„é€»è¾‘ã€‚\nä¸€ä¸ªå·²å…³é—­çš„channelæ˜¯ä¸ä¼šä»æœªæ»¡è½¬å˜æˆå·²æ»¡çš„(å› ä¸ºå‘å·²ç»ä¸ºnilçš„channelè¿›è¡Œsendæ˜¯ä¸å…è®¸çš„)ï¼Œä¹Ÿå°±æ˜¯closeåï¼Œfullçš„ç»“æœä¸å¯èƒ½ä¼šä»falseè½¬å˜ä¸ºtrue.\nåŒæ­¥å‘é€ è¿›è¡Œå®Œæ£€æŸ¥ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å‘é€é€»è¾‘\n... lock(\u0026c.lock) // ä¸Šé”åæ£€æŸ¥channelæ˜¯å¦å…³é—­ï¼Œå¦‚æœå·²å…³é—­ï¼Œäº§ç”Ÿpanic. if c.closed != 0 { unlock(\u0026c.lock) panic(plainError(\"send on closed channel\")) } if sg := c.recvq.dequeue(); sg != nil { // Found a waiting receiver. We pass the value we want to send // directly to the receiver, bypassing the channel buffer (if any). send(c, sg, ep, func() { unlock(\u0026c.lock) }, 3) return true } ... å…ˆå¯»æ‰¾æ˜¯å¦å­˜åœ¨æ­£åœ¨ç­‰å¾…çš„æ¥æ”¶è€…ï¼Œé€šè¿‡dequeue() å–å‡ºå¤´éƒ¨ç¬¬ä¸€ä¸ªçš„sudogï¼Œå¦‚æœä¸ä¸ºç©ºä»£è¡¨å­˜åœ¨ï¼Œæ­¤æ—¶ç›´æ¥å°†å€¼sendç»™è¯¥æ¥æ”¶è€…ã€‚\nsend:\nfunc send(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { // ç«æ€åˆ†æä»£ç çœç•¥... if sg.elem != nil { sendDirect(c.elemtype, sg, ep) sg.elem = nil } gp := sg.g unlockf() gp.param = unsafe.Pointer(sg) sg.success = true if sg.releasetime != 0 { sg.releasetime = cputicks() } goready(gp, skip+1) } ä¸»è¦å…³æ³¨ä¸¤ä»¶äº‹ï¼š\nè°ƒç”¨ sendDirect() å°†æ•°æ®æ‹·è´åˆ°äº†æ¥æ”¶å˜é‡çš„å†…å­˜åœ°å€ä¸Š è°ƒç”¨ goready() å°†ç­‰å¾…æ¥æ”¶çš„é˜»å¡ goroutine çš„çŠ¶æ€ä» Gwaiting æˆ–è€… Gscanwaiting æ”¹å˜æˆ Grunnableã€‚ä¸‹ä¸€è½®è°ƒåº¦æ—¶ä¼šå”¤é†’è¿™ä¸ªæ¥æ”¶çš„ goroutineã€‚ func sendDirect(t *_type, sg *sudog, src unsafe.Pointer) { // src is on our stack, dst is a slot on another stack. // Once we read sg.elem out of sg, it will no longer // be updated if the destination's stack gets copied (shrunk). // So make sure that no preemption points can happen between read \u0026 use. dst := sg.elem typeBitsBulkBarrier(t, uintptr(dst), uintptr(src), t.size) // No need for cgo write barrier checks because dst is always // Go memory. memmove(dst, src, t.size) } sendDirectä¸­ä½¿ç”¨çš„æ˜¯memmoveï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€æ¬¡æ‹·è´æ“ä½œ.\nå¼‚æ­¥å‘é€ å¦‚æœæ²¡æœ‰æ­£åœ¨ç­‰å¾…çš„æ¥æ”¶è€…ï¼Œå¹¶ä¸”channelæœ‰ç¼“å†²ï¼Œä¼šè¿›è¡Œå¼‚æ­¥çš„å‘é€.\nif c.qcount \u003c c.dataqsiz { // channelç¼“å­˜åŒºè¿˜æœ‰ç©ºé—´ï¼Œå°†è¦sendçš„å…ƒç´ å…¥é˜Ÿ. qp := chanbuf(c, c.sendx) ... typedmemmove(c.elemtype, qp, ep) c.sendx++ if c.sendx == c.dataqsiz { c.sendx = 0 } c.qcount++ unlock(\u0026c.lock) return true } è°ƒç”¨chanbufå¯ä»¥è·å– sendx ç´¢å¼•çš„å…ƒç´ æŒ‡é’ˆå€¼ï¼Œå†è°ƒç”¨typedmemmoveå°†è¯¥å€¼æ‹·è´åˆ°bufä¸­å¯¹åº”çš„ä½ç½®ã€‚æ‹·è´å®Œæˆåï¼Œéœ€è¦ç»´æŠ¤ sendx ç´¢å¼•ä¸‹æ ‡å€¼å’Œ qcount ä¸ªæ•°ã€‚è¿™é‡Œå°† buf ç¼“å†²åŒºè®¾è®¡æˆç¯å½¢çš„ï¼Œç´¢å¼•å€¼å¦‚æœåˆ°äº†é˜Ÿå°¾ï¼Œä¸‹ä¸€ä¸ªä½ç½®é‡æ–°å›åˆ°é˜Ÿå¤´ã€‚ é˜»å¡å‘é€ å¦‚æœæ²¡æœ‰æˆåŠŸè¿›è¡ŒåŒæ­¥æˆ–å¼‚æ­¥çš„å‘é€ï¼Œä»£è¡¨è¯¥channelæ­¤æ—¶æ²¡æœ‰æ­£åœ¨ç­‰å¾…çš„æ¥æ”¶è€…ï¼Œä¸”bufå·²ç»æ»¡äº†ï¼Œå¦‚æœè°ƒç”¨è€…é€‰æ‹©éé˜»å¡å¼çš„å‘é€ï¼Œchansendä¼šç«‹å³è¿”å›falseã€‚ å¦‚æœé€‰æ‹©é˜»å¡å¼å‘é€ï¼š\n... // å¦‚æœé€‰æ‹©éé˜»å¡å¼çš„å‘é€ï¼Œchansendä¼šç«‹å³è¿”å›false if !block { unlock(\u0026c.lock) return false } // è·å–å½“å‰g gp := getg() // è·å–ä¸€ä¸ªsudogï¼Œå¯èƒ½æ˜¯æ–°å»ºçš„ï¼Œä¹Ÿå¯èƒ½æ˜¯ä»ç¼“å­˜ä¸­å¤ç”¨çš„ mysg := acquireSudog() mysg.releasetime = 0 if t0 != 0 { mysg.releasetime = -1 } // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. mysg.elem = ep mysg.waitlink = nil mysg.g = gp mysg.isSelect = false mysg.c = c gp.waiting = mysg gp.param = nil // å°†sudogå…¥é˜Ÿ c.sendq.enqueue(mysg) // è®¾ç½®åŸå­ä¿¡å·ã€‚å½“æ ˆè¦ shrink æ”¶ç¼©æ—¶ï¼Œè¿™ä¸ªæ ‡è®°ä»£è¡¨å½“å‰ goroutine è¿˜ parking åœåœ¨æŸä¸ª channel ä¸­ã€‚ // åœ¨ g çŠ¶æ€å˜æ›´ä¸è®¾ç½® activeStackChans çŠ¶æ€è¿™ä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´çš„æ—¶é—´çª—å£è¿›è¡Œæ ˆ shrink æ”¶ç¼©æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®è¿™ä¸ªåŸå­ä¿¡å·ã€‚ atomic.Store8(\u0026gp.parkingOnChan, 1) // è°ƒç”¨ gopark æ–¹æ³•æŒ‚èµ·å½“å‰ goroutineï¼ŒçŠ¶æ€ä¸º waitReasonChanSendï¼Œé˜»å¡ç­‰å¾… channelã€‚ gopark(chanparkcommit, unsafe.Pointer(\u0026c.lock), waitReasonChanSend, traceEvGoBlockSend, 2) // æœ€åï¼ŒKeepAlive() ç¡®ä¿å‘é€çš„å€¼ä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Œç›´åˆ°æ¥æ”¶è€…å°†å…¶å¤åˆ¶å‡ºæ¥ KeepAlive(ep) ... sudogçš„äºŒçº§ç¼“å­˜è®¾è®¡ func acquireSudog() *sudog { // è·å–å½“å‰m mp := acquirem() // è·å–å½“å‰p pp := mp.p.ptr() // å¦‚æœpä¸Šçš„æœ¬åœ°ç¼“å­˜ä¸ºç©º if len(pp.sudogcache) == 0 { // ä¸Šé”åå°è¯•ä»ä¸­å¿ƒç¼“å­˜è·å–ä¸€æ‰¹ lock(\u0026sched.sudoglock) for len(pp.sudogcache) \u003c cap(pp.sudogcache)/2 \u0026\u0026 sched.sudogcache != nil { s := sched.sudogcache sched.sudogcache = s.next s.next = nil pp.sudogcache = append(pp.sudogcache, s) } unlock(\u0026sched.sudoglock) // å¦‚æœä¸­å¿ƒç¼“å­˜ä¸ºç©ºï¼Œè·å–å¤±è´¥ï¼Œç›´æ¥è¿›è¡Œåˆ†é… if len(pp.sudogcache) == 0 { pp.sudogcache = append(pp.sudogcache, new(sudog)) } } // å¦‚æœæœ¬åœ°ç¼“å­˜ä¸ä¸ºç©ºï¼Œç›´æ¥ä»æœ¬åœ°ç¼“å­˜è·å– n := len(pp.sudogcache) s := pp.sudogcache[n-1] pp.sudogcache[n-1] = nil pp.sudogcache = pp.sudogcache[:n-1] if s.elem != nil { throw(\"acquireSudog: found s.elem != nil in cache\") } releasem(mp) return s } sched.sudogcache æ˜¯å…¨å±€ä¸­å¤®ç¼“å­˜ï¼Œå¯ä»¥è®¤ä¸ºå®ƒæ˜¯â€œä¸€çº§ç¼“å­˜â€ï¼Œå®ƒä¼šåœ¨ GC åƒåœ¾å›æ”¶æ‰§è¡Œ clearpools è¢«æ¸…ç†ã€‚p.sudogcache å¯ä»¥è®¤ä¸ºå®ƒæ˜¯â€œäºŒçº§ç¼“å­˜â€ï¼Œæ˜¯æœ¬åœ°ç¼“å­˜ä¸ä¼šè¢« GC æ¸…ç†æ‰ã€‚\nå‘é€æ”¶å°¾ chansend æœ€åçš„ä»£ç é€»è¾‘æ˜¯å½“ goroutine å”¤é†’ä»¥åï¼Œè§£é™¤é˜»å¡çš„çŠ¶æ€ï¼š\n// someone woke us up. if mysg != gp.waiting { throw(\"G waiting list is corrupted\") } gp.waiting = nil gp.activeStackChans = false closed := !mysg.success gp.param = nil if mysg.releasetime \u003e 0 { blockevent(mysg.releasetime-t0, 2) } mysg.c = nil releaseSudog(mysg) if closed { if c.closed == 0 { throw(\"chansend: spurious wakeup\") } panic(plainError(\"send on closed channel\")) } return true sudog ç®—æ˜¯å¯¹ g çš„ä¸€ç§å°è£…ï¼Œé‡Œé¢åŒ…å«äº† gï¼Œè¦å‘é€çš„æ•°æ®ä»¥åŠç›¸å…³çš„çŠ¶æ€ã€‚goroutine è¢«å”¤é†’åä¼šå®Œæˆ channel çš„é˜»å¡æ•°æ®å‘é€ã€‚å‘é€å®Œæœ€åè¿›è¡ŒåŸºæœ¬çš„å‚æ•°æ£€æŸ¥ï¼Œè§£é™¤ channel çš„ç»‘å®šå¹¶é‡Šæ”¾ sudogã€‚\nsudogçš„é‡Šæ”¾:\nfunc releaseSudog(s *sudog) { if s.elem != nil { throw(\"runtime: sudog with non-nil elem\") } if s.isSelect { throw(\"runtime: sudog with non-false isSelect\") } if s.next != nil { throw(\"runtime: sudog with non-nil next\") } if s.prev != nil { throw(\"runtime: sudog with non-nil prev\") } if s.waitlink != nil { throw(\"runtime: sudog with non-nil waitlink\") } if s.c != nil { throw(\"runtime: sudog with non-nil c\") } // è·å–å½“å‰g gp := getg() if gp.param != nil { throw(\"runtime: releaseSudog with non-nil gp.param\") } // è·å–å½“å‰m mp := acquirem() // avoid rescheduling to another P // è·å–å½“å‰p pp := mp.p.ptr() if len(pp.sudogcache) == cap(pp.sudogcache) { // å¦‚æœæœ¬åœ°sudogç¼“å­˜å·²æ»¡ï¼Œè¿ç§»ä¸€åŠçš„sudogåˆ°å…¨å±€ä¸­å¿ƒç¼“å­˜ var first, last *sudog for len(pp.sudogcache) \u003e cap(pp.sudogcache)/2 { n := len(pp.sudogcache) p := pp.sudogcache[n-1] pp.sudogcache[n-1] = nil pp.sudogcache = pp.sudogcache[:n-1] if first == nil { first = p } else { last.next = p } last = p } lock(\u0026sched.sudoglock) last.next = sched.sudogcache sched.sudogcache = first unlock(\u0026sched.sudoglock) } // ç›´æ¥åŠ åˆ°æœ¬åœ°sudogç¼“å­˜ pp.sudogcache = append(pp.sudogcache, s) releasem(mp) } å°ç»“ Channel Status Result Write nil é˜»å¡ Write open and full é˜»å¡ Write open and not full success Write colsed panic Write read only compiler error å½“æ¥æ”¶é˜Ÿåˆ—ä¸­å­˜åœ¨ sudog å¯ä»¥ç›´æ¥å‘é€æ•°æ®æ—¶ï¼Œæ‰§è¡ŒÂ goready()å°† g æ’å…¥ runnext æ’æ§½ä¸­ï¼ŒçŠ¶æ€ä» Gwaiting æˆ–è€… Gscanwaiting æ”¹å˜æˆ Grunnableï¼Œç­‰å¾…ä¸‹æ¬¡è°ƒåº¦ä¾¿ç«‹å³è¿è¡Œã€‚ å½“ channel é˜»å¡æ—¶ï¼Œæ‰§è¡ŒÂ gopark()Â å°† g é˜»å¡ï¼Œè®©å‡º cpu çš„ä½¿ç”¨æƒã€‚ éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œé€šé“å¹¶ä¸æä¾›è·¨ goroutine çš„æ•°æ®è®¿é—®ä¿æŠ¤æœºåˆ¶ã€‚å¦‚æœé€šè¿‡é€šé“ä¼ è¾“æ•°æ®çš„ä¸€ä»½å‰¯æœ¬ï¼Œé‚£ä¹ˆæ¯ä¸ª goroutine éƒ½æŒæœ‰ä¸€ä»½å‰¯æœ¬ï¼Œå„è‡ªå¯¹è‡ªå·±çš„å‰¯æœ¬åšä¿®æ”¹æ˜¯å®‰å…¨çš„ã€‚å½“ä¼ è¾“çš„æ˜¯æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆæ—¶ï¼Œå¦‚æœè¯»å’Œå†™æ˜¯ç”±ä¸åŒçš„ goroutine å®Œæˆçš„ï¼Œé‚£ä¹ˆæ¯ä¸ª goroutine ä¾æ—§éœ€è¦é¢å¤–çš„åŒæ­¥æ“ä½œã€‚\næ¥æ”¶æ•°æ® channelæ¥æ”¶æ•°æ®çš„ä»£ç åœ¨/src/runtime/chan.go:455.\nå¼‚å¸¸æ£€æŸ¥ å’Œsendä¸€æ ·ï¼Œä¸€å¼€å§‹ä¹Ÿæ˜¯ä¸€æ®µæ£€æŸ¥ä»£ç ï¼Œ\n// chanrecvç”¨äºåœ¨cä¸Šæ¥æ”¶å€¼å¹¶èµ‹å€¼ç»™epï¼Œblockå†³å®šæ˜¯å¦é˜»å¡ func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) { if debugChan { print(\"chanrecv: chan=\", c, \"\\n\") } if c == nil { if !block { return } gopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2) throw(\"unreachable\") } // æ— é”å¼‚å¸¸æ£€æŸ¥ // éé˜»å¡ä¸”channelä¸ºç©º if !block \u0026\u0026 empty(c) { if atomic.Load(\u0026c.closed) == 0 { // å¦‚æœchannelä¸ºç©ºä¸”æœªå…³é—­ï¼Œè¡¨ç¤ºæ²¡æœ‰æ•°æ®å¯æ¥æ”¶,å¯ç›´æ¥return return } // åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šåœ¨ç¬¬ä¸€æ¬¡è§‚å¯Ÿåˆ°ä¸ºç©ºåï¼Œç¬¬äºŒæ¬¡è§‚å¯Ÿä¹‹å‰ï¼Œæ–°å¢äº†æ•°æ® if empty(c) { if raceenabled { raceacquire(c.raceaddr()) } if ep != nil { typedmemclr(c.elemtype, ep) } // å¦‚æœ channel å·²ç»å…³é—­ä¸”ä¸å­˜åœ¨ç¼“å­˜æ•°æ®äº†ï¼Œåˆ™æ¸…ç† ep æŒ‡é’ˆä¸­çš„æ•°æ®å¹¶è¿”å›ã€‚è¿™é‡Œä¹Ÿæ˜¯ä»å·²ç»å…³é—­çš„ channel ä¸­è¯»æ•°æ®ï¼Œè¯»å‡ºæ¥çš„æ˜¯è¯¥ç±»å‹é›¶å€¼çš„åŸå› ã€‚ return true, false } } ... } åŒæ­¥æ¥æ”¶ if sg := c.sendq.dequeue(); sg != nil { // å­˜åœ¨ç­‰å¾…ä¸­çš„senderã€‚å¦‚æœç¼“å†²åŒºå¤§å°ä¸º 0ï¼Œåˆ™ç›´æ¥ä»senderæ¥æ”¶å€¼. // å¦åˆ™ï¼Œä»£è¡¨ç¼“å†²åŒºå·²æ»¡ï¼Œä»é˜Ÿåˆ—å¤´éƒ¨æ¥æ”¶å¹¶å°†senderçš„å€¼æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨. recv(c, sg, ep, func() { unlock(\u0026c.lock) }, 3) return true, true } ğŸ“¢è¦æ³¨æ„ä¸€ç‚¹ï¼Œå­˜åœ¨ç­‰å¾…ä¸­çš„å‘é€è€…ï¼Œå¦‚æœchannelæœ‰ç¼“å†²åŒºï¼Œé‚£ç¼“å†²åŒºä¸€å®šæ˜¯æ»¡çš„ã€‚\nfunc recv(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { // channelæ— ç¼“å†²åŒºï¼Œå°†senderçš„å€¼èµ‹ç»™ep if c.dataqsiz == 0 { if raceenabled { racesync(c, sg) } if ep != nil { // copy data from sender recvDirect(c.elemtype, sg, ep) } } else { // è¿›å…¥è¿™éƒ¨åˆ†ä»£ç ä»£è¡¨channelå­˜åœ¨ç¼“å†²åŒºä¸”å·²æ»¡. // bufä¸­é˜Ÿé¦–ä½ç½®çš„é‚£ä¸€ä¸ªå€¼ qp := chanbuf(c, c.recvx) if raceenabled { racenotify(c, c.recvx, nil) racenotify(c, c.recvx, sg) } // å°†qpå€¼èµ‹ç»™ep if ep != nil { typedmemmove(c.elemtype, ep, qp) } // å°†senderçš„ä¸­çš„å€¼èµ‹ç»™qp typedmemmove(c.elemtype, qp, sg.elem) // é˜Ÿé¦–æŒ‡é’ˆ++ï¼Œqpå¯¹åº”çš„ä½ç½®æˆäº†é˜Ÿå°¾ c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } // é˜Ÿæ»¡çš„æƒ…å†µä¸‹sendxå’Œrecvxç›¸ç­‰ c.sendx = c.recvx // c.sendx = (c.sendx+1) % c.dataqsiz } // ä¿®æ”¹sgçŠ¶æ€ï¼Œå”¤é†’å¯¹åº”g sg.elem = nil gp := sg.g unlockf() gp.param = unsafe.Pointer(sg) sg.success = true if sg.releasetime != 0 { sg.releasetime = cputicks() } goready(gp, skip+1) } å¼‚æ­¥æ¥æ”¶ å¦‚æœchannelä¸Šæ²¡æœ‰ç­‰å¾…ä¸­çš„senderï¼Œä½†æ˜¯ç¼“å†²åŒºä¸Šæœ‰æ•°æ®æ—¶ï¼Œé‚£ä¹ˆå°±æ¥æ”¶ç¼“å†²åŒºå†…çš„æ•°æ®\nif c.qcount \u003e 0 { qp := chanbuf(c, c.recvx) if raceenabled { racenotify(c, c.recvx, nil) } if ep != nil { typedmemmove(c.elemtype, ep, qp) } typedmemclr(c.elemtype, qp) c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } c.qcount-- unlock(\u0026c.lock) return true, true } è¿™é‡Œæ²¡æœ‰ä»€ä¹ˆå¥½ç‰¹åˆ«çš„ã€‚\né˜»å¡æ¥æ”¶ å½“ç¼“å†²åŒºå†…ä¹Ÿæ²¡æœ‰æ•°æ®æ—¶ï¼Œå¦‚æœé€‰æ‹©äº†é˜»å¡æ¥æ”¶ï¼Œæ­¤æ—¶åªèƒ½è¿›è¡Œç­‰å¾…\n// no sender available: block on this channel. // è·å–å½“å‰g gp := getg() // æ–°å»ºæˆ–ä»ç¼“å­˜è·å–sudog mysg := acquireSudog() // è®¾ç½®sudogçš„å€¼ mysg.releasetime = 0 if t0 != 0 { mysg.releasetime = -1 } // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. mysg.elem = ep mysg.waitlink = nil gp.waiting = mysg mysg.g = gp mysg.isSelect = false mysg.c = c gp.param = nil // å°†sudogåŠ å…¥channelçš„æ¥æ”¶è€…é˜Ÿåˆ— c.recvq.enqueue(mysg) // Signal to anyone trying to shrink our stack that we're about // to park on a channel. The window between when this G's status // changes and when we set gp.activeStackChans is not safe for // stack shrinking. // è®¾ç½®åŸå­ä¿¡å·ã€‚å½“æ ˆè¦ shrink æ”¶ç¼©æ—¶ï¼Œè¿™ä¸ªæ ‡è®°ä»£è¡¨å½“å‰ goroutine è¿˜ parking åœåœ¨æŸä¸ª channel ä¸­ã€‚ // åœ¨ g çŠ¶æ€å˜æ›´ä¸è®¾ç½® activeStackChans çŠ¶æ€è¿™ä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´çš„æ—¶é—´çª—å£è¿›è¡Œæ ˆ shrink æ”¶ç¼©æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®è¿™ä¸ªåŸå­ä¿¡å·ã€‚ atomic.Store8(\u0026gp.parkingOnChan, 1) // è°ƒç”¨ gopark æ–¹æ³•æŒ‚èµ·å½“å‰ goroutineï¼ŒçŠ¶æ€ä¸º waitReasonChanReceiveï¼Œé˜»å¡ç­‰å¾… channel gopark(chanparkcommit, unsafe.Pointer(\u0026c.lock), waitReasonChanReceive, traceEvGoBlockRecv, 2) è¿™é‡Œå’Œchansendä¸­çš„é˜»å¡éƒ¨åˆ†å‡ ä¹ä¸€æ ·ï¼Œä½†æ˜¯ä½œä¸ºæ¥æ”¶æ–¹ï¼Œä¸ç”¨KeepAlive(ep)æ¥ç¡®ä¿æ•°æ®ä¸è¢«å›æ”¶\nè¢«å”¤é†’å:\n// someone woke us up if mysg != gp.waiting { throw(\"G waiting list is corrupted\") } gp.waiting = nil gp.activeStackChans = false if mysg.releasetime \u003e 0 { blockevent(mysg.releasetime-t0, 2) } success := mysg.success gp.param = nil mysg.c = nil releaseSudog(mysg) return true, success goroutine è¢«å”¤é†’åä¼šå®Œæˆ channel çš„é˜»å¡æ•°æ®æ¥æ”¶ã€‚æ¥æ”¶å®Œæœ€åè¿›è¡ŒåŸºæœ¬çš„å‚æ•°æ£€æŸ¥ï¼Œè§£é™¤ channel çš„ç»‘å®šå¹¶é‡Šæ”¾ sudogã€‚\nå°ç»“ channelè¯»å–æ“ä½œå„çŠ¶æ€:\nChannel status Result Read nil block Read open and not empty read success Read open and empty block Read closed default value,false Read read only Compole Error chanrecv çš„è¿”å›å€¼æœ‰å‡ ç§æƒ…å†µï¼š\ntmp, ok := \u003c-ch Channel status Selected Received nil false false open and not empty true true open and empty false false closed true false receivedå€¼å¯¹åº”okï¼Œselected å€¼ä¸ä¼šè¢«å¤–éƒ¨ä½¿ç”¨ã€‚ channel æ¥æ”¶è¿‡ç¨‹ä¸­åŒ…å« 2 æ¬¡æœ‰å…³ goroutine è°ƒåº¦è¿‡ç¨‹ï¼š\nå½“ channel ä¸º nil æ—¶ï¼Œæ‰§è¡Œ gopark() æŒ‚èµ·å½“å‰çš„ goroutineã€‚ å½“å‘é€é˜Ÿåˆ—ä¸­å­˜åœ¨ sudog å¯ä»¥ç›´æ¥æ¥æ”¶æ•°æ®æ—¶ï¼Œæ‰§è¡Œ goready()å°† g æ’å…¥ runnext æ’æ§½ä¸­ï¼ŒçŠ¶æ€ä» Gwaiting æˆ–è€… Gscanwaiting æ”¹å˜æˆ Grunnableï¼Œç­‰å¾…ä¸‹æ¬¡è°ƒåº¦ä¾¿ç«‹å³è¿è¡Œã€‚ å½“ channel ç¼“å†²åŒºä¸ºç©ºï¼Œä¸”æ²¡æœ‰å‘é€è€…æ—¶ï¼Œè¿™æ—¶ channel é˜»å¡ï¼Œæ‰§è¡Œ gopark() å°† g é˜»å¡ï¼Œè®©å‡º cpu çš„ä½¿ç”¨æƒå¹¶ç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚ å…³é—­channel å…³é—­channelçš„æ‰‹æ®µ:\nclose(ch) ç¼–è¯‘å™¨ä¼šå°†å…¶è½¬æ¢ä¸º/src/runtime/chan.go:356å¤„çš„runtime.closechan() æ–¹æ³•ã€‚\nå¼‚å¸¸æ£€æŸ¥ func closechan(c *hchan) {\tif c == nil { panic(plainError(\"close of nil channel\")) } lock(\u0026c.lock) if c.closed != 0 { unlock(\u0026c.lock) panic(plainError(\"close of closed channel\")) } if raceenabled { callerpc := getcallerpc() racewritepc(c.raceaddr(), callerpc, abi.FuncPCABIInternal(closechan)) racerelease(c.raceaddr()) } c.closed = 1 å¦‚æœchannelä¸ºnilæˆ–è€…å·²å…³é—­çš„è¯ï¼Œpanicã€‚ å¦åˆ™ï¼Œæ ‡è®°channelçš„closedå­—æ®µä¸º1ã€‚\né‡Šæ”¾æ‰€æœ‰æ¥æ”¶è€…å’Œå‘é€è€… var glist gList // release all readers // é‡Šæ”¾æ¥æ”¶è€…ï¼Œå°†ç­‰å¾…é˜Ÿåˆ—recvqä¸­çš„sudogæ¸…é™¤ï¼Œå¹¶æŠŠå¯¹åº”çš„géƒ½åŠ å…¥åˆ°å¾…æ¸…é™¤é˜Ÿåˆ— glist ä¸­ for { sg := c.recvq.dequeue() if sg == nil { break } if sg.elem != nil { typedmemclr(c.elemtype, sg.elem) sg.elem = nil } if sg.releasetime != 0 { sg.releasetime = cputicks() } gp := sg.g gp.param = unsafe.Pointer(sg) sg.success = false if raceenabled { raceacquireg(gp, c.raceaddr()) } glist.push(gp) } // release all writers (they will panic) for { sg := c.sendq.dequeue() if sg == nil { break } sg.elem = nil if sg.releasetime != 0 { sg.releasetime = cputicks() } gp := sg.g gp.param = unsafe.Pointer(sg) sg.success = false if raceenabled { raceacquireg(gp, c.raceaddr()) } glist.push(gp) } unlock(\u0026c.lock) æ‰§è¡Œåç¨‹è°ƒåº¦ // Ready all Gs now that we've dropped the channel lock. for !glist.empty() { gp := glist.pop() gp.schedlink = 0 goready(gp, 3) } æœ€åä¼šä¸ºæ‰€æœ‰è¢«é˜»å¡çš„ goroutine è°ƒç”¨ goready è§¦å‘è°ƒåº¦ã€‚å°†æ‰€æœ‰ glist ä¸­çš„ goroutine çŠ¶æ€ä» _Gwaiting è®¾ç½®ä¸º _Grunnable çŠ¶æ€ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚\nä¼˜é›…å…³é—­ â€œChannel æœ‰å‡ ç§ä¼˜é›…çš„å…³é—­æ–¹æ³•ï¼Ÿâ€ è¿™ç§é—®é¢˜å¸¸å¸¸å‡ºç°åœ¨é¢è¯•é¢˜ä¸­ï¼Œç©¶å…¶åŸå› æ˜¯å› ä¸º Channel åˆ›å»ºå®¹æ˜“ï¼Œä½†æ˜¯å…³é—­â€œä¸æ˜“â€ï¼š\nåœ¨ä¸æ”¹å˜ Channel è‡ªèº«çŠ¶æ€çš„æ¡ä»¶ä¸‹ï¼Œæ— æ³•çŸ¥é“å®ƒæ˜¯å¦å·²ç»å…³é—­ã€‚â€œä¸æ˜“â€ä¹‹ä¸€ï¼Œå…³é—­æ—¶æœºæœªçŸ¥ã€‚ å¦‚æœä¸€ä¸ª Channel å·²ç»å…³é—­ï¼Œé‡å¤å…³é—­ Channel ä¼šå¯¼è‡´ panicã€‚â€œä¸æ˜“â€ä¹‹äºŒï¼Œä¸èƒ½æ— è„‘å…³é—­ã€‚ å¾€ä¸€ä¸ª close çš„ Channel å†…å†™æ•°æ®ï¼Œä¹Ÿä¼šå¯¼è‡´ panicã€‚â€œä¸æ˜“â€ä¹‹ä¸‰ï¼Œå†™æ•°æ®ä¹‹å‰ä¹Ÿéœ€è¦å…³æ³¨æ˜¯å¦ close çš„çŠ¶æ€ã€‚ Channel status Result close nil panic close open and not empty å…³é—­ Channelï¼›è¯»å–æˆåŠŸï¼Œç›´åˆ° Channel è€—å°½æ•°æ®ï¼Œç„¶åè¯»å–äº§ç”Ÿå€¼çš„é»˜è®¤å€¼ close open and empty å…³é—­ Channelï¼›è¯»åˆ°ç”Ÿäº§è€…çš„é»˜è®¤å€¼ close closed panic close read only Compile Error é‚£ç©¶ç«Ÿä»€ä¹ˆæ—¶å€™å…³é—­ Channel å‘¢ï¼Ÿç”±ä¸Šé¢ä¸‰ä¸ªâ€œä¸æ˜“â€ï¼Œå¯ä»¥æµ“ç¼©ä¸º 2 ç‚¹ï¼š\nä¸èƒ½ç®€å•çš„ä»æ¶ˆè´¹è€…ä¾§å…³é—­ Channelã€‚ å¦‚æœæœ‰å¤šä¸ªç”Ÿäº§è€…ï¼Œå®ƒä»¬ä¸èƒ½å…³é—­ Channelã€‚ è§£é‡Šä¸€ä¸‹è¿™ 2 ä¸ªé—®é¢˜ã€‚ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæ¶ˆè´¹è€…ä¸çŸ¥é“ Channel ä½•æ—¶è¯¥å…³é—­ã€‚å¦‚æœå…³é—­äº†å·²ç»å…³é—­çš„ Channel ä¼šå¯¼è‡´ panicã€‚è€Œä¸”åˆ†å¸ƒå¼åº”ç”¨é€šå¸¸æœ‰å¤šä¸ªæ¶ˆè´¹è€…ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…çš„è¡Œä¸ºä¸€è‡´ï¼Œè¿™ä¹ˆå¤šæ¶ˆè´¹è€…éƒ½å°è¯•å…³é—­ Channel å¿…ç„¶ä¼šå¯¼è‡´ panicã€‚ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå¦‚æœæœ‰å¤šä¸ªç”Ÿäº§è€…å¾€ Channel å†…å†™å…¥æ•°æ®ï¼Œè¿™äº›ç”Ÿäº§è€…çš„è¡Œä¸ºé€»è¾‘ä¹Ÿéƒ½ä¸€è‡´ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªç”Ÿäº§è€…å…³é—­äº† Channelï¼Œå…¶ä»–çš„ç”Ÿäº§è€…è¿˜åœ¨å¾€é‡Œå†™ï¼Œè¿™ä¸ªæ—¶å€™ä¼š panicã€‚æ‰€ä»¥ä¸ºäº†é˜²æ­¢ panicï¼Œå¿…é¡»è§£å†³ä¸Šé¢è¿™ 2 ä¸ªé—®é¢˜ã€‚\ncontext æ–¹å¼ done channel æ–¹å¼ ","wordCount":"2202","inLanguage":"zh","datePublished":"2022-11-21T09:45:13+08:00","dateModified":"2022-11-21T09:45:13+08:00","author":[{"@type":"Person","name":"å£¹æ¬¡å¿ƒ"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.yici.xin/post/tech/go-channel/"},"publisher":{"@type":"Organization","name":"yicixin's blog","logo":{"@type":"ImageObject","url":"https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.yici.xin/ accesskey=h title="ğŸ‘€ (Alt + H)">ğŸ‘€</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.yici.xin/tags/ title=æ ‡ç­¾ğŸ·ï¸><span>æ ‡ç­¾ğŸ·ï¸</span></a></li><li><a href=https://www.yici.xin/archives/ title=å½’æ¡£ğŸ•°ï¸><span>å½’æ¡£ğŸ•°ï¸</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.yici.xin/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://www.yici.xin/post/>Posts</a>&nbsp;Â»&nbsp;<a href=https://www.yici.xin/post/tech/>ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div><h1 class=post-title>Go channel</h1><div class=post-meta><span title='2022-11-21 09:45:13 +0800 +0800'>2022-11-21</span>&nbsp;Â·&nbsp;11 åˆ†é’Ÿ&nbsp;Â·&nbsp;2202 å­—&nbsp;Â·&nbsp;å£¹æ¬¡å¿ƒ&nbsp;|&nbsp;<a href=https://github.com/yicixin/blog/blob/main/content/post/tech/go-channel.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84 aria-label=æ•°æ®ç»“æ„>æ•°æ®ç»“æ„</a></li><li><a href=#%e5%88%9b%e5%bb%bachannel aria-label=åˆ›å»ºchannel>åˆ›å»ºchannel</a></li><li><a href=#%e5%8f%91%e9%80%81%e6%95%b0%e6%8d%ae aria-label=å‘é€æ•°æ®>å‘é€æ•°æ®</a><ul><li><a href=#%e5%bc%82%e5%b8%b8%e6%a3%80%e6%9f%a5 aria-label=å¼‚å¸¸æ£€æŸ¥>å¼‚å¸¸æ£€æŸ¥</a></li><li><a href=#%e5%90%8c%e6%ad%a5%e5%8f%91%e9%80%81 aria-label=åŒæ­¥å‘é€>åŒæ­¥å‘é€</a></li><li><a href=#%e5%bc%82%e6%ad%a5%e5%8f%91%e9%80%81 aria-label=å¼‚æ­¥å‘é€>å¼‚æ­¥å‘é€</a></li><li><a href=#%e9%98%bb%e5%a1%9e%e5%8f%91%e9%80%81 aria-label=é˜»å¡å‘é€>é˜»å¡å‘é€</a></li><li><a href=#sudog%e7%9a%84%e4%ba%8c%e7%ba%a7%e7%bc%93%e5%ad%98%e8%ae%be%e8%ae%a1 aria-label=sudogçš„äºŒçº§ç¼“å­˜è®¾è®¡>sudogçš„äºŒçº§ç¼“å­˜è®¾è®¡</a></li><li><a href=#%e5%8f%91%e9%80%81%e6%94%b6%e5%b0%be aria-label=å‘é€æ”¶å°¾>å‘é€æ”¶å°¾</a></li><li><a href=#%e5%b0%8f%e7%bb%93 aria-label=å°ç»“>å°ç»“</a></li></ul></li><li><a href=#%e6%8e%a5%e6%94%b6%e6%95%b0%e6%8d%ae aria-label=æ¥æ”¶æ•°æ®>æ¥æ”¶æ•°æ®</a><ul><li><a href=#%e5%bc%82%e5%b8%b8%e6%a3%80%e6%9f%a5-1 aria-label=å¼‚å¸¸æ£€æŸ¥>å¼‚å¸¸æ£€æŸ¥</a></li><li><a href=#%e5%90%8c%e6%ad%a5%e6%8e%a5%e6%94%b6 aria-label=åŒæ­¥æ¥æ”¶>åŒæ­¥æ¥æ”¶</a></li><li><a href=#%e5%bc%82%e6%ad%a5%e6%8e%a5%e6%94%b6 aria-label=å¼‚æ­¥æ¥æ”¶>å¼‚æ­¥æ¥æ”¶</a></li><li><a href=#%e9%98%bb%e5%a1%9e%e6%8e%a5%e6%94%b6 aria-label=é˜»å¡æ¥æ”¶>é˜»å¡æ¥æ”¶</a></li><li><a href=#%e5%b0%8f%e7%bb%93-1 aria-label=å°ç»“>å°ç»“</a></li></ul></li><li><a href=#%e5%85%b3%e9%97%adchannel aria-label=å…³é—­channel>å…³é—­channel</a><ul><li><a href=#%e5%bc%82%e5%b8%b8%e6%a3%80%e6%9f%a5-2 aria-label=å¼‚å¸¸æ£€æŸ¥>å¼‚å¸¸æ£€æŸ¥</a></li><li><a href=#%e9%87%8a%e6%94%be%e6%89%80%e6%9c%89%e6%8e%a5%e6%94%b6%e8%80%85%e5%92%8c%e5%8f%91%e9%80%81%e8%80%85 aria-label=é‡Šæ”¾æ‰€æœ‰æ¥æ”¶è€…å’Œå‘é€è€…>é‡Šæ”¾æ‰€æœ‰æ¥æ”¶è€…å’Œå‘é€è€…</a></li><li><a href=#%e6%89%a7%e8%a1%8c%e5%8d%8f%e7%a8%8b%e8%b0%83%e5%ba%a6 aria-label=æ‰§è¡Œåç¨‹è°ƒåº¦>æ‰§è¡Œåç¨‹è°ƒåº¦</a></li><li><a href=#%e4%bc%98%e9%9b%85%e5%85%b3%e9%97%ad aria-label=ä¼˜é›…å…³é—­>ä¼˜é›…å…³é—­</a></li><li><a href=#context-%e6%96%b9%e5%bc%8f aria-label="context æ–¹å¼">context æ–¹å¼</a></li><li><a href=#done-channel-%e6%96%b9%e5%bc%8f aria-label="done channel æ–¹å¼">done channel æ–¹å¼</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=æ•°æ®ç»“æ„>æ•°æ®ç»“æ„<a hidden class=anchor aria-hidden=true href=#æ•°æ®ç»“æ„>#</a></h2><p>channel çš„åº•å±‚æºç å’Œç›¸å…³å®ç°åœ¨/src/runtime/chan.goä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>hchan</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>qcount</span>   <span style=color:#66d9ef>uint</span>           <span style=color:#75715e>// é˜Ÿåˆ—ä¸­æ‰€æœ‰æ•°æ®æ€»æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>dataqsiz</span> <span style=color:#66d9ef>uint</span>           <span style=color:#75715e>// ç¯å½¢é˜Ÿåˆ—çš„ size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>buf</span>      <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span> <span style=color:#75715e>// æŒ‡å‘ dataqsiz é•¿åº¦çš„æ•°ç»„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>elemsize</span> <span style=color:#66d9ef>uint16</span>         <span style=color:#75715e>// å…ƒç´ å¤§å°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>closed</span>   <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elemtype</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>_type</span>         <span style=color:#75715e>// å…ƒç´ ç±»å‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sendx</span>    <span style=color:#66d9ef>uint</span>           <span style=color:#75715e>// å·²å‘é€çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>recvx</span>    <span style=color:#66d9ef>uint</span>           <span style=color:#75715e>// å·²æ¥æ”¶çš„å…ƒç´ åœ¨ç¯å½¢é˜Ÿåˆ—ä¸­çš„ä½ç½®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>recvq</span>    <span style=color:#a6e22e>waitq</span>          <span style=color:#75715e>// æ¥æ”¶è€…çš„ç­‰å¾…é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sendq</span>    <span style=color:#a6e22e>waitq</span>          <span style=color:#75715e>// å‘é€è€…çš„ç­‰å¾…é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// lock é”ä¿æŠ¤ hchan ä¸­çš„æ‰€æœ‰å­—æ®µï¼Œä»¥åŠæ­¤é€šé“ä¸Šè¢«é˜»å¡çš„ sudogs ä¸­çš„å¤šä¸ªå­—æ®µã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// æŒæœ‰ lock çš„æ—¶å€™ï¼Œç¦æ­¢æ›´æ”¹å¦ä¸€ä¸ª G çš„çŠ¶æ€ï¼ˆç‰¹åˆ«æ˜¯ä¸è¦ä½¿ G çŠ¶æ€å˜æˆreadyï¼‰ï¼Œ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// å› ä¸ºè¿™ä¼šå› ä¸ºå †æ ˆ shrinking è€Œå‘ç”Ÿæ­»é”ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lock</span> <span style=color:#a6e22e>mutex</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211291714199.png alt=hchanæ•°æ®ç»“æ„></p><p>recvq å’Œ sendq æ˜¯ç­‰å¾…é˜Ÿåˆ—ï¼Œwaitq æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>waitq</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>first</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>last</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// sudog è¡¨ç¤ºä¸€ä¸ªåœ¨ç­‰å¾…åˆ—è¡¨ä¸­çš„g, ä¾‹å¦‚åœ¨ä¸€ä¸ªchannelä¸Šç­‰å¾…å‘é€/æ¥æ”¶.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// sudog æ˜¯ Go ä¸­éå¸¸é‡è¦çš„æ•°æ®ç»“æ„.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// g ä¸åŒæ­¥å¯¹è±¡å…³ç³»å¯ä»¥æ˜¯å¤šå¯¹å¤šçš„ï¼Œä¸€ä¸ª g èƒ½å‡ºç°åœ¨è®¸å¤šç­‰å¾…é˜Ÿåˆ—ä¸Š(ä¾‹å¦‚ä½¿ç”¨selectç­‰å¾…å¤šä¸ªchannel)ï¼Œå› æ­¤ä¸€ä¸ª g å¯èƒ½æœ‰å¾ˆå¤šsudogã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e>// å¹¶ä¸”å¤šä¸ª g å¯èƒ½æ­£åœ¨ç­‰å¾…åŒä¸€ä¸ªåŒæ­¥å¯¹è±¡(å¤šä¸ªåç¨‹ç­‰å¾…åŒä¸€ä¸ªchannel)ï¼Œå› æ­¤ä¸€ä¸ªå¯¹è±¡å¯èƒ½æœ‰è®¸å¤š sudogã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e>// sudog æ˜¯ä»ç‰¹æ®Šæ± ä¸­åˆ†é…å‡ºæ¥çš„ã€‚ä½¿ç”¨ acquireSudog å’Œ releaseSudog åˆ†é…å’Œé‡Šæ”¾å®ƒä»¬ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>sudog</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The following fields are protected by the hchan.lock of the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// channel this sudog is blocking on. shrinkstack depends on
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// this for sudogs involved in channel ops.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>next</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>prev</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elem</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span> <span style=color:#75715e>// data element (may point to stack)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ä»¥ä¸‹çš„ä¸‰ä¸ªå­—æ®µæ°¸è¿œä¸ä¼šè¢«åŒæ—¶è®¿é—®.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å¯¹channelæ¥è¯´ï¼Œwaitlinkä»…å…è®¸gè®¿é—®.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å¯¹semaphoresæ¥è¯´ï¼Œåªæœ‰åœ¨æŒæœ‰semaRooté”çš„æ—¶å€™æ‰èƒ½è®¿é—®è¿™ä¸‰ä¸ªå­—æ®µ.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>acquiretime</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releasetime</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ticket</span>      <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// isSelect è¡¨ç¤º g æ˜¯å¦è¢«é€‰æ‹©.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// g.selectDone å¿…é¡»è¿›è¡Œ CAS æ‰èƒ½åœ¨è¢«å”¤é†’çš„ç«äº‰ä¸­èƒœå‡º.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>isSelect</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// success è¡¨ç¤º channel c ä¸Šçš„é€šä¿¡æ˜¯å¦æˆåŠŸ. 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å¦‚æœgoroutineå› channelä¸Šæ´¾å‘äº†ä¸€ä¸ªå€¼è€Œè¢«å”¤é†’ï¼Œsuccessä¸ºtrueï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// å¦‚æœæ˜¯å› ä¸ºchannelå…³é—­è€Œå”¤é†’ï¼Œåˆ™ä¸ºfalse
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>success</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>parent</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span> <span style=color:#75715e>// semaRoot binary tree
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>waitlink</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span> <span style=color:#75715e>// g.waiting list or semaRoot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>waittail</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span> <span style=color:#75715e>// semaRoot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span> <span style=color:#75715e>// channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=åˆ›å»ºchannel>åˆ›å»ºchannel<a hidden class=anchor aria-hidden=true href=#åˆ›å»ºchannel>#</a></h2><p>åˆ›å»ºchannelçš„å‡½æ•°ä½äº/src/runtime/chan.go:72</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// params:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// t: channelçš„ç±»å‹æºæ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e>// size: channelçš„å¤§å°ï¼Œ å¯¹åº”hchanä¸­dataqsizå¤§å°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>makechan</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>chantype</span>, <span style=color:#a6e22e>size</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elem</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>elem</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç¼–è¯‘å™¨æ£€æŸ¥æ•°æ®é¡¹å¤§å°ä¸èƒ½è¶…è¿‡ 64KB
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>size</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>&lt;&lt;</span><span style=color:#ae81ff>16</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;makechan: invalid channel element type&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ£€æŸ¥å¯¹é½æ˜¯å¦æ­£ç¡®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>hchanSize</span><span style=color:#f92672>%</span><span style=color:#a6e22e>maxAlign</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>align</span> &gt; <span style=color:#a6e22e>maxAlign</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;makechan: bad alignment&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç¼“å†²åŒºå¤§å°æ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦æº¢å‡º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mem</span>, <span style=color:#a6e22e>overflow</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>MulUintptr</span>(<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>size</span>, uintptr(<span style=color:#a6e22e>size</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>overflow</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>mem</span> &gt; <span style=color:#a6e22e>maxAlloc</span><span style=color:#f92672>-</span><span style=color:#a6e22e>hchanSize</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>size</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;makechan: size out of range&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>mem</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// memä¸º0ï¼Œåˆ™ä»£è¡¨é˜Ÿåˆ—æˆ–è€…å…ƒç´ å¤§å°ä¸ºzero.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span> = (<span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>)(<span style=color:#a6e22e>mallocgc</span>(<span style=color:#a6e22e>hchanSize</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>true</span>))
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Race ç«äº‰æ£€æŸ¥åˆ©ç”¨è¿™ä¸ªåœ°å€æ¥è¿›è¡ŒåŒæ­¥æ“ä½œ.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>ptrdata</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆï¼Œä½¿ç”¨è¿ç»­çš„å†…å­˜ç©ºé—´ä¸€æ¬¡æ€§åˆ†é…hchanå’Œbufæ‰€éœ€çš„å†…å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span> = (<span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>)(<span style=color:#a6e22e>mallocgc</span>(<span style=color:#a6e22e>hchanSize</span><span style=color:#f92672>+</span><span style=color:#a6e22e>mem</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>true</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>c</span>), <span style=color:#a6e22e>hchanSize</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å…ƒç´ åŒ…å«æŒ‡é’ˆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span> = new(<span style=color:#a6e22e>hchan</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>mallocgc</span>(<span style=color:#a6e22e>mem</span>, <span style=color:#a6e22e>elem</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è®¾ç½®å±æ€§
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemsize</span> = uint16(<span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span> = <span style=color:#a6e22e>elem</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> = uint(<span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lockInit</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>lockRankHchan</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debugChan</span> {
</span></span><span style=display:flex><span>		print(<span style=color:#e6db74>&#34;makechan: chan=&#34;</span>, <span style=color:#a6e22e>c</span>, <span style=color:#e6db74>&#34;; elemsize=&#34;</span>, <span style=color:#a6e22e>elem</span>.<span style=color:#a6e22e>size</span>, <span style=color:#e6db74>&#34;; dataqsiz=&#34;</span>, <span style=color:#a6e22e>size</span>, <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸Šé¢è¿™æ®µ makechan() ä»£ç ä¸»è¦ç›®çš„æ˜¯ç”Ÿæˆ <code>*hchan</code>å¯¹è±¡ã€‚é‡ç‚¹å…³æ³¨ switch-case ä¸­çš„ 3 ç§æƒ…å†µ</p><ul><li>å½“é˜Ÿåˆ—æˆ–è€…å…ƒç´ å¤§å°ä¸º 0 æ—¶ï¼Œè°ƒç”¨ mallocgc() åœ¨å †ä¸Šä¸º channel å¼€è¾Ÿä¸€æ®µå¤§å°ä¸º hchanSize çš„å†…å­˜ç©ºé—´ã€‚</li><li>å½“å…ƒç´ ç±»å‹ä¸æ˜¯æŒ‡é’ˆç±»å‹æ—¶ï¼Œè°ƒç”¨ mallocgc() åœ¨å †ä¸Šå¼€è¾Ÿä¸º channel å’Œåº•å±‚ buf ç¼“å†²åŒºæ•°ç»„å¼€è¾Ÿä¸€æ®µå¤§å°ä¸º hchanSize + mem è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚</li><li>é»˜è®¤æƒ…å†µå…ƒç´ ç±»å‹ä¸­æœ‰æŒ‡é’ˆç±»å‹ï¼Œè°ƒç”¨ mallocgc() åœ¨å †ä¸Šåˆ†åˆ«ä¸º channel å’Œ buf ç¼“å†²åŒºåˆ†é…å†…å­˜ã€‚</li></ul><p>å®Œæˆç¬¬ä¸€æ­¥çš„å†…å­˜åˆ†é…ä¹‹åï¼Œå†å°±æ˜¯ hchan æ•°æ®ç»“æ„å…¶ä»–å­—æ®µçš„åˆå§‹åŒ–å’Œ lock çš„åˆå§‹åŒ–ã€‚å€¼å¾—è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼Œå½“å­˜å‚¨åœ¨ buf ä¸­çš„å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆæ—¶ï¼ŒHchan ä¸­ä¹Ÿä¸åŒ…å« GC å…³å¿ƒçš„æŒ‡é’ˆã€‚buf æŒ‡å‘ä¸€æ®µç›¸åŒå…ƒç´ ç±»å‹çš„å†…å­˜ï¼Œelemtype å›ºå®šä¸å˜ã€‚
<strong>SudoG æ˜¯ä»å®ƒä»¬è‡ªå·±çš„çº¿ç¨‹ä¸­å¼•ç”¨çš„ï¼Œå› æ­¤åƒåœ¾å›æ”¶çš„æ—¶å€™æ— æ³•å›æ”¶å®ƒä»¬ã€‚å—åˆ°åƒåœ¾å›æ”¶å™¨çš„é™åˆ¶ï¼ŒæŒ‡é’ˆç±»å‹çš„ç¼“å†² buf éœ€è¦å•ç‹¬åˆ†é…å†…å­˜ã€‚å®˜æ–¹åœ¨è¿™é‡ŒåŠ äº†ä¸€ä¸ª TODOï¼Œåƒåœ¾å›æ”¶çš„æ—¶å€™è¿™æ®µä»£ç é€»è¾‘éœ€è¦é‡æ–°è€ƒè™‘ã€‚</strong></p><style type=text/css media=screen>html{--color-alert-info-text:#24292e;--color-alert-info-bg:#dbedff;--color-alert-info-border:rgba(4, 66, 137, 0.2);--color-alert-warn-text:#24292e;--color-alert-warn-bg:#fffbdd;--color-alert-warn-border:rgba(176, 136, 0, 0.2);--color-alert-error-text:#24292e;--color-alert-error-bg:#ffe3e6;--color-alert-error-border:rgba(158, 28, 35, 0.2);--color-alert-success-text:#24292e;--color-alert-success-bg:#dcffe4;--color-alert-success-border:rgba(23, 111, 44, 0.2)}html[data-theme=dark]{--color-alert-info-text:#79c0ff;--color-alert-info-bg:rgba(56, 139, 253, 0.1);--color-alert-info-border:rgba(56, 139, 253, 0.4);--color-alert-warn-text:#e3b341;--color-alert-warn-bg:rgba(187, 128, 9, 0.1);--color-alert-warn-border:rgba(187, 128, 9, 0.4);--color-alert-error-text:#ff7b72;--color-alert-error-bg:rgba(248, 81, 73, 0.1);--color-alert-error-border:rgba(248, 81, 73, 0.4);--color-alert-success-text:#56d364;--color-alert-success-bg:rgba(46, 160, 67, 0.1);--color-alert-success-border:rgba(46, 160, 67, 0.4)}.tips{position:relative;padding:20px 16px;margin-bottom:20px;border-style:solid;border-width:1px;border-radius:6px;border-left-style:solid;border-left-width:6px}.tips.info{color:var(--color-alert-info-text);background-image:linear-gradient(var(--color-alert-info-bg),var(--color-alert-info-bg));border-color:var(--color-alert-info-border)}.tips.warn{color:var(--color-alert-warn-text);background-image:linear-gradient(var(--color-alert-warn-bg),var(--color-alert-warn-bg));border-color:var(--color-alert-warn-border)}.tips.error{color:var(--color-alert-error-text);background-image:linear-gradient(var(--color-alert-error-bg),var(--color-alert-error-bg));border-color:var(--color-alert-error-border)}.tips.success{color:var(--color-alert-success-text);background-image:linear-gradient(var(--color-alert-success-bg),var(--color-alert-success-bg));border-color:var(--color-alert-success-border)}#tips-title{font-size:19px;font-weight:800;margin-bottom:10px}</style><div class="tips info">å› ä¸º channel çš„åˆ›å»ºå…¨éƒ¨è°ƒç”¨çš„ mallocgc()ï¼Œåœ¨å †ä¸Šå¼€è¾Ÿçš„å†…å­˜ç©ºé—´ï¼Œchannel æœ¬èº«ä¼šè¢« GC è‡ªåŠ¨å›æ”¶ã€‚æœ‰äº†è¿™ä¸€æ€§è´¨ï¼Œæ‰€ä»¥æ‰æœ‰äº†ä¸‹æ–‡å…³é—­ channel ä¸­ä¼˜é›…å…³é—­çš„æ–¹æ³•ã€‚</div><h2 id=å‘é€æ•°æ®>å‘é€æ•°æ®<a hidden class=anchor aria-hidden=true href=#å‘é€æ•°æ®>#</a></h2><p>å¾€channelå‘é€æ•°æ®çš„ä»£ç åœ¨/src/runtime/chan.go:159.</p><h3 id=å¼‚å¸¸æ£€æŸ¥>å¼‚å¸¸æ£€æŸ¥<a hidden class=anchor aria-hidden=true href=#å¼‚å¸¸æ£€æŸ¥>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// params:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// c: chansendæ‰€æ“ä½œçš„channel
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ep: å‘é€çš„å€¼
</span></span></span><span style=display:flex><span><span style=color:#75715e>// block: æ˜¯å¦é˜»å¡å‘é€ï¼Œå³åŒæ­¥è¿˜æ˜¯å¼‚æ­¥
</span></span></span><span style=display:flex><span><span style=color:#75715e>// callerpc: è°ƒç”¨è€…çš„pcå¯„å­˜å™¨åœ°å€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>chansend</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>ep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>block</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>callerpc</span> <span style=color:#66d9ef>uintptr</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// åˆ¤æ–­channelæ˜¯å¦ä¸ºnil, æœä¸€ä¸ªä¸º nil çš„ channel å‘é€æ•°æ®ä¼šå‘ç”Ÿé˜»å¡ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// gopark ä¼šå¼•å‘ä»¥ waitReasonChanSendNilChan ä¸ºåŸå› çš„ä¼‘çœ ï¼Œå¹¶æŠ›å‡º unreachable çš„ fatal errorã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gopark</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>waitReasonChanSendNilChan</span>, <span style=color:#a6e22e>traceEvGoStop</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;unreachable&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debugChan</span> {
</span></span><span style=display:flex><span>		print(<span style=color:#e6db74>&#34;chansend: chan=&#34;</span>, <span style=color:#a6e22e>c</span>, <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>racereadpc</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>(), <span style=color:#a6e22e>callerpc</span>, <span style=color:#a6e22e>abi</span>.<span style=color:#a6e22e>FuncPCABIInternal</span>(<span style=color:#a6e22e>chansend</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å½“ channel ä¸ä¸º nilï¼Œå¹¶ä¸” channel æ²¡æœ‰ close æ—¶ï¼Œè¿˜éœ€è¦æ£€æŸ¥æ­¤æ—¶ channel æ˜¯å¦å¯ä»¥sendï¼Œå³åˆ¤æ–­ full(c)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>full</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span></code></pre></div><p>fullçš„ä»£ç :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// fullåæ˜ åœ¨cä¸Šçš„ä¸€ä¸ªsendæ˜¯å¦ä¼šé˜»å¡(å³channelæ˜¯å¦å·²æ»¡)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>full</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// c.dataqsiz æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€ä»¥åœ¨channelåˆ›å»ºåï¼Œè¯¥å€¼éƒ½æ˜¯å¯ä»¥å®‰å…¨è¯»å–çš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>first</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="tips warn"><p>è¿™æ®µæ£€æŸ¥<strong>å¤±è´¥çš„éé˜»å¡æ“ä½œ</strong>å¹¶æ²¡æœ‰ä¸Šé”ï¼Œè€Œæ˜¯åœ¨æ£€æŸ¥ä¹‹åè¿›è¡Œçš„ä¸Šé”æ“ä½œã€‚è¿™ä¸ªåŸå› åœ¨æºç ä¸­æœ‰æ³¨é‡Šè¿›è¡Œäº†é˜è¿°ï¼Œæˆ‘è¿›è¡Œä¸€ä¸‹æ¶¦è‰²è§£é‡Šï¼š
<code>!block && c.closed == 0 && full(c)</code>ï¼Œåœ¨è¿™ä¸ªåˆ¤æ–­ä¸­ï¼Œæˆ‘ä»¬å…ˆè§‚å¯Ÿåˆ°channelæ˜¯æœªå…³é—­çŠ¶æ€ï¼Œå†è§‚å¯Ÿchannelæ˜¯å¦fullï¼Œè¿™ä¸¤æ­¥ä¸­çš„è¯»å–æ“ä½œéƒ½æ˜¯å•å­—å¤§å°çš„è¯»å–(ä½ å¯ä»¥è®¤ä¸ºè¿™ä¸¤æ­¥è¯»å–éƒ½æ˜¯åŸå­æ€§çš„).</p><p>æˆ‘ä»¬å¯ä»¥å‡è®¾ä¸€ä¸ªæƒ…å†µï¼Œåœ¨æˆ‘ä»¬è§‚å¯Ÿåˆ°channelæœªå…³é—­åï¼Œåœ¨è§‚å¯Ÿfullçš„è¿‡ç¨‹ä¸­ï¼Œchannelè¢«å…³é—­äº†ï¼Œå¦‚æœfullçš„ç»“æœä¸ºfalseï¼Œé‚£è¿™æ¬¡closeçš„ä¿®æ”¹æ²¡æœ‰äº§ç”Ÿå®è´¨å½±å“ï¼›å¦‚æœfullçš„ç»“æœä¸ºtrueï¼Œæ­¤æ—¶æ•´ä¸ªåˆ¤æ–­ä¸ºçœŸï¼Œä¼šæ‰§è¡Œreturnï¼Œè™½ç„¶æœ¬ä¸åº”è¯¥ï¼Œä½†æ˜¯ä¸å½±å“æ•´ä½“çš„é€»è¾‘ã€‚</p><p>ä¸€ä¸ªå·²å…³é—­çš„channelæ˜¯ä¸ä¼šä»<strong>æœªæ»¡</strong>è½¬å˜æˆ<strong>å·²æ»¡</strong>çš„(å› ä¸ºå‘å·²ç»ä¸ºnilçš„channelè¿›è¡Œsendæ˜¯ä¸å…è®¸çš„)ï¼Œä¹Ÿå°±æ˜¯closeåï¼Œfullçš„ç»“æœä¸å¯èƒ½ä¼šä»falseè½¬å˜ä¸ºtrue.</p></div><h3 id=åŒæ­¥å‘é€>åŒæ­¥å‘é€<a hidden class=anchor aria-hidden=true href=#åŒæ­¥å‘é€>#</a></h3><p>è¿›è¡Œå®Œæ£€æŸ¥ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å‘é€é€»è¾‘</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ä¸Šé”åæ£€æŸ¥channelæ˜¯å¦å…³é—­ï¼Œå¦‚æœå·²å…³é—­ï¼Œäº§ç”Ÿpanic.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;send on closed channel&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>dequeue</span>(); <span style=color:#a6e22e>sg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Found a waiting receiver. We pass the value we want to send
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// directly to the receiver, bypassing the channel buffer (if any).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>) }, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>å…ˆå¯»æ‰¾æ˜¯å¦å­˜åœ¨æ­£åœ¨ç­‰å¾…çš„æ¥æ”¶è€…ï¼Œé€šè¿‡dequeue() å–å‡ºå¤´éƒ¨ç¬¬ä¸€ä¸ªçš„sudogï¼Œå¦‚æœä¸ä¸ºç©ºä»£è¡¨å­˜åœ¨ï¼Œæ­¤æ—¶ç›´æ¥å°†å€¼sendç»™è¯¥æ¥æ”¶è€…ã€‚</p><p>send:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>sg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>, <span style=color:#a6e22e>ep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>unlockf</span> <span style=color:#66d9ef>func</span>(), <span style=color:#a6e22e>skip</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç«æ€åˆ†æä»£ç çœç•¥...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sendDirect</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlockf</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>sg</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#a6e22e>cputicks</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>goready</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>skip</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸»è¦å…³æ³¨ä¸¤ä»¶äº‹ï¼š</p><ul><li><ol><li>è°ƒç”¨ sendDirect() å°†æ•°æ®æ‹·è´åˆ°äº†æ¥æ”¶å˜é‡çš„å†…å­˜åœ°å€ä¸Š</li></ol></li><li><ol start=2><li>è°ƒç”¨ goready() å°†ç­‰å¾…æ¥æ”¶çš„é˜»å¡ goroutine çš„çŠ¶æ€ä» Gwaiting æˆ–è€… Gscanwaiting æ”¹å˜æˆ Grunnableã€‚ä¸‹ä¸€è½®è°ƒåº¦æ—¶ä¼šå”¤é†’è¿™ä¸ªæ¥æ”¶çš„ goroutineã€‚</li></ol></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sendDirect</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>_type</span>, <span style=color:#a6e22e>sg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>, <span style=color:#a6e22e>src</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// src is on our stack, dst is a slot on another stack.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Once we read sg.elem out of sg, it will no longer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// be updated if the destination&#39;s stack gets copied (shrunk).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// So make sure that no preemption points can happen between read &amp; use.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>dst</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>typeBitsBulkBarrier</span>(<span style=color:#a6e22e>t</span>, uintptr(<span style=color:#a6e22e>dst</span>), uintptr(<span style=color:#a6e22e>src</span>), <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// No need for cgo write barrier checks because dst is always
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Go memory.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>memmove</span>(<span style=color:#a6e22e>dst</span>, <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>sendDirectä¸­ä½¿ç”¨çš„æ˜¯memmoveï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€æ¬¡æ‹·è´æ“ä½œ.</p><h3 id=å¼‚æ­¥å‘é€>å¼‚æ­¥å‘é€<a hidden class=anchor aria-hidden=true href=#å¼‚æ­¥å‘é€>#</a></h3><p>å¦‚æœæ²¡æœ‰æ­£åœ¨ç­‰å¾…çš„æ¥æ”¶è€…ï¼Œå¹¶ä¸”channelæœ‰ç¼“å†²ï¼Œä¼šè¿›è¡Œå¼‚æ­¥çš„å‘é€.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span> &lt; <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// channelç¼“å­˜åŒºè¿˜æœ‰ç©ºé—´ï¼Œå°†è¦sendçš„å…ƒç´ å…¥é˜Ÿ.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>qp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chanbuf</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span>)
</span></span><span style=display:flex><span>		<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>typedmemmove</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>qp</span>, <span style=color:#a6e22e>ep</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>è°ƒç”¨chanbufå¯ä»¥è·å– sendx ç´¢å¼•çš„å…ƒç´ æŒ‡é’ˆå€¼ï¼Œå†è°ƒç”¨typedmemmoveå°†è¯¥å€¼æ‹·è´åˆ°bufä¸­å¯¹åº”çš„ä½ç½®ã€‚æ‹·è´å®Œæˆåï¼Œéœ€è¦ç»´æŠ¤ sendx ç´¢å¼•ä¸‹æ ‡å€¼å’Œ qcount ä¸ªæ•°ã€‚è¿™é‡Œå°† buf ç¼“å†²åŒºè®¾è®¡æˆç¯å½¢çš„ï¼Œç´¢å¼•å€¼å¦‚æœåˆ°äº†é˜Ÿå°¾ï¼Œä¸‹ä¸€ä¸ªä½ç½®é‡æ–°å›åˆ°é˜Ÿå¤´ã€‚
<img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211301721328.png alt></p><h3 id=é˜»å¡å‘é€>é˜»å¡å‘é€<a hidden class=anchor aria-hidden=true href=#é˜»å¡å‘é€>#</a></h3><p>å¦‚æœæ²¡æœ‰æˆåŠŸè¿›è¡ŒåŒæ­¥æˆ–å¼‚æ­¥çš„å‘é€ï¼Œä»£è¡¨è¯¥channelæ­¤æ—¶æ²¡æœ‰æ­£åœ¨ç­‰å¾…çš„æ¥æ”¶è€…ï¼Œä¸”bufå·²ç»æ»¡äº†ï¼Œå¦‚æœè°ƒç”¨è€…é€‰æ‹©éé˜»å¡å¼çš„å‘é€ï¼Œchansendä¼šç«‹å³è¿”å›falseã€‚
å¦‚æœé€‰æ‹©é˜»å¡å¼å‘é€ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¦‚æœé€‰æ‹©éé˜»å¡å¼çš„å‘é€ï¼Œchansendä¼šç«‹å³è¿”å›false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è·å–å½“å‰g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è·å–ä¸€ä¸ªsudogï¼Œå¯èƒ½æ˜¯æ–°å»ºçš„ï¼Œä¹Ÿå¯èƒ½æ˜¯ä»ç¼“å­˜ä¸­å¤ç”¨çš„
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acquireSudog</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t0</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// No stack splits between assigning elem and enqueuing mysg
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// on gp.waiting where copystack can find it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#a6e22e>ep</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>waitlink</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>gp</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>isSelect</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#a6e22e>mysg</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å°†sudogå…¥é˜Ÿ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendq</span>.<span style=color:#a6e22e>enqueue</span>(<span style=color:#a6e22e>mysg</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è®¾ç½®åŸå­ä¿¡å·ã€‚å½“æ ˆè¦ shrink æ”¶ç¼©æ—¶ï¼Œè¿™ä¸ªæ ‡è®°ä»£è¡¨å½“å‰ goroutine è¿˜ parking åœåœ¨æŸä¸ª channel ä¸­ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// åœ¨ g çŠ¶æ€å˜æ›´ä¸è®¾ç½® activeStackChans çŠ¶æ€è¿™ä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´çš„æ—¶é—´çª—å£è¿›è¡Œæ ˆ shrink æ”¶ç¼©æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®è¿™ä¸ªåŸå­ä¿¡å·ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Store8</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>parkingOnChan</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è°ƒç”¨ gopark æ–¹æ³•æŒ‚èµ·å½“å‰ goroutineï¼ŒçŠ¶æ€ä¸º waitReasonChanSendï¼Œé˜»å¡ç­‰å¾… channelã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gopark</span>(<span style=color:#a6e22e>chanparkcommit</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>), <span style=color:#a6e22e>waitReasonChanSend</span>, <span style=color:#a6e22e>traceEvGoBlockSend</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æœ€åï¼ŒKeepAlive() ç¡®ä¿å‘é€çš„å€¼ä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Œç›´åˆ°æ¥æ”¶è€…å°†å…¶å¤åˆ¶å‡ºæ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>KeepAlive</span>(<span style=color:#a6e22e>ep</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><h3 id=sudogçš„äºŒçº§ç¼“å­˜è®¾è®¡>sudogçš„äºŒçº§ç¼“å­˜è®¾è®¡<a hidden class=anchor aria-hidden=true href=#sudogçš„äºŒçº§ç¼“å­˜è®¾è®¡>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>acquireSudog</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è·å–å½“å‰m
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acquirem</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è·å–å½“å‰p
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¦‚æœpä¸Šçš„æœ¬åœ°ç¼“å­˜ä¸ºç©º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ä¸Šé”åå°è¯•ä»ä¸­å¿ƒç¼“å­˜è·å–ä¸€æ‰¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>sudoglock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> len(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>) &lt; cap(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>sudogcache</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>sudogcache</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>sudogcache</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>next</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>next</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span> = append(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>, <span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>sudoglock</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å¦‚æœä¸­å¿ƒç¼“å­˜ä¸ºç©ºï¼Œè·å–å¤±è´¥ï¼Œç›´æ¥è¿›è¡Œåˆ†é…
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span> = append(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>, new(<span style=color:#a6e22e>sudog</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¦‚æœæœ¬åœ°ç¼“å­˜ä¸ä¸ºç©ºï¼Œç›´æ¥ä»æœ¬åœ°ç¼“å­˜è·å–
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>[<span style=color:#a6e22e>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>[<span style=color:#a6e22e>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span> = <span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>[:<span style=color:#a6e22e>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>elem</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;acquireSudog: found s.elem != nil in cache&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>mp</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>sched.sudogcache æ˜¯å…¨å±€ä¸­å¤®ç¼“å­˜ï¼Œå¯ä»¥è®¤ä¸ºå®ƒæ˜¯â€œä¸€çº§ç¼“å­˜â€ï¼Œå®ƒä¼šåœ¨ GC åƒåœ¾å›æ”¶æ‰§è¡Œ clearpools è¢«æ¸…ç†ã€‚p.sudogcache å¯ä»¥è®¤ä¸ºå®ƒæ˜¯â€œäºŒçº§ç¼“å­˜â€ï¼Œæ˜¯æœ¬åœ°ç¼“å­˜ä¸ä¼šè¢« GC æ¸…ç†æ‰ã€‚</p><h3 id=å‘é€æ”¶å°¾>å‘é€æ”¶å°¾<a hidden class=anchor aria-hidden=true href=#å‘é€æ”¶å°¾>#</a></h3><p>chansend æœ€åçš„ä»£ç é€»è¾‘æ˜¯å½“ goroutine å”¤é†’ä»¥åï¼Œè§£é™¤é˜»å¡çš„çŠ¶æ€ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#75715e>// someone woke us up.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;G waiting list is corrupted&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>activeStackChans</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>closed</span> <span style=color:#f92672>:=</span> !<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>success</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>blockevent</span>(<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span><span style=color:#f92672>-</span><span style=color:#a6e22e>t0</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releaseSudog</span>(<span style=color:#a6e22e>mysg</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>closed</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;chansend: spurious wakeup&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;send on closed channel&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>sudog ç®—æ˜¯å¯¹ g çš„ä¸€ç§å°è£…ï¼Œé‡Œé¢åŒ…å«äº† gï¼Œè¦å‘é€çš„æ•°æ®ä»¥åŠç›¸å…³çš„çŠ¶æ€ã€‚goroutine è¢«å”¤é†’åä¼šå®Œæˆ channel çš„é˜»å¡æ•°æ®å‘é€ã€‚å‘é€å®Œæœ€åè¿›è¡ŒåŸºæœ¬çš„å‚æ•°æ£€æŸ¥ï¼Œè§£é™¤ channel çš„ç»‘å®šå¹¶é‡Šæ”¾ sudogã€‚</p><p>sudogçš„é‡Šæ”¾:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>releaseSudog</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>elem</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: sudog with non-nil elem&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>isSelect</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: sudog with non-false isSelect&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>next</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: sudog with non-nil next&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>prev</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: sudog with non-nil prev&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>waitlink</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: sudog with non-nil waitlink&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>c</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: sudog with non-nil c&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è·å–å½“å‰g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: releaseSudog with non-nil gp.param&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è·å–å½“å‰m
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acquirem</span>() <span style=color:#75715e>// avoid rescheduling to another P
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// è·å–å½“å‰p
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>) <span style=color:#f92672>==</span> cap(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å¦‚æœæœ¬åœ°sudogç¼“å­˜å·²æ»¡ï¼Œè¿ç§»ä¸€åŠçš„sudogåˆ°å…¨å±€ä¸­å¿ƒç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>first</span>, <span style=color:#a6e22e>last</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> len(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>) &gt; cap(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>[<span style=color:#a6e22e>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>[<span style=color:#a6e22e>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span> = <span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>[:<span style=color:#a6e22e>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>first</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>first</span> = <span style=color:#a6e22e>p</span>
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>last</span>.<span style=color:#a6e22e>next</span> = <span style=color:#a6e22e>p</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>last</span> = <span style=color:#a6e22e>p</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>sudoglock</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>last</span>.<span style=color:#a6e22e>next</span> = <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>sudogcache</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>sudogcache</span> = <span style=color:#a6e22e>first</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>sudoglock</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç›´æ¥åŠ åˆ°æœ¬åœ°sudogç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span> = append(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>sudogcache</span>, <span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>mp</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=å°ç»“>å°ç»“<a hidden class=anchor aria-hidden=true href=#å°ç»“>#</a></h3><table><thead><tr><th style=text-align:center></th><th style=text-align:center>Channel Status</th><th style=text-align:center>Result</th></tr></thead><tbody><tr><td style=text-align:center>Write</td><td style=text-align:center>nil</td><td style=text-align:center>é˜»å¡</td></tr><tr><td style=text-align:center>Write</td><td style=text-align:center>open and full</td><td style=text-align:center>é˜»å¡</td></tr><tr><td style=text-align:center>Write</td><td style=text-align:center>open and not full</td><td style=text-align:center>success</td></tr><tr><td style=text-align:center>Write</td><td style=text-align:center>colsed</td><td style=text-align:center>panic</td></tr><tr><td style=text-align:center>Write</td><td style=text-align:center>read only</td><td style=text-align:center>compiler error</td></tr></tbody></table><ul><li><ol><li>å½“æ¥æ”¶é˜Ÿåˆ—ä¸­å­˜åœ¨ sudog å¯ä»¥ç›´æ¥å‘é€æ•°æ®æ—¶ï¼Œæ‰§è¡ŒÂ <code>goready()</code>å°† g æ’å…¥ runnext æ’æ§½ä¸­ï¼ŒçŠ¶æ€ä» Gwaiting æˆ–è€… Gscanwaiting æ”¹å˜æˆ Grunnableï¼Œç­‰å¾…ä¸‹æ¬¡è°ƒåº¦ä¾¿ç«‹å³è¿è¡Œã€‚</li></ol></li><li><ol start=2><li>å½“ channel é˜»å¡æ—¶ï¼Œæ‰§è¡ŒÂ <code>gopark()</code>Â å°† g é˜»å¡ï¼Œè®©å‡º cpu çš„ä½¿ç”¨æƒã€‚</li></ol></li></ul><p>éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œé€šé“å¹¶ä¸æä¾›è·¨ goroutine çš„æ•°æ®è®¿é—®ä¿æŠ¤æœºåˆ¶ã€‚å¦‚æœé€šè¿‡é€šé“ä¼ è¾“æ•°æ®çš„ä¸€ä»½å‰¯æœ¬ï¼Œé‚£ä¹ˆæ¯ä¸ª goroutine éƒ½æŒæœ‰ä¸€ä»½å‰¯æœ¬ï¼Œå„è‡ªå¯¹è‡ªå·±çš„å‰¯æœ¬åšä¿®æ”¹æ˜¯å®‰å…¨çš„ã€‚å½“ä¼ è¾“çš„æ˜¯æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆæ—¶ï¼Œå¦‚æœè¯»å’Œå†™æ˜¯ç”±ä¸åŒçš„ goroutine å®Œæˆçš„ï¼Œé‚£ä¹ˆæ¯ä¸ª goroutine ä¾æ—§éœ€è¦é¢å¤–çš„åŒæ­¥æ“ä½œã€‚</p><h2 id=æ¥æ”¶æ•°æ®>æ¥æ”¶æ•°æ®<a hidden class=anchor aria-hidden=true href=#æ¥æ”¶æ•°æ®>#</a></h2><p>channelæ¥æ”¶æ•°æ®çš„ä»£ç åœ¨/src/runtime/chan.go:455.</p><h3 id=å¼‚å¸¸æ£€æŸ¥-1>å¼‚å¸¸æ£€æŸ¥<a hidden class=anchor aria-hidden=true href=#å¼‚å¸¸æ£€æŸ¥-1>#</a></h3><p>å’Œsendä¸€æ ·ï¼Œä¸€å¼€å§‹ä¹Ÿæ˜¯ä¸€æ®µæ£€æŸ¥ä»£ç ï¼Œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// chanrecvç”¨äºåœ¨cä¸Šæ¥æ”¶å€¼å¹¶èµ‹å€¼ç»™epï¼Œblockå†³å®šæ˜¯å¦é˜»å¡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>chanrecv</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>ep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>block</span> <span style=color:#66d9ef>bool</span>) (<span style=color:#a6e22e>selected</span>, <span style=color:#a6e22e>received</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debugChan</span> {
</span></span><span style=display:flex><span>		print(<span style=color:#e6db74>&#34;chanrecv: chan=&#34;</span>, <span style=color:#a6e22e>c</span>, <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gopark</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>waitReasonChanReceiveNilChan</span>, <span style=color:#a6e22e>traceEvGoStop</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;unreachable&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ— é”å¼‚å¸¸æ£€æŸ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// éé˜»å¡ä¸”channelä¸ºç©º
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>block</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>empty</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// å¦‚æœchannelä¸ºç©ºä¸”æœªå…³é—­ï¼Œè¡¨ç¤ºæ²¡æœ‰æ•°æ®å¯æ¥æ”¶,å¯ç›´æ¥return
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šåœ¨ç¬¬ä¸€æ¬¡è§‚å¯Ÿåˆ°ä¸ºç©ºåï¼Œç¬¬äºŒæ¬¡è§‚å¯Ÿä¹‹å‰ï¼Œæ–°å¢äº†æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>empty</span>(<span style=color:#a6e22e>c</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>raceacquire</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ep</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>typedmemclr</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>ep</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#75715e>// å¦‚æœ channel å·²ç»å…³é—­ä¸”ä¸å­˜åœ¨ç¼“å­˜æ•°æ®äº†ï¼Œåˆ™æ¸…ç† ep æŒ‡é’ˆä¸­çš„æ•°æ®å¹¶è¿”å›ã€‚è¿™é‡Œä¹Ÿæ˜¯ä»å·²ç»å…³é—­çš„ channel ä¸­è¯»æ•°æ®ï¼Œè¯»å‡ºæ¥çš„æ˜¯è¯¥ç±»å‹é›¶å€¼çš„åŸå› ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=åŒæ­¥æ¥æ”¶>åŒæ­¥æ¥æ”¶<a hidden class=anchor aria-hidden=true href=#åŒæ­¥æ¥æ”¶>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendq</span>.<span style=color:#a6e22e>dequeue</span>(); <span style=color:#a6e22e>sg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å­˜åœ¨ç­‰å¾…ä¸­çš„senderã€‚å¦‚æœç¼“å†²åŒºå¤§å°ä¸º 0ï¼Œåˆ™ç›´æ¥ä»senderæ¥æ”¶å€¼.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// å¦åˆ™ï¼Œä»£è¡¨ç¼“å†²åŒºå·²æ»¡ï¼Œä»é˜Ÿåˆ—å¤´éƒ¨æ¥æ”¶å¹¶å°†senderçš„å€¼æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>recv</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>) }, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>ğŸ“¢è¦æ³¨æ„ä¸€ç‚¹ï¼Œå­˜åœ¨ç­‰å¾…ä¸­çš„å‘é€è€…ï¼Œå¦‚æœchannelæœ‰ç¼“å†²åŒºï¼Œé‚£ç¼“å†²åŒºä¸€å®šæ˜¯æ»¡çš„ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>recv</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>, <span style=color:#a6e22e>sg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sudog</span>, <span style=color:#a6e22e>ep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>unlockf</span> <span style=color:#66d9ef>func</span>(), <span style=color:#a6e22e>skip</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// channelæ— ç¼“å†²åŒºï¼Œå°†senderçš„å€¼èµ‹ç»™ep
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>racesync</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>sg</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ep</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// copy data from sender
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>recvDirect</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>sg</span>, <span style=color:#a6e22e>ep</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// è¿›å…¥è¿™éƒ¨åˆ†ä»£ç ä»£è¡¨channelå­˜åœ¨ç¼“å†²åŒºä¸”å·²æ»¡. 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// bufä¸­é˜Ÿé¦–ä½ç½®çš„é‚£ä¸€ä¸ªå€¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>qp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chanbuf</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>racenotify</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>racenotify</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span>, <span style=color:#a6e22e>sg</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å°†qpå€¼èµ‹ç»™ep
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ep</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>typedmemmove</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#a6e22e>qp</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// å°†senderçš„ä¸­çš„å€¼èµ‹ç»™qp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>typedmemmove</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>qp</span>, <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// é˜Ÿé¦–æŒ‡é’ˆ++ï¼Œqpå¯¹åº”çš„ä½ç½®æˆäº†é˜Ÿå°¾
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// é˜Ÿæ»¡çš„æƒ…å†µä¸‹sendxå’Œrecvxç›¸ç­‰
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendx</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span> <span style=color:#75715e>// c.sendx = (c.sendx+1) % c.dataqsiz
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ä¿®æ”¹sgçŠ¶æ€ï¼Œå”¤é†’å¯¹åº”g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlockf</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>sg</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#a6e22e>cputicks</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>goready</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>skip</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=å¼‚æ­¥æ¥æ”¶>å¼‚æ­¥æ¥æ”¶<a hidden class=anchor aria-hidden=true href=#å¼‚æ­¥æ¥æ”¶>#</a></h3><p>å¦‚æœchannelä¸Šæ²¡æœ‰ç­‰å¾…ä¸­çš„senderï¼Œä½†æ˜¯ç¼“å†²åŒºä¸Šæœ‰æ•°æ®æ—¶ï¼Œé‚£ä¹ˆå°±æ¥æ”¶ç¼“å†²åŒºå†…çš„æ•°æ®</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>qp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>chanbuf</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>racenotify</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ep</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>typedmemmove</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>ep</span>, <span style=color:#a6e22e>qp</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>typedmemclr</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>qp</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>dataqsiz</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvx</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>qcount</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>è¿™é‡Œæ²¡æœ‰ä»€ä¹ˆå¥½ç‰¹åˆ«çš„ã€‚</p><h3 id=é˜»å¡æ¥æ”¶>é˜»å¡æ¥æ”¶<a hidden class=anchor aria-hidden=true href=#é˜»å¡æ¥æ”¶>#</a></h3><p>å½“ç¼“å†²åŒºå†…ä¹Ÿæ²¡æœ‰æ•°æ®æ—¶ï¼Œå¦‚æœé€‰æ‹©äº†é˜»å¡æ¥æ”¶ï¼Œæ­¤æ—¶åªèƒ½è¿›è¡Œç­‰å¾…</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#75715e>// no sender available: block on this channel.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// è·å–å½“å‰g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ–°å»ºæˆ–ä»ç¼“å­˜è·å–sudog
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acquireSudog</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è®¾ç½®sudogçš„å€¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t0</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// No stack splits between assigning elem and enqueuing mysg
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// on gp.waiting where copystack can find it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#a6e22e>ep</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>waitlink</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#a6e22e>mysg</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>gp</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>isSelect</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å°†sudogåŠ å…¥channelçš„æ¥æ”¶è€…é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>enqueue</span>(<span style=color:#a6e22e>mysg</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Signal to anyone trying to shrink our stack that we&#39;re about
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// to park on a channel. The window between when this G&#39;s status
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// changes and when we set gp.activeStackChans is not safe for
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// stack shrinking.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// è®¾ç½®åŸå­ä¿¡å·ã€‚å½“æ ˆè¦ shrink æ”¶ç¼©æ—¶ï¼Œè¿™ä¸ªæ ‡è®°ä»£è¡¨å½“å‰ goroutine è¿˜ parking åœåœ¨æŸä¸ª channel ä¸­ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// åœ¨ g çŠ¶æ€å˜æ›´ä¸è®¾ç½® activeStackChans çŠ¶æ€è¿™ä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´çš„æ—¶é—´çª—å£è¿›è¡Œæ ˆ shrink æ”¶ç¼©æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®è¿™ä¸ªåŸå­ä¿¡å·ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Store8</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>parkingOnChan</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è°ƒç”¨ gopark æ–¹æ³•æŒ‚èµ·å½“å‰ goroutineï¼ŒçŠ¶æ€ä¸º waitReasonChanReceiveï¼Œé˜»å¡ç­‰å¾… channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gopark</span>(<span style=color:#a6e22e>chanparkcommit</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>), <span style=color:#a6e22e>waitReasonChanReceive</span>, <span style=color:#a6e22e>traceEvGoBlockRecv</span>, <span style=color:#ae81ff>2</span>)
</span></span></code></pre></div><p>è¿™é‡Œå’Œchansendä¸­çš„é˜»å¡éƒ¨åˆ†å‡ ä¹ä¸€æ ·ï¼Œä½†æ˜¯ä½œä¸ºæ¥æ”¶æ–¹ï¼Œä¸ç”¨<code>KeepAlive(ep)</code>æ¥ç¡®ä¿æ•°æ®ä¸è¢«å›æ”¶</p><p>è¢«å”¤é†’å:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#75715e>// someone woke us up
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;G waiting list is corrupted&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waiting</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>activeStackChans</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>blockevent</span>(<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>releasetime</span><span style=color:#f92672>-</span><span style=color:#a6e22e>t0</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>success</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>success</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mysg</span>.<span style=color:#a6e22e>c</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releaseSudog</span>(<span style=color:#a6e22e>mysg</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>success</span>
</span></span></code></pre></div><p>goroutine è¢«å”¤é†’åä¼šå®Œæˆ channel çš„é˜»å¡æ•°æ®æ¥æ”¶ã€‚æ¥æ”¶å®Œæœ€åè¿›è¡ŒåŸºæœ¬çš„å‚æ•°æ£€æŸ¥ï¼Œè§£é™¤ channel çš„ç»‘å®šå¹¶é‡Šæ”¾ sudogã€‚</p><h3 id=å°ç»“-1>å°ç»“<a hidden class=anchor aria-hidden=true href=#å°ç»“-1>#</a></h3><p>channelè¯»å–æ“ä½œå„çŠ¶æ€:</p><table><thead><tr><th></th><th>Channel status</th><th>Result</th></tr></thead><tbody><tr><td>Read</td><td>nil</td><td>block</td></tr><tr><td>Read</td><td>open and not empty</td><td>read success</td></tr><tr><td>Read</td><td>open and empty</td><td>block</td></tr><tr><td>Read</td><td>closed</td><td>default value,false</td></tr><tr><td>Read</td><td>read only</td><td>Compole Error</td></tr></tbody></table><p>chanrecv çš„è¿”å›å€¼æœ‰å‡ ç§æƒ…å†µï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>tmp</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span>
</span></span></code></pre></div><table><thead><tr><th>Channel status</th><th>Selected</th><th>Received</th></tr></thead><tbody><tr><td>nil</td><td>false</td><td>false</td></tr><tr><td>open and not empty</td><td>true</td><td>true</td></tr><tr><td>open and empty</td><td>false</td><td>false</td></tr><tr><td>closed</td><td>true</td><td>false</td></tr><tr><td>receivedå€¼å¯¹åº”okï¼Œselected å€¼ä¸ä¼šè¢«å¤–éƒ¨ä½¿ç”¨ã€‚</td><td></td><td></td></tr></tbody></table><p>channel æ¥æ”¶è¿‡ç¨‹ä¸­åŒ…å« 2 æ¬¡æœ‰å…³ goroutine è°ƒåº¦è¿‡ç¨‹ï¼š</p><ol><li>å½“ channel ä¸º nil æ—¶ï¼Œæ‰§è¡Œ gopark() æŒ‚èµ·å½“å‰çš„ goroutineã€‚</li><li>å½“å‘é€é˜Ÿåˆ—ä¸­å­˜åœ¨ sudog å¯ä»¥ç›´æ¥æ¥æ”¶æ•°æ®æ—¶ï¼Œæ‰§è¡Œ goready()å°† g æ’å…¥ runnext æ’æ§½ä¸­ï¼ŒçŠ¶æ€ä» Gwaiting æˆ–è€… Gscanwaiting æ”¹å˜æˆ Grunnableï¼Œç­‰å¾…ä¸‹æ¬¡è°ƒåº¦ä¾¿ç«‹å³è¿è¡Œã€‚</li><li>å½“ channel ç¼“å†²åŒºä¸ºç©ºï¼Œä¸”æ²¡æœ‰å‘é€è€…æ—¶ï¼Œè¿™æ—¶ channel é˜»å¡ï¼Œæ‰§è¡Œ gopark() å°† g é˜»å¡ï¼Œè®©å‡º cpu çš„ä½¿ç”¨æƒå¹¶ç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚</li></ol><h2 id=å…³é—­channel>å…³é—­channel<a hidden class=anchor aria-hidden=true href=#å…³é—­channel>#</a></h2><p>å…³é—­channelçš„æ‰‹æ®µ:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>close(<span style=color:#a6e22e>ch</span>)
</span></span></code></pre></div><p>ç¼–è¯‘å™¨ä¼šå°†å…¶è½¬æ¢ä¸º/src/runtime/chan.go:356å¤„çš„runtime.closechan() æ–¹æ³•ã€‚</p><h3 id=å¼‚å¸¸æ£€æŸ¥-2>å¼‚å¸¸æ£€æŸ¥<a hidden class=anchor aria-hidden=true href=#å¼‚å¸¸æ£€æŸ¥-2>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>closechan</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hchan</span>) {	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;close of nil channel&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>plainError</span>(<span style=color:#e6db74>&#34;close of closed channel&#34;</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>callerpc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getcallerpc</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>racewritepc</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>(), <span style=color:#a6e22e>callerpc</span>, <span style=color:#a6e22e>abi</span>.<span style=color:#a6e22e>FuncPCABIInternal</span>(<span style=color:#a6e22e>closechan</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>racerelease</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>closed</span> = <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>å¦‚æœchannelä¸ºnilæˆ–è€…å·²å…³é—­çš„è¯ï¼Œpanicã€‚
å¦åˆ™ï¼Œæ ‡è®°channelçš„closedå­—æ®µä¸º1ã€‚</p><h3 id=é‡Šæ”¾æ‰€æœ‰æ¥æ”¶è€…å’Œå‘é€è€…>é‡Šæ”¾æ‰€æœ‰æ¥æ”¶è€…å’Œå‘é€è€…<a hidden class=anchor aria-hidden=true href=#é‡Šæ”¾æ‰€æœ‰æ¥æ”¶è€…å’Œå‘é€è€…>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>glist</span> <span style=color:#a6e22e>gList</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// release all readers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// é‡Šæ”¾æ¥æ”¶è€…ï¼Œå°†ç­‰å¾…é˜Ÿåˆ—recvqä¸­çš„sudogæ¸…é™¤ï¼Œå¹¶æŠŠå¯¹åº”çš„géƒ½åŠ å…¥åˆ°å¾…æ¸…é™¤é˜Ÿåˆ— glist ä¸­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>recvq</span>.<span style=color:#a6e22e>dequeue</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>typedmemclr</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>elemtype</span>, <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#a6e22e>cputicks</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>sg</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>raceacquireg</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>())
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>glist</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>gp</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// release all writers (they will panic)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>sendq</span>.<span style=color:#a6e22e>dequeue</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>elem</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>releasetime</span> = <span style=color:#a6e22e>cputicks</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>param</span> = <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>sg</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sg</span>.<span style=color:#a6e22e>success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>raceacquireg</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>raceaddr</span>())
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>glist</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>gp</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span></code></pre></div><h3 id=æ‰§è¡Œåç¨‹è°ƒåº¦>æ‰§è¡Œåç¨‹è°ƒåº¦<a hidden class=anchor aria-hidden=true href=#æ‰§è¡Œåç¨‹è°ƒåº¦>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Ready all Gs now that we&#39;ve dropped the channel lock.  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>glist</span>.<span style=color:#a6e22e>empty</span>() {  
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>glist</span>.<span style=color:#a6e22e>pop</span>()  
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>schedlink</span> = <span style=color:#ae81ff>0</span>  
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>goready</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#ae81ff>3</span>)  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æœ€åä¼šä¸ºæ‰€æœ‰è¢«é˜»å¡çš„ goroutine è°ƒç”¨ goready è§¦å‘è°ƒåº¦ã€‚å°†æ‰€æœ‰ glist ä¸­çš„ goroutine çŠ¶æ€ä» _Gwaiting è®¾ç½®ä¸º _Grunnable çŠ¶æ€ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚</p><h3 id=ä¼˜é›…å…³é—­>ä¼˜é›…å…³é—­<a hidden class=anchor aria-hidden=true href=#ä¼˜é›…å…³é—­>#</a></h3><p>â€œChannel æœ‰å‡ ç§ä¼˜é›…çš„å…³é—­æ–¹æ³•ï¼Ÿâ€ è¿™ç§é—®é¢˜å¸¸å¸¸å‡ºç°åœ¨é¢è¯•é¢˜ä¸­ï¼Œç©¶å…¶åŸå› æ˜¯å› ä¸º Channel åˆ›å»ºå®¹æ˜“ï¼Œä½†æ˜¯å…³é—­â€œä¸æ˜“â€ï¼š</p><ul><li>åœ¨ä¸æ”¹å˜ Channel è‡ªèº«çŠ¶æ€çš„æ¡ä»¶ä¸‹ï¼Œæ— æ³•çŸ¥é“å®ƒæ˜¯å¦å·²ç»å…³é—­ã€‚â€œä¸æ˜“â€ä¹‹ä¸€ï¼Œå…³é—­æ—¶æœºæœªçŸ¥ã€‚</li><li>å¦‚æœä¸€ä¸ª Channel å·²ç»å…³é—­ï¼Œé‡å¤å…³é—­ Channel ä¼šå¯¼è‡´ panicã€‚â€œä¸æ˜“â€ä¹‹äºŒï¼Œä¸èƒ½æ— è„‘å…³é—­ã€‚</li><li>å¾€ä¸€ä¸ª close çš„ Channel å†…å†™æ•°æ®ï¼Œä¹Ÿä¼šå¯¼è‡´ panicã€‚â€œä¸æ˜“â€ä¹‹ä¸‰ï¼Œå†™æ•°æ®ä¹‹å‰ä¹Ÿéœ€è¦å…³æ³¨æ˜¯å¦ close çš„çŠ¶æ€ã€‚</li></ul><table><thead><tr><th></th><th>Channel status</th><th>Result</th></tr></thead><tbody><tr><td>close</td><td>nil</td><td>panic</td></tr><tr><td>close</td><td>open and not empty</td><td>å…³é—­ Channelï¼›è¯»å–æˆåŠŸï¼Œç›´åˆ° Channel è€—å°½æ•°æ®ï¼Œç„¶åè¯»å–äº§ç”Ÿå€¼çš„é»˜è®¤å€¼</td></tr><tr><td>close</td><td>open and empty</td><td>å…³é—­ Channelï¼›è¯»åˆ°ç”Ÿäº§è€…çš„é»˜è®¤å€¼</td></tr><tr><td>close</td><td>closed</td><td>panic</td></tr><tr><td>close</td><td>read only</td><td>Compile Error</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><p>é‚£ç©¶ç«Ÿä»€ä¹ˆæ—¶å€™å…³é—­ Channel å‘¢ï¼Ÿç”±ä¸Šé¢ä¸‰ä¸ªâ€œä¸æ˜“â€ï¼Œå¯ä»¥æµ“ç¼©ä¸º 2 ç‚¹ï¼š</p><ul><li>ä¸èƒ½ç®€å•çš„ä»æ¶ˆè´¹è€…ä¾§å…³é—­ Channelã€‚</li><li>å¦‚æœæœ‰å¤šä¸ªç”Ÿäº§è€…ï¼Œå®ƒä»¬ä¸èƒ½å…³é—­ Channelã€‚</li></ul><p>è§£é‡Šä¸€ä¸‹è¿™ 2 ä¸ªé—®é¢˜ã€‚ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæ¶ˆè´¹è€…ä¸çŸ¥é“ Channel ä½•æ—¶è¯¥å…³é—­ã€‚å¦‚æœå…³é—­äº†å·²ç»å…³é—­çš„ Channel ä¼šå¯¼è‡´ panicã€‚è€Œä¸”åˆ†å¸ƒå¼åº”ç”¨é€šå¸¸æœ‰å¤šä¸ªæ¶ˆè´¹è€…ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…çš„è¡Œä¸ºä¸€è‡´ï¼Œè¿™ä¹ˆå¤šæ¶ˆè´¹è€…éƒ½å°è¯•å…³é—­ Channel å¿…ç„¶ä¼šå¯¼è‡´ panicã€‚ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå¦‚æœæœ‰å¤šä¸ªç”Ÿäº§è€…å¾€ Channel å†…å†™å…¥æ•°æ®ï¼Œè¿™äº›ç”Ÿäº§è€…çš„è¡Œä¸ºé€»è¾‘ä¹Ÿéƒ½ä¸€è‡´ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªç”Ÿäº§è€…å…³é—­äº† Channelï¼Œå…¶ä»–çš„ç”Ÿäº§è€…è¿˜åœ¨å¾€é‡Œå†™ï¼Œè¿™ä¸ªæ—¶å€™ä¼š panicã€‚æ‰€ä»¥ä¸ºäº†é˜²æ­¢ panicï¼Œå¿…é¡»è§£å†³ä¸Šé¢è¿™ 2 ä¸ªé—®é¢˜ã€‚</p><h3 id=context-æ–¹å¼>context æ–¹å¼<a hidden class=anchor aria-hidden=true href=#context-æ–¹å¼>#</a></h3><h3 id=done-channel-æ–¹å¼>done channel æ–¹å¼<a hidden class=anchor aria-hidden=true href=#done-channel-æ–¹å¼>#</a></h3></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://www.yici.xin/post/tech/go-sync-pool/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>Go Sync Pool</span></a>
<a class=next href=https://www.yici.xin/post/tech/short_code/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>Short_code</span></a></nav></footer><script type=text/javascript>let giscusTheme=localStorage.getItem("pref-theme")==="dark"?"dark_dimmed":"light",giscusAttributes={src:"https://giscus.app/client.js","data-repo":"yicixin/blog_comment","data-repo-id":"R_kgDOIr6QyQ","data-category":"Announcements","data-category-id":"DIC_kwDOIr6Qyc4CTSs3","data-mapping":"title","data-reactions-enabled":"1","data-emit-metadata":"0","data-theme":giscusTheme===null?"light":giscusTheme,"data-lang":"zh-CN",crossorigin:"anonymous","data-loading":"lazy",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([e,t])=>giscusScript.setAttribute(e,t));var article=document.getElementsByTagName("article")[0].appendChild(giscusScript);function changeGiscusTheme(){const e=localStorage.getItem("pref-theme")==="dark"?"light":"dark_dimmed";function t(e){const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}t({setConfig:{theme:e}})}const toggle=document.querySelector("#theme-toggle");toggle&&toggle.addEventListener("click",changeGiscusTheme)</script><script src=https://giscus.app/client.js data-repo=yicixin/blog_comment data-repo-id=R_kgDOIr6QyQ data-category=Announcements data-category-id=DIC_kwDOIr6Qyc4CTSs3 data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://www.yici.xin/>yicixin's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="ctrl\u002bc";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="ctrl\u002bc"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script src=https://code.jquery.com/jquery-1.12.4.min.js></script>
<script>$("code[class^=language] ").on("mouseover",function(){this.clientWidth<this.scrollWidth&&$(this).css("width","135%")}).on("mouseout",function(){$(this).css("width","100%"),$(".copy-code").css("right","4px")})</script></body></html>