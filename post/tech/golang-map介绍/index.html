<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css integrity=sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.2.1.slim.min.js integrity=sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js integrity=sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js integrity=sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl crossorigin=anonymous></script><title>golang-mapä»‹ç» | yicixin's blog</title>
<meta name=keywords content="golang,map,hashmap,æºç è§£æ"><meta name=description content="æœ¬æ–‡ä¸­ä½¿ç”¨çš„ go ç‰ˆæœ¬ï¼š
go version go1.17.2 darwin/amd64
å†…å®¹æ¦‚è¿° æœ¬æ–‡ä»‹ç» golang ä¸­ç»å¸¸ç”¨åˆ°çš„ç»“æ„-mapï¼Œç®€ç§°å“ˆå¸Œè¡¨ã€å­—å…¸ã€‚ä»‹ç»å…¶ç»“æ„åŠè®¾è®¡æ€è·¯ã€‚
map åœ¨æºç ä¸­çš„ç»“æ„â€”â€”hmap Go è¯­è¨€é‡‡ç”¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„æ˜¯å“ˆå¸ŒæŸ¥æ‰¾è¡¨ï¼Œä½¿ç”¨é“¾è¡¨è§£å†³å“ˆå¸Œå†²çªã€‚
åœ¨æºç ä¸­$GOROOT/src/runtime/map.goï¼Œmap çš„æ ¸å¿ƒç»“æ„ä½“æ˜¯è¿™æ ·çš„ï¼š
// A header for a Go map. type hmap struct { count int // mapä¸­çš„å…ƒç´ æ•°é‡ï¼Œå³len(map)æ—¶çš„è¿”å›å€¼ flags uint8 B uint8 // bucketsçš„ä»¥2ä¸ºåº•çš„å¯¹æ•°, å³2^B=buckets noverflow uint16 // æº¢å‡ºæ¡¶çš„è¿‘ä¼¼æ•°; see incrnoverflow for details hash0 uint32 // å“ˆå¸Œç§å­ buckets unsafe.Pointer // 2^Bä¸ªbucketçš„æ•°ç»„ï¼Œmay be nil if count==0. oldbuckets unsafe.Pointer // å“ˆå¸Œåœ¨æ‰©å®¹æ—¶ç”¨äºä¿å­˜ä¹‹å‰ buckets çš„å­—æ®µï¼Œå®ƒçš„å¤§å°æ˜¯å½“å‰ buckets çš„ä¸€åŠï¼› nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) extra *mapextra // optional fields } åœ¨ä¸Šé¢æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ ¸å¿ƒæ˜¯bucketsï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæœ€ç»ˆæŒ‡å‘äº†bmapç»“æ„ä½“æ•°ç»„"><meta name=author content="å£¹æ¬¡å¿ƒ"><link rel=canonical href=https://www.yici.xin/post/tech/golang-map%E4%BB%8B%E7%BB%8D/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.b35f27175e1d679d5ac37249ed25e28b57702f4740c052621132f937b795fa44.css integrity="sha256-s18nF14dZ51aw3JJ7SXii1dwL0dAwFJiETL5N7eV+kQ=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/js/extended.js></script><link rel=icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=icon type=image/png sizes=16x16 href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=icon type=image/png sizes=32x32 href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=apple-touch-icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=mask-icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="golang-mapä»‹ç»"><meta property="og:description" content="æœ¬æ–‡ä¸­ä½¿ç”¨çš„ go ç‰ˆæœ¬ï¼š
go version go1.17.2 darwin/amd64
å†…å®¹æ¦‚è¿° æœ¬æ–‡ä»‹ç» golang ä¸­ç»å¸¸ç”¨åˆ°çš„ç»“æ„-mapï¼Œç®€ç§°å“ˆå¸Œè¡¨ã€å­—å…¸ã€‚ä»‹ç»å…¶ç»“æ„åŠè®¾è®¡æ€è·¯ã€‚
map åœ¨æºç ä¸­çš„ç»“æ„â€”â€”hmap Go è¯­è¨€é‡‡ç”¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„æ˜¯å“ˆå¸ŒæŸ¥æ‰¾è¡¨ï¼Œä½¿ç”¨é“¾è¡¨è§£å†³å“ˆå¸Œå†²çªã€‚
åœ¨æºç ä¸­$GOROOT/src/runtime/map.goï¼Œmap çš„æ ¸å¿ƒç»“æ„ä½“æ˜¯è¿™æ ·çš„ï¼š
// A header for a Go map. type hmap struct { count int // mapä¸­çš„å…ƒç´ æ•°é‡ï¼Œå³len(map)æ—¶çš„è¿”å›å€¼ flags uint8 B uint8 // bucketsçš„ä»¥2ä¸ºåº•çš„å¯¹æ•°, å³2^B=buckets noverflow uint16 // æº¢å‡ºæ¡¶çš„è¿‘ä¼¼æ•°; see incrnoverflow for details hash0 uint32 // å“ˆå¸Œç§å­ buckets unsafe.Pointer // 2^Bä¸ªbucketçš„æ•°ç»„ï¼Œmay be nil if count==0. oldbuckets unsafe.Pointer // å“ˆå¸Œåœ¨æ‰©å®¹æ—¶ç”¨äºä¿å­˜ä¹‹å‰ buckets çš„å­—æ®µï¼Œå®ƒçš„å¤§å°æ˜¯å½“å‰ buckets çš„ä¸€åŠï¼› nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) extra *mapextra // optional fields } åœ¨ä¸Šé¢æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ ¸å¿ƒæ˜¯bucketsï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæœ€ç»ˆæŒ‡å‘äº†bmapç»“æ„ä½“æ•°ç»„"><meta property="og:type" content="article"><meta property="og:url" content="https://www.yici.xin/post/tech/golang-map%E4%BB%8B%E7%BB%8D/"><meta property="og:image" content="https://www.yici.xin/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-01-05T23:38:06+08:00"><meta property="article:modified_time" content="2022-01-05T23:38:06+08:00"><meta property="og:site_name" content="yicixin's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.yici.xin/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="golang-mapä»‹ç»"><meta name=twitter:description content="æœ¬æ–‡ä¸­ä½¿ç”¨çš„ go ç‰ˆæœ¬ï¼š
go version go1.17.2 darwin/amd64
å†…å®¹æ¦‚è¿° æœ¬æ–‡ä»‹ç» golang ä¸­ç»å¸¸ç”¨åˆ°çš„ç»“æ„-mapï¼Œç®€ç§°å“ˆå¸Œè¡¨ã€å­—å…¸ã€‚ä»‹ç»å…¶ç»“æ„åŠè®¾è®¡æ€è·¯ã€‚
map åœ¨æºç ä¸­çš„ç»“æ„â€”â€”hmap Go è¯­è¨€é‡‡ç”¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„æ˜¯å“ˆå¸ŒæŸ¥æ‰¾è¡¨ï¼Œä½¿ç”¨é“¾è¡¨è§£å†³å“ˆå¸Œå†²çªã€‚
åœ¨æºç ä¸­$GOROOT/src/runtime/map.goï¼Œmap çš„æ ¸å¿ƒç»“æ„ä½“æ˜¯è¿™æ ·çš„ï¼š
// A header for a Go map. type hmap struct { count int // mapä¸­çš„å…ƒç´ æ•°é‡ï¼Œå³len(map)æ—¶çš„è¿”å›å€¼ flags uint8 B uint8 // bucketsçš„ä»¥2ä¸ºåº•çš„å¯¹æ•°, å³2^B=buckets noverflow uint16 // æº¢å‡ºæ¡¶çš„è¿‘ä¼¼æ•°; see incrnoverflow for details hash0 uint32 // å“ˆå¸Œç§å­ buckets unsafe.Pointer // 2^Bä¸ªbucketçš„æ•°ç»„ï¼Œmay be nil if count==0. oldbuckets unsafe.Pointer // å“ˆå¸Œåœ¨æ‰©å®¹æ—¶ç”¨äºä¿å­˜ä¹‹å‰ buckets çš„å­—æ®µï¼Œå®ƒçš„å¤§å°æ˜¯å½“å‰ buckets çš„ä¸€åŠï¼› nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) extra *mapextra // optional fields } åœ¨ä¸Šé¢æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ ¸å¿ƒæ˜¯bucketsï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæœ€ç»ˆæŒ‡å‘äº†bmapç»“æ„ä½“æ•°ç»„"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.yici.xin/post/"},{"@type":"ListItem","position":2,"name":"ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯","item":"https://www.yici.xin/post/tech/"},{"@type":"ListItem","position":3,"name":"golang-mapä»‹ç»","item":"https://www.yici.xin/post/tech/golang-map%E4%BB%8B%E7%BB%8D/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"golang-mapä»‹ç»","name":"golang-mapä»‹ç»","description":"æœ¬æ–‡ä¸­ä½¿ç”¨çš„ go ç‰ˆæœ¬ï¼š\ngo version go1.17.2 darwin/amd64\nå†…å®¹æ¦‚è¿° æœ¬æ–‡ä»‹ç» golang ä¸­ç»å¸¸ç”¨åˆ°çš„ç»“æ„-mapï¼Œç®€ç§°å“ˆå¸Œè¡¨ã€å­—å…¸ã€‚ä»‹ç»å…¶ç»“æ„åŠè®¾è®¡æ€è·¯ã€‚\nmap åœ¨æºç ä¸­çš„ç»“æ„â€”â€”hmap Go è¯­è¨€é‡‡ç”¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„æ˜¯å“ˆå¸ŒæŸ¥æ‰¾è¡¨ï¼Œä½¿ç”¨é“¾è¡¨è§£å†³å“ˆå¸Œå†²çªã€‚\nåœ¨æºç ä¸­$GOROOT/src/runtime/map.goï¼Œmap çš„æ ¸å¿ƒç»“æ„ä½“æ˜¯è¿™æ ·çš„ï¼š\n// A header for a Go map. type hmap struct { count int // mapä¸­çš„å…ƒç´ æ•°é‡ï¼Œå³len(map)æ—¶çš„è¿”å›å€¼ flags uint8 B uint8 // bucketsçš„ä»¥2ä¸ºåº•çš„å¯¹æ•°, å³2^B=buckets noverflow uint16 // æº¢å‡ºæ¡¶çš„è¿‘ä¼¼æ•°; see incrnoverflow for details hash0 uint32 // å“ˆå¸Œç§å­ buckets unsafe.Pointer // 2^Bä¸ªbucketçš„æ•°ç»„ï¼Œmay be nil if count==0. oldbuckets unsafe.Pointer // å“ˆå¸Œåœ¨æ‰©å®¹æ—¶ç”¨äºä¿å­˜ä¹‹å‰ buckets çš„å­—æ®µï¼Œå®ƒçš„å¤§å°æ˜¯å½“å‰ buckets çš„ä¸€åŠï¼› nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) extra *mapextra // optional fields } åœ¨ä¸Šé¢æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ ¸å¿ƒæ˜¯bucketsï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæœ€ç»ˆæŒ‡å‘äº†bmapç»“æ„ä½“æ•°ç»„","keywords":["golang","map","hashmap","æºç è§£æ"],"articleBody":" æœ¬æ–‡ä¸­ä½¿ç”¨çš„ go ç‰ˆæœ¬ï¼š\ngo version go1.17.2 darwin/amd64\nå†…å®¹æ¦‚è¿° æœ¬æ–‡ä»‹ç» golang ä¸­ç»å¸¸ç”¨åˆ°çš„ç»“æ„-mapï¼Œç®€ç§°å“ˆå¸Œè¡¨ã€å­—å…¸ã€‚ä»‹ç»å…¶ç»“æ„åŠè®¾è®¡æ€è·¯ã€‚\nmap åœ¨æºç ä¸­çš„ç»“æ„â€”â€”hmap Go è¯­è¨€é‡‡ç”¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„æ˜¯å“ˆå¸ŒæŸ¥æ‰¾è¡¨ï¼Œä½¿ç”¨é“¾è¡¨è§£å†³å“ˆå¸Œå†²çªã€‚\nåœ¨æºç ä¸­$GOROOT/src/runtime/map.goï¼Œmap çš„æ ¸å¿ƒç»“æ„ä½“æ˜¯è¿™æ ·çš„ï¼š\n// A header for a Go map. type hmap struct { count int // mapä¸­çš„å…ƒç´ æ•°é‡ï¼Œå³len(map)æ—¶çš„è¿”å›å€¼ flags uint8 B uint8 // bucketsçš„ä»¥2ä¸ºåº•çš„å¯¹æ•°, å³2^B=buckets noverflow uint16 // æº¢å‡ºæ¡¶çš„è¿‘ä¼¼æ•°; see incrnoverflow for details hash0 uint32 // å“ˆå¸Œç§å­ buckets unsafe.Pointer // 2^Bä¸ªbucketçš„æ•°ç»„ï¼Œmay be nil if count==0. oldbuckets unsafe.Pointer // å“ˆå¸Œåœ¨æ‰©å®¹æ—¶ç”¨äºä¿å­˜ä¹‹å‰ buckets çš„å­—æ®µï¼Œå®ƒçš„å¤§å°æ˜¯å½“å‰ buckets çš„ä¸€åŠï¼› nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) extra *mapextra // optional fields } åœ¨ä¸Šé¢æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ ¸å¿ƒæ˜¯bucketsï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæœ€ç»ˆæŒ‡å‘äº†bmapç»“æ„ä½“æ•°ç»„\n// A bucket for a Go map. type bmap struct { // tophash generally contains the top byte of the hash value // for each key in this bucket. If tophash[0] \u003c minTopHash, // tophash[0] is a bucket evacuation state instead. // ç¿»è¯‘: tophash å­˜å‚¨äº†æ¯ä¸ªåœ¨è¯¥bucketä¸­çš„keyçš„æœ€é«˜å­—èŠ‚ï¼Œå¦‚æœtophash[0] \u003c minTopHashï¼Œtophash[0]æ˜¯ä¸€ä¸ªæ¡¶ç–æ¾çŠ¶æ€ tophash [bucketCnt]uint8 // Followed by bucketCnt keys and then bucketCnt elems. // NOTE: packing all the keys together and then all the elems together makes the // code a bit more complicated than alternating key/elem/key/elem/... but it allows // us to eliminate padding which would be needed for, e.g., map[int64]int8. // ç¿»è¯‘: æ³¨æ„ï¼ŒæŠŠæ‰€æœ‰é”®æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œç„¶åå†æŠŠæ‰€æœ‰å¯¹åº”å€¼æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œè¿™ä¼šæ¯”é”®å€¼å¯¹äº¤é”™æ›´å¤æ‚ã€‚ä½†è¿™ç§å½¢å¼èƒ½å¤Ÿæ¶ˆé™¤å¤šä½™çš„å¡«å……å­—èŠ‚ï¼Œæ–¹ä¾¿å†…å­˜å¯¹é½ // Followed by an overflow pointer. } bucketCnt æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå®ƒæ˜¯ä¸€ä¸ª bucket èƒ½å¤ŸæŒæœ‰é”®å€¼å¯¹ä¸ªæ•°çš„æœ€å¤§å€¼ã€‚\nå®ƒåœ¨æºç ä¸­æ˜¯è¿™æ ·çš„ï¼š\nbucketCntBits = 3 bucketCnt = 1 \u003c\u003c bucketCntBits å³ bucketCnt = 1 å·¦ç§»ä¸‰ä½ = 8\nbucket çš„ç»“æ„-bmap åœ¨è¿è¡Œæ—¶ï¼Œbmap çš„çœŸæ­£ç»“æ„å¹¶ä¸åƒå®ƒåœ¨æºç é‡Œå±•ç¤ºçš„è¿™ä¹ˆç®€å•ï¼Œåœ¨ç¼–è¯‘æœŸé—´ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æ„ï¼Œè¿™æ˜¯å› ä¸ºå“ˆå¸Œè¡¨ä¸­èƒ½å­˜å‚¨çš„é”®å€¼å¯¹ç±»å‹ä¸ç¡®å®šï¼Œè€Œä¸” Go è¯­è¨€ä¹Ÿä¸æ”¯æŒæ³›å‹ï¼Œä¸å¯èƒ½åœ¨æºç ä¸­å…¨éƒ¨å®šä¹‰ï¼Œæ‰€ä»¥é”®å€¼å¯¹çš„ç±»å‹åŠå…¶å æ®çš„å†…å­˜ç©ºé—´å¤§å°åªèƒ½åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ¨å¯¼ã€‚\nå…·ä½“æ¥è¯´ï¼Œæ˜¯åœ¨ç±»å‹æ£€æŸ¥é˜¶æ®µï¼Œåœ¨è¿™ä¸€æ­¥ AST(æŠ½è±¡è¯­æ³•æ ‘)å°†è½¬æ¢ä¸º SSA(é™æ€å•èµ‹å€¼)å½¢å¼çš„ä¸­é—´ä»£ç ï¼Œmap å…³é”®å­—åŠå…¶æ“ä½œå°†è½¬æ¢ä¸ºå¯¹åº”çš„ runtime å‡½æ•°ï¼Œä¾‹å¦‚:\nv := hash[key] // =\u003e v := runtime.mapaccess1(maptype, hash, \u0026key) æ‰€ä»¥ï¼Œbmap è¿è¡Œæ—¶çš„çœŸæ­£ç»“æ„æ˜¯è¿™æ ·ï¼š\ntype bmap struct { topbits [8]uint8 keys [8]keytype values [8]valuetype pad uintptr overflow uintptr } å…¶ä¸­ï¼Œæ‰€æœ‰çš„ key åœ¨ä¸€ä¸ªç»„é‡Œï¼Œæ‰€æœ‰çš„ value åœ¨ä¸€ä¸ªç»„é‡Œï¼Œè€Œä¸æ˜¯ä»¥{key,value}çš„ç»„æ¥å­˜å‚¨ï¼Œè¿™æ ·èƒ½å¤Ÿå‡å°‘å†…å­˜å¯¹é½å¸¦æ¥çš„å†…å­˜æµªè´¹ã€‚\nbucket çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nå¦‚æœ bucket è£…æ»¡äº†çš„è¯ï¼Œä¼šåˆ›å»ºæ–°çš„ bucketï¼Œå¹¶ä½¿ç”¨ overflow å­—æ®µæŒ‡å‘æ–°çš„ bucketï¼Œå½¢æˆç±»ä¼¼é“¾è¡¨çš„ç»“æ„ã€‚\nä¸€ä¸ª map ä¸­ä¼šå­˜åœ¨ä¸€ä¸ª bucket æ•°ç»„ï¼Œå®ƒä»¬çš„å…³ç³»å¤§æ¦‚åƒè¿™æ ·ã€‚\nè®©æˆ‘ä»¬æš‚åœåˆ†æä¸€ä¸‹ç›®å‰çš„ç»“æ„ï¼Œå½“å¾€ map ä¸­å­˜å‚¨ä¸€ä¸ª kv å¯¹æ—¶ï¼Œé€šè¿‡ k è·å– hash å€¼ï¼Œhash å€¼çš„ä½å…«ä½å’Œ bucket æ•°ç»„é•¿åº¦å–ä½™ï¼Œå®šä½åˆ°æ•°ç»„ä¸­çš„ä¸‹æ ‡ï¼Œhash å€¼çš„é«˜å…«ä½å­˜å‚¨åœ¨ bucket ä¸­çš„ tophash ä¸­ï¼Œç”¨æ¥å¿«é€Ÿåˆ¤æ–­ key æ˜¯å¦å­˜åœ¨ï¼Œkey å’Œ value çš„å…·ä½“å€¼åˆ™é€šè¿‡æŒ‡é’ˆè¿ç®—å­˜å‚¨ï¼Œå½“ä¸€ä¸ª bucket æ»¡æ—¶ï¼Œé€šè¿‡ overfolw æŒ‡é’ˆé“¾æ¥åˆ°ä¸‹ä¸€ä¸ª bucketã€‚\néšç€å“ˆå¸Œè¡¨å­˜å‚¨çš„æ•°æ®é€æ¸å¢å¤šï¼Œæˆ‘ä»¬ä¼šæ‰©å®¹å“ˆå¸Œè¡¨æˆ–è€…ä½¿ç”¨é¢å¤–çš„æ¡¶å­˜å‚¨æº¢å‡ºçš„æ•°æ®ï¼Œä¸ä¼šè®©å•ä¸ªæ¡¶ä¸­çš„æ•°æ®è¶…è¿‡ 8 ä¸ªï¼Œä¸è¿‡æº¢å‡ºæ¡¶åªæ˜¯ä¸´æ—¶çš„è§£å†³æ–¹æ¡ˆï¼Œåˆ›å»ºè¿‡å¤šçš„æº¢å‡ºæ¡¶æœ€ç»ˆä¹Ÿä¼šå¯¼è‡´å“ˆå¸Œçš„æ‰©å®¹ã€‚\né¢„å¤‡ ç®€å•äº†è§£å®Œäº† map çš„æ„æˆä¹‹åï¼Œæ¥ä¸‹æ¥è¦ä»‹ç»çš„å°±æ˜¯å¯¹ map çš„å…·ä½“æ“ä½œäº†ï¼Œä¸ºäº†è¯»è€…èƒ½æ›´å¥½çš„ç†è§£ï¼Œè¿™é‡Œè¦å…ˆè®²ä¸€äº›é¢„å¤‡çŸ¥è¯†ã€‚ä»ä½•è®²èµ·ï¼Ÿå…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ go æ˜¯å¼ºç±»å‹çš„è¯­è¨€ï¼Œå¹¶ä¸”ç›®å‰ä¸ºæ­¢(go1.17)éƒ½è¿˜ä¸æ”¯æŒæ³›å‹ï¼Œé‚£ä¹ˆè¦æ€ä¹ˆè®© map æ”¯æŒè¿™ä¹ˆå¤šç±»å‹å‘¢ï¼Ÿ\nå…ˆæ¥çœ‹çœ‹åˆ«çš„å¼ºç±»å‹è¯­è¨€æ˜¯æ€ä¹ˆåšçš„å§\nC++çš„ map é¦–å…ˆæ¥çœ‹çœ‹ c++ï¼Œè¿™é‡Œç”¨åˆ°äº† c++çš„ç‰¹æ€§ä¹‹ä¸€â€”â€”â€”â€”æ¨¡æ¿(ä¹Ÿå°±æ˜¯æ³›å‹å•¦)ï¼Œc++æ ‡å‡†æ¨¡æ¿åº“ STL æä¾›äº† std::unordered_mapï¼Œç»å¸¸ç”¨æ¥å®ç° hashmapã€‚\nThis is the declaration for std::unordered_map. Itâ€™s a template, so the actual values of the parameters depend on how the template is instantiated.\nè¿™é‡Œæ˜¯std::unordered_mapçš„å®šä¹‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼Œæ‰€ä»¥å®é™…çš„å‚æ•°å€¼å†³å®šæ¨¡æ¿å¦‚ä½•åˆå§‹åŒ–ã€‚\ntemplate\u003c class Key, // the type of the key class T, // the type of the value class Hash = std::hash\u003cKey\u003e, // the hash function class KeyEqual = std::equal_to\u003cKey\u003e, // the key equality function class Allocator = std::allocator\u003c std::pair\u003cconst Key, T\u003e \u003e \u003e class unordered_map; é€šè¿‡è¿™äº›å‚æ•°èƒ½çŸ¥é“ï¼š\nkey å’Œ value çš„ç±»å‹Keyã€Tï¼Œä¹Ÿå°±çŸ¥é“äº†å®ƒä»¬çš„å¤§å°ã€‚ KeyEqualï¼Œç±»å‹æ˜¯std::equal_toï¼Œè¡¨ç¤ºè¿™ä¸ªæ˜¯ä¸€ä¸ªå¤„ç†Keyçš„å“ˆå¸Œå‡½æ•°ï¼Œç”¨æ¥æ±‚ key çš„å“ˆå¸Œå€¼ Allocatorï¼Œç±»å‹æ˜¯std::equal_toï¼ŒåŒæ ·ä¹Ÿæ˜¯å¤„ç†Keyçš„å‡½æ•°ï¼Œç”¨äºæ¯”è¾ƒä¸¤ä¸ª key æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œç¼–è¯‘å™¨å°±èƒ½åœ¨ç¼–è¯‘æ—¶ç¡®å®šç±»å‹ï¼Œç”Ÿæˆå¯¹åº”çš„ç¡®å®šç±»å‹çš„ä»£ç äº†ã€‚\næ¥æº: å¼•ç”¨ 11\nc++çš„ map æŸ¥è¯¢æ“ä½œç®€å•æ¥è¯´æ˜¯è¿™æ ·çš„ï¼Œå¦‚ä¸Šå›¾ï¼Œé¦–å…ˆæˆ‘ä»¬å°† key ä¼ ç»™ std::hash å‡½æ•°ä»¥å¾—åˆ° key çš„ hash å€¼ã€‚ç„¶ååšæ©ç å¹¶å–åˆ° bucket æ•°ç»„ä¸­çš„åºå·ï¼Œæ¥ç€å†éå†å¯¹åº” bucket çš„ entry åˆ—è¡¨å¹¶ç”¨ std::equal_to å‡½æ•°æ¥æ¯”è¾ƒ keyã€‚\njava çš„ map ç¬¬äºŒä¸ªè¦è°ˆçš„æ˜¯ javaï¼Œä¸å‡ºæ‰€æ–™ï¼Œjava ä¸­ hashmap ç±»å‹å°±æ˜¯java.util.Hashmapã€‚\nåœ¨ java ä¸­ï¼Œ java.util.Hashmapåªèƒ½å¤Ÿæ“ä½œå¯¹è±¡ï¼Œå› ä¸º java ä¸‡ç‰©çš†å¯¹è±¡ ğŸ¤ªï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æ¥æºäºjava.lang.Objectï¼Œå¯ä»¥ç»§æ‰¿æˆ–é‡å†™hashCode å’Œ equals æ–¹æ³•ã€‚\nå½“ç„¶ï¼Œæœ‰ 8 ç§åŸºç¡€ç±»å‹ä¸èƒ½å¤Ÿè¿™æ ·æ“ä½œbooleanï¼Œ intï¼Œ shortï¼Œ longï¼Œ byteï¼Œ charï¼Œ floatï¼Œ and doubleï¼Œå› ä¸ºå®ƒä»¬ä¸æ˜¯java.lang.Objectçš„å­ç±»ï¼Œéš¾é“è¯´åŸºç¡€ç±»å‹æ²¡æ³•ä½œä¸º key æˆ– value å—ï¼Ÿéä¹Ÿï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé™åˆ¶ï¼Œjava ä¼šéšå¼è½¬æ¢åŸºç¡€ç±»å‹ä¸ºå®ƒä»¬å¯¹åº”çš„å¯¹è±¡ï¼Œè¿™ç§æ“ä½œå«è£…ç®±ã€‚\næ¥æº: å¼•ç”¨ 11\njava ä¸­çš„æŸ¥æ‰¾æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆæˆ‘ä»¬è°ƒç”¨ key çš„ hashCode æ–¹æ³•æ¥è·å–å®ƒçš„ hash å€¼ï¼Œç„¶ååšæ©ç æ“ä½œï¼Œè·å–åˆ° bucket æ•°ç»„ä¸­çš„å¯¹åº”ä½ç½®ï¼Œé‡Œé¢å­˜æ”¾äº†ä¸€ä¸ªæŒ‡å‘ Entry çš„æŒ‡é’ˆã€‚Entry ä¸­æœ‰ä¸€ä¸ª keyï¼Œä¸€ä¸ª valueï¼Œè¿˜æœ‰ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ª Entry çš„æŒ‡é’ˆï¼Œå½¢æˆäº†ä¸€ä¸ª linked listã€‚\nä¼˜ç¼ºç‚¹ ç°åœ¨æˆ‘ä»¬çŸ¥é“äº† hashmap åœ¨ c++å’Œ java ä¸­çš„å®ç°äº†ï¼Œæ¥æ¯”è¾ƒä¸€ä¸‹ä»–ä»¬çš„ä¼˜ç¼ºç‚¹ï¼š\nc++ ä¼˜ç‚¹ï¼š\nkey å’Œ value ç±»å‹çš„å¤§å°åœ¨ç¼–è¯‘æœŸé—´å°±ç¡®å®šäº†ã€‚ ä¸éœ€è¦è£…ç®±æ“ä½œã€‚ ç”±äºä»£ç åœ¨ç¼–è¯‘æœŸé—´å°±å®šä¸‹æ¥äº†ï¼Œæ‰€ä»¥å…¶ä»–ç¼–è¯‘ä¼˜åŒ–æ“ä½œä¾‹å¦‚å†…è”ï¼Œå¸¸æ•°æŠ˜å å’Œæ­»ä»£ç åˆ é™¤å°±å¯ä»¥ä»‹å…¥äº†ã€‚ æ€»ä¹‹ï¼ŒC++ä¸­çš„ map å’Œè‡ªå·±ä¸ºæ¯ç§ key/value ç±»å‹ç»„åˆæ‰‹å†™çš„ç‰¹å®š map ä¸€æ ·å¿«é€Ÿé«˜æ•ˆï¼Œå› ä¸ºæœ¬è´¨å°±æ˜¯ä¸€æ ·çš„ï¼Œæ¨¡æ¿ä¸ºä½ ç”Ÿæˆäº†å¯¹åº”çš„ä»£ç ã€‚\nç¼ºç‚¹ï¼š\nä»£ç è†¨èƒ€ï¼Œæ¯ä¸ªä¸åŒçš„ç±»å‹æ˜ å°„éƒ½æœ‰å¯¹åº”çš„ä¸€ä»½ map ä»£ç  ç¼–è¯‘æ—¶é—´å¢é•¿ï¼Œç»§ä¸Šä¸€ç‚¹ï¼Œæ›´å¤šçš„ä»£ç ä¼šå¸¦æ¥æ›´ä¹…çš„ç¼–è¯‘æ—¶é—´ java ä¼˜ç‚¹:\nåŸºäºå¤šæ€ï¼Œä¸€ä»½ map ä»£ç çš„å®ç°å¯ä»¥ç”¨äºä»»ä½• java.util.Object çš„å­ç±»ã€‚åªéœ€è¦ç¼–è¯‘ä¸€ä»½ java.util.Objectï¼Œåœ¨æ¯ä¸ª class æ–‡ä»¶ä¸­å°±éƒ½å¯ä»¥å¼•ç”¨äº†ã€‚ ç¼ºç‚¹ï¼š\nåŸºæœ¬ç±»å‹çš„ map å¿…é¡»ç”¨é€šè¿‡è£…ç®±æ“ä½œè½¬åŒ–ä¸ºå¯¹è±¡ã€‚è£…ç®±æ“ä½œä¼šå¢åŠ åƒåœ¾å›æ”¶çš„å‹åŠ›ï¼Œå¹¶ä¸”é¢å¤–çš„æŒ‡é’ˆå¼•ç”¨ä¼šå¢åŠ ç¼“å­˜å‹åŠ›ï¼ˆæ¯ä¸ªå¯¹è±¡éƒ½å¿…é¡»é€šè¿‡å¦å¤–çš„æŒ‡é’ˆæ¥æŸ¥æ‰¾ï¼‰ã€‚ Hash å’Œ equals å‡½æ•°éœ€è¦ä»£ç ç¼–å†™è€…æ¥å®ç°ã€‚ä¸æ­£ç¡®çš„ hash å’Œ equals å‡½æ•°ä¼šå‡æ…¢ map çš„è¿è¡Œé€Ÿåº¦ï¼Œç”šè‡³å¯¼è‡´ map çš„è¡Œä¸ºé”™è¯¯ã€‚ go çš„ map æ€»ç»“ä¸€ä¸‹ï¼Œc++çš„ map å°±æ˜¯å†™é‡å¤çš„ä»£ç æ¥å…¼å®¹ä¸åŒçš„æ˜ å°„ç±»å‹ï¼Œå°†ç±»å‹ä¿¡æ¯ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼Œè€Œ java çš„ map ä½¿ç”¨ä¸€å¥—ä»£ç ï¼Œå°†æ“ä½œå¯¹è±¡ç»Ÿä¸€ï¼Œä»¥å¤šæ€å½¢å¼å¤„ç†ä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œå³ç›¸å½“äºç­‰åˆ°è¿è¡Œæ—¶è·å–ç±»å‹ä¿¡æ¯ã€‚\ngo è¯­è¨€æ˜¯ä»€ä¹ˆæ–¹å¼å‘¢ï¼Ÿé¦–å…ˆ go æ²¡æœ‰æ³›å‹ï¼Œæ²¡æ³•åƒ C++æ¨¡æ¿ä¸€æ ·ç”Ÿæˆæ‰€æœ‰ç›¸åº”ç±»å‹æ˜ å°„çš„ä»£ç ï¼Œé‚£æ€ä¹ˆä»¥ä¸€å¥—ä»£ç å¤„ç†æ‰€æœ‰ç±»å‹å‘¢ï¼Ÿ(interface{}å—ï¼Ÿç•™ç»™å¤§å®¶æ€è€ƒ)\nè¿™é‡Œå…ˆç»™å‡ºç­”æ¡ˆï¼Œå¹¶ä¸æ˜¯ç”¨ interface{}ï¼Œgo çš„ map çš„ç‰¹åˆ«ä¹‹å¤„ï¼Œåœ¨äºå®ƒä¸æ˜¯å•å•ç¼–è¯‘é˜¶æ®µå°±å¤„ç†å®Œæˆï¼Œéœ€è¦ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶çš„ç›¸äº’åä½œã€‚\nç¼–è¯‘æ—¶é‡å†™ åœ¨ä¸Šæ–‡æœ‰æåˆ°è¿‡ï¼Œç¼–è¯‘å™¨ä¼šé‡å†™ map æ“ä½œä¸º runtime å‡½æ•°è°ƒç”¨ï¼Œä¾‹å¦‚:\nv := hash[key] // =\u003e v := runtime.mapaccess1(maptype, hash, \u0026key) è¿™é‡Œçš„ runtime å‡½æ•°å°±æ˜¯å…³é”®äº†ï¼Œæˆ‘ä»¬ä»¥runtime.mapaccess1å‡½æ•°ä¸¾ä¾‹ä»‹ç»ã€‚\nruntime å‡½æ•° å…ˆæ¥çœ‹çœ‹runtime.mapaccess1å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨æ¥è®¿é—® map çš„å‡½æ•°ï¼Œç­¾å:\nfunc mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer è§£é‡Šä¸€ä¸‹è¿™äº›å‚æ•°:\nkeyï¼Œ ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘äº†ä½ æä¾›çš„ key å€¼ã€‚ h ï¼ŒæŒ‡å‘ runtime.hmap ç»“æ„çš„æŒ‡é’ˆã€‚ t æ˜¯ä¸ªæŒ‡å‘ maptype çš„æŒ‡é’ˆã€‚ ğŸ¤“ æ¥äº†ï¼Œç»è¿‡ä¸Šæ–‡ä»‹ç»ï¼Œè¿™é‡Œ key å’Œ h çš„ä½œç”¨æˆ‘æƒ³è¯»è€…éƒ½èƒ½å¤Ÿå¾ˆå¥½çš„ç†è§£ï¼Œä½†æ˜¯å®ƒä»¬éƒ½æ²¡æœ‰è§£å†³é—®é¢˜ï¼Œå…³é”®æ‰€åœ¨å°±æ˜¯è¿™é‡Œçš„maptypeï¼Œå®ƒä½¿å¾—é€šç”¨çš„ *hmap å¯ä»¥æœåŠ¡äºï¼ˆå‡ ä¹ï¼‰ä»»æ„ key å’Œ value ç±»å‹çš„ç»„åˆã€‚åœ¨ä½ çš„ç¨‹åºä¸­å¯¹äºæ¯ä¸€ä¸ªç‹¬ç«‹çš„ map å®šä¹‰éƒ½ä¼šæœ‰ä¸€ä¸ªç‰¹å®šçš„maptypeå€¼ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ª maptype å€¼æè¿°äº†ä» string åˆ° int çš„æ˜ å°„ï¼Œå¦ä¸€ä¸ªæè¿°äº† string åˆ° http.Headers çš„æ˜ å°„ï¼Œç­‰ç­‰ã€‚\nå› æ­¤ï¼Œgo åœ¨ç¼–è¯‘æœŸé—´åšçš„äº‹æ˜¯ï¼Œåˆ›å»ºå¯¹åº”çš„ maptypeï¼Œåœ¨è°ƒç”¨ runtime çš„ map å‡½æ•°çš„æ—¶å€™å½“åšå‚æ•°ä¼ å…¥ï¼Œæä¾› hmap éœ€è¦çš„ä¿¡æ¯ã€‚\nmaptype type maptype struct { typ _type key *_type elem *_type bucket *_type // internal type representing a hash bucket // function for hashing keys (ptr to key, seed) -\u003e hash hasher func(unsafe.Pointer, uintptr) uintptr keysize uint8 // size of key slot elemsize uint8 // size of elem slot bucketsize uint16 // size of bucket flags uint32 } è¿™æ˜¯ maptype çš„ç»“æ„å®šä¹‰ï¼ŒåŒ…å«äº†ç‰¹å®š map ä¸­ä» key æ˜ å°„åˆ° elem æ‰€éœ€çš„å„ç§å±æ€§ç»†èŠ‚ã€‚å¦‚ key å’Œ elem çš„ç±»å‹ä¿¡æ¯(_type ç±»å‹ä¸­)ï¼Œå“ˆå¸Œå‡½æ•°ã€‚\n// Needs to be in sync with ../cmd/link/internal/ld/decodesym.go:/^func.commonsize, // ../cmd/compile/internal/reflectdata/reflect.go:/^func.dcommontype and // ../reflect/type.go:/^type.rtype. // ../internal/reflectlite/type.go:/^type.rtype. type _type struct { size uintptr ptrdata uintptr // size of memory prefix holding all pointers hash uint32 tflag tflag align uint8 fieldAlign uint8 kind uint8 // function for comparing objects of this type // (ptr to object A, ptr to object B) -\u003e ==? equal func(unsafe.Pointer, unsafe.Pointer) bool // gcdata stores the GC type data for the garbage collector. // If the KindGCProg bit is set in kind, gcdata is a GC program. // Otherwise it is a ptrmask bitmap. See mbitmap.go for details. gcdata *byte str nameOff ptrToThis typeOff } åœ¨ _type ç±»å‹ä¸­ï¼Œè®°è½½çš„æ˜¯ç±»å‹ä¿¡æ¯ï¼Œæ¯”å¦‚å®ƒçš„å¤§å°sizeï¼Œè¯¥ç±»å‹åˆ¤æ–­æ˜¯å¦ç›¸ç­‰çš„æ–¹æ³•euqalã€‚\næ€»ç»“ï¼Œgo çš„ map æ²¡æœ‰é‡å¤çš„ map ä»£ç ï¼Œé çš„æ˜¯å¤šä¸ªmaptypeæ¥æä¾›ä¸åŒçš„ç±»å‹ä¿¡æ¯ï¼Œåœ¨è¿è¡Œæ—¶ä»å‚æ•°maptypeä¸­è·å–éœ€è¦çš„ç±»å‹ä¿¡æ¯ï¼Œé€šè¿‡è¿™ä¸ªæœºåˆ¶ï¼Œgo ä¸å¿…ç”Ÿæˆå¤§é‡çš„é‡å¤ map ä»£ç ï¼Œä¹Ÿä¸ç”¨ç‰¹æ®Šå¤„ç†åŸºç¡€ç±»å‹ï¼Œä»¥ä¸€å¥— map ä»£ç å°±èƒ½å¤Ÿå¤„ç†æ‰€æœ‰çš„ç±»å‹æ˜ å°„ï¼Œå¹¶ä¸”æ€§èƒ½ä¾ç„¶ä¼˜ç§€ã€‚ä½¿ç”¨æ–¹å¼ç®€å•æ¸…æ™°ï¼Œçš„ç¡®æ˜¯ä¼˜ç§€çš„è®¾è®¡ï¼\nå¼•ç”¨ Runtime:æºç è§£æ Golang çš„ map å®ç°åŸç†\nHow the Go runtime implements maps efficiently (without generics)Â â†©ï¸Â â†©ï¸\n","wordCount":"841","inLanguage":"zh","datePublished":"2022-01-05T23:38:06+08:00","dateModified":"2022-01-05T23:38:06+08:00","author":[{"@type":"Person","name":"å£¹æ¬¡å¿ƒ"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.yici.xin/post/tech/golang-map%E4%BB%8B%E7%BB%8D/"},"publisher":{"@type":"Organization","name":"yicixin's blog","logo":{"@type":"ImageObject","url":"https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.yici.xin/ accesskey=h title="ğŸ‘€ (Alt + H)">ğŸ‘€</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.yici.xin/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://www.yici.xin/post/>Posts</a>&nbsp;Â»&nbsp;<a href=https://www.yici.xin/post/tech/>ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div><h1 class=post-title>golang-mapä»‹ç»</h1><div class=post-meta><span title='2022-01-05 23:38:06 +0800 +0800'>2022-01-05</span>&nbsp;Â·&nbsp;å£¹æ¬¡å¿ƒ</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e5%86%85%e5%ae%b9%e6%a6%82%e8%bf%b0 aria-label=å†…å®¹æ¦‚è¿°>å†…å®¹æ¦‚è¿°</a></li><li><a href=#map-%e5%9c%a8%e6%ba%90%e7%a0%81%e4%b8%ad%e7%9a%84%e7%bb%93%e6%9e%84hmap aria-label="map åœ¨æºç ä¸­çš„ç»“æ„â€”â€”hmap">map åœ¨æºç ä¸­çš„ç»“æ„â€”â€”hmap</a></li><li><a href=#bucket-%e7%9a%84%e7%bb%93%e6%9e%84-bmap aria-label="bucket çš„ç»“æ„-bmap">bucket çš„ç»“æ„-bmap</a></li><li><a href=#%e9%a2%84%e5%a4%87 aria-label=é¢„å¤‡>é¢„å¤‡</a><ul><li><a href=#c%e7%9a%84-map aria-label="C++çš„ map">C++çš„ map</a></li><li><a href=#java-%e7%9a%84-map aria-label="java çš„ map">java çš„ map</a></li><li><a href=#%e4%bc%98%e7%bc%ba%e7%82%b9 aria-label=ä¼˜ç¼ºç‚¹>ä¼˜ç¼ºç‚¹</a><ul><li><a href=#c aria-label=c++>c++</a></li><li><a href=#java aria-label=java>java</a></li></ul></li></ul></li><li><a href=#go-%e7%9a%84-map aria-label="go çš„ map">go çš„ map</a><ul><li><a href=#%e7%bc%96%e8%af%91%e6%97%b6%e9%87%8d%e5%86%99 aria-label=ç¼–è¯‘æ—¶é‡å†™>ç¼–è¯‘æ—¶é‡å†™</a></li><li><a href=#runtime-%e5%87%bd%e6%95%b0 aria-label="runtime å‡½æ•°">runtime å‡½æ•°</a></li><li><a href=#maptype aria-label=maptype>maptype</a></li></ul></li><li><a href=#%e5%bc%95%e7%94%a8 aria-label=å¼•ç”¨>å¼•ç”¨</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><blockquote><p>æœ¬æ–‡ä¸­ä½¿ç”¨çš„ go ç‰ˆæœ¬ï¼š</p><p>go version go1.17.2 darwin/amd64</p></blockquote><h2 id=å†…å®¹æ¦‚è¿°>å†…å®¹æ¦‚è¿°<a hidden class=anchor aria-hidden=true href=#å†…å®¹æ¦‚è¿°>#</a></h2><p>æœ¬æ–‡ä»‹ç» golang ä¸­ç»å¸¸ç”¨åˆ°çš„ç»“æ„-mapï¼Œç®€ç§°å“ˆå¸Œè¡¨ã€å­—å…¸ã€‚ä»‹ç»å…¶ç»“æ„åŠè®¾è®¡æ€è·¯ã€‚</p><h2 id=map-åœ¨æºç ä¸­çš„ç»“æ„hmap>map åœ¨æºç ä¸­çš„ç»“æ„â€”â€”hmap<a hidden class=anchor aria-hidden=true href=#map-åœ¨æºç ä¸­çš„ç»“æ„hmap>#</a></h2><p>Go è¯­è¨€é‡‡ç”¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„æ˜¯å“ˆå¸ŒæŸ¥æ‰¾è¡¨ï¼Œä½¿ç”¨é“¾è¡¨è§£å†³å“ˆå¸Œå†²çªã€‚</p><p>åœ¨æºç ä¸­<code>$GOROOT/src/runtime/map.go</code>ï¼Œmap çš„æ ¸å¿ƒç»“æ„ä½“æ˜¯è¿™æ ·çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// A header for a Go map.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>hmap</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>count</span>     <span style=color:#66d9ef>int</span> <span style=color:#75715e>// mapä¸­çš„å…ƒç´ æ•°é‡ï¼Œå³len(map)æ—¶çš„è¿”å›å€¼
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>flags</span>     <span style=color:#66d9ef>uint8</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>B</span>         <span style=color:#66d9ef>uint8</span>  <span style=color:#75715e>// bucketsçš„ä»¥2ä¸ºåº•çš„å¯¹æ•°, å³2^B=buckets
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>noverflow</span> <span style=color:#66d9ef>uint16</span> <span style=color:#75715e>// æº¢å‡ºæ¡¶çš„è¿‘ä¼¼æ•°; see incrnoverflow for details
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>hash0</span>     <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// å“ˆå¸Œç§å­
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>buckets</span>    <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span> <span style=color:#75715e>// 2^Bä¸ªbucketçš„æ•°ç»„ï¼Œmay be nil if count==0.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>oldbuckets</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span> <span style=color:#75715e>// å“ˆå¸Œåœ¨æ‰©å®¹æ—¶ç”¨äºä¿å­˜ä¹‹å‰ buckets çš„å­—æ®µï¼Œå®ƒçš„å¤§å°æ˜¯å½“å‰ buckets çš„ä¸€åŠï¼›
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>nevacuate</span>  <span style=color:#66d9ef>uintptr</span>        <span style=color:#75715e>// progress counter for evacuation (buckets less than this have been evacuated)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>extra</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mapextra</span> <span style=color:#75715e>// optional fields
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>åœ¨ä¸Šé¢æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ ¸å¿ƒæ˜¯<code>buckets</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæœ€ç»ˆæŒ‡å‘äº†<code>bmap</code>ç»“æ„ä½“æ•°ç»„</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// A bucket for a Go map.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>bmap</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// tophash generally contains the top byte of the hash value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// for each key in this bucket. If tophash[0] &lt; minTopHash,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// tophash[0] is a bucket evacuation state instead.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// ç¿»è¯‘: tophash å­˜å‚¨äº†æ¯ä¸ªåœ¨è¯¥bucketä¸­çš„keyçš„æœ€é«˜å­—èŠ‚ï¼Œå¦‚æœtophash[0] &lt; minTopHashï¼Œtophash[0]æ˜¯ä¸€ä¸ªæ¡¶ç–æ¾çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>tophash</span> [<span style=color:#a6e22e>bucketCnt</span>]<span style=color:#66d9ef>uint8</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Followed by bucketCnt keys and then bucketCnt elems.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// NOTE: packing all the keys together and then all the elems together makes the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// code a bit more complicated than alternating key/elem/key/elem/... but it allows
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// us to eliminate padding which would be needed for, e.g., map[int64]int8.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// ç¿»è¯‘: æ³¨æ„ï¼ŒæŠŠæ‰€æœ‰é”®æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œç„¶åå†æŠŠæ‰€æœ‰å¯¹åº”å€¼æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œè¿™ä¼šæ¯”é”®å€¼å¯¹äº¤é”™æ›´å¤æ‚ã€‚ä½†è¿™ç§å½¢å¼èƒ½å¤Ÿæ¶ˆé™¤å¤šä½™çš„å¡«å……å­—èŠ‚ï¼Œæ–¹ä¾¿å†…å­˜å¯¹é½
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Followed by an overflow pointer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><blockquote><p>bucketCnt æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå®ƒæ˜¯ä¸€ä¸ª bucket èƒ½å¤ŸæŒæœ‰é”®å€¼å¯¹ä¸ªæ•°çš„æœ€å¤§å€¼ã€‚</p><p>å®ƒåœ¨æºç ä¸­æ˜¯è¿™æ ·çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>bucketCntBits</span> = <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bucketCnt</span>     = <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#a6e22e>bucketCntBits</span>
</span></span></code></pre></div><p>å³ bucketCnt = 1 å·¦ç§»ä¸‰ä½ = 8</p></blockquote><h2 id=bucket-çš„ç»“æ„-bmap>bucket çš„ç»“æ„-bmap<a hidden class=anchor aria-hidden=true href=#bucket-çš„ç»“æ„-bmap>#</a></h2><p>åœ¨è¿è¡Œæ—¶ï¼Œbmap çš„çœŸæ­£ç»“æ„å¹¶ä¸åƒå®ƒåœ¨æºç é‡Œå±•ç¤ºçš„è¿™ä¹ˆç®€å•ï¼Œåœ¨ç¼–è¯‘æœŸé—´ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æ„ï¼Œè¿™æ˜¯å› ä¸ºå“ˆå¸Œè¡¨ä¸­èƒ½å­˜å‚¨çš„é”®å€¼å¯¹ç±»å‹ä¸ç¡®å®šï¼Œè€Œä¸” Go è¯­è¨€ä¹Ÿä¸æ”¯æŒæ³›å‹ï¼Œä¸å¯èƒ½åœ¨æºç ä¸­å…¨éƒ¨å®šä¹‰ï¼Œæ‰€ä»¥é”®å€¼å¯¹çš„ç±»å‹åŠå…¶å æ®çš„å†…å­˜ç©ºé—´å¤§å°åªèƒ½åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ¨å¯¼ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œæ˜¯åœ¨<strong>ç±»å‹æ£€æŸ¥</strong>é˜¶æ®µï¼Œåœ¨è¿™ä¸€æ­¥ AST(æŠ½è±¡è¯­æ³•æ ‘)å°†è½¬æ¢ä¸º SSA(é™æ€å•èµ‹å€¼)å½¢å¼çš„ä¸­é—´ä»£ç ï¼Œmap å…³é”®å­—åŠå…¶æ“ä½œå°†è½¬æ¢ä¸ºå¯¹åº”çš„ runtime å‡½æ•°ï¼Œä¾‹å¦‚:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>v</span>     <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hash</span>[<span style=color:#a6e22e>key</span>] <span style=color:#75715e>// =&gt; v     := runtime.mapaccess1(maptype, hash, &amp;key)
</span></span></span></code></pre></div><p>æ‰€ä»¥ï¼Œbmap è¿è¡Œæ—¶çš„çœŸæ­£ç»“æ„æ˜¯è¿™æ ·ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>bmap</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>topbits</span>  [<span style=color:#ae81ff>8</span>]<span style=color:#66d9ef>uint8</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>keys</span>     [<span style=color:#ae81ff>8</span>]<span style=color:#a6e22e>keytype</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>values</span>   [<span style=color:#ae81ff>8</span>]<span style=color:#a6e22e>valuetype</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pad</span>      <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>overflow</span> <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…¶ä¸­ï¼Œæ‰€æœ‰çš„ key åœ¨ä¸€ä¸ªç»„é‡Œï¼Œæ‰€æœ‰çš„ value åœ¨ä¸€ä¸ªç»„é‡Œï¼Œè€Œä¸æ˜¯ä»¥{key,value}çš„ç»„æ¥å­˜å‚¨ï¼Œè¿™æ ·èƒ½å¤Ÿå‡å°‘å†…å­˜å¯¹é½å¸¦æ¥çš„å†…å­˜æµªè´¹ã€‚</p><p>bucket çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><img src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png alt=bucket style=zoom:50%><p>å¦‚æœ bucket è£…æ»¡äº†çš„è¯ï¼Œä¼šåˆ›å»ºæ–°çš„ bucketï¼Œå¹¶ä½¿ç”¨ overflow å­—æ®µæŒ‡å‘æ–°çš„ bucketï¼Œå½¢æˆç±»ä¼¼é“¾è¡¨çš„ç»“æ„ã€‚</p><p>ä¸€ä¸ª map ä¸­ä¼šå­˜åœ¨ä¸€ä¸ª bucket æ•°ç»„ï¼Œå®ƒä»¬çš„å…³ç³»å¤§æ¦‚åƒè¿™æ ·ã€‚</p><img src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20(1).png alt=mapä¸­çš„buckets style=zoom:25%><p>è®©æˆ‘ä»¬æš‚åœåˆ†æä¸€ä¸‹ç›®å‰çš„ç»“æ„ï¼Œå½“å¾€ map ä¸­å­˜å‚¨ä¸€ä¸ª kv å¯¹æ—¶ï¼Œé€šè¿‡ k è·å– hash å€¼ï¼Œhash å€¼çš„ä½å…«ä½å’Œ bucket æ•°ç»„é•¿åº¦å–ä½™ï¼Œå®šä½åˆ°æ•°ç»„ä¸­çš„ä¸‹æ ‡ï¼Œhash å€¼çš„é«˜å…«ä½å­˜å‚¨åœ¨ bucket ä¸­çš„ tophash ä¸­ï¼Œç”¨æ¥å¿«é€Ÿåˆ¤æ–­ key æ˜¯å¦å­˜åœ¨ï¼Œkey å’Œ value çš„å…·ä½“å€¼åˆ™é€šè¿‡æŒ‡é’ˆè¿ç®—å­˜å‚¨ï¼Œå½“ä¸€ä¸ª bucket æ»¡æ—¶ï¼Œé€šè¿‡ overfolw æŒ‡é’ˆé“¾æ¥åˆ°ä¸‹ä¸€ä¸ª bucketã€‚</p><p>éšç€å“ˆå¸Œè¡¨å­˜å‚¨çš„æ•°æ®é€æ¸å¢å¤šï¼Œæˆ‘ä»¬ä¼šæ‰©å®¹å“ˆå¸Œè¡¨æˆ–è€…ä½¿ç”¨é¢å¤–çš„æ¡¶å­˜å‚¨æº¢å‡ºçš„æ•°æ®ï¼Œä¸ä¼šè®©å•ä¸ªæ¡¶ä¸­çš„æ•°æ®è¶…è¿‡ 8 ä¸ªï¼Œä¸è¿‡æº¢å‡ºæ¡¶åªæ˜¯ä¸´æ—¶çš„è§£å†³æ–¹æ¡ˆï¼Œåˆ›å»ºè¿‡å¤šçš„æº¢å‡ºæ¡¶æœ€ç»ˆä¹Ÿä¼šå¯¼è‡´å“ˆå¸Œçš„æ‰©å®¹ã€‚</p><h2 id=é¢„å¤‡>é¢„å¤‡<a hidden class=anchor aria-hidden=true href=#é¢„å¤‡>#</a></h2><p>ç®€å•äº†è§£å®Œäº† map çš„æ„æˆä¹‹åï¼Œæ¥ä¸‹æ¥è¦ä»‹ç»çš„å°±æ˜¯å¯¹ map çš„å…·ä½“æ“ä½œäº†ï¼Œä¸ºäº†è¯»è€…èƒ½æ›´å¥½çš„ç†è§£ï¼Œè¿™é‡Œè¦å…ˆè®²ä¸€äº›é¢„å¤‡çŸ¥è¯†ã€‚ä»ä½•è®²èµ·ï¼Ÿå…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ go æ˜¯å¼ºç±»å‹çš„è¯­è¨€ï¼Œå¹¶ä¸”ç›®å‰ä¸ºæ­¢(go1.17)éƒ½è¿˜ä¸æ”¯æŒæ³›å‹ï¼Œé‚£ä¹ˆè¦æ€ä¹ˆè®© map æ”¯æŒè¿™ä¹ˆå¤šç±»å‹å‘¢ï¼Ÿ</p><p>å…ˆæ¥çœ‹çœ‹åˆ«çš„å¼ºç±»å‹è¯­è¨€æ˜¯æ€ä¹ˆåšçš„å§</p><h3 id=cçš„-map>C++çš„ map<a hidden class=anchor aria-hidden=true href=#cçš„-map>#</a></h3><p>é¦–å…ˆæ¥çœ‹çœ‹ c++ï¼Œè¿™é‡Œç”¨åˆ°äº† c++çš„ç‰¹æ€§ä¹‹ä¸€â€”â€”â€”â€”æ¨¡æ¿(ä¹Ÿå°±æ˜¯æ³›å‹å•¦)ï¼Œc++æ ‡å‡†æ¨¡æ¿åº“ STL æä¾›äº† std::unordered_mapï¼Œç»å¸¸ç”¨æ¥å®ç° hashmapã€‚</p><p>This is the declaration for <code>std::unordered_map</code>. Itâ€™s a template, so the actual values of the parameters depend on how the template is instantiated.</p><p>è¿™é‡Œæ˜¯<code>std::unordered_map</code>çš„å®šä¹‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼Œæ‰€ä»¥å®é™…çš„å‚æ•°å€¼å†³å®šæ¨¡æ¿å¦‚ä½•åˆå§‹åŒ–ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Key</span>,                             <span style=color:#75715e>// the type of the key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span>,                               <span style=color:#75715e>// the type of the value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Hash</span> <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>hash<span style=color:#f92672>&lt;</span>Key<span style=color:#f92672>&gt;</span>,           <span style=color:#75715e>// the hash function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>KeyEqual</span> <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>equal_to<span style=color:#f92672>&lt;</span>Key<span style=color:#f92672>&gt;</span>,   <span style=color:#75715e>// the key equality function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Allocator</span> <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>allocator<span style=color:#f92672>&lt;</span> std<span style=color:#f92672>::</span>pair<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> Key, T<span style=color:#f92672>&gt;</span> <span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>unordered_map</span>;
</span></span></code></pre></div><p>é€šè¿‡è¿™äº›å‚æ•°èƒ½çŸ¥é“ï¼š</p><ul><li>key å’Œ value çš„ç±»å‹<code>Key</code>ã€<code>T</code>ï¼Œä¹Ÿå°±çŸ¥é“äº†å®ƒä»¬çš„å¤§å°ã€‚</li><li><code>KeyEqual</code>ï¼Œç±»å‹æ˜¯<code>std::equal_to&lt;Key></code>ï¼Œè¡¨ç¤ºè¿™ä¸ªæ˜¯ä¸€ä¸ªå¤„ç†<code>Key</code>çš„å“ˆå¸Œå‡½æ•°ï¼Œç”¨æ¥æ±‚ key çš„å“ˆå¸Œå€¼</li><li><code>Allocator</code>ï¼Œç±»å‹æ˜¯<code>std::equal_to&lt;Key></code>ï¼ŒåŒæ ·ä¹Ÿæ˜¯å¤„ç†<code>Key</code>çš„å‡½æ•°ï¼Œç”¨äºæ¯”è¾ƒä¸¤ä¸ª key</li></ul><p>æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œç¼–è¯‘å™¨å°±èƒ½åœ¨ç¼–è¯‘æ—¶ç¡®å®šç±»å‹ï¼Œç”Ÿæˆå¯¹åº”çš„<code>ç¡®å®šç±»å‹</code>çš„ä»£ç äº†ã€‚</p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/Gocon-2018-Maps.030-624x351.png alt=std::unordered_map></p><p>æ¥æº: å¼•ç”¨ 1<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>c++çš„ map æŸ¥è¯¢æ“ä½œç®€å•æ¥è¯´æ˜¯è¿™æ ·çš„ï¼Œå¦‚ä¸Šå›¾ï¼Œé¦–å…ˆæˆ‘ä»¬å°† key ä¼ ç»™ <code>std::hash</code> å‡½æ•°ä»¥å¾—åˆ° key çš„ hash å€¼ã€‚ç„¶ååšæ©ç å¹¶å–åˆ° bucket æ•°ç»„ä¸­çš„åºå·ï¼Œæ¥ç€å†éå†å¯¹åº” bucket çš„ entry åˆ—è¡¨å¹¶ç”¨ <code>std::equal_to</code> å‡½æ•°æ¥æ¯”è¾ƒ keyã€‚</p><h3 id=java-çš„-map>java çš„ map<a hidden class=anchor aria-hidden=true href=#java-çš„-map>#</a></h3><p>ç¬¬äºŒä¸ªè¦è°ˆçš„æ˜¯ javaï¼Œä¸å‡ºæ‰€æ–™ï¼Œjava ä¸­ hashmap ç±»å‹å°±æ˜¯<code>java.util.Hashmap</code>ã€‚</p><p>åœ¨ java ä¸­ï¼Œ <code>java.util.Hashmap</code>åªèƒ½å¤Ÿæ“ä½œ<code>å¯¹è±¡</code>ï¼Œå› ä¸º java ä¸‡ç‰©çš†å¯¹è±¡ ğŸ¤ªï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æ¥æºäº<code>java.lang.Object</code>ï¼Œå¯ä»¥ç»§æ‰¿æˆ–é‡å†™<code>hashCode</code> å’Œ <code>equals</code> æ–¹æ³•ã€‚</p><p>å½“ç„¶ï¼Œæœ‰ 8 ç§åŸºç¡€ç±»å‹ä¸èƒ½å¤Ÿè¿™æ ·æ“ä½œ<code>boolean</code>ï¼Œ <code>int</code>ï¼Œ <code>short</code>ï¼Œ <code>long</code>ï¼Œ <code>byte</code>ï¼Œ <code>char</code>ï¼Œ <code>float</code>ï¼Œ and <code>double</code>ï¼Œå› ä¸ºå®ƒä»¬ä¸æ˜¯<code>java.lang.Object</code>çš„å­ç±»ï¼Œéš¾é“è¯´åŸºç¡€ç±»å‹æ²¡æ³•ä½œä¸º key æˆ– value å—ï¼Ÿéä¹Ÿï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé™åˆ¶ï¼Œjava ä¼šéšå¼è½¬æ¢åŸºç¡€ç±»å‹ä¸ºå®ƒä»¬å¯¹åº”çš„å¯¹è±¡ï¼Œè¿™ç§æ“ä½œå«<code>è£…ç®±</code>ã€‚</p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/Gocon-2018-Maps.034-624x351.png alt=java_hashmap></p><p>æ¥æº: å¼•ç”¨ 1<sup id=fnref1:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>java ä¸­çš„æŸ¥æ‰¾æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆæˆ‘ä»¬è°ƒç”¨ key çš„ <code>hashCode</code> æ–¹æ³•æ¥è·å–å®ƒçš„ hash å€¼ï¼Œç„¶ååšæ©ç æ“ä½œï¼Œè·å–åˆ° bucket æ•°ç»„ä¸­çš„å¯¹åº”ä½ç½®ï¼Œé‡Œé¢å­˜æ”¾äº†ä¸€ä¸ªæŒ‡å‘ <code>Entry</code> çš„æŒ‡é’ˆã€‚<code>Entry</code> ä¸­æœ‰ä¸€ä¸ª keyï¼Œä¸€ä¸ª valueï¼Œè¿˜æœ‰ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ª <code>Entry</code> çš„æŒ‡é’ˆï¼Œå½¢æˆäº†ä¸€ä¸ª linked listã€‚</p><h3 id=ä¼˜ç¼ºç‚¹>ä¼˜ç¼ºç‚¹<a hidden class=anchor aria-hidden=true href=#ä¼˜ç¼ºç‚¹>#</a></h3><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº† hashmap åœ¨ c++å’Œ java ä¸­çš„å®ç°äº†ï¼Œæ¥æ¯”è¾ƒä¸€ä¸‹ä»–ä»¬çš„ä¼˜ç¼ºç‚¹ï¼š</p><h4 id=c>c++<a hidden class=anchor aria-hidden=true href=#c>#</a></h4><p>ä¼˜ç‚¹ï¼š</p><ul><li>key å’Œ value ç±»å‹çš„å¤§å°åœ¨ç¼–è¯‘æœŸé—´å°±ç¡®å®šäº†ã€‚</li><li>ä¸éœ€è¦è£…ç®±æ“ä½œã€‚</li><li>ç”±äºä»£ç åœ¨ç¼–è¯‘æœŸé—´å°±å®šä¸‹æ¥äº†ï¼Œæ‰€ä»¥å…¶ä»–ç¼–è¯‘ä¼˜åŒ–æ“ä½œä¾‹å¦‚å†…è”ï¼Œå¸¸æ•°æŠ˜å å’Œæ­»ä»£ç åˆ é™¤å°±å¯ä»¥ä»‹å…¥äº†ã€‚</li></ul><p>æ€»ä¹‹ï¼ŒC++ä¸­çš„ map å’Œè‡ªå·±ä¸ºæ¯ç§ key/value ç±»å‹ç»„åˆæ‰‹å†™çš„ç‰¹å®š map ä¸€æ ·å¿«é€Ÿé«˜æ•ˆï¼Œå› ä¸ºæœ¬è´¨å°±æ˜¯ä¸€æ ·çš„ï¼Œæ¨¡æ¿ä¸ºä½ ç”Ÿæˆäº†å¯¹åº”çš„ä»£ç ã€‚</p><p>ç¼ºç‚¹ï¼š</p><ul><li>ä»£ç è†¨èƒ€ï¼Œæ¯ä¸ªä¸åŒçš„ç±»å‹æ˜ å°„éƒ½æœ‰å¯¹åº”çš„ä¸€ä»½ map ä»£ç </li><li>ç¼–è¯‘æ—¶é—´å¢é•¿ï¼Œç»§ä¸Šä¸€ç‚¹ï¼Œæ›´å¤šçš„ä»£ç ä¼šå¸¦æ¥æ›´ä¹…çš„ç¼–è¯‘æ—¶é—´</li></ul><h4 id=java>java<a hidden class=anchor aria-hidden=true href=#java>#</a></h4><p>ä¼˜ç‚¹:</p><ul><li>åŸºäºå¤šæ€ï¼Œä¸€ä»½ map ä»£ç çš„å®ç°å¯ä»¥ç”¨äºä»»ä½• java.util.Object çš„å­ç±»ã€‚åªéœ€è¦ç¼–è¯‘ä¸€ä»½ java.util.Objectï¼Œåœ¨æ¯ä¸ª class æ–‡ä»¶ä¸­å°±éƒ½å¯ä»¥å¼•ç”¨äº†ã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>åŸºæœ¬ç±»å‹çš„ map å¿…é¡»ç”¨é€šè¿‡è£…ç®±æ“ä½œè½¬åŒ–ä¸ºå¯¹è±¡ã€‚è£…ç®±æ“ä½œä¼šå¢åŠ åƒåœ¾å›æ”¶çš„å‹åŠ›ï¼Œå¹¶ä¸”é¢å¤–çš„æŒ‡é’ˆå¼•ç”¨ä¼šå¢åŠ ç¼“å­˜å‹åŠ›ï¼ˆæ¯ä¸ªå¯¹è±¡éƒ½å¿…é¡»é€šè¿‡å¦å¤–çš„æŒ‡é’ˆæ¥æŸ¥æ‰¾ï¼‰ã€‚</li><li>Hash å’Œ equals å‡½æ•°éœ€è¦ä»£ç ç¼–å†™è€…æ¥å®ç°ã€‚ä¸æ­£ç¡®çš„ hash å’Œ equals å‡½æ•°ä¼šå‡æ…¢ map çš„è¿è¡Œé€Ÿåº¦ï¼Œç”šè‡³å¯¼è‡´ map çš„è¡Œä¸ºé”™è¯¯ã€‚</li></ul><h2 id=go-çš„-map>go çš„ map<a hidden class=anchor aria-hidden=true href=#go-çš„-map>#</a></h2><p>æ€»ç»“ä¸€ä¸‹ï¼Œc++çš„ map å°±æ˜¯å†™é‡å¤çš„ä»£ç æ¥å…¼å®¹ä¸åŒçš„æ˜ å°„ç±»å‹ï¼Œå°†ç±»å‹ä¿¡æ¯ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼Œè€Œ java çš„ map ä½¿ç”¨ä¸€å¥—ä»£ç ï¼Œå°†æ“ä½œå¯¹è±¡ç»Ÿä¸€ï¼Œä»¥å¤šæ€å½¢å¼å¤„ç†ä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œå³ç›¸å½“äºç­‰åˆ°è¿è¡Œæ—¶è·å–ç±»å‹ä¿¡æ¯ã€‚</p><p>go è¯­è¨€æ˜¯ä»€ä¹ˆæ–¹å¼å‘¢ï¼Ÿé¦–å…ˆ go æ²¡æœ‰æ³›å‹ï¼Œæ²¡æ³•åƒ C++æ¨¡æ¿ä¸€æ ·ç”Ÿæˆæ‰€æœ‰ç›¸åº”ç±»å‹æ˜ å°„çš„ä»£ç ï¼Œé‚£æ€ä¹ˆä»¥ä¸€å¥—ä»£ç å¤„ç†æ‰€æœ‰ç±»å‹å‘¢ï¼Ÿ(interface{}å—ï¼Ÿç•™ç»™å¤§å®¶æ€è€ƒ)</p><p>è¿™é‡Œå…ˆç»™å‡ºç­”æ¡ˆï¼Œå¹¶ä¸æ˜¯ç”¨ interface{}ï¼Œgo çš„ map çš„ç‰¹åˆ«ä¹‹å¤„ï¼Œåœ¨äºå®ƒä¸æ˜¯å•å•ç¼–è¯‘é˜¶æ®µå°±å¤„ç†å®Œæˆï¼Œéœ€è¦ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶çš„ç›¸äº’åä½œã€‚</p><h3 id=ç¼–è¯‘æ—¶é‡å†™>ç¼–è¯‘æ—¶é‡å†™<a hidden class=anchor aria-hidden=true href=#ç¼–è¯‘æ—¶é‡å†™>#</a></h3><p>åœ¨ä¸Šæ–‡æœ‰æåˆ°è¿‡ï¼Œç¼–è¯‘å™¨ä¼šé‡å†™ map æ“ä½œä¸º runtime å‡½æ•°è°ƒç”¨ï¼Œä¾‹å¦‚:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hash</span>[<span style=color:#a6e22e>key</span>] <span style=color:#75715e>// =&gt; v := runtime.mapaccess1(maptype, hash, &amp;key)
</span></span></span></code></pre></div><p>è¿™é‡Œçš„ runtime å‡½æ•°å°±æ˜¯å…³é”®äº†ï¼Œæˆ‘ä»¬ä»¥<code>runtime.mapaccess1</code>å‡½æ•°ä¸¾ä¾‹ä»‹ç»ã€‚</p><h3 id=runtime-å‡½æ•°>runtime å‡½æ•°<a hidden class=anchor aria-hidden=true href=#runtime-å‡½æ•°>#</a></h3><p>å…ˆæ¥çœ‹çœ‹<code>runtime.mapaccess1</code>å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨æ¥è®¿é—® map çš„å‡½æ•°ï¼Œç­¾å:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mapaccess1</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>maptype</span>, <span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>hmap</span>, <span style=color:#a6e22e>key</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>
</span></span></code></pre></div><p>è§£é‡Šä¸€ä¸‹è¿™äº›å‚æ•°:</p><ul><li><code>key</code>ï¼Œ ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘äº†ä½ æä¾›çš„ key å€¼ã€‚</li><li><code>h</code> ï¼ŒæŒ‡å‘ <code>runtime.hmap</code> ç»“æ„çš„æŒ‡é’ˆã€‚</li><li><code>t</code> æ˜¯ä¸ªæŒ‡å‘ <code>maptype</code> çš„æŒ‡é’ˆã€‚</li></ul><p>ğŸ¤“ æ¥äº†ï¼Œç»è¿‡ä¸Šæ–‡ä»‹ç»ï¼Œè¿™é‡Œ key å’Œ h çš„ä½œç”¨æˆ‘æƒ³è¯»è€…éƒ½èƒ½å¤Ÿå¾ˆå¥½çš„ç†è§£ï¼Œä½†æ˜¯å®ƒä»¬éƒ½æ²¡æœ‰è§£å†³é—®é¢˜ï¼Œå…³é”®æ‰€åœ¨å°±æ˜¯è¿™é‡Œçš„<code>maptype</code>ï¼Œå®ƒä½¿å¾—é€šç”¨çš„ <code>*hmap</code> å¯ä»¥æœåŠ¡äºï¼ˆå‡ ä¹ï¼‰ä»»æ„ key å’Œ value ç±»å‹çš„ç»„åˆã€‚åœ¨ä½ çš„ç¨‹åºä¸­å¯¹äºæ¯ä¸€ä¸ªç‹¬ç«‹çš„ map å®šä¹‰éƒ½ä¼šæœ‰ä¸€ä¸ªç‰¹å®šçš„<code>maptype</code>å€¼ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ª <code>maptype</code> å€¼æè¿°äº†ä» <code>string</code> åˆ° <code>int</code> çš„æ˜ å°„ï¼Œå¦ä¸€ä¸ªæè¿°äº† <code>string</code> åˆ° <code>http.Headers</code> çš„æ˜ å°„ï¼Œç­‰ç­‰ã€‚</p><p>å› æ­¤ï¼Œgo åœ¨ç¼–è¯‘æœŸé—´åšçš„äº‹æ˜¯ï¼Œåˆ›å»ºå¯¹åº”çš„ maptypeï¼Œåœ¨è°ƒç”¨ runtime çš„ map å‡½æ•°çš„æ—¶å€™å½“åšå‚æ•°ä¼ å…¥ï¼Œæä¾› hmap éœ€è¦çš„ä¿¡æ¯ã€‚</p><h3 id=maptype>maptype<a hidden class=anchor aria-hidden=true href=#maptype>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>maptype</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>typ</span>    <span style=color:#a6e22e>_type</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>key</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>_type</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>elem</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>_type</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bucket</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>_type</span> <span style=color:#75715e>// internal type representing a hash bucket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// function for hashing keys (ptr to key, seed) -&gt; hash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>hasher</span>     <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#66d9ef>uintptr</span>) <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>keysize</span>    <span style=color:#66d9ef>uint8</span>  <span style=color:#75715e>// size of key slot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>elemsize</span>   <span style=color:#66d9ef>uint8</span>  <span style=color:#75715e>// size of elem slot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>bucketsize</span> <span style=color:#66d9ef>uint16</span> <span style=color:#75715e>// size of bucket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>flags</span>      <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™æ˜¯ maptype çš„ç»“æ„å®šä¹‰ï¼ŒåŒ…å«äº†ç‰¹å®š map ä¸­ä» key æ˜ å°„åˆ° elem æ‰€éœ€çš„å„ç§å±æ€§ç»†èŠ‚ã€‚å¦‚ key å’Œ elem çš„ç±»å‹ä¿¡æ¯(_type ç±»å‹ä¸­)ï¼Œå“ˆå¸Œå‡½æ•°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Needs to be in sync with ../cmd/link/internal/ld/decodesym.go:/^func.commonsize,
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ../cmd/compile/internal/reflectdata/reflect.go:/^func.dcommontype and
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ../reflect/type.go:/^type.rtype.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ../internal/reflectlite/type.go:/^type.rtype.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>_type</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>size</span>       <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ptrdata</span>    <span style=color:#66d9ef>uintptr</span> <span style=color:#75715e>// size of memory prefix holding all pointers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>hash</span>       <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tflag</span>      <span style=color:#a6e22e>tflag</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>align</span>      <span style=color:#66d9ef>uint8</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fieldAlign</span> <span style=color:#66d9ef>uint8</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kind</span>       <span style=color:#66d9ef>uint8</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// function for comparing objects of this type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// (ptr to object A, ptr to object B) -&gt; ==?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>equal</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// gcdata stores the GC type data for the garbage collector.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// If the KindGCProg bit is set in kind, gcdata is a GC program.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Otherwise it is a ptrmask bitmap. See mbitmap.go for details.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>gcdata</span>    <span style=color:#f92672>*</span><span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>str</span>       <span style=color:#a6e22e>nameOff</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ptrToThis</span> <span style=color:#a6e22e>typeOff</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨ <code>_type</code> ç±»å‹ä¸­ï¼Œè®°è½½çš„æ˜¯ç±»å‹ä¿¡æ¯ï¼Œæ¯”å¦‚å®ƒçš„å¤§å°<code>size</code>ï¼Œè¯¥ç±»å‹åˆ¤æ–­æ˜¯å¦ç›¸ç­‰çš„æ–¹æ³•<code>euqal</code>ã€‚</p><p>æ€»ç»“ï¼Œgo çš„ map æ²¡æœ‰é‡å¤çš„ map ä»£ç ï¼Œé çš„æ˜¯å¤šä¸ª<code>maptype</code>æ¥æä¾›ä¸åŒçš„ç±»å‹ä¿¡æ¯ï¼Œåœ¨è¿è¡Œæ—¶ä»å‚æ•°<code>maptype</code>ä¸­è·å–éœ€è¦çš„ç±»å‹ä¿¡æ¯ï¼Œé€šè¿‡è¿™ä¸ªæœºåˆ¶ï¼Œgo ä¸å¿…ç”Ÿæˆå¤§é‡çš„é‡å¤ map ä»£ç ï¼Œä¹Ÿä¸ç”¨ç‰¹æ®Šå¤„ç†åŸºç¡€ç±»å‹ï¼Œä»¥ä¸€å¥— map ä»£ç å°±èƒ½å¤Ÿå¤„ç†æ‰€æœ‰çš„ç±»å‹æ˜ å°„ï¼Œå¹¶ä¸”æ€§èƒ½ä¾ç„¶ä¼˜ç§€ã€‚ä½¿ç”¨æ–¹å¼ç®€å•æ¸…æ™°ï¼Œçš„ç¡®æ˜¯ä¼˜ç§€çš„è®¾è®¡ï¼</p><h2 id=å¼•ç”¨>å¼•ç”¨<a hidden class=anchor aria-hidden=true href=#å¼•ç”¨>#</a></h2><p><a href=https://www.jianshu.com/p/888a90aa25b0>Runtime:æºç è§£æ Golang çš„ map å®ç°åŸç†</a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://dave.cheney.net/2018/05/29/how-the-go-runtime-implements-maps-efficiently-without-generics>How the Go runtime implements maps efficiently (without generics)</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.yici.xin/tags/golang/>golang</a></li><li><a href=https://www.yici.xin/tags/map/>map</a></li><li><a href=https://www.yici.xin/tags/hashmap/>hashmap</a></li><li><a href=https://www.yici.xin/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/>æºç è§£æ</a></li></ul><nav class=paginav><a class=prev href=https://www.yici.xin/post/tech/short_code/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>Short_code</span></a></nav></footer><script type=text/javascript>let giscusTheme=localStorage.getItem("pref-theme")==="dark"?"dark_dimmed":"light",giscusAttributes={src:"https://giscus.app/client.js","data-repo":"yicixin/blog_comment","data-repo-id":"R_kgDOIr6QyQ","data-category":"Announcements","data-category-id":"DIC_kwDOIr6Qyc4CTSs3","data-mapping":"title","data-reactions-enabled":"1","data-emit-metadata":"0","data-theme":giscusTheme===null?"light":giscusTheme,"data-lang":"zh-CN",crossorigin:"anonymous","data-loading":"lazy",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([e,t])=>giscusScript.setAttribute(e,t));var article=document.getElementsByTagName("article")[0].appendChild(giscusScript);function changeGiscusTheme(){const e=localStorage.getItem("pref-theme")==="dark"?"light":"dark_dimmed";function t(e){const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}t({setConfig:{theme:e}})}const toggle=document.querySelector("#theme-toggle");toggle&&toggle.addEventListener("click",changeGiscusTheme)</script><script src=https://giscus.app/client.js data-repo=yicixin/blog_comment data-repo-id=R_kgDOIr6QyQ data-category=Announcements data-category-id=DIC_kwDOIr6Qyc4CTSs3 data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.yici.xin/>yicixin's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script src=https://code.jquery.com/jquery-1.12.4.min.js></script><script>$("code[class^=language] ").on("mouseover",function(){this.clientWidth<this.scrollWidth&&$(this).css("width","135%")}).on("mouseout",function(){$(this).css("width","100%"),$(".copy-code").css("right","4px")})</script></body></html>