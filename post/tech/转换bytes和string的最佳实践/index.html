<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css integrity=sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.2.1.slim.min.js integrity=sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js integrity=sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js integrity=sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl crossorigin=anonymous></script><title>è½¬æ¢byteså’Œstringçš„æœ€ä½³å®è·µ | ç»çŸ¥</title>
<meta name=keywords content="golang,string"><meta name=description content='
æœ¬æ–‡golangæºç ä¸º1.18ç‰ˆæœ¬

æ ‡å‡†è½¬æ¢
ä½¿ç”¨æ ‡å‡†è½¬æ¢æ˜¯æœ€å¸¸è§çš„é€‰æ‹©
package main

func main() {
	s := "Hello, world!"
  	// stringè½¬byteæ•°ç»„
	b := []byte(s)
  	// byteæ•°ç»„è½¬string
	s2 := string(b)
}
è¯¥è½¬æ¢è¯­å¥ä¼šè¢«goç¼–è¯‘å™¨ç¿»è¯‘ä¸ºruntimeå±‚çš„æ–¹æ³•è°ƒç”¨ï¼Œå…¶ä¸­[]byteåˆ°stringçš„è½¬æ¢å¯¹åº”/src/runtime/string.go:81å¤„çš„slicebytetostringå‡½æ•°ï¼›è€Œstringåˆ°[]byteçš„è½¬æ¢å¯¹åº”çš„åˆ™æ˜¯/src/runtime/string.go:172å¤„çš„stringtoslicebyteå‡½æ•°ã€‚
å…ˆæ¥çœ‹çœ‹æ¯”è¾ƒç®€å•çš„stringtoslicebyteå‡½æ•°ï¼ŒtmpBufç±»å‹æ˜¯ä¸ªå¤§å°ä¸º32çš„byteæ•°ç»„ã€‚
// The constant is known to the compiler.
// There is no fundamental theory behind this number. ğŸ¤£
const tmpStringBufSize = 32

type tmpBuf [tmpStringBufSize]byte

func stringtoslicebyte(buf *tmpBuf, s string) []byte {
	var b []byte
	if buf != nil && len(s) <= len(buf) {
		*buf = tmpBuf{}
		b = buf[:len(s)]
	} else {
        // å¦‚æœæ²¡æœ‰ç¼“å†²åŒºæˆ–ç¼“å†²åŒºå¤§å°ä¸è¶³ï¼Œéœ€è¦ç”³è¯·å†…å­˜
		b = rawbyteslice(len(s))
	}
    // å¤åˆ¶æ•°æ®
	copy(b, s)
	return b
}

func rawbyteslice(size int) (b []byte) {
    // å®¹é‡è®¡ç®—ï¼Œè€ƒè™‘å†…å­˜å¯¹é½ï¼Œå¯»æ‰¾å¤§å°æœ€åŒ¹é…çš„å†…å­˜å—
	cap := roundupsize(uintptr(size))
    // ä½¿ç”¨mallocgcç”³è¯·å¯¹åº”å¤§å°çš„å†…å­˜
	p := mallocgc(cap, nil, false)
    // å¦‚æœè¦ç”³è¯·çš„sizeå’Œæœ€ç»ˆè®¡ç®—å¾—åˆ°çš„capå¤§å°ä¸ä¸€è‡´ï¼Œcapåªä¼šæ¯”sizeæ›´å¤§ï¼Œæ¸…ç†æ‰å¤šä½™çš„å†…å­˜
	if cap != uintptr(size) {
		memclrNoHeapPointers(add(p, uintptr(size)), cap-uintptr(size))
	}
	// å°†bæŒ‡å‘è¿™ç‰‡ç”³è¯·å¥½çš„å†…å­˜ã€‚è¯¥sliceä¸ä¸ºç©ºï¼Œæ•…å¤–éƒ¨ä½¿ç”¨copyè¿›è¡Œè¦†ç›–è€Œä¸æ˜¯append
	*(*slice)(unsafe.Pointer(&amp;b)) = slice{p, size, int(cap)}
	return
}
å½“éœ€è¦è½¬æ¢çš„å­—ç¬¦ä¸²é•¿åº¦å°äº32æ—¶ï¼Œåªä¼šè¿›è¡Œå†…å­˜å¤åˆ¶ï¼Œè€Œå¤§äº32çš„è¯ï¼Œé™¤äº†å¤åˆ¶æ“ä½œï¼Œè¿˜éœ€è¦åˆ†é…å†…å­˜ã€‚'><meta name=author content="å£¹æ¬¡å¿ƒ"><link rel=canonical href=https://www.yici.xin/post/tech/%E8%BD%AC%E6%8D%A2bytes%E5%92%8Cstring%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.278e8b2dd0edae6a4a4d865210e46385ee100556bcf14ba56506e7501326056e.css integrity="sha256-J46LLdDtrmpKTYZSEORjhe4QBVa88UulZQbnUBMmBW4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/js/extended.js></script><link rel=icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=icon type=image/png sizes=16x16 href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=icon type=image/png sizes=32x32 href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=apple-touch-icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><link rel=mask-icon href=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.yici.xin/post/tech/%E8%BD%AC%E6%8D%A2bytes%E5%92%8Cstring%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><meta property="og:title" content="è½¬æ¢byteså’Œstringçš„æœ€ä½³å®è·µ"><meta property="og:description" content='
æœ¬æ–‡golangæºç ä¸º1.18ç‰ˆæœ¬

æ ‡å‡†è½¬æ¢
ä½¿ç”¨æ ‡å‡†è½¬æ¢æ˜¯æœ€å¸¸è§çš„é€‰æ‹©
package main

func main() {
	s := "Hello, world!"
  	// stringè½¬byteæ•°ç»„
	b := []byte(s)
  	// byteæ•°ç»„è½¬string
	s2 := string(b)
}
è¯¥è½¬æ¢è¯­å¥ä¼šè¢«goç¼–è¯‘å™¨ç¿»è¯‘ä¸ºruntimeå±‚çš„æ–¹æ³•è°ƒç”¨ï¼Œå…¶ä¸­[]byteåˆ°stringçš„è½¬æ¢å¯¹åº”/src/runtime/string.go:81å¤„çš„slicebytetostringå‡½æ•°ï¼›è€Œstringåˆ°[]byteçš„è½¬æ¢å¯¹åº”çš„åˆ™æ˜¯/src/runtime/string.go:172å¤„çš„stringtoslicebyteå‡½æ•°ã€‚
å…ˆæ¥çœ‹çœ‹æ¯”è¾ƒç®€å•çš„stringtoslicebyteå‡½æ•°ï¼ŒtmpBufç±»å‹æ˜¯ä¸ªå¤§å°ä¸º32çš„byteæ•°ç»„ã€‚
// The constant is known to the compiler.
// There is no fundamental theory behind this number. ğŸ¤£
const tmpStringBufSize = 32

type tmpBuf [tmpStringBufSize]byte

func stringtoslicebyte(buf *tmpBuf, s string) []byte {
	var b []byte
	if buf != nil && len(s) <= len(buf) {
		*buf = tmpBuf{}
		b = buf[:len(s)]
	} else {
        // å¦‚æœæ²¡æœ‰ç¼“å†²åŒºæˆ–ç¼“å†²åŒºå¤§å°ä¸è¶³ï¼Œéœ€è¦ç”³è¯·å†…å­˜
		b = rawbyteslice(len(s))
	}
    // å¤åˆ¶æ•°æ®
	copy(b, s)
	return b
}

func rawbyteslice(size int) (b []byte) {
    // å®¹é‡è®¡ç®—ï¼Œè€ƒè™‘å†…å­˜å¯¹é½ï¼Œå¯»æ‰¾å¤§å°æœ€åŒ¹é…çš„å†…å­˜å—
	cap := roundupsize(uintptr(size))
    // ä½¿ç”¨mallocgcç”³è¯·å¯¹åº”å¤§å°çš„å†…å­˜
	p := mallocgc(cap, nil, false)
    // å¦‚æœè¦ç”³è¯·çš„sizeå’Œæœ€ç»ˆè®¡ç®—å¾—åˆ°çš„capå¤§å°ä¸ä¸€è‡´ï¼Œcapåªä¼šæ¯”sizeæ›´å¤§ï¼Œæ¸…ç†æ‰å¤šä½™çš„å†…å­˜
	if cap != uintptr(size) {
		memclrNoHeapPointers(add(p, uintptr(size)), cap-uintptr(size))
	}
	// å°†bæŒ‡å‘è¿™ç‰‡ç”³è¯·å¥½çš„å†…å­˜ã€‚è¯¥sliceä¸ä¸ºç©ºï¼Œæ•…å¤–éƒ¨ä½¿ç”¨copyè¿›è¡Œè¦†ç›–è€Œä¸æ˜¯append
	*(*slice)(unsafe.Pointer(&amp;b)) = slice{p, size, int(cap)}
	return
}
å½“éœ€è¦è½¬æ¢çš„å­—ç¬¦ä¸²é•¿åº¦å°äº32æ—¶ï¼Œåªä¼šè¿›è¡Œå†…å­˜å¤åˆ¶ï¼Œè€Œå¤§äº32çš„è¯ï¼Œé™¤äº†å¤åˆ¶æ“ä½œï¼Œè¿˜éœ€è¦åˆ†é…å†…å­˜ã€‚'><meta property="og:type" content="article"><meta property="og:url" content="https://www.yici.xin/post/tech/%E8%BD%AC%E6%8D%A2bytes%E5%92%8Cstring%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"><meta property="og:image" content="https://www.yici.xin/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-02-01T19:34:04+08:00"><meta property="article:modified_time" content="2023-02-01T19:34:04+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.yici.xin/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="è½¬æ¢byteså’Œstringçš„æœ€ä½³å®è·µ"><meta name=twitter:description content='
æœ¬æ–‡golangæºç ä¸º1.18ç‰ˆæœ¬

æ ‡å‡†è½¬æ¢
ä½¿ç”¨æ ‡å‡†è½¬æ¢æ˜¯æœ€å¸¸è§çš„é€‰æ‹©
package main

func main() {
	s := "Hello, world!"
  	// stringè½¬byteæ•°ç»„
	b := []byte(s)
  	// byteæ•°ç»„è½¬string
	s2 := string(b)
}
è¯¥è½¬æ¢è¯­å¥ä¼šè¢«goç¼–è¯‘å™¨ç¿»è¯‘ä¸ºruntimeå±‚çš„æ–¹æ³•è°ƒç”¨ï¼Œå…¶ä¸­[]byteåˆ°stringçš„è½¬æ¢å¯¹åº”/src/runtime/string.go:81å¤„çš„slicebytetostringå‡½æ•°ï¼›è€Œstringåˆ°[]byteçš„è½¬æ¢å¯¹åº”çš„åˆ™æ˜¯/src/runtime/string.go:172å¤„çš„stringtoslicebyteå‡½æ•°ã€‚
å…ˆæ¥çœ‹çœ‹æ¯”è¾ƒç®€å•çš„stringtoslicebyteå‡½æ•°ï¼ŒtmpBufç±»å‹æ˜¯ä¸ªå¤§å°ä¸º32çš„byteæ•°ç»„ã€‚
// The constant is known to the compiler.
// There is no fundamental theory behind this number. ğŸ¤£
const tmpStringBufSize = 32

type tmpBuf [tmpStringBufSize]byte

func stringtoslicebyte(buf *tmpBuf, s string) []byte {
	var b []byte
	if buf != nil && len(s) <= len(buf) {
		*buf = tmpBuf{}
		b = buf[:len(s)]
	} else {
        // å¦‚æœæ²¡æœ‰ç¼“å†²åŒºæˆ–ç¼“å†²åŒºå¤§å°ä¸è¶³ï¼Œéœ€è¦ç”³è¯·å†…å­˜
		b = rawbyteslice(len(s))
	}
    // å¤åˆ¶æ•°æ®
	copy(b, s)
	return b
}

func rawbyteslice(size int) (b []byte) {
    // å®¹é‡è®¡ç®—ï¼Œè€ƒè™‘å†…å­˜å¯¹é½ï¼Œå¯»æ‰¾å¤§å°æœ€åŒ¹é…çš„å†…å­˜å—
	cap := roundupsize(uintptr(size))
    // ä½¿ç”¨mallocgcç”³è¯·å¯¹åº”å¤§å°çš„å†…å­˜
	p := mallocgc(cap, nil, false)
    // å¦‚æœè¦ç”³è¯·çš„sizeå’Œæœ€ç»ˆè®¡ç®—å¾—åˆ°çš„capå¤§å°ä¸ä¸€è‡´ï¼Œcapåªä¼šæ¯”sizeæ›´å¤§ï¼Œæ¸…ç†æ‰å¤šä½™çš„å†…å­˜
	if cap != uintptr(size) {
		memclrNoHeapPointers(add(p, uintptr(size)), cap-uintptr(size))
	}
	// å°†bæŒ‡å‘è¿™ç‰‡ç”³è¯·å¥½çš„å†…å­˜ã€‚è¯¥sliceä¸ä¸ºç©ºï¼Œæ•…å¤–éƒ¨ä½¿ç”¨copyè¿›è¡Œè¦†ç›–è€Œä¸æ˜¯append
	*(*slice)(unsafe.Pointer(&amp;b)) = slice{p, size, int(cap)}
	return
}
å½“éœ€è¦è½¬æ¢çš„å­—ç¬¦ä¸²é•¿åº¦å°äº32æ—¶ï¼Œåªä¼šè¿›è¡Œå†…å­˜å¤åˆ¶ï¼Œè€Œå¤§äº32çš„è¯ï¼Œé™¤äº†å¤åˆ¶æ“ä½œï¼Œè¿˜éœ€è¦åˆ†é…å†…å­˜ã€‚'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.yici.xin/post/"},{"@type":"ListItem","position":2,"name":"ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯","item":"https://www.yici.xin/post/tech/"},{"@type":"ListItem","position":3,"name":"è½¬æ¢byteså’Œstringçš„æœ€ä½³å®è·µ","item":"https://www.yici.xin/post/tech/%E8%BD%AC%E6%8D%A2bytes%E5%92%8Cstring%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"è½¬æ¢byteså’Œstringçš„æœ€ä½³å®è·µ","name":"è½¬æ¢byteså’Œstringçš„æœ€ä½³å®è·µ","description":" æœ¬æ–‡golangæºç ä¸º1.18ç‰ˆæœ¬\næ ‡å‡†è½¬æ¢ ä½¿ç”¨æ ‡å‡†è½¬æ¢æ˜¯æœ€å¸¸è§çš„é€‰æ‹©\npackage main func main() { s := \u0026#34;Hello, world!\u0026#34; // stringè½¬byteæ•°ç»„ b := []byte(s) // byteæ•°ç»„è½¬string s2 := string(b) } è¯¥è½¬æ¢è¯­å¥ä¼šè¢«goç¼–è¯‘å™¨ç¿»è¯‘ä¸ºruntimeå±‚çš„æ–¹æ³•è°ƒç”¨ï¼Œå…¶ä¸­[]byteåˆ°stringçš„è½¬æ¢å¯¹åº”/src/runtime/string.go:81å¤„çš„slicebytetostringå‡½æ•°ï¼›è€Œstringåˆ°[]byteçš„è½¬æ¢å¯¹åº”çš„åˆ™æ˜¯/src/runtime/string.go:172å¤„çš„stringtoslicebyteå‡½æ•°ã€‚\nå…ˆæ¥çœ‹çœ‹æ¯”è¾ƒç®€å•çš„stringtoslicebyteå‡½æ•°ï¼ŒtmpBufç±»å‹æ˜¯ä¸ªå¤§å°ä¸º32çš„byteæ•°ç»„ã€‚\n// The constant is known to the compiler. // There is no fundamental theory behind this number. ğŸ¤£ const tmpStringBufSize = 32 type tmpBuf [tmpStringBufSize]byte func stringtoslicebyte(buf *tmpBuf, s string) []byte { var b []byte if buf != nil \u0026amp;\u0026amp; len(s) \u0026lt;= len(buf) { *buf = tmpBuf{} b = buf[:len(s)] } else { // å¦‚æœæ²¡æœ‰ç¼“å†²åŒºæˆ–ç¼“å†²åŒºå¤§å°ä¸è¶³ï¼Œéœ€è¦ç”³è¯·å†…å­˜ b = rawbyteslice(len(s)) } // å¤åˆ¶æ•°æ® copy(b, s) return b } func rawbyteslice(size int) (b []byte) { // å®¹é‡è®¡ç®—ï¼Œè€ƒè™‘å†…å­˜å¯¹é½ï¼Œå¯»æ‰¾å¤§å°æœ€åŒ¹é…çš„å†…å­˜å— cap := roundupsize(uintptr(size)) // ä½¿ç”¨mallocgcç”³è¯·å¯¹åº”å¤§å°çš„å†…å­˜ p := mallocgc(cap, nil, false) // å¦‚æœè¦ç”³è¯·çš„sizeå’Œæœ€ç»ˆè®¡ç®—å¾—åˆ°çš„capå¤§å°ä¸ä¸€è‡´ï¼Œcapåªä¼šæ¯”sizeæ›´å¤§ï¼Œæ¸…ç†æ‰å¤šä½™çš„å†…å­˜ if cap != uintptr(size) { memclrNoHeapPointers(add(p, uintptr(size)), cap-uintptr(size)) } // å°†bæŒ‡å‘è¿™ç‰‡ç”³è¯·å¥½çš„å†…å­˜ã€‚è¯¥sliceä¸ä¸ºç©ºï¼Œæ•…å¤–éƒ¨ä½¿ç”¨copyè¿›è¡Œè¦†ç›–è€Œä¸æ˜¯append *(*slice)(unsafe.Pointer(\u0026amp;b)) = slice{p, size, int(cap)} return } å½“éœ€è¦è½¬æ¢çš„å­—ç¬¦ä¸²é•¿åº¦å°äº32æ—¶ï¼Œåªä¼šè¿›è¡Œå†…å­˜å¤åˆ¶ï¼Œè€Œå¤§äº32çš„è¯ï¼Œé™¤äº†å¤åˆ¶æ“ä½œï¼Œè¿˜éœ€è¦åˆ†é…å†…å­˜ã€‚\n","keywords":["golang","string"],"articleBody":" æœ¬æ–‡golangæºç ä¸º1.18ç‰ˆæœ¬\næ ‡å‡†è½¬æ¢ ä½¿ç”¨æ ‡å‡†è½¬æ¢æ˜¯æœ€å¸¸è§çš„é€‰æ‹©\npackage main func main() { s := \"Hello, world!\" // stringè½¬byteæ•°ç»„ b := []byte(s) // byteæ•°ç»„è½¬string s2 := string(b) } è¯¥è½¬æ¢è¯­å¥ä¼šè¢«goç¼–è¯‘å™¨ç¿»è¯‘ä¸ºruntimeå±‚çš„æ–¹æ³•è°ƒç”¨ï¼Œå…¶ä¸­[]byteåˆ°stringçš„è½¬æ¢å¯¹åº”/src/runtime/string.go:81å¤„çš„slicebytetostringå‡½æ•°ï¼›è€Œstringåˆ°[]byteçš„è½¬æ¢å¯¹åº”çš„åˆ™æ˜¯/src/runtime/string.go:172å¤„çš„stringtoslicebyteå‡½æ•°ã€‚\nå…ˆæ¥çœ‹çœ‹æ¯”è¾ƒç®€å•çš„stringtoslicebyteå‡½æ•°ï¼ŒtmpBufç±»å‹æ˜¯ä¸ªå¤§å°ä¸º32çš„byteæ•°ç»„ã€‚\n// The constant is known to the compiler. // There is no fundamental theory behind this number. ğŸ¤£ const tmpStringBufSize = 32 type tmpBuf [tmpStringBufSize]byte func stringtoslicebyte(buf *tmpBuf, s string) []byte { var b []byte if buf != nil \u0026\u0026 len(s) \u003c= len(buf) { *buf = tmpBuf{} b = buf[:len(s)] } else { // å¦‚æœæ²¡æœ‰ç¼“å†²åŒºæˆ–ç¼“å†²åŒºå¤§å°ä¸è¶³ï¼Œéœ€è¦ç”³è¯·å†…å­˜ b = rawbyteslice(len(s)) } // å¤åˆ¶æ•°æ® copy(b, s) return b } func rawbyteslice(size int) (b []byte) { // å®¹é‡è®¡ç®—ï¼Œè€ƒè™‘å†…å­˜å¯¹é½ï¼Œå¯»æ‰¾å¤§å°æœ€åŒ¹é…çš„å†…å­˜å— cap := roundupsize(uintptr(size)) // ä½¿ç”¨mallocgcç”³è¯·å¯¹åº”å¤§å°çš„å†…å­˜ p := mallocgc(cap, nil, false) // å¦‚æœè¦ç”³è¯·çš„sizeå’Œæœ€ç»ˆè®¡ç®—å¾—åˆ°çš„capå¤§å°ä¸ä¸€è‡´ï¼Œcapåªä¼šæ¯”sizeæ›´å¤§ï¼Œæ¸…ç†æ‰å¤šä½™çš„å†…å­˜ if cap != uintptr(size) { memclrNoHeapPointers(add(p, uintptr(size)), cap-uintptr(size)) } // å°†bæŒ‡å‘è¿™ç‰‡ç”³è¯·å¥½çš„å†…å­˜ã€‚è¯¥sliceä¸ä¸ºç©ºï¼Œæ•…å¤–éƒ¨ä½¿ç”¨copyè¿›è¡Œè¦†ç›–è€Œä¸æ˜¯append *(*slice)(unsafe.Pointer(\u0026b)) = slice{p, size, int(cap)} return } å½“éœ€è¦è½¬æ¢çš„å­—ç¬¦ä¸²é•¿åº¦å°äº32æ—¶ï¼Œåªä¼šè¿›è¡Œå†…å­˜å¤åˆ¶ï¼Œè€Œå¤§äº32çš„è¯ï¼Œé™¤äº†å¤åˆ¶æ“ä½œï¼Œè¿˜éœ€è¦åˆ†é…å†…å­˜ã€‚\nå†çœ‹çœ‹slicebytetostringå‡½æ•°ï¼Œ\n// ptræŒ‡å‘sliceçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œnæ˜¯sliceçš„é•¿åº¦ func slicebytetostring(buf *tmpBuf, ptr *byte, n int) (str string) { if n == 0 { return \"\" } ... // å¦‚æœåªæœ‰å•ä¸ªbyteï¼Œè¿”å›å€¼å­—ç¬¦ä¸²ä¸­çš„æ•°æ®æŒ‡é’ˆstrç›´æ¥æŒ‡å‘é¢„åˆ†é…å¥½çš„ä¸€å—é™æ€å†…å­˜åŒº if n == 1 { // staticuint64sæ˜¯ä¸€ä¸ªuint64æ•°ç»„ï¼Œé‡Œé¢ä¸€ä¸ªä¸ªå€¼éƒ½å¯¹åº”ç€å•ä¸ªbyteçš„int8å€¼ï¼Œæä¾›æ­¤ç§æƒ…å†µä¸‹çš„strä¸å¯ä¿®æ”¹çš„æŒ‡å‘ p := unsafe.Pointer(\u0026staticuint64s[*ptr]) if goarch.BigEndian { p = add(p, 7) } // å¡«å……è¿”å›æ•°æ® stringStructOf(\u0026str).str = p stringStructOf(\u0026str).len = 1 return } var p unsafe.Pointer if buf != nil \u0026\u0026 n \u003c= len(buf) { p = unsafe.Pointer(buf) } else { // ç¼“å†²åŒºä¸å­˜åœ¨æˆ–è€…ä¸å¤Ÿæ—¶ï¼Œåˆ†é…å†…å­˜ p = mallocgc(uintptr(n), nil, false) } stringStructOf(\u0026str).str = p stringStructOf(\u0026str).len = n // ä½¿ç”¨memmoveå¤åˆ¶æ•°æ® memmove(p, unsafe.Pointer(ptr), uintptr(n)) return } å…³äºstaticuint64sçš„ä¸€æ®µæµ‹è¯•ä»£ç :\npackage main import \"unsafe\" var staticuint64s = [...]uint64{ 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48, 0x49, 0x4a, 0x4b, 0x4c, 0x4d, 0x4e, 0x4f, 0x50, 0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x5a, 0x5b, 0x5c, 0x5d, 0x5e, 0x5f, 0x60, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6a, 0x6b, 0x6c, 0x6d, 0x6e, 0x6f, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7a, 0x7b, 0x7c, 0x7d, 0x7e, 0x7f, 0x80, 0x81, 0x82, 0x83, 0x84, 0x85, 0x86, 0x87, 0x88, 0x89, 0x8a, 0x8b, 0x8c, 0x8d, 0x8e, 0x8f, 0x90, 0x91, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97, 0x98, 0x99, 0x9a, 0x9b, 0x9c, 0x9d, 0x9e, 0x9f, 0xa0, 0xa1, 0xa2, 0xa3, 0xa4, 0xa5, 0xa6, 0xa7, 0xa8, 0xa9, 0xaa, 0xab, 0xac, 0xad, 0xae, 0xaf, 0xb0, 0xb1, 0xb2, 0xb3, 0xb4, 0xb5, 0xb6, 0xb7, 0xb8, 0xb9, 0xba, 0xbb, 0xbc, 0xbd, 0xbe, 0xbf, 0xc0, 0xc1, 0xc2, 0xc3, 0xc4, 0xc5, 0xc6, 0xc7, 0xc8, 0xc9, 0xca, 0xcb, 0xcc, 0xcd, 0xce, 0xcf, 0xd0, 0xd1, 0xd2, 0xd3, 0xd4, 0xd5, 0xd6, 0xd7, 0xd8, 0xd9, 0xda, 0xdb, 0xdc, 0xdd, 0xde, 0xdf, 0xe0, 0xe1, 0xe2, 0xe3, 0xe4, 0xe5, 0xe6, 0xe7, 0xe8, 0xe9, 0xea, 0xeb, 0xec, 0xed, 0xee, 0xef, 0xf0, 0xf1, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6, 0xf7, 0xf8, 0xf9, 0xfa, 0xfb, 0xfc, 0xfd, 0xfe, 0xff, } type stringStruct struct { str unsafe.Pointer len int } func stringStructOf(sp *string) *stringStruct { return (*stringStruct)(unsafe.Pointer(sp)) } func main() { var s string stringStructOf(\u0026s).str = unsafe.Pointer(\u0026staticuint64s[80]) stringStructOf(\u0026s).len = 1 println(s) } ä½¿ç”¨æ ‡å‡†è½¬æ¢æ˜¯æœ€ç®€å•ä¹Ÿæ˜¯æœ€å®‰å…¨çš„ï¼Œä½†ä»ä¸Šé¢çš„æºç å¯ä»¥çœ‹åˆ°ï¼Œstringå’Œ[]byteçš„ä¸¤ä¸ªç›¸äº’è½¬æ¢ï¼Œéƒ½å¯èƒ½å‡ºç°æ–°çš„å†…å­˜åˆ†é…ï¼Œå¹¶ä¸”ä¸€å®šè¦è¿›è¡Œå†…å­˜çš„å¤åˆ¶ã€‚è¿™æ ·çš„è½¬æ¢åœ¨æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ä¸‹æ— æ³•æ»¡è¶³è¦æ±‚ï¼Œè¿˜å¥½æˆ‘ä»¬è¿˜æœ‰å…¶ä»–çš„è½¬æ¢é»‘é­”æ³•ğŸ˜ˆã€‚\né›¶æ‹·è´è½¬æ¢ ç¼–è¯‘å™¨è½¬æ¢ å…¶å®åœ¨ä¸Šæ–‡æåˆ°çš„ä¸¤ä¸ªå‡½æ•°æ—è¾¹ï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°â€”â€”slicebytetostringtmp(src/runtime/string.go:154)\n// slicebytetostringtmp returns a \"string\" referring to the actual []byte bytes. // // Callers need to ensure that the returned string will not be used after // the calling goroutine modifies the original slice or synchronizes with // another goroutine. // // The function is only called when instrumenting // and otherwise intrinsified by the compiler. // // Some internal compiler optimizations use this function. // - Used for m[T1{... Tn{..., string(k), ...} ...}] and m[string(k)] // where k is []byte, T1 to Tn is a nesting of struct and array literals. // - Used for \"\u003c\"+string(b)+\"\u003e\" concatenation where b is []byte. // - Used for string(b)==\"foo\" comparison where b is []byte. func slicebytetostringtmp(ptr *byte, n int) (str string) { if raceenabled \u0026\u0026 n \u003e 0 { racereadrangepc(unsafe.Pointer(ptr), uintptr(n), getcallerpc(), abi.FuncPCABIInternal(slicebytetostringtmp)) } if msanenabled \u0026\u0026 n \u003e 0 { msanread(unsafe.Pointer(ptr), uintptr(n)) } if asanenabled \u0026\u0026 n \u003e 0 { asanread(unsafe.Pointer(ptr), uintptr(n)) } stringStructOf(\u0026str).str = unsafe.Pointer(ptr) stringStructOf(\u0026str).len = n return } æŠ›å¼€æ— éœ€å…³å¿ƒçš„ä»£ç ï¼Œæ ¸å¿ƒä»£ç åªæœ‰ä¸¤å¥:\nstringStructOf(\u0026str).str = unsafe.Pointer(ptr) stringStructOf(\u0026str).len = n è¿”å›å­—ç¬¦ä¸²çš„æ•°æ®æŒ‡é’ˆstrç›´æ¥æŒ‡å‘äº†[]byteçš„é¦–åœ°å€ï¼Œè€Œé•¿åº¦ç›´æ¥å–[]byteé•¿åº¦ã€‚èƒ½å¤Ÿå¦‚æ­¤è½¬æ¢çš„æ ¹æœ¬åŸå› æ˜¯stringçš„åº•å±‚ç±»å‹å’Œsliceçš„åº•å±‚ç±»å‹å†…å­˜åˆ†å¸ƒç›¸ä¼¼ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡ä¿®æ”¹æŒ‡é’ˆçš„æ–¹å¼è¿›è¡Œè½¬æ¢ã€‚\n// src/runtime/string.go:238 type stringStruct struct { str unsafe.Pointer len int } // src/runtime/slice.go:15 type slice struct { array unsafe.Pointer len int cap int } å¯è§ï¼Œä¸¤ä¸ªç»“æ„ä½“çš„å‰ä¸¤ä¸ªå­—æ®µå†…å­˜åˆ†å¸ƒæ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œå¹¶ä¸”stringçš„åº•å±‚æ•°æ®ç±»å‹å’Œ[]byteä¸€è‡´ï¼Œæ‰€ä»¥unsafe.Pointerå¯¹åº”çš„å®é™…æŒ‡é’ˆéƒ½æ˜¯*byteã€‚è¿™æ ·çš„è½¬æ¢å®é™…ä¸Šå°±æ˜¯æŒ‡é’ˆçš„è½¬æ¢ï¼Œä¸éœ€è¦è¿›è¡Œå†…å­˜çš„åˆ†é…å’Œå¤åˆ¶ï¼Œæ‰€ä»¥æ•ˆç‡éå¸¸é«˜ã€‚\nä½†æ˜¯ä½¿ç”¨è¿™æ ·çš„ä»£ç æ˜¯æœ‰é£é™©çš„ï¼Œä¸Šæ–‡ä¸­çš„ä»£ç æˆ‘ç‰¹æ„æŠŠæ³¨é‡Šä¹Ÿè´´å‡ºæ¥äº†ï¼Œæ³¨é‡Šé‡Œç¬¬äºŒæ®µæ˜ç¡®å†™åˆ°ï¼Œè°ƒç”¨è€…éœ€è¦ä¿è¯ï¼Œåœ¨ä¿®æ”¹æˆ–ä¸å…¶ä»–gåŒæ­¥äº†åŸ[]byteåï¼Œè¿”å›çš„stringä¸ä¼šå†è¢«ä½¿ç”¨ã€‚è¿™æ˜¯å› ä¸ºä½ å¼ºè¡Œåˆ›é€ çš„è¿™ä¸ªstringæ‰€å¯¹åº”çš„åº•å±‚æ•°æ®å¹¶ä¸å®‰å…¨ï¼Œåˆ›é€ å‡ºè¯¥stringåï¼Œä½ å¯ä»¥ç›´æ¥å¯¹åŸ[]byteè¿›è¡Œä¿®æ”¹ï¼Œè¿™è¿èƒŒäº†goè¯­è¨€å­—ç¬¦ä¸²ä¸å¯ä¿®æ”¹çš„åŸåˆ™ï¼Œå°†ä¼šäº§ç”Ÿæ— æ³•æ•è·çš„é”™è¯¯ã€‚\næ‰€ä»¥è¿™ä¸ªæ–¹æ³•goæ²¡æœ‰æš´éœ²ç»™å¼€å‘è€…ï¼Œä»…åœ¨æºç å†…éƒ¨å¯ä½¿ç”¨ï¼Œä¾›ç¼–è¯‘å™¨åœ¨æŸäº›é€‚ç”¨åœºæ™¯ä¼˜åŒ–æ€§èƒ½ã€‚\nä»¥ä¸Šä¸¤ç§è½¬æ¢çš„æ€§èƒ½å¯¹æ¯”:\npackage main import ( \"testing\" ) const LEN = 33 func getBytes() []byte { var b []byte for i := 0; i \u003c LEN; i++ { b = append(b, ' ') } return b } func BenchmarkByte2StringOrigin(b *testing.B) { bytes := getBytes() for i := 0; i \u003c b.N; i++ { s := string(bytes) _ = s } } func BenchmarkByte2StringTmp(b *testing.B) { bytes := getBytes() for i := 0; i \u003c b.N; i++ { s := slicebytetostringtmp(bytes) _ = s } } // ä¾èµ–ä»£ç  type stringStruct struct { str unsafe.Pointer len int } func stringStructOf(sp *string) *stringStruct { return (*stringStruct)(unsafe.Pointer(sp)) } func slicebytetostringtmp(b []byte) (str string) { stringStructOf(\u0026str).str = unsafe.Pointer(\u0026b[0]) stringStructOf(\u0026str).len = len(b) return } å’Œä¹‹å‰æºç çœ‹åˆ°çš„ä¸€è‡´ï¼Œå¯¹äºæ ‡å‡†è½¬æ¢ï¼Œé•¿åº¦32æ˜¯ä¸€ä¸ªåˆ†æ°´å²­ï¼Œé•¿åº¦å¤§äº32æ—¶ï¼Œå°±ä¼šå‡ºç°å†…å­˜åˆ†é…ï¼ŒåŒæ—¶æ“ä½œè€—æ—¶ä¹Ÿæ˜¾è‘—å¢åŠ ã€‚å¹¶ä¸”éšç€sliceé•¿åº¦çš„å¢åŠ ï¼Œå’ŒæŒ‡é’ˆè½¬æ¢çš„æ€§èƒ½å·®è·ä¼šè¶Šæ¥è¶Šå¤§ã€‚\nè‡ªå·±å®ç°â€”â€”unsafe.Pointer è™½ç„¶slicebytetostringtmpæˆ‘ä»¬æ— æ³•ä½¿ç”¨ï¼Œä½†æ˜¯é€šè¿‡ä½¿ç”¨unsafeåŒ…ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªè¡Œæ„é€ ç±»ä¼¼çš„æŒ‡é’ˆè½¬æ¢ã€‚\nå…ˆæ¥ä¸€ä¸ªæœ€ç®€å•çš„ç‰ˆæœ¬:\nfunc String2bytesEasy(s string) []byte { return *(*[]byte)(unsafe.Pointer(\u0026s)) } func Bytes2StringEasy(b []byte) string { return *(*string)(unsafe.Pointer(\u0026b)) } ç›´æ¥ä½¿ç”¨unsafe.Pointerä½œä¸ºä¸­é—´ç±»å‹è¿›è¡Œå¼ºè½¬ï¼Œéå¸¸å¿«é€Ÿï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼ŒString2bytesEasyå‡½æ•°ä¸­ï¼Œè¿”å›çš„sliceä¸­capå­—æ®µæ˜¯æ²¡æœ‰èµ‹å€¼çš„ï¼Œå› ä¸ºstringç±»å‹åªæœ‰ä¸¤ä¸ªå­—æ®µï¼Œè€Œsliceæœ‰ä¸‰ä¸ªï¼Œæœªèµ‹å€¼çš„capå­—æ®µçš„å€¼æ˜¯éšæœºçš„ï¼Œå–å†³äºé‚£ä¸€å—å†…å­˜çš„å€¼ã€‚\nä¼˜åŒ–ç‰ˆæœ¬:\n// src/reflect/value.go:2670 type StringHeader struct { Data uintptr Len int } // src/reflect/value.go:2681 type SliceHeader struct { Data uintptr Len int Cap int } func String2bytes(s string) []byte { stringHeader := (*reflect.StringHeader)(unsafe.Pointer(\u0026s)) bh := reflect.SliceHeader{ Data: stringHeader.Data, Len: stringHeader.Len, Cap: stringHeader.Len, } return *(*[]byte)(unsafe.Pointer(\u0026bh)) } è¿™ä¸ªç‰ˆæœ¬ç”¨åˆ°äº†reflectåŒ…ä¸­çš„ä¸¤ä¸ªç±»å‹StringHeaderå’ŒSliceHeaderï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯stringå’Œsliceçš„runtimeå±‚å½¢æ€ã€‚é€šè¿‡è¿™æ ·çš„è½¬æ¢åï¼Œæˆ‘ä»¬å¾—ä»¥ç›´æ¥æ“ä½œå®ƒä»¬çš„å­—æ®µã€‚\né€šè¿‡å…¨éƒ¨çš„ä¸‰ä¸ªå­—æ®µèµ‹å€¼ï¼Œæœ€ç»ˆå¾—åˆ°çš„æ˜¯ä¸€ä¸ªå®Œæ•´çš„sliceã€‚\nä½†æ˜¯è¿™é‡Œçš„ä»£ç è¿˜éšè—äº†ä¸€ä¸ªæ·±å±‚æ¬¡çš„é—®é¢˜ ç»§ç»­æ·±æŒ–ï¼Œè¿™é‡Œçš„å…³é”®æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ä¸­é—´å˜é‡bhï¼Œç‰¹æ®Šç‚¹åœ¨äºå®ƒçš„ç±»å‹reflect.SliceHeaderã€‚å¦‚æœä½ æ‰“å¼€è¿‡æºç çš„unsafeåŒ…ï¼Œåœ¨Pointç±»å‹çš„å¼€å¤´æœ‰ä¸€å¤§å †æ³¨é‡Š(ä»¥ä¸‹ä»…éƒ¨åˆ†):\n// (6) Conversion of a reflect.SliceHeader or reflect.StringHeader Data field to or from Pointer. // // As in the previous case, the reflect data structures SliceHeader and StringHeader // declare the field Data as a uintptr to keep callers from changing the result to // an arbitrary type without first importing \"unsafe\". However, this means that // SliceHeader and StringHeader are only valid when interpreting the content // of an actual slice or string value. // //\tvar s string //\thdr := (*reflect.StringHeader)(unsafe.Pointer(\u0026s)) // case 1 //\thdr.Data = uintptr(unsafe.Pointer(p)) // case 6 (this case) //\thdr.Len = n // // In this usage hdr.Data is really an alternate way to refer to the underlying // pointer in the string header, not a uintptr variable itself. // // In general, reflect.SliceHeader and reflect.StringHeader should be used // only as *reflect.SliceHeader and *reflect.StringHeader pointing at actual // slices or strings, never as plain structs. // A program should not declare or allocate variables of these struct types. // //\t// INVALID: a directly-declared header will not hold Data as a reference. //\tvar hdr reflect.StringHeader //\thdr.Data = uintptr(unsafe.Pointer(p)) //\thdr.Len = n //\ts := *(*string)(unsafe.Pointer(\u0026hdr)) // p possibly already lost // é‡ç‚¹å°±æ˜¯è¿™ä¸€å¥â€”â€”INVALID: a directly-declared header will not hold Data as a reference.\nç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼Œä¸€ä¸ªç›´æ¥å£°æ˜çš„headerä¸ä¼šå°†Dataä½œä¸ºå¼•ç”¨ã€‚\nè§£é‡Šä¸€ä¸‹ï¼ŒHeaderçš„Dataå­—æ®µç±»å‹æ˜¯uintptrè€Œä¸æ˜¯unsafe.Pointerï¼Œè¿™ä¸¤ä¸ªç±»å‹çš„å…¶ä¸­ä¸€ä¸ªå·®åˆ«å°±æ˜¯ï¼Œgoçš„gcä¸ä¼šè®°å½•uintptrçš„å¼•ç”¨ï¼Œè¿™ä¸€ç‚¹åœ¨SliceHeaderå’ŒStringHeaderçš„å®šä¹‰å¤„ä¹Ÿæœ‰æ³¨é‡Šè¿›è¡Œäº†è¯´æ˜ï¼Œå®ƒä»¬ä¿©çš„å®šä¹‰ä¸Šæ–¹éƒ½æœ‰è¿™ä¹ˆä¸€æ®µ:\n// Moreover, the Data field is not sufficient to guarantee the data // it references will not be garbage collected, so programs must keep // a separate, correctly typed pointer to the underlying data. è¿™æ„å‘³ç€gcåœ¨æ¸…ç†å†…å­˜æ—¶å¹¶ä¸çŸ¥é“è¿˜å­˜åœ¨ä¸€ä¸ªHeaderçš„Dataå­—æ®µæŒ‡å‘äº†è¿™å—å†…å­˜ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´åœ¨è½¬æ¢çš„è¿‡ç¨‹ä¸­ï¼Œåº•å±‚æ•°æ®å·²ç»è¢«gcç»™æ¸…ç†ã€‚\nå¯¹åº”ä¸Šé¢çš„ä¾‹å­ä¸­:\nfunc String2bytes(s string) []byte { stringHeader := (*reflect.StringHeader)(unsafe.Pointer(\u0026s)) bh := reflect.SliceHeader{ Data: stringHeader.Data, Len: stringHeader.Len, Cap: stringHeader.Len, } // åœ¨æ‰§è¡Œè¿™ä¸€æ­¥ä¹‹å‰ï¼ŒstringHeaderå·²ç»æ²¡æœ‰äº†ç”¨å¤„ï¼Œè€Œbhæ²¡æœ‰äº§ç”Ÿå¼•ç”¨ï¼Œæ­¤æ—¶gcè®¤ä¸ºæ˜¯å¯ä»¥è¿›è¡Œå›æ”¶çš„ return *(*[]byte)(unsafe.Pointer(\u0026bh)) } é¿å…è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œé¿å¼€directly-declaredå°±å¯ä»¥äº†ï¼Œæ³¨é‡Šä¸­ä¹Ÿç»™äº†ä¸€ä¸ªæ­£ç¡®ä¾‹å­:\nvar s string hdr := (*reflect.StringHeader)(unsafe.Pointer(\u0026s)) // case 1 hdr.Data = uintptr(unsafe.Pointer(p)) // case 6 (this case) hdr.Len = n è¿™é‡Œå…ˆåˆ›å»ºäº†ä¸´æ—¶å˜é‡sï¼Œå†åŸºäºsè¿›è¡Œè½¬æ¢å¾—åˆ°çš„headeræŒ‡é’ˆï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸å­˜åœ¨ä¸€ä¸ªå®é™…çš„headerï¼Œå¯¹hdrçš„èµ‹å€¼æ“ä½œå…¶å®æ˜¯åœ¨ç›´æ¥æ“ä½œå­—ç¬¦ä¸²sï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰äº†gcè¿½è¸ªä¸åˆ°çš„é—®é¢˜äº†ã€‚\nè´´ä¸€ä¸ªä¼˜åŒ–ä»£ç ç¤ºä¾‹:\nfunc b2s(b []byte) string { return *(*string)(unsafe.Pointer(\u0026b)) } func S2b(s string) (b []byte) { bh := (*reflect.SliceHeader)(unsafe.Pointer(\u0026b)) sh := (*reflect.StringHeader)(unsafe.Pointer(\u0026s)) bh.Data = sh.Data bh.Len = sh.Len bh.Cap = sh.Len return b } è¡¥å…… å…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘è¿˜æ‰¾åˆ°ä¸€ä¸ªgoæºç åº“çš„issueï¼šFeature: provide no-copy conversion from []byte to stringï¼Œè™½ç„¶issueçš„å‘èµ·è€…æ˜¯æƒ³é—®ä¸ºä»€ä¹ˆæ²¡æœ‰å®˜æ–¹æä¾›çš„è½¬æ¢å‡½æ•°ï¼Œä½†æ˜¯ä»–æä¾›çš„ä»£ç æœ‰ç€å’Œæˆ‘æ‰€ç»™çš„åä¾‹ä»£ç ä¸€æ ·çš„é—®é¢˜ï¼Œå¹¶ä¸”è¢«å…¶ä»–ç”¨æˆ·æŒ‡å‡ºæ¥äº†ï¼Œå¹¶ä¸”è¿™ä¸ªé—®é¢˜å¾—åˆ°äº†goçš„ç»„ç»‡æˆå‘˜çš„è‚¯å®šï¼š\næœ‰è¶£çš„æ˜¯ï¼Œgo101(åº”è¯¥æœ‰äººè®¤è¯†å§)è¿˜åœ¨ä¸‹é¢æå‡ºå³ä½¿é¿å¼€äº†headerçš„ç›´æ¥å®šä¹‰ï¼Œè¿˜æ˜¯éœ€è¦ä½¿ç”¨runtime.KeepAliveæ¥ä¿è¯gcä¸ä¼šå›æ”¶æ•°æ®ï¼Œè¿™å°±ä¸æˆ‘æœ¬æ–‡è§‚ç‚¹å†²çªäº†ğŸ¤£ã€‚\nä¸è¿‡å¥½åœ¨è¿™æ¡åœ¨ä¸‹é¢è¢«åå¯¹äº†ğŸ‘€\nè‡³äºä¸ºä»€ä¹ˆä¸æŠŠreflectåŒ…ä¸­headerçš„Dataå­—æ®µæ”¹ä¸ºunsafe.Pointeræ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿæœ‰äº†è§£é‡Šï¼š\nè¿™é‡Œé¢æåˆ°çš„å¦å¤–çš„issue:\nunsafe: add Slice(ptr *T, len anyIntegerType) []T\nproposal: spec: disallow T\u003c-\u003euintptr conversion for type T unsafe.Pointer\nå¦å¤–ï¼Œæˆ‘è§‰å¾—è¯¥issueçš„å‘èµ·äººè¯´çš„è¯æŒºæœ‰é“ç†çš„ï¼Œè¿™æ®µè½¬æ¢çš„ä»£ç è—äº†å¾ˆæ·±çš„å‘ï¼Œæ²¡æœ‰å¯¹æºç æœ‰ä¸€å®šäº†è§£çš„äººå®Œå…¨æ— æ³•å‘ç°ï¼Œè€Œå®˜æ–¹åˆæ²¡æœ‰æä¾›è½¬æ¢çš„æœ€ä½³å®è·µï¼Œä»¥è‡´äºç½‘ç»œä¸Šå‡ºç°äº†å„ç§è‡ªè¡Œå®ç°çš„ç‰ˆæœ¬ï¼Œè€Œå…¶ä¸­è®¸å¤šçš„å®ç°éƒ½æ˜¯å­˜åœ¨é—®é¢˜çš„ã€‚\nå¹¸å¥½ï¼Œè¿™ä¸ªé—®é¢˜åœ¨Go2è¿æ¥äº†è½¬æœºã€‚\nå±•æœ›æœªæ¥ï¼ŒGo1.20 åœ¨go1.20rcä¸­çš„è¿™ä¸ªæäº¤ï¼Œä¸ºsliceå’Œstringçš„è½¬æ¢æä¾›äº†æ–°çš„é€‰æ‹©ï¼Œè¯¥æäº¤åœ¨unsafeåŒ…ä¸­æ–°å¢äº†å››ä¸ªå‡½æ•°https://github.com/golang/go/blob/release-branch.go1.20/src/unsafe/unsafe.go:\n// The function Slice returns a slice whose underlying array starts at ptr // and whose length and capacity are len. // Slice(ptr, len) is equivalent to // //\t(*[len]ArbitraryType)(unsafe.Pointer(ptr))[:] // // except that, as a special case, if ptr is nil and len is zero, // Slice returns nil. // // The len argument must be of integer type or an untyped constant. // A constant len argument must be non-negative and representable by a value of type int; // if it is an untyped constant it is given type int. // At run time, if len is negative, or if ptr is nil and len is not zero, // a run-time panic occurs. func Slice(ptr *ArbitraryType, len IntegerType) []ArbitraryType // SliceData returns a pointer to the underlying array of the argument // slice. // - If cap(slice) \u003e 0, SliceData returns \u0026slice[:1][0]. // - If slice == nil, SliceData returns nil. // - Otherwise, SliceData returns a non-nil pointer to an // unspecified memory address. func SliceData(slice []ArbitraryType) *ArbitraryType // String returns a string value whose underlying bytes // start at ptr and whose length is len. // // The len argument must be of integer type or an untyped constant. // A constant len argument must be non-negative and representable by a value of type int; // if it is an untyped constant it is given type int. // At run time, if len is negative, or if ptr is nil and len is not zero, // a run-time panic occurs. // // Since Go strings are immutable, the bytes passed to String // must not be modified afterwards. func String(ptr *byte, len IntegerType) string // StringData returns a pointer to the underlying bytes of str. // For an empty string the return value is unspecified, and may be nil. // // Since Go strings are immutable, the bytes returned by StringData // must not be modified. func StringData(str string) *byte ç”±äºunsafeåŒ…çš„ç‰¹æ®Šæ€§ï¼Œå…¶å‡½æ•°çš„å…·ä½“å®ç°æ˜¯é€šè¿‡æ±‡ç¼–ç­‰æ‰‹æ®µå®ç°çš„ï¼Œæ‰€ä»¥ä½ åœ¨è¿™é‡Œåªèƒ½çœ‹åˆ°å‡½æ•°ç­¾åã€‚\nç®€å•ä»‹ç»ä¸‹å››ä¸ªå‡½æ•°çš„ä½œç”¨:\nSliceï¼šè¿”å›ä¸€ä¸ªsliceï¼Œå…¶åº•å±‚æ•°ç»„çš„èµ·å§‹åœ°å€å³ä¸ºå‚æ•°ptræ‰€æŒ‡å‘çš„åœ°å€ï¼Œsliceçš„lenå’Œcapéƒ½ä¸ºå‚æ•°lenã€‚ SliceData: è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥sliceåº•å±‚æ•°ç»„çš„æŒ‡é’ˆã€‚ Stringï¼šè¿”å›ä¸€ä¸ªstringï¼Œå…¶åº•å±‚çš„byteæ•°ç»„çš„èµ·å§‹åœ°å€å³ä¸ºå‚æ•°ptræ‰€æŒ‡å‘çš„åœ°å€ï¼Œé•¿åº¦ä¸ºå‚æ•°lenã€‚ StringData: è¿”å›å‚æ•°stråº•å±‚byteæ•°ç»„çš„æŒ‡é’ˆã€‚ è¿™å››ä¸ªå‡½æ•°æä¾›çš„åŠŸèƒ½éå¸¸åŸºç¡€ï¼Œä¸è¿‡ç»„åˆèµ·æ¥å°±èƒ½å®ç°æˆ‘ä»¬æƒ³è¦çš„å­—ç¬¦ä¸²è½¬æ¢åŠŸèƒ½äº†,å¦‚æœä¸æƒ³å®‰è£…go1.20rcï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œå»è¯•ç”¨è¿™å››ä¸ªå‡½æ•°:\npackage main import ( \"fmt\" \"unsafe\" ) func main() { str := \"hello world!\" bt := unsafe.Slice(unsafe.StringData(str), len(str)) fmt.Println(bt) } æœ‰äº†è¿™ä¸ªå†™æ³•ï¼Œreflectçš„headerså°±å¯ä»¥å¼ƒç”¨äº†ã€‚\né™„ä¸Šä¸‰ç§è½¬æ¢çš„benchmark(IDEå¯èƒ½ä¼šæŠ¥é”™ï¼Œä½†æ˜¯æ²¡äº‹ï¼Œgo1.20å¯ä»¥æ‰§è¡Œ)ï¼š\npackage main import ( \"testing\" \"unsafe\" ) const LEN = 33 func getBytes() []byte { var b []byte for i := 0; i \u003c LEN; i++ { b = append(b, ' ') } return b } func getStr() string { return string(getBytes()) } func BenchmarkString2Slice(b *testing.B) { str := getStr() for i := 0; i \u003c b.N; i++ { bt := []byte(str) _ = bt } } func BenchmarkString2SliceReflect(b *testing.B) { str := getStr() for i := 0; i \u003c b.N; i++ { bt := *(*[]byte)(unsafe.Pointer(\u0026str)) _ = bt } } func BenchmarkString2SliceUnsafe(b *testing.B) { str := getStr() for i := 0; i \u003c b.N; i++ { bt := unsafe.Slice(unsafe.StringData(str), len(str)) _ = bt } } func BenchmarkSlice2String(b *testing.B) { bytes := getBytes() for i := 0; i \u003c b.N; i++ { ss := string(bytes) _ = ss } } func BenchmarkSlice2StringReflect(b *testing.B) { bytes := getBytes() for i := 0; i \u003c b.N; i++ { ss := *(*string)(unsafe.Pointer(\u0026bytes)) _ = ss } } func BenchmarkSlice2StringUnsafe(b *testing.B) { bytes := getBytes() for i := 0; i \u003c b.N; i++ { ss := unsafe.String(unsafe.SliceData(bytes), len(bytes)) _ = ss } } ","wordCount":"1812","inLanguage":"zh","datePublished":"2023-02-01T19:34:04+08:00","dateModified":"2023-02-01T19:34:04+08:00","author":[{"@type":"Person","name":"å£¹æ¬¡å¿ƒ"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.yici.xin/post/tech/%E8%BD%AC%E6%8D%A2bytes%E5%92%8Cstring%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"},"publisher":{"@type":"Organization","name":"ç»çŸ¥","logo":{"@type":"ImageObject","url":"https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202211171234877.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.yici.xin/ accesskey=h title="ç»çŸ¥ (Alt + H)">ç»çŸ¥</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li></li></ul></div></div><ul id=menu><li><a href=https://www.yici.xin/tags/ title=æ ‡ç­¾ğŸ·ï¸><span>æ ‡ç­¾ğŸ·ï¸</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.yici.xin/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://www.yici.xin/post/>Posts</a>&nbsp;Â»&nbsp;<a href=https://www.yici.xin/post/tech/>ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div><h1 class=post-title>è½¬æ¢byteså’Œstringçš„æœ€ä½³å®è·µ</h1><div class=post-meta><span title='2023-02-01 19:34:04 +0800 +0800'>2023-02-01</span>&nbsp;Â·&nbsp;å£¹æ¬¡å¿ƒ</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e6%a0%87%e5%87%86%e8%bd%ac%e6%8d%a2 aria-label=æ ‡å‡†è½¬æ¢>æ ‡å‡†è½¬æ¢</a></li><li><a href=#%e9%9b%b6%e6%8b%b7%e8%b4%9d%e8%bd%ac%e6%8d%a2 aria-label=é›¶æ‹·è´è½¬æ¢>é›¶æ‹·è´è½¬æ¢</a><ul><li><a href=#%e7%bc%96%e8%af%91%e5%99%a8%e8%bd%ac%e6%8d%a2 aria-label=ç¼–è¯‘å™¨è½¬æ¢>ç¼–è¯‘å™¨è½¬æ¢</a></li></ul></li><li><a href=#%e8%87%aa%e5%b7%b1%e5%ae%9e%e7%8e%b0unsafepointer aria-label=è‡ªå·±å®ç°â€”â€”unsafe.Pointer>è‡ªå·±å®ç°â€”â€”unsafe.Pointer</a><ul><li><a href=#%e8%a1%a5%e5%85%85 aria-label=è¡¥å……>è¡¥å……</a></li></ul></li><li><a href=#%e5%b1%95%e6%9c%9b%e6%9c%aa%e6%9d%a5go120 aria-label=å±•æœ›æœªæ¥ï¼ŒGo1.20>å±•æœ›æœªæ¥ï¼ŒGo1.20</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><blockquote><p>æœ¬æ–‡golangæºç ä¸º1.18ç‰ˆæœ¬</p></blockquote><h2 id=æ ‡å‡†è½¬æ¢>æ ‡å‡†è½¬æ¢<a hidden class=anchor aria-hidden=true href=#æ ‡å‡†è½¬æ¢>#</a></h2><p>ä½¿ç”¨æ ‡å‡†è½¬æ¢æ˜¯æœ€å¸¸è§çš„é€‰æ‹©</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>package</span> <span style=color:#e06c75>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>s</span> <span style=color:#56b6c2>:=</span> <span style=color:#98c379>&#34;Hello, world!&#34;</span>
</span></span><span style=display:flex><span>  	<span style=color:#7f848e>// stringè½¬byteæ•°ç»„</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>b</span> <span style=color:#56b6c2>:=</span> []<span style=color:#e5c07b>byte</span>(<span style=color:#e06c75>s</span>)
</span></span><span style=display:flex><span>  	<span style=color:#7f848e>// byteæ•°ç»„è½¬string</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>s2</span> <span style=color:#56b6c2>:=</span> <span style=color:#e5c07b>string</span>(<span style=color:#e06c75>b</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¯¥è½¬æ¢è¯­å¥ä¼šè¢«goç¼–è¯‘å™¨ç¿»è¯‘ä¸ºruntimeå±‚çš„æ–¹æ³•è°ƒç”¨ï¼Œå…¶ä¸­<code>[]byte</code>åˆ°<code>string</code>çš„è½¬æ¢å¯¹åº”<code>/src/runtime/string.go:81</code>å¤„çš„<code>slicebytetostring</code>å‡½æ•°ï¼›è€Œ<code>string</code>åˆ°<code>[]byte</code>çš„è½¬æ¢å¯¹åº”çš„åˆ™æ˜¯<code>/src/runtime/string.go:172</code>å¤„çš„<code>stringtoslicebyte</code>å‡½æ•°ã€‚</p><p>å…ˆæ¥çœ‹çœ‹æ¯”è¾ƒç®€å•çš„<code>stringtoslicebyte</code>å‡½æ•°ï¼Œ<code>tmpBuf</code>ç±»å‹æ˜¯ä¸ªå¤§å°ä¸º32çš„<code>byte</code>æ•°ç»„ã€‚</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// The constant is known to the compiler.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// There is no fundamental theory behind this number. ğŸ¤£</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>const</span> <span style=color:#e06c75>tmpStringBufSize</span> = <span style=color:#d19a66>32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>type</span> <span style=color:#e06c75>tmpBuf</span> [<span style=color:#e06c75>tmpStringBufSize</span>]<span style=color:#e5c07b>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>stringtoslicebyte</span>(<span style=color:#e06c75>buf</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>tmpBuf</span>, <span style=color:#e06c75>s</span> <span style=color:#e5c07b>string</span>) []<span style=color:#e5c07b>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>var</span> <span style=color:#e06c75>b</span> []<span style=color:#e5c07b>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>buf</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>s</span>) <span style=color:#56b6c2>&lt;=</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>buf</span>) {
</span></span><span style=display:flex><span>		<span style=color:#56b6c2>*</span><span style=color:#e06c75>buf</span> = <span style=color:#e06c75>tmpBuf</span>{}
</span></span><span style=display:flex><span>		<span style=color:#e06c75>b</span> = <span style=color:#e06c75>buf</span>[:<span style=color:#e5c07b>len</span>(<span style=color:#e06c75>s</span>)]
</span></span><span style=display:flex><span>	} <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#7f848e>// å¦‚æœæ²¡æœ‰ç¼“å†²åŒºæˆ–ç¼“å†²åŒºå¤§å°ä¸è¶³ï¼Œéœ€è¦ç”³è¯·å†…å­˜</span>
</span></span><span style=display:flex><span>		<span style=color:#e06c75>b</span> = <span style=color:#61afef;font-weight:700>rawbyteslice</span>(<span style=color:#e5c07b>len</span>(<span style=color:#e06c75>s</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// å¤åˆ¶æ•°æ®</span>
</span></span><span style=display:flex><span>	<span style=color:#e5c07b>copy</span>(<span style=color:#e06c75>b</span>, <span style=color:#e06c75>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e06c75>b</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>rawbyteslice</span>(<span style=color:#e06c75>size</span> <span style=color:#e5c07b>int</span>) (<span style=color:#e06c75>b</span> []<span style=color:#e5c07b>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// å®¹é‡è®¡ç®—ï¼Œè€ƒè™‘å†…å­˜å¯¹é½ï¼Œå¯»æ‰¾å¤§å°æœ€åŒ¹é…çš„å†…å­˜å—</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>cap</span> <span style=color:#56b6c2>:=</span> <span style=color:#61afef;font-weight:700>roundupsize</span>(<span style=color:#e5c07b>uintptr</span>(<span style=color:#e06c75>size</span>))
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// ä½¿ç”¨mallocgcç”³è¯·å¯¹åº”å¤§å°çš„å†…å­˜</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>p</span> <span style=color:#56b6c2>:=</span> <span style=color:#61afef;font-weight:700>mallocgc</span>(<span style=color:#e06c75>cap</span>, <span style=color:#e5c07b>nil</span>, <span style=color:#e5c07b>false</span>)
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// å¦‚æœè¦ç”³è¯·çš„sizeå’Œæœ€ç»ˆè®¡ç®—å¾—åˆ°çš„capå¤§å°ä¸ä¸€è‡´ï¼Œcapåªä¼šæ¯”sizeæ›´å¤§ï¼Œæ¸…ç†æ‰å¤šä½™çš„å†…å­˜</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>cap</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>uintptr</span>(<span style=color:#e06c75>size</span>) {
</span></span><span style=display:flex><span>		<span style=color:#61afef;font-weight:700>memclrNoHeapPointers</span>(<span style=color:#61afef;font-weight:700>add</span>(<span style=color:#e06c75>p</span>, <span style=color:#e5c07b>uintptr</span>(<span style=color:#e06c75>size</span>)), <span style=color:#e06c75>cap</span><span style=color:#56b6c2>-</span><span style=color:#e5c07b>uintptr</span>(<span style=color:#e06c75>size</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#7f848e>// å°†bæŒ‡å‘è¿™ç‰‡ç”³è¯·å¥½çš„å†…å­˜ã€‚è¯¥sliceä¸ä¸ºç©ºï¼Œæ•…å¤–éƒ¨ä½¿ç”¨copyè¿›è¡Œè¦†ç›–è€Œä¸æ˜¯append</span>
</span></span><span style=display:flex><span>	<span style=color:#56b6c2>*</span>(<span style=color:#56b6c2>*</span><span style=color:#e06c75>slice</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>b</span>)) = <span style=color:#e06c75>slice</span>{<span style=color:#e06c75>p</span>, <span style=color:#e06c75>size</span>, <span style=color:#e5c07b>int</span>(<span style=color:#e06c75>cap</span>)}
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å½“éœ€è¦è½¬æ¢çš„å­—ç¬¦ä¸²é•¿åº¦å°äº32æ—¶ï¼Œåªä¼šè¿›è¡Œå†…å­˜å¤åˆ¶ï¼Œè€Œå¤§äº32çš„è¯ï¼Œé™¤äº†å¤åˆ¶æ“ä½œï¼Œè¿˜éœ€è¦åˆ†é…å†…å­˜ã€‚</p><p>å†çœ‹çœ‹<code>slicebytetostring</code>å‡½æ•°ï¼Œ</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// ptræŒ‡å‘sliceçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œnæ˜¯sliceçš„é•¿åº¦</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>slicebytetostring</span>(<span style=color:#e06c75>buf</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>tmpBuf</span>, <span style=color:#e06c75>ptr</span> <span style=color:#56b6c2>*</span><span style=color:#e5c07b>byte</span>, <span style=color:#e06c75>n</span> <span style=color:#e5c07b>int</span>) (<span style=color:#e06c75>str</span> <span style=color:#e5c07b>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>n</span> <span style=color:#56b6c2>==</span> <span style=color:#d19a66>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#c678dd>return</span> <span style=color:#98c379>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>...</span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// å¦‚æœåªæœ‰å•ä¸ªbyteï¼Œè¿”å›å€¼å­—ç¬¦ä¸²ä¸­çš„æ•°æ®æŒ‡é’ˆstrç›´æ¥æŒ‡å‘é¢„åˆ†é…å¥½çš„ä¸€å—é™æ€å†…å­˜åŒº</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>n</span> <span style=color:#56b6c2>==</span> <span style=color:#d19a66>1</span> {
</span></span><span style=display:flex><span>        <span style=color:#7f848e>// staticuint64sæ˜¯ä¸€ä¸ªuint64æ•°ç»„ï¼Œé‡Œé¢ä¸€ä¸ªä¸ªå€¼éƒ½å¯¹åº”ç€å•ä¸ªbyteçš„int8å€¼ï¼Œæä¾›æ­¤ç§æƒ…å†µä¸‹çš„strä¸å¯ä¿®æ”¹çš„æŒ‡å‘</span>
</span></span><span style=display:flex><span>		<span style=color:#e06c75>p</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>staticuint64s</span>[<span style=color:#56b6c2>*</span><span style=color:#e06c75>ptr</span>])
</span></span><span style=display:flex><span>		<span style=color:#c678dd>if</span> <span style=color:#e06c75>goarch</span>.<span style=color:#e06c75>BigEndian</span> {
</span></span><span style=display:flex><span>			<span style=color:#e06c75>p</span> = <span style=color:#61afef;font-weight:700>add</span>(<span style=color:#e06c75>p</span>, <span style=color:#d19a66>7</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#7f848e>// å¡«å……è¿”å›æ•°æ®</span>
</span></span><span style=display:flex><span>		<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>str</span>).<span style=color:#e06c75>str</span> = <span style=color:#e06c75>p</span>
</span></span><span style=display:flex><span>		<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>str</span>).<span style=color:#e06c75>len</span> = <span style=color:#d19a66>1</span>
</span></span><span style=display:flex><span>		<span style=color:#c678dd>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#c678dd>var</span> <span style=color:#e06c75>p</span> <span style=color:#e06c75>unsafe</span>.<span style=color:#e06c75>Pointer</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>buf</span> <span style=color:#56b6c2>!=</span> <span style=color:#e5c07b>nil</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>n</span> <span style=color:#56b6c2>&lt;=</span> <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>buf</span>) {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>p</span> = <span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#e06c75>buf</span>)
</span></span><span style=display:flex><span>	} <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#7f848e>// ç¼“å†²åŒºä¸å­˜åœ¨æˆ–è€…ä¸å¤Ÿæ—¶ï¼Œåˆ†é…å†…å­˜</span>
</span></span><span style=display:flex><span>		<span style=color:#e06c75>p</span> = <span style=color:#61afef;font-weight:700>mallocgc</span>(<span style=color:#e5c07b>uintptr</span>(<span style=color:#e06c75>n</span>), <span style=color:#e5c07b>nil</span>, <span style=color:#e5c07b>false</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>str</span>).<span style=color:#e06c75>str</span> = <span style=color:#e06c75>p</span>
</span></span><span style=display:flex><span>	<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>str</span>).<span style=color:#e06c75>len</span> = <span style=color:#e06c75>n</span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// ä½¿ç”¨memmoveå¤åˆ¶æ•°æ®</span>
</span></span><span style=display:flex><span>	<span style=color:#61afef;font-weight:700>memmove</span>(<span style=color:#e06c75>p</span>, <span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#e06c75>ptr</span>), <span style=color:#e5c07b>uintptr</span>(<span style=color:#e06c75>n</span>))
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…³äº<code>staticuint64s</code>çš„ä¸€æ®µæµ‹è¯•ä»£ç :</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>package</span> <span style=color:#e06c75>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> <span style=color:#98c379>&#34;unsafe&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>var</span> <span style=color:#e06c75>staticuint64s</span> = [<span style=color:#56b6c2>...</span>]<span style=color:#e5c07b>uint64</span>{
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x00</span>, <span style=color:#d19a66>0x01</span>, <span style=color:#d19a66>0x02</span>, <span style=color:#d19a66>0x03</span>, <span style=color:#d19a66>0x04</span>, <span style=color:#d19a66>0x05</span>, <span style=color:#d19a66>0x06</span>, <span style=color:#d19a66>0x07</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x08</span>, <span style=color:#d19a66>0x09</span>, <span style=color:#d19a66>0x0a</span>, <span style=color:#d19a66>0x0b</span>, <span style=color:#d19a66>0x0c</span>, <span style=color:#d19a66>0x0d</span>, <span style=color:#d19a66>0x0e</span>, <span style=color:#d19a66>0x0f</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x10</span>, <span style=color:#d19a66>0x11</span>, <span style=color:#d19a66>0x12</span>, <span style=color:#d19a66>0x13</span>, <span style=color:#d19a66>0x14</span>, <span style=color:#d19a66>0x15</span>, <span style=color:#d19a66>0x16</span>, <span style=color:#d19a66>0x17</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x18</span>, <span style=color:#d19a66>0x19</span>, <span style=color:#d19a66>0x1a</span>, <span style=color:#d19a66>0x1b</span>, <span style=color:#d19a66>0x1c</span>, <span style=color:#d19a66>0x1d</span>, <span style=color:#d19a66>0x1e</span>, <span style=color:#d19a66>0x1f</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x20</span>, <span style=color:#d19a66>0x21</span>, <span style=color:#d19a66>0x22</span>, <span style=color:#d19a66>0x23</span>, <span style=color:#d19a66>0x24</span>, <span style=color:#d19a66>0x25</span>, <span style=color:#d19a66>0x26</span>, <span style=color:#d19a66>0x27</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x28</span>, <span style=color:#d19a66>0x29</span>, <span style=color:#d19a66>0x2a</span>, <span style=color:#d19a66>0x2b</span>, <span style=color:#d19a66>0x2c</span>, <span style=color:#d19a66>0x2d</span>, <span style=color:#d19a66>0x2e</span>, <span style=color:#d19a66>0x2f</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x30</span>, <span style=color:#d19a66>0x31</span>, <span style=color:#d19a66>0x32</span>, <span style=color:#d19a66>0x33</span>, <span style=color:#d19a66>0x34</span>, <span style=color:#d19a66>0x35</span>, <span style=color:#d19a66>0x36</span>, <span style=color:#d19a66>0x37</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x38</span>, <span style=color:#d19a66>0x39</span>, <span style=color:#d19a66>0x3a</span>, <span style=color:#d19a66>0x3b</span>, <span style=color:#d19a66>0x3c</span>, <span style=color:#d19a66>0x3d</span>, <span style=color:#d19a66>0x3e</span>, <span style=color:#d19a66>0x3f</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x40</span>, <span style=color:#d19a66>0x41</span>, <span style=color:#d19a66>0x42</span>, <span style=color:#d19a66>0x43</span>, <span style=color:#d19a66>0x44</span>, <span style=color:#d19a66>0x45</span>, <span style=color:#d19a66>0x46</span>, <span style=color:#d19a66>0x47</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x48</span>, <span style=color:#d19a66>0x49</span>, <span style=color:#d19a66>0x4a</span>, <span style=color:#d19a66>0x4b</span>, <span style=color:#d19a66>0x4c</span>, <span style=color:#d19a66>0x4d</span>, <span style=color:#d19a66>0x4e</span>, <span style=color:#d19a66>0x4f</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x50</span>, <span style=color:#d19a66>0x51</span>, <span style=color:#d19a66>0x52</span>, <span style=color:#d19a66>0x53</span>, <span style=color:#d19a66>0x54</span>, <span style=color:#d19a66>0x55</span>, <span style=color:#d19a66>0x56</span>, <span style=color:#d19a66>0x57</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x58</span>, <span style=color:#d19a66>0x59</span>, <span style=color:#d19a66>0x5a</span>, <span style=color:#d19a66>0x5b</span>, <span style=color:#d19a66>0x5c</span>, <span style=color:#d19a66>0x5d</span>, <span style=color:#d19a66>0x5e</span>, <span style=color:#d19a66>0x5f</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x60</span>, <span style=color:#d19a66>0x61</span>, <span style=color:#d19a66>0x62</span>, <span style=color:#d19a66>0x63</span>, <span style=color:#d19a66>0x64</span>, <span style=color:#d19a66>0x65</span>, <span style=color:#d19a66>0x66</span>, <span style=color:#d19a66>0x67</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x68</span>, <span style=color:#d19a66>0x69</span>, <span style=color:#d19a66>0x6a</span>, <span style=color:#d19a66>0x6b</span>, <span style=color:#d19a66>0x6c</span>, <span style=color:#d19a66>0x6d</span>, <span style=color:#d19a66>0x6e</span>, <span style=color:#d19a66>0x6f</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x70</span>, <span style=color:#d19a66>0x71</span>, <span style=color:#d19a66>0x72</span>, <span style=color:#d19a66>0x73</span>, <span style=color:#d19a66>0x74</span>, <span style=color:#d19a66>0x75</span>, <span style=color:#d19a66>0x76</span>, <span style=color:#d19a66>0x77</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x78</span>, <span style=color:#d19a66>0x79</span>, <span style=color:#d19a66>0x7a</span>, <span style=color:#d19a66>0x7b</span>, <span style=color:#d19a66>0x7c</span>, <span style=color:#d19a66>0x7d</span>, <span style=color:#d19a66>0x7e</span>, <span style=color:#d19a66>0x7f</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x80</span>, <span style=color:#d19a66>0x81</span>, <span style=color:#d19a66>0x82</span>, <span style=color:#d19a66>0x83</span>, <span style=color:#d19a66>0x84</span>, <span style=color:#d19a66>0x85</span>, <span style=color:#d19a66>0x86</span>, <span style=color:#d19a66>0x87</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x88</span>, <span style=color:#d19a66>0x89</span>, <span style=color:#d19a66>0x8a</span>, <span style=color:#d19a66>0x8b</span>, <span style=color:#d19a66>0x8c</span>, <span style=color:#d19a66>0x8d</span>, <span style=color:#d19a66>0x8e</span>, <span style=color:#d19a66>0x8f</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x90</span>, <span style=color:#d19a66>0x91</span>, <span style=color:#d19a66>0x92</span>, <span style=color:#d19a66>0x93</span>, <span style=color:#d19a66>0x94</span>, <span style=color:#d19a66>0x95</span>, <span style=color:#d19a66>0x96</span>, <span style=color:#d19a66>0x97</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0x98</span>, <span style=color:#d19a66>0x99</span>, <span style=color:#d19a66>0x9a</span>, <span style=color:#d19a66>0x9b</span>, <span style=color:#d19a66>0x9c</span>, <span style=color:#d19a66>0x9d</span>, <span style=color:#d19a66>0x9e</span>, <span style=color:#d19a66>0x9f</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xa0</span>, <span style=color:#d19a66>0xa1</span>, <span style=color:#d19a66>0xa2</span>, <span style=color:#d19a66>0xa3</span>, <span style=color:#d19a66>0xa4</span>, <span style=color:#d19a66>0xa5</span>, <span style=color:#d19a66>0xa6</span>, <span style=color:#d19a66>0xa7</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xa8</span>, <span style=color:#d19a66>0xa9</span>, <span style=color:#d19a66>0xaa</span>, <span style=color:#d19a66>0xab</span>, <span style=color:#d19a66>0xac</span>, <span style=color:#d19a66>0xad</span>, <span style=color:#d19a66>0xae</span>, <span style=color:#d19a66>0xaf</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xb0</span>, <span style=color:#d19a66>0xb1</span>, <span style=color:#d19a66>0xb2</span>, <span style=color:#d19a66>0xb3</span>, <span style=color:#d19a66>0xb4</span>, <span style=color:#d19a66>0xb5</span>, <span style=color:#d19a66>0xb6</span>, <span style=color:#d19a66>0xb7</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xb8</span>, <span style=color:#d19a66>0xb9</span>, <span style=color:#d19a66>0xba</span>, <span style=color:#d19a66>0xbb</span>, <span style=color:#d19a66>0xbc</span>, <span style=color:#d19a66>0xbd</span>, <span style=color:#d19a66>0xbe</span>, <span style=color:#d19a66>0xbf</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xc0</span>, <span style=color:#d19a66>0xc1</span>, <span style=color:#d19a66>0xc2</span>, <span style=color:#d19a66>0xc3</span>, <span style=color:#d19a66>0xc4</span>, <span style=color:#d19a66>0xc5</span>, <span style=color:#d19a66>0xc6</span>, <span style=color:#d19a66>0xc7</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xc8</span>, <span style=color:#d19a66>0xc9</span>, <span style=color:#d19a66>0xca</span>, <span style=color:#d19a66>0xcb</span>, <span style=color:#d19a66>0xcc</span>, <span style=color:#d19a66>0xcd</span>, <span style=color:#d19a66>0xce</span>, <span style=color:#d19a66>0xcf</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xd0</span>, <span style=color:#d19a66>0xd1</span>, <span style=color:#d19a66>0xd2</span>, <span style=color:#d19a66>0xd3</span>, <span style=color:#d19a66>0xd4</span>, <span style=color:#d19a66>0xd5</span>, <span style=color:#d19a66>0xd6</span>, <span style=color:#d19a66>0xd7</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xd8</span>, <span style=color:#d19a66>0xd9</span>, <span style=color:#d19a66>0xda</span>, <span style=color:#d19a66>0xdb</span>, <span style=color:#d19a66>0xdc</span>, <span style=color:#d19a66>0xdd</span>, <span style=color:#d19a66>0xde</span>, <span style=color:#d19a66>0xdf</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xe0</span>, <span style=color:#d19a66>0xe1</span>, <span style=color:#d19a66>0xe2</span>, <span style=color:#d19a66>0xe3</span>, <span style=color:#d19a66>0xe4</span>, <span style=color:#d19a66>0xe5</span>, <span style=color:#d19a66>0xe6</span>, <span style=color:#d19a66>0xe7</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xe8</span>, <span style=color:#d19a66>0xe9</span>, <span style=color:#d19a66>0xea</span>, <span style=color:#d19a66>0xeb</span>, <span style=color:#d19a66>0xec</span>, <span style=color:#d19a66>0xed</span>, <span style=color:#d19a66>0xee</span>, <span style=color:#d19a66>0xef</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xf0</span>, <span style=color:#d19a66>0xf1</span>, <span style=color:#d19a66>0xf2</span>, <span style=color:#d19a66>0xf3</span>, <span style=color:#d19a66>0xf4</span>, <span style=color:#d19a66>0xf5</span>, <span style=color:#d19a66>0xf6</span>, <span style=color:#d19a66>0xf7</span>,
</span></span><span style=display:flex><span>	<span style=color:#d19a66>0xf8</span>, <span style=color:#d19a66>0xf9</span>, <span style=color:#d19a66>0xfa</span>, <span style=color:#d19a66>0xfb</span>, <span style=color:#d19a66>0xfc</span>, <span style=color:#d19a66>0xfd</span>, <span style=color:#d19a66>0xfe</span>, <span style=color:#d19a66>0xff</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>type</span> <span style=color:#e06c75>stringStruct</span> <span style=color:#c678dd>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>str</span> <span style=color:#e06c75>unsafe</span>.<span style=color:#e06c75>Pointer</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>len</span> <span style=color:#e5c07b>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#e06c75>sp</span> <span style=color:#56b6c2>*</span><span style=color:#e5c07b>string</span>) <span style=color:#56b6c2>*</span><span style=color:#e06c75>stringStruct</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> (<span style=color:#56b6c2>*</span><span style=color:#e06c75>stringStruct</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#e06c75>sp</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>var</span> <span style=color:#e06c75>s</span> <span style=color:#e5c07b>string</span>
</span></span><span style=display:flex><span>	<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>s</span>).<span style=color:#e06c75>str</span> = <span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>staticuint64s</span>[<span style=color:#d19a66>80</span>])
</span></span><span style=display:flex><span>	<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>s</span>).<span style=color:#e06c75>len</span> = <span style=color:#d19a66>1</span>
</span></span><span style=display:flex><span>	<span style=color:#e5c07b>println</span>(<span style=color:#e06c75>s</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä½¿ç”¨æ ‡å‡†è½¬æ¢æ˜¯æœ€ç®€å•ä¹Ÿæ˜¯æœ€å®‰å…¨çš„ï¼Œä½†ä»ä¸Šé¢çš„æºç å¯ä»¥çœ‹åˆ°ï¼Œ<code>string</code>å’Œ<code>[]byte</code>çš„ä¸¤ä¸ªç›¸äº’è½¬æ¢ï¼Œéƒ½å¯èƒ½å‡ºç°æ–°çš„å†…å­˜åˆ†é…ï¼Œå¹¶ä¸”ä¸€å®šè¦è¿›è¡Œå†…å­˜çš„å¤åˆ¶ã€‚è¿™æ ·çš„è½¬æ¢åœ¨æ€§èƒ½æ•æ„Ÿçš„åœºæ™¯ä¸‹æ— æ³•æ»¡è¶³è¦æ±‚ï¼Œè¿˜å¥½æˆ‘ä»¬è¿˜æœ‰å…¶ä»–çš„è½¬æ¢é»‘é­”æ³•ğŸ˜ˆã€‚</p><h2 id=é›¶æ‹·è´è½¬æ¢>é›¶æ‹·è´è½¬æ¢<a hidden class=anchor aria-hidden=true href=#é›¶æ‹·è´è½¬æ¢>#</a></h2><h3 id=ç¼–è¯‘å™¨è½¬æ¢>ç¼–è¯‘å™¨è½¬æ¢<a hidden class=anchor aria-hidden=true href=#ç¼–è¯‘å™¨è½¬æ¢>#</a></h3><p>å…¶å®åœ¨ä¸Šæ–‡æåˆ°çš„ä¸¤ä¸ªå‡½æ•°æ—è¾¹ï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°â€”â€”<code>slicebytetostringtmp(src/runtime/string.go:154)</code></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// slicebytetostringtmp returns a &#34;string&#34; referring to the actual []byte bytes.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Callers need to ensure that the returned string will not be used after</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// the calling goroutine modifies the original slice or synchronizes with</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// another goroutine.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// The function is only called when instrumenting</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// and otherwise intrinsified by the compiler.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Some internal compiler optimizations use this function.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// - Used for m[T1{... Tn{..., string(k), ...} ...}] and m[string(k)]</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//   where k is []byte, T1 to Tn is a nesting of struct and array literals.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// - Used for &#34;&lt;&#34;+string(b)+&#34;&gt;&#34; concatenation where b is []byte.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// - Used for string(b)==&#34;foo&#34; comparison where b is []byte.</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>slicebytetostringtmp</span>(<span style=color:#e06c75>ptr</span> <span style=color:#56b6c2>*</span><span style=color:#e5c07b>byte</span>, <span style=color:#e06c75>n</span> <span style=color:#e5c07b>int</span>) (<span style=color:#e06c75>str</span> <span style=color:#e5c07b>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>raceenabled</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>n</span> &gt; <span style=color:#d19a66>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#61afef;font-weight:700>racereadrangepc</span>(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#e06c75>ptr</span>),
</span></span><span style=display:flex><span>			<span style=color:#e5c07b>uintptr</span>(<span style=color:#e06c75>n</span>),
</span></span><span style=display:flex><span>			<span style=color:#61afef;font-weight:700>getcallerpc</span>(),
</span></span><span style=display:flex><span>			<span style=color:#e06c75>abi</span>.<span style=color:#61afef;font-weight:700>FuncPCABIInternal</span>(<span style=color:#e06c75>slicebytetostringtmp</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>msanenabled</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>n</span> &gt; <span style=color:#d19a66>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#61afef;font-weight:700>msanread</span>(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#e06c75>ptr</span>), <span style=color:#e5c07b>uintptr</span>(<span style=color:#e06c75>n</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#c678dd>if</span> <span style=color:#e06c75>asanenabled</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>n</span> &gt; <span style=color:#d19a66>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#61afef;font-weight:700>asanread</span>(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#e06c75>ptr</span>), <span style=color:#e5c07b>uintptr</span>(<span style=color:#e06c75>n</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>str</span>).<span style=color:#e06c75>str</span> = <span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#e06c75>ptr</span>)
</span></span><span style=display:flex><span>	<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>str</span>).<span style=color:#e06c75>len</span> = <span style=color:#e06c75>n</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æŠ›å¼€æ— éœ€å…³å¿ƒçš„ä»£ç ï¼Œæ ¸å¿ƒä»£ç åªæœ‰ä¸¤å¥:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>str</span>).<span style=color:#e06c75>str</span> = <span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#e06c75>ptr</span>)
</span></span><span style=display:flex><span>	<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>str</span>).<span style=color:#e06c75>len</span> = <span style=color:#e06c75>n</span>
</span></span></code></pre></div><p>è¿”å›å­—ç¬¦ä¸²çš„æ•°æ®æŒ‡é’ˆstrç›´æ¥æŒ‡å‘äº†<code>[]byte</code>çš„é¦–åœ°å€ï¼Œè€Œé•¿åº¦ç›´æ¥å–<code>[]byte</code>é•¿åº¦ã€‚èƒ½å¤Ÿå¦‚æ­¤è½¬æ¢çš„æ ¹æœ¬åŸå› æ˜¯stringçš„åº•å±‚ç±»å‹å’Œsliceçš„åº•å±‚ç±»å‹å†…å­˜åˆ†å¸ƒç›¸ä¼¼ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡ä¿®æ”¹æŒ‡é’ˆçš„æ–¹å¼è¿›è¡Œè½¬æ¢ã€‚</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// src/runtime/string.go:238</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>type</span> <span style=color:#e06c75>stringStruct</span> <span style=color:#c678dd>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#e06c75>str</span> <span style=color:#e06c75>unsafe</span>.<span style=color:#e06c75>Pointer</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>len</span> <span style=color:#e5c07b>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// src/runtime/slice.go:15</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>type</span> <span style=color:#e06c75>slice</span> <span style=color:#c678dd>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>array</span> <span style=color:#e06c75>unsafe</span>.<span style=color:#e06c75>Pointer</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>len</span>   <span style=color:#e5c07b>int</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>cap</span>   <span style=color:#e5c07b>int</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¯è§ï¼Œä¸¤ä¸ªç»“æ„ä½“çš„å‰ä¸¤ä¸ªå­—æ®µå†…å­˜åˆ†å¸ƒæ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œå¹¶ä¸”<code>string</code>çš„åº•å±‚æ•°æ®ç±»å‹å’Œ<code>[]byte</code>ä¸€è‡´ï¼Œæ‰€ä»¥<code>unsafe.Pointer</code>å¯¹åº”çš„å®é™…æŒ‡é’ˆéƒ½æ˜¯<code>*byte</code>ã€‚è¿™æ ·çš„è½¬æ¢å®é™…ä¸Šå°±æ˜¯æŒ‡é’ˆçš„è½¬æ¢ï¼Œä¸éœ€è¦è¿›è¡Œå†…å­˜çš„åˆ†é…å’Œå¤åˆ¶ï¼Œæ‰€ä»¥æ•ˆç‡éå¸¸é«˜ã€‚</p><style type=text/css media=screen>html{--color-alert-info-text:#24292e;--color-alert-info-bg:#dbedff;--color-alert-info-border:rgba(4, 66, 137, 0.2);--color-alert-warn-text:#24292e;--color-alert-warn-bg:#fffbdd;--color-alert-warn-border:rgba(176, 136, 0, 0.2);--color-alert-error-text:#24292e;--color-alert-error-bg:#ffe3e6;--color-alert-error-border:rgba(158, 28, 35, 0.2);--color-alert-success-text:#24292e;--color-alert-success-bg:#dcffe4;--color-alert-success-border:rgba(23, 111, 44, 0.2)}html[data-theme=dark]{--color-alert-info-text:#79c0ff;--color-alert-info-bg:rgba(56, 139, 253, 0.1);--color-alert-info-border:rgba(56, 139, 253, 0.4);--color-alert-warn-text:#e3b341;--color-alert-warn-bg:rgba(187, 128, 9, 0.1);--color-alert-warn-border:rgba(187, 128, 9, 0.4);--color-alert-error-text:#ff7b72;--color-alert-error-bg:rgba(248, 81, 73, 0.1);--color-alert-error-border:rgba(248, 81, 73, 0.4);--color-alert-success-text:#56d364;--color-alert-success-bg:rgba(46, 160, 67, 0.1);--color-alert-success-border:rgba(46, 160, 67, 0.4)}.tips{position:relative;padding:20px 16px;margin-bottom:20px;border-style:solid;border-width:1px;border-radius:6px;border-left-style:solid;border-left-width:6px}.tips.info{color:var(--color-alert-info-text);background-image:linear-gradient(var(--color-alert-info-bg),var(--color-alert-info-bg));border-color:var(--color-alert-info-border)}.tips.warn{color:var(--color-alert-warn-text);background-image:linear-gradient(var(--color-alert-warn-bg),var(--color-alert-warn-bg));border-color:var(--color-alert-warn-border)}.tips.error{color:var(--color-alert-error-text);background-image:linear-gradient(var(--color-alert-error-bg),var(--color-alert-error-bg));border-color:var(--color-alert-error-border)}.tips.success{color:var(--color-alert-success-text);background-image:linear-gradient(var(--color-alert-success-bg),var(--color-alert-success-bg));border-color:var(--color-alert-success-border)}#tips-title{font-size:19px;font-weight:800;margin-bottom:10px}</style><div class="tips warn"><p>ä½†æ˜¯ä½¿ç”¨è¿™æ ·çš„ä»£ç æ˜¯æœ‰é£é™©çš„ï¼Œä¸Šæ–‡ä¸­çš„ä»£ç æˆ‘ç‰¹æ„æŠŠæ³¨é‡Šä¹Ÿè´´å‡ºæ¥äº†ï¼Œæ³¨é‡Šé‡Œç¬¬äºŒæ®µæ˜ç¡®å†™åˆ°ï¼Œè°ƒç”¨è€…éœ€è¦ä¿è¯ï¼Œåœ¨ä¿®æ”¹æˆ–ä¸å…¶ä»–gåŒæ­¥äº†<code>åŸ[]byte</code>åï¼Œè¿”å›çš„<code>string</code>ä¸ä¼šå†è¢«ä½¿ç”¨ã€‚è¿™æ˜¯å› ä¸ºä½ <strong>å¼ºè¡Œåˆ›é€ </strong>çš„è¿™ä¸ª<code>string</code>æ‰€å¯¹åº”çš„åº•å±‚æ•°æ®å¹¶ä¸å®‰å…¨ï¼Œåˆ›é€ å‡ºè¯¥stringåï¼Œä½ å¯ä»¥ç›´æ¥å¯¹<code>åŸ[]byte</code>è¿›è¡Œä¿®æ”¹ï¼Œè¿™è¿èƒŒäº†goè¯­è¨€å­—ç¬¦ä¸²ä¸å¯ä¿®æ”¹çš„åŸåˆ™ï¼Œå°†ä¼šäº§ç”Ÿæ— æ³•æ•è·çš„é”™è¯¯ã€‚</p><p>æ‰€ä»¥è¿™ä¸ªæ–¹æ³•goæ²¡æœ‰æš´éœ²ç»™å¼€å‘è€…ï¼Œä»…åœ¨æºç å†…éƒ¨å¯ä½¿ç”¨ï¼Œä¾›ç¼–è¯‘å™¨åœ¨æŸäº›é€‚ç”¨åœºæ™¯ä¼˜åŒ–æ€§èƒ½ã€‚</p></div><p>ä»¥ä¸Šä¸¤ç§è½¬æ¢çš„æ€§èƒ½å¯¹æ¯”:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>package</span> <span style=color:#e06c75>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#98c379>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>const</span> <span style=color:#e06c75>LEN</span> = <span style=color:#d19a66>33</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>getBytes</span>() []<span style=color:#e5c07b>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>var</span> <span style=color:#e06c75>b</span> []<span style=color:#e5c07b>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>:=</span> <span style=color:#d19a66>0</span>; <span style=color:#e06c75>i</span> &lt; <span style=color:#e06c75>LEN</span>; <span style=color:#e06c75>i</span><span style=color:#56b6c2>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>b</span> = <span style=color:#e5c07b>append</span>(<span style=color:#e06c75>b</span>, <span style=color:#98c379>&#39; &#39;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e06c75>b</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>BenchmarkByte2StringOrigin</span>(<span style=color:#e06c75>b</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>testing</span>.<span style=color:#e06c75>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bytes</span> <span style=color:#56b6c2>:=</span> <span style=color:#61afef;font-weight:700>getBytes</span>()
</span></span><span style=display:flex><span>	<span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>:=</span> <span style=color:#d19a66>0</span>; <span style=color:#e06c75>i</span> &lt; <span style=color:#e06c75>b</span>.<span style=color:#e06c75>N</span>; <span style=color:#e06c75>i</span><span style=color:#56b6c2>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>s</span> <span style=color:#56b6c2>:=</span> <span style=color:#e5c07b>string</span>(<span style=color:#e06c75>bytes</span>)
</span></span><span style=display:flex><span>		<span style=color:#e06c75>_</span> = <span style=color:#e06c75>s</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>BenchmarkByte2StringTmp</span>(<span style=color:#e06c75>b</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>testing</span>.<span style=color:#e06c75>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bytes</span> <span style=color:#56b6c2>:=</span> <span style=color:#61afef;font-weight:700>getBytes</span>()
</span></span><span style=display:flex><span>	<span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>:=</span> <span style=color:#d19a66>0</span>; <span style=color:#e06c75>i</span> &lt; <span style=color:#e06c75>b</span>.<span style=color:#e06c75>N</span>; <span style=color:#e06c75>i</span><span style=color:#56b6c2>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>s</span> <span style=color:#56b6c2>:=</span> <span style=color:#61afef;font-weight:700>slicebytetostringtmp</span>(<span style=color:#e06c75>bytes</span>)
</span></span><span style=display:flex><span>		<span style=color:#e06c75>_</span> = <span style=color:#e06c75>s</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// ä¾èµ–ä»£ç </span>
</span></span><span style=display:flex><span><span style=color:#c678dd>type</span> <span style=color:#e06c75>stringStruct</span> <span style=color:#c678dd>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>str</span> <span style=color:#e06c75>unsafe</span>.<span style=color:#e06c75>Pointer</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>len</span> <span style=color:#e5c07b>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#e06c75>sp</span> <span style=color:#56b6c2>*</span><span style=color:#e5c07b>string</span>) <span style=color:#56b6c2>*</span><span style=color:#e06c75>stringStruct</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> (<span style=color:#56b6c2>*</span><span style=color:#e06c75>stringStruct</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#e06c75>sp</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>slicebytetostringtmp</span>(<span style=color:#e06c75>b</span> []<span style=color:#e5c07b>byte</span>) (<span style=color:#e06c75>str</span> <span style=color:#e5c07b>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>str</span>).<span style=color:#e06c75>str</span> = <span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>b</span>[<span style=color:#d19a66>0</span>])
</span></span><span style=display:flex><span>	<span style=color:#61afef;font-weight:700>stringStructOf</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>str</span>).<span style=color:#e06c75>len</span> = <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>b</span>)
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202302011436253.png alt=é•¿åº¦ä¸º5çš„[]byte></p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202302011437519.png alt=é•¿åº¦32çš„[]byte></p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202302011438301.png alt=é•¿åº¦ä¸º33çš„[]byte></p><p>å’Œä¹‹å‰æºç çœ‹åˆ°çš„ä¸€è‡´ï¼Œå¯¹äºæ ‡å‡†è½¬æ¢ï¼Œé•¿åº¦32æ˜¯ä¸€ä¸ªåˆ†æ°´å²­ï¼Œé•¿åº¦å¤§äº32æ—¶ï¼Œå°±ä¼šå‡ºç°å†…å­˜åˆ†é…ï¼ŒåŒæ—¶æ“ä½œè€—æ—¶ä¹Ÿæ˜¾è‘—å¢åŠ ã€‚å¹¶ä¸”éšç€<code>slice</code>é•¿åº¦çš„å¢åŠ ï¼Œå’ŒæŒ‡é’ˆè½¬æ¢çš„æ€§èƒ½å·®è·ä¼šè¶Šæ¥è¶Šå¤§ã€‚</p><h2 id=è‡ªå·±å®ç°unsafepointer>è‡ªå·±å®ç°â€”â€”unsafe.Pointer<a hidden class=anchor aria-hidden=true href=#è‡ªå·±å®ç°unsafepointer>#</a></h2><p>è™½ç„¶<code>slicebytetostringtmp</code>æˆ‘ä»¬æ— æ³•ä½¿ç”¨ï¼Œä½†æ˜¯é€šè¿‡ä½¿ç”¨<code>unsafe</code>åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªè¡Œæ„é€ ç±»ä¼¼çš„æŒ‡é’ˆè½¬æ¢ã€‚</p><p>å…ˆæ¥ä¸€ä¸ªæœ€ç®€å•çš„ç‰ˆæœ¬:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>String2bytesEasy</span>(<span style=color:#e06c75>s</span> <span style=color:#e5c07b>string</span>) []<span style=color:#e5c07b>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#56b6c2>*</span>(<span style=color:#56b6c2>*</span>[]<span style=color:#e5c07b>byte</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>s</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>Bytes2StringEasy</span>(<span style=color:#e06c75>b</span> []<span style=color:#e5c07b>byte</span>) <span style=color:#e5c07b>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#56b6c2>*</span>(<span style=color:#56b6c2>*</span><span style=color:#e5c07b>string</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>b</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç›´æ¥ä½¿ç”¨<code>unsafe.Pointer</code>ä½œä¸ºä¸­é—´ç±»å‹è¿›è¡Œå¼ºè½¬ï¼Œéå¸¸å¿«é€Ÿï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œ<code>String2bytesEasy</code>å‡½æ•°ä¸­ï¼Œè¿”å›çš„<code>slice</code>ä¸­<code>cap</code>å­—æ®µæ˜¯æ²¡æœ‰èµ‹å€¼çš„ï¼Œå› ä¸º<code>string</code>ç±»å‹åªæœ‰ä¸¤ä¸ªå­—æ®µï¼Œè€Œ<code>slice</code>æœ‰ä¸‰ä¸ªï¼Œæœªèµ‹å€¼çš„<code>cap</code>å­—æ®µçš„å€¼æ˜¯éšæœºçš„ï¼Œå–å†³äºé‚£ä¸€å—å†…å­˜çš„å€¼ã€‚</p><p>ä¼˜åŒ–ç‰ˆæœ¬:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// src/reflect/value.go:2670</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>type</span> <span style=color:#e06c75>StringHeader</span> <span style=color:#c678dd>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>Data</span> <span style=color:#e5c07b>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>Len</span>  <span style=color:#e5c07b>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// src/reflect/value.go:2681</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>type</span> <span style=color:#e06c75>SliceHeader</span> <span style=color:#c678dd>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>Data</span> <span style=color:#e5c07b>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>Len</span>  <span style=color:#e5c07b>int</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>Cap</span>  <span style=color:#e5c07b>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>String2bytes</span>(<span style=color:#e06c75>s</span> <span style=color:#e5c07b>string</span>) []<span style=color:#e5c07b>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>stringHeader</span> <span style=color:#56b6c2>:=</span> (<span style=color:#56b6c2>*</span><span style=color:#e06c75>reflect</span>.<span style=color:#e06c75>StringHeader</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>s</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bh</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>reflect</span>.<span style=color:#e06c75>SliceHeader</span>{
</span></span><span style=display:flex><span>		<span style=color:#e06c75>Data</span>: <span style=color:#e06c75>stringHeader</span>.<span style=color:#e06c75>Data</span>,
</span></span><span style=display:flex><span>		<span style=color:#e06c75>Len</span>:  <span style=color:#e06c75>stringHeader</span>.<span style=color:#e06c75>Len</span>,
</span></span><span style=display:flex><span>		<span style=color:#e06c75>Cap</span>:  <span style=color:#e06c75>stringHeader</span>.<span style=color:#e06c75>Len</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#56b6c2>*</span>(<span style=color:#56b6c2>*</span>[]<span style=color:#e5c07b>byte</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>bh</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™ä¸ªç‰ˆæœ¬ç”¨åˆ°äº†<code>reflect</code>åŒ…ä¸­çš„ä¸¤ä¸ªç±»å‹<code>StringHeader</code>å’Œ<code>SliceHeader</code>ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯<code>string</code>å’Œ<code>slice</code>çš„<code>runtime</code>å±‚å½¢æ€ã€‚é€šè¿‡è¿™æ ·çš„è½¬æ¢åï¼Œæˆ‘ä»¬å¾—ä»¥ç›´æ¥æ“ä½œå®ƒä»¬çš„å­—æ®µã€‚</p><p>é€šè¿‡å…¨éƒ¨çš„ä¸‰ä¸ªå­—æ®µèµ‹å€¼ï¼Œæœ€ç»ˆå¾—åˆ°çš„æ˜¯ä¸€ä¸ªå®Œæ•´çš„<code>slice</code>ã€‚</p><div class="tips warn">ä½†æ˜¯è¿™é‡Œçš„ä»£ç è¿˜éšè—äº†ä¸€ä¸ªæ·±å±‚æ¬¡çš„é—®é¢˜</div><p>ç»§ç»­æ·±æŒ–ï¼Œè¿™é‡Œçš„å…³é”®æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ä¸­é—´å˜é‡<code>bh</code>ï¼Œç‰¹æ®Šç‚¹åœ¨äºå®ƒçš„ç±»å‹<code>reflect.SliceHeader</code>ã€‚å¦‚æœä½ æ‰“å¼€è¿‡æºç çš„<code>unsafe</code>åŒ…ï¼Œåœ¨<code>Point</code>ç±»å‹çš„å¼€å¤´æœ‰ä¸€å¤§å †æ³¨é‡Š(ä»¥ä¸‹ä»…éƒ¨åˆ†):</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// (6) Conversion of a reflect.SliceHeader or reflect.StringHeader Data field to or from Pointer.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// As in the previous case, the reflect data structures SliceHeader and StringHeader</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// declare the field Data as a uintptr to keep callers from changing the result to</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// an arbitrary type without first importing &#34;unsafe&#34;. However, this means that</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// SliceHeader and StringHeader are only valid when interpreting the content</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// of an actual slice or string value.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//	var s string</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//	hdr := (*reflect.StringHeader)(unsafe.Pointer(&amp;s)) // case 1</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//	hdr.Data = uintptr(unsafe.Pointer(p))              // case 6 (this case)</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//	hdr.Len = n</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// In this usage hdr.Data is really an alternate way to refer to the underlying</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// pointer in the string header, not a uintptr variable itself.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// In general, reflect.SliceHeader and reflect.StringHeader should be used</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// only as *reflect.SliceHeader and *reflect.StringHeader pointing at actual</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// slices or strings, never as plain structs.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// A program should not declare or allocate variables of these struct types.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//	// INVALID: a directly-declared header will not hold Data as a reference.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//	var hdr reflect.StringHeader</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//	hdr.Data = uintptr(unsafe.Pointer(p))</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//	hdr.Len = n</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//	s := *(*string)(unsafe.Pointer(&amp;hdr)) // p possibly already lost</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span></code></pre></div><p>é‡ç‚¹å°±æ˜¯è¿™ä¸€å¥â€”â€”INVALID: a directly-declared header will not hold Data as a reference.</p><p>ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼Œä¸€ä¸ªç›´æ¥å£°æ˜çš„headerä¸ä¼šå°†Dataä½œä¸ºå¼•ç”¨ã€‚</p><p>è§£é‡Šä¸€ä¸‹ï¼ŒHeaderçš„Dataå­—æ®µç±»å‹æ˜¯<code>uintptr</code>è€Œä¸æ˜¯<code>unsafe.Pointer</code>ï¼Œè¿™ä¸¤ä¸ªç±»å‹çš„å…¶ä¸­ä¸€ä¸ªå·®åˆ«å°±æ˜¯ï¼Œgoçš„gcä¸ä¼šè®°å½•<code>uintptr</code>çš„å¼•ç”¨ï¼Œè¿™ä¸€ç‚¹åœ¨<code>SliceHeader</code>å’Œ<code>StringHeader</code>çš„å®šä¹‰å¤„ä¹Ÿæœ‰æ³¨é‡Šè¿›è¡Œäº†è¯´æ˜ï¼Œå®ƒä»¬ä¿©çš„å®šä¹‰ä¸Šæ–¹éƒ½æœ‰è¿™ä¹ˆä¸€æ®µ:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// Moreover, the Data field is not sufficient to guarantee the data</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// it references will not be garbage collected, so programs must keep</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// a separate, correctly typed pointer to the underlying data.</span>
</span></span></code></pre></div><p>è¿™æ„å‘³ç€gcåœ¨æ¸…ç†å†…å­˜æ—¶å¹¶ä¸çŸ¥é“è¿˜å­˜åœ¨ä¸€ä¸ªHeaderçš„Dataå­—æ®µæŒ‡å‘äº†è¿™å—å†…å­˜ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´åœ¨è½¬æ¢çš„è¿‡ç¨‹ä¸­ï¼Œåº•å±‚æ•°æ®å·²ç»è¢«gcç»™æ¸…ç†ã€‚</p><p>å¯¹åº”ä¸Šé¢çš„ä¾‹å­ä¸­:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>String2bytes</span>(<span style=color:#e06c75>s</span> <span style=color:#e5c07b>string</span>) []<span style=color:#e5c07b>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>stringHeader</span> <span style=color:#56b6c2>:=</span> (<span style=color:#56b6c2>*</span><span style=color:#e06c75>reflect</span>.<span style=color:#e06c75>StringHeader</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>s</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bh</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>reflect</span>.<span style=color:#e06c75>SliceHeader</span>{
</span></span><span style=display:flex><span>		<span style=color:#e06c75>Data</span>: <span style=color:#e06c75>stringHeader</span>.<span style=color:#e06c75>Data</span>,
</span></span><span style=display:flex><span>		<span style=color:#e06c75>Len</span>:  <span style=color:#e06c75>stringHeader</span>.<span style=color:#e06c75>Len</span>,
</span></span><span style=display:flex><span>		<span style=color:#e06c75>Cap</span>:  <span style=color:#e06c75>stringHeader</span>.<span style=color:#e06c75>Len</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#7f848e>// åœ¨æ‰§è¡Œè¿™ä¸€æ­¥ä¹‹å‰ï¼ŒstringHeaderå·²ç»æ²¡æœ‰äº†ç”¨å¤„ï¼Œè€Œbhæ²¡æœ‰äº§ç”Ÿå¼•ç”¨ï¼Œæ­¤æ—¶gcè®¤ä¸ºæ˜¯å¯ä»¥è¿›è¡Œå›æ”¶çš„</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#56b6c2>*</span>(<span style=color:#56b6c2>*</span>[]<span style=color:#e5c07b>byte</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>bh</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é¿å…è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œé¿å¼€<code>directly-declared</code>å°±å¯ä»¥äº†ï¼Œæ³¨é‡Šä¸­ä¹Ÿç»™äº†ä¸€ä¸ªæ­£ç¡®ä¾‹å­:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>var</span> <span style=color:#e06c75>s</span> <span style=color:#e5c07b>string</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>hdr</span> <span style=color:#56b6c2>:=</span> (<span style=color:#56b6c2>*</span><span style=color:#e06c75>reflect</span>.<span style=color:#e06c75>StringHeader</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>s</span>)) <span style=color:#7f848e>// case 1</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>hdr</span>.<span style=color:#e06c75>Data</span> = <span style=color:#e5c07b>uintptr</span>(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#e06c75>p</span>))              <span style=color:#7f848e>// case 6 (this case)</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>hdr</span>.<span style=color:#e06c75>Len</span> = <span style=color:#e06c75>n</span>
</span></span></code></pre></div><p>è¿™é‡Œå…ˆåˆ›å»ºäº†ä¸´æ—¶å˜é‡sï¼Œå†åŸºäºsè¿›è¡Œè½¬æ¢å¾—åˆ°çš„headeræŒ‡é’ˆï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸å­˜åœ¨ä¸€ä¸ª<strong>å®é™…çš„header</strong>ï¼Œå¯¹hdrçš„èµ‹å€¼æ“ä½œå…¶å®æ˜¯åœ¨ç›´æ¥æ“ä½œå­—ç¬¦ä¸²sï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰äº†gcè¿½è¸ªä¸åˆ°çš„é—®é¢˜äº†ã€‚</p><p>è´´ä¸€ä¸ªä¼˜åŒ–ä»£ç ç¤ºä¾‹:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>b2s</span>(<span style=color:#e06c75>b</span> []<span style=color:#e5c07b>byte</span>) <span style=color:#e5c07b>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#56b6c2>*</span>(<span style=color:#56b6c2>*</span><span style=color:#e5c07b>string</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>b</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>S2b</span>(<span style=color:#e06c75>s</span> <span style=color:#e5c07b>string</span>) (<span style=color:#e06c75>b</span> []<span style=color:#e5c07b>byte</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bh</span> <span style=color:#56b6c2>:=</span> (<span style=color:#56b6c2>*</span><span style=color:#e06c75>reflect</span>.<span style=color:#e06c75>SliceHeader</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>b</span>))
</span></span><span style=display:flex><span>	<span style=color:#e06c75>sh</span> <span style=color:#56b6c2>:=</span> (<span style=color:#56b6c2>*</span><span style=color:#e06c75>reflect</span>.<span style=color:#e06c75>StringHeader</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>s</span>))
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bh</span>.<span style=color:#e06c75>Data</span> = <span style=color:#e06c75>sh</span>.<span style=color:#e06c75>Data</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bh</span>.<span style=color:#e06c75>Len</span> = <span style=color:#e06c75>sh</span>.<span style=color:#e06c75>Len</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bh</span>.<span style=color:#e06c75>Cap</span> = <span style=color:#e06c75>sh</span>.<span style=color:#e06c75>Len</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e06c75>b</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=è¡¥å……>è¡¥å……<a hidden class=anchor aria-hidden=true href=#è¡¥å……>#</a></h3><p>å…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘è¿˜æ‰¾åˆ°ä¸€ä¸ªgoæºç åº“çš„issueï¼š<a href=https://github.com/golang/go/issues/25484>Feature: provide no-copy conversion from []byte to string</a>ï¼Œè™½ç„¶issueçš„å‘èµ·è€…æ˜¯æƒ³é—®ä¸ºä»€ä¹ˆæ²¡æœ‰å®˜æ–¹æä¾›çš„è½¬æ¢å‡½æ•°ï¼Œä½†æ˜¯ä»–æä¾›çš„ä»£ç æœ‰ç€å’Œæˆ‘æ‰€ç»™çš„åä¾‹ä»£ç ä¸€æ ·çš„é—®é¢˜ï¼Œå¹¶ä¸”è¢«å…¶ä»–ç”¨æˆ·æŒ‡å‡ºæ¥äº†ï¼Œå¹¶ä¸”è¿™ä¸ªé—®é¢˜å¾—åˆ°äº†goçš„ç»„ç»‡æˆå‘˜çš„è‚¯å®šï¼š</p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202302011956539.png alt=image-20230201195628479></p><p>æœ‰è¶£çš„æ˜¯ï¼Œgo101(åº”è¯¥æœ‰äººè®¤è¯†å§)è¿˜åœ¨ä¸‹é¢æå‡ºå³ä½¿é¿å¼€äº†headerçš„ç›´æ¥å®šä¹‰ï¼Œè¿˜æ˜¯éœ€è¦ä½¿ç”¨<code>runtime.KeepAlive</code>æ¥ä¿è¯gcä¸ä¼šå›æ”¶æ•°æ®ï¼Œè¿™å°±ä¸æˆ‘æœ¬æ–‡è§‚ç‚¹å†²çªäº†ğŸ¤£ã€‚</p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202302011959967.png alt=image-20230201195952921></p><p>ä¸è¿‡å¥½åœ¨è¿™æ¡åœ¨ä¸‹é¢è¢«åå¯¹äº†ğŸ‘€</p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202302012003206.png alt=image-20230201200316161></p><p>è‡³äºä¸ºä»€ä¹ˆä¸æŠŠreflectåŒ…ä¸­headerçš„Dataå­—æ®µæ”¹ä¸ºunsafe.Pointeræ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿæœ‰äº†è§£é‡Šï¼š</p><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202302012008314.png alt=image-20230201200812265></p><p>è¿™é‡Œé¢æåˆ°çš„å¦å¤–çš„issue:</p><p><a href=https://github.com/golang/go/issues/19367>unsafe: add Slice(ptr *T, len anyIntegerType) []T</a></p><p><a href=https://github.com/golang/go/issues/20171>proposal: spec: disallow T&lt;->uintptr conversion for type T unsafe.Pointer</a></p><p>å¦å¤–ï¼Œæˆ‘è§‰å¾—è¯¥issueçš„å‘èµ·äººè¯´çš„è¯æŒºæœ‰é“ç†çš„ï¼Œè¿™æ®µè½¬æ¢çš„ä»£ç è—äº†å¾ˆæ·±çš„å‘ï¼Œæ²¡æœ‰å¯¹æºç æœ‰ä¸€å®šäº†è§£çš„äººå®Œå…¨æ— æ³•å‘ç°ï¼Œè€Œå®˜æ–¹åˆæ²¡æœ‰æä¾›è½¬æ¢çš„æœ€ä½³å®è·µï¼Œä»¥è‡´äºç½‘ç»œä¸Šå‡ºç°äº†å„ç§è‡ªè¡Œå®ç°çš„ç‰ˆæœ¬ï¼Œè€Œå…¶ä¸­è®¸å¤šçš„å®ç°éƒ½æ˜¯å­˜åœ¨é—®é¢˜çš„ã€‚</p><p>å¹¸å¥½ï¼Œè¿™ä¸ªé—®é¢˜åœ¨Go2è¿æ¥äº†è½¬æœºã€‚</p><h2 id=å±•æœ›æœªæ¥go120>å±•æœ›æœªæ¥ï¼ŒGo1.20<a hidden class=anchor aria-hidden=true href=#å±•æœ›æœªæ¥go120>#</a></h2><p>åœ¨go1.20rcä¸­çš„è¿™ä¸ª<a href=https://github.com/golang/go/commit/42768b4c265065df9b7faeb9df0301ef64b271a2>æäº¤</a>ï¼Œä¸º<code>slice</code>å’Œ<code>string</code>çš„è½¬æ¢æä¾›äº†æ–°çš„é€‰æ‹©ï¼Œè¯¥æäº¤åœ¨unsafeåŒ…ä¸­æ–°å¢äº†å››ä¸ªå‡½æ•°<a href=https://github.com/golang/go/blob/release-branch.go1.20/src/unsafe/unsafe.go>https://github.com/golang/go/blob/release-branch.go1.20/src/unsafe/unsafe.go</a>:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#7f848e>// The function Slice returns a slice whose underlying array starts at ptr</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// and whose length and capacity are len.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Slice(ptr, len) is equivalent to</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//	(*[len]ArbitraryType)(unsafe.Pointer(ptr))[:]</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// except that, as a special case, if ptr is nil and len is zero,</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Slice returns nil.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// The len argument must be of integer type or an untyped constant.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// A constant len argument must be non-negative and representable by a value of type int;</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// if it is an untyped constant it is given type int.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// At run time, if len is negative, or if ptr is nil and len is not zero,</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// a run-time panic occurs.</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>Slice</span>(<span style=color:#e06c75>ptr</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>ArbitraryType</span>, <span style=color:#e06c75>len</span> <span style=color:#e06c75>IntegerType</span>) []<span style=color:#e06c75>ArbitraryType</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// SliceData returns a pointer to the underlying array of the argument</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// slice.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//   - If cap(slice) &gt; 0, SliceData returns &amp;slice[:1][0].</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//   - If slice == nil, SliceData returns nil.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//   - Otherwise, SliceData returns a non-nil pointer to an</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//     unspecified memory address.</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>SliceData</span>(<span style=color:#e06c75>slice</span> []<span style=color:#e06c75>ArbitraryType</span>) <span style=color:#56b6c2>*</span><span style=color:#e06c75>ArbitraryType</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// String returns a string value whose underlying bytes</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// start at ptr and whose length is len.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// The len argument must be of integer type or an untyped constant.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// A constant len argument must be non-negative and representable by a value of type int;</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// if it is an untyped constant it is given type int.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// At run time, if len is negative, or if ptr is nil and len is not zero,</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// a run-time panic occurs.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Since Go strings are immutable, the bytes passed to String</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// must not be modified afterwards.</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>String</span>(<span style=color:#e06c75>ptr</span> <span style=color:#56b6c2>*</span><span style=color:#e5c07b>byte</span>, <span style=color:#e06c75>len</span> <span style=color:#e06c75>IntegerType</span>) <span style=color:#e5c07b>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// StringData returns a pointer to the underlying bytes of str.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// For an empty string the return value is unspecified, and may be nil.</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>//</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// Since Go strings are immutable, the bytes returned by StringData</span>
</span></span><span style=display:flex><span><span style=color:#7f848e>// must not be modified.</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>StringData</span>(<span style=color:#e06c75>str</span> <span style=color:#e5c07b>string</span>) <span style=color:#56b6c2>*</span><span style=color:#e5c07b>byte</span>
</span></span></code></pre></div><p>ç”±äºunsafeåŒ…çš„ç‰¹æ®Šæ€§ï¼Œå…¶å‡½æ•°çš„å…·ä½“å®ç°æ˜¯é€šè¿‡æ±‡ç¼–ç­‰æ‰‹æ®µå®ç°çš„ï¼Œæ‰€ä»¥ä½ åœ¨è¿™é‡Œåªèƒ½çœ‹åˆ°å‡½æ•°ç­¾åã€‚</p><p>ç®€å•ä»‹ç»ä¸‹å››ä¸ªå‡½æ•°çš„ä½œç”¨:</p><ul><li>Sliceï¼šè¿”å›ä¸€ä¸ªsliceï¼Œå…¶åº•å±‚æ•°ç»„çš„èµ·å§‹åœ°å€å³ä¸ºå‚æ•°ptræ‰€æŒ‡å‘çš„åœ°å€ï¼Œsliceçš„lenå’Œcapéƒ½ä¸ºå‚æ•°lenã€‚</li><li>SliceData: è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥sliceåº•å±‚æ•°ç»„çš„æŒ‡é’ˆã€‚</li><li>Stringï¼šè¿”å›ä¸€ä¸ªstringï¼Œå…¶åº•å±‚çš„byteæ•°ç»„çš„èµ·å§‹åœ°å€å³ä¸ºå‚æ•°ptræ‰€æŒ‡å‘çš„åœ°å€ï¼Œé•¿åº¦ä¸ºå‚æ•°lenã€‚</li><li>StringData: è¿”å›å‚æ•°stråº•å±‚byteæ•°ç»„çš„æŒ‡é’ˆã€‚</li></ul><p>è¿™å››ä¸ªå‡½æ•°æä¾›çš„åŠŸèƒ½éå¸¸åŸºç¡€ï¼Œä¸è¿‡ç»„åˆèµ·æ¥å°±èƒ½å®ç°æˆ‘ä»¬æƒ³è¦çš„å­—ç¬¦ä¸²è½¬æ¢åŠŸèƒ½äº†,å¦‚æœä¸æƒ³å®‰è£…go1.20rcï¼Œä½ å¯ä»¥åœ¨<a href="https://go.dev/play/p/1scbUmFP3FC?v=gotip">è¿™é‡Œ</a>å»è¯•ç”¨è¿™å››ä¸ªå‡½æ•°:</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>package</span> <span style=color:#e06c75>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#98c379>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#98c379>&#34;unsafe&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>str</span> <span style=color:#56b6c2>:=</span> <span style=color:#98c379>&#34;hello world!&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bt</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Slice</span>(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>StringData</span>(<span style=color:#e06c75>str</span>), <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>str</span>))
</span></span><span style=display:flex><span>	<span style=color:#e06c75>fmt</span>.<span style=color:#61afef;font-weight:700>Println</span>(<span style=color:#e06c75>bt</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æœ‰äº†è¿™ä¸ªå†™æ³•ï¼Œreflectçš„headerså°±å¯ä»¥å¼ƒç”¨äº†ã€‚</p><p>é™„ä¸Šä¸‰ç§è½¬æ¢çš„benchmark(IDEå¯èƒ½ä¼šæŠ¥é”™ï¼Œä½†æ˜¯æ²¡äº‹ï¼Œgo1.20å¯ä»¥æ‰§è¡Œ)ï¼š</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#c678dd>package</span> <span style=color:#e06c75>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#98c379>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#98c379>&#34;unsafe&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>const</span> <span style=color:#e06c75>LEN</span> = <span style=color:#d19a66>33</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>getBytes</span>() []<span style=color:#e5c07b>byte</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>var</span> <span style=color:#e06c75>b</span> []<span style=color:#e5c07b>byte</span>
</span></span><span style=display:flex><span>	<span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>:=</span> <span style=color:#d19a66>0</span>; <span style=color:#e06c75>i</span> &lt; <span style=color:#e06c75>LEN</span>; <span style=color:#e06c75>i</span><span style=color:#56b6c2>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>b</span> = <span style=color:#e5c07b>append</span>(<span style=color:#e06c75>b</span>, <span style=color:#98c379>&#39; &#39;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e06c75>b</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>getStr</span>() <span style=color:#e5c07b>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#c678dd>return</span> <span style=color:#e5c07b>string</span>(<span style=color:#61afef;font-weight:700>getBytes</span>())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>BenchmarkString2Slice</span>(<span style=color:#e06c75>b</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>testing</span>.<span style=color:#e06c75>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>str</span> <span style=color:#56b6c2>:=</span> <span style=color:#61afef;font-weight:700>getStr</span>()
</span></span><span style=display:flex><span>	<span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>:=</span> <span style=color:#d19a66>0</span>; <span style=color:#e06c75>i</span> &lt; <span style=color:#e06c75>b</span>.<span style=color:#e06c75>N</span>; <span style=color:#e06c75>i</span><span style=color:#56b6c2>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>bt</span> <span style=color:#56b6c2>:=</span> []<span style=color:#e5c07b>byte</span>(<span style=color:#e06c75>str</span>)
</span></span><span style=display:flex><span>		<span style=color:#e06c75>_</span> = <span style=color:#e06c75>bt</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>BenchmarkString2SliceReflect</span>(<span style=color:#e06c75>b</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>testing</span>.<span style=color:#e06c75>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>str</span> <span style=color:#56b6c2>:=</span> <span style=color:#61afef;font-weight:700>getStr</span>()
</span></span><span style=display:flex><span>	<span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>:=</span> <span style=color:#d19a66>0</span>; <span style=color:#e06c75>i</span> &lt; <span style=color:#e06c75>b</span>.<span style=color:#e06c75>N</span>; <span style=color:#e06c75>i</span><span style=color:#56b6c2>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>bt</span> <span style=color:#56b6c2>:=</span> <span style=color:#56b6c2>*</span>(<span style=color:#56b6c2>*</span>[]<span style=color:#e5c07b>byte</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>str</span>))
</span></span><span style=display:flex><span>		<span style=color:#e06c75>_</span> = <span style=color:#e06c75>bt</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>BenchmarkString2SliceUnsafe</span>(<span style=color:#e06c75>b</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>testing</span>.<span style=color:#e06c75>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>str</span> <span style=color:#56b6c2>:=</span> <span style=color:#61afef;font-weight:700>getStr</span>()
</span></span><span style=display:flex><span>	<span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>:=</span> <span style=color:#d19a66>0</span>; <span style=color:#e06c75>i</span> &lt; <span style=color:#e06c75>b</span>.<span style=color:#e06c75>N</span>; <span style=color:#e06c75>i</span><span style=color:#56b6c2>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>bt</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Slice</span>(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>StringData</span>(<span style=color:#e06c75>str</span>), <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>str</span>))
</span></span><span style=display:flex><span>		<span style=color:#e06c75>_</span> = <span style=color:#e06c75>bt</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>BenchmarkSlice2String</span>(<span style=color:#e06c75>b</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>testing</span>.<span style=color:#e06c75>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bytes</span> <span style=color:#56b6c2>:=</span> <span style=color:#61afef;font-weight:700>getBytes</span>()
</span></span><span style=display:flex><span>	<span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>:=</span> <span style=color:#d19a66>0</span>; <span style=color:#e06c75>i</span> &lt; <span style=color:#e06c75>b</span>.<span style=color:#e06c75>N</span>; <span style=color:#e06c75>i</span><span style=color:#56b6c2>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>ss</span> <span style=color:#56b6c2>:=</span> <span style=color:#e5c07b>string</span>(<span style=color:#e06c75>bytes</span>)
</span></span><span style=display:flex><span>		<span style=color:#e06c75>_</span> = <span style=color:#e06c75>ss</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>BenchmarkSlice2StringReflect</span>(<span style=color:#e06c75>b</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>testing</span>.<span style=color:#e06c75>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bytes</span> <span style=color:#56b6c2>:=</span> <span style=color:#61afef;font-weight:700>getBytes</span>()
</span></span><span style=display:flex><span>	<span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>:=</span> <span style=color:#d19a66>0</span>; <span style=color:#e06c75>i</span> &lt; <span style=color:#e06c75>b</span>.<span style=color:#e06c75>N</span>; <span style=color:#e06c75>i</span><span style=color:#56b6c2>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>ss</span> <span style=color:#56b6c2>:=</span> <span style=color:#56b6c2>*</span>(<span style=color:#56b6c2>*</span><span style=color:#e5c07b>string</span>)(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>Pointer</span>(<span style=color:#56b6c2>&amp;</span><span style=color:#e06c75>bytes</span>))
</span></span><span style=display:flex><span>		<span style=color:#e06c75>_</span> = <span style=color:#e06c75>ss</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#c678dd>func</span> <span style=color:#61afef;font-weight:700>BenchmarkSlice2StringUnsafe</span>(<span style=color:#e06c75>b</span> <span style=color:#56b6c2>*</span><span style=color:#e06c75>testing</span>.<span style=color:#e06c75>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#e06c75>bytes</span> <span style=color:#56b6c2>:=</span> <span style=color:#61afef;font-weight:700>getBytes</span>()
</span></span><span style=display:flex><span>	<span style=color:#c678dd>for</span> <span style=color:#e06c75>i</span> <span style=color:#56b6c2>:=</span> <span style=color:#d19a66>0</span>; <span style=color:#e06c75>i</span> &lt; <span style=color:#e06c75>b</span>.<span style=color:#e06c75>N</span>; <span style=color:#e06c75>i</span><span style=color:#56b6c2>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#e06c75>ss</span> <span style=color:#56b6c2>:=</span> <span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>String</span>(<span style=color:#e06c75>unsafe</span>.<span style=color:#61afef;font-weight:700>SliceData</span>(<span style=color:#e06c75>bytes</span>), <span style=color:#e5c07b>len</span>(<span style=color:#e06c75>bytes</span>))
</span></span><span style=display:flex><span>		<span style=color:#e06c75>_</span> = <span style=color:#e06c75>ss</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img loading=lazy src=https://yicixin-blog-image.oss-accelerate.aliyuncs.com/img/202302021120164.png alt=å¯¹æ¯”ç»“æœ></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.yici.xin/tags/golang/>Golang</a></li><li><a href=https://www.yici.xin/tags/string/>String</a></li></ul><nav class=paginav><a class=next href=https://www.yici.xin/post/tech/golang-map%E7%9A%84%E6%93%8D%E4%BD%9C/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>Golang-mapçš„æ“ä½œ</span></a></nav></footer><script type=text/javascript>let giscusTheme=localStorage.getItem("pref-theme")==="light"?"light":"dark_dimmed",giscusAttributes={src:"https://giscus.app/client.js","data-repo":"yicixin/blog_comment","data-repo-id":"R_kgDOIr6QyQ","data-category":"Announcements","data-category-id":"DIC_kwDOIr6Qyc4CTSs3","data-mapping":"title","data-reactions-enabled":"1","data-emit-metadata":"0","data-theme":giscusTheme,"data-lang":"zh-CN",crossorigin:"anonymous","data-loading":"lazy",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([e,t])=>giscusScript.setAttribute(e,t));var article=document.getElementsByTagName("article")[0].appendChild(giscusScript);function changeGiscusTheme(){const e=localStorage.getItem("pref-theme")==="dark"?"light":"dark_dimmed";console.log(e);function t(e){const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")}t({setConfig:{theme:e}})}const toggle=document.querySelector("#theme-toggle");toggle&&toggle.addEventListener("click",changeGiscusTheme)</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.yici.xin/>ç»çŸ¥</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script src=https://code.jquery.com/jquery-1.12.4.min.js></script><script>$("code[class^=language] ").on("mouseover",function(){this.clientWidth<this.scrollWidth&&$(this).css("width","135%")}).on("mouseout",function(){$(this).css("width","100%"),$(".copy-code").css("right","4px")})</script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/katex.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/katex.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></body></html>